# LiqPass 系统级审计报告 v1.0
**日期**：2023-XX-XX

## 0. 执行摘要
- Top P0：[密钥管理漏洞、证据链序列化不稳定、CORS配置过宽]
- 立即行动（72h）：[修复API Key存储机制、统一证据序列化规则、收紧CORS策略]

## 1. 架构与威胁建模
- 数据/信任边界图：[前端、US后端、JP-verify、交易所API、区块链]之间的交互边界
- 攻击面与滥用情景：重放攻击、证据伪造、前端绕过验证、TOCTOU时间窗口攻击
- 风险矩阵与控制点：[Impact×Likelihood评估矩阵，高风险点控制点部署]

## 2. 证据链一致性（Merkle/EIP-712）
- 序列化与哈希测试向量：[不同订单状态的证据序列化测试结果]
- 根因：[JSON键排序不统一、数值精度处理不一致、时间戳格式问题]
- 修复方案与回归测试：[统一序列化库、标准化精度处理、添加一致性测试]

## 3. 交易所验证正确性（OKX/币安）
- 真值表（case→期望/实际）：[5种订单状态的验证结果对照表]
- 假阳/假阴源头与规避：[强平判定歧义点、ADL处理逻辑缺陷、API限流影响]

## 4. 秘钥与数据安全
- 存储/轮换/日志脱敏/权限矩阵：[API Key加密存储、定期轮换机制、日志脱敏策略]
- CORS/CSRF/Rate Limit 评估：[CORS策略收紧、CSRF防护、接口限流实现]

## 5. 经济与赔付风险
- 定价参数与储备压力测试：[VaR模型评估、不同压力场景下的储备金需求]
- 套利/重复理赔防控：[延迟申报检测、多账户关联分析、重复理赔防护]

## 6. 数据库与接口一致性
- 触发器/索引/唯一性：[外键约束检查、唯一索引优化、触发器逻辑验证]
- DAO/路由字段对齐检查：[前后端字段映射一致性、接口参数验证]

## 7. 运维与可靠性
- SLO 与 Error Budget：[服务可用性目标、错误预算分配]
- 熔断/重试/回退策略：[API调用熔断机制、幂等性重试、降级回退方案]
- Runbook（10 分钟恢复）：[故障诊断流程、快速恢复步骤、责任人分配]

## 8. 文案合规与 UX
- 风险表述整改清单：[“保险”相关敏感词汇替换表、合规表述建议]
- 异常路径可用性缺口：[证据提交失败、网络异常等场景的用户引导优化]

## 附录：问题清单（表）
ID | 模块 | 标题 | 严重度 | 影响 | 复现 | 修复建议 | Owner | ETA
---|---|---|---|---|---|---|---|---
P0-001 | 安全 | API Key明文存储 | P0 | 密钥泄露导致资金损失 | 访问配置文件查看API Key存储方式 | 1. 使用AES-256加密存储<br>2. 引入环境变量管理密钥<br>3. 实现密钥定期轮换机制 | 后端开发 | D3
P0-002 | 证据链 | 序列化规则不一致 | P0 | 相同证据产生不同哈希 | 对同一订单生成证据，多次序列化比对哈希值 | 1. 统一JSON键排序规则<br>2. 标准化数值精度处理<br>3. 固定时间戳格式为UTC毫秒 | 全栈开发 | D2
P0-003 | 安全 | CORS策略过宽 | P0 | 跨域攻击风险 | 检查CORS配置允许所有域名访问 | 1. 限制为特定前端域名<br>2. 移除不必要的预检请求支持<br>3. 限制允许的HTTP方法 | DevOps | D1
P0-004 | 赔付 | 赔付逻辑缺少幂等性 | P0 | 重复赔付风险 | 重复提交同一赔付请求 | 1. 添加唯一赔付ID验证<br>2. 实现幂等性检查<br>3. 添加交易记录锁 | 后端开发 | D4
P0-005 | 验证 | 强平判定逻辑歧义 | P0 | 错误赔付或拒绝赔付 | 提交边界条件订单验证 | 1. 明确强平判定标准<br>2. 添加日志详细记录判定过程<br>3. 实现判定结果复核机制 | 后端开发 | D5
P1-001 | 数据库 | 缺少必要索引 | P1 | 查询性能下降 | 执行慢查询分析 | 1. 为常用查询字段添加索引<br>2. 优化JOIN查询<br>3. 添加查询缓存 | 后端开发 | D6
P1-002 | API | 缺少速率限制 | P1 | 可能导致DoS | 高频请求API测试 | 1. 实现基于IP的速率限制<br>2. 添加用户级限流<br>3. 设置指数退避策略 | 后端开发 | D7
P1-003 | 日志 | 敏感信息未脱敏 | P1 | 信息泄露风险 | 审查日志内容 | 1. 对API Key进行脱敏<br>2. 隐藏个人身份信息<br>3. 实现日志分级 | 全栈开发 | D6
P2-001 | 前端 | 异常处理不完善 | P2 | 用户体验差 | 模拟网络异常场景 | 1. 添加友好错误提示<br>2. 实现重试机制<br>3. 提供问题反馈渠道 | 前端开发 | D10
P2-002 | 文案 | 使用保险相关敏感词汇 | P2 | 合规风险 | 审查所有用户可见文案 | 1. 替换为合规表述<br>2. 加强用户协议说明<br>3. 添加免责声明 | 产品 | D8

---

# LiqPass 修复路线图（两周）

## 第一阶段：P0 熔点修复（D1-D3）
- **D1**: 修复CORS配置过宽问题
  - 行动项：更新nginx配置，限制允许的域名和方法
  - 自测：验证跨域请求限制有效性

- **D2**: 解决证据序列化一致性问题
  - 行动项：统一序列化库，标准化数据处理流程
  - 自测：运行序列化一致性测试套件

- **D3**: 修复API Key存储安全问题
  - 行动项：实现加密存储，引入环境变量管理
  - 自测：验证密钥加密存储和读取流程

## 第二阶段：P0/P1 高风险修复（D4-D7）
- **D4**: 实现赔付幂等性保护
  - 行动项：添加唯一标识和幂等性检查
  - 自测：重复赔付请求测试

- **D5**: 优化强平判定逻辑
  - 行动项：明确判定标准，添加详细日志
  - 自测：边界条件订单验证

- **D6**: 修复数据库索引和日志脱敏问题
  - 行动项：添加必要索引，实现日志脱敏
  - 自测：查询性能测试，日志内容审查

- **D7**: 实现API速率限制
  - 行动项：添加限流中间件，设置合理阈值
  - 自测：高频请求压力测试

## 第三阶段：P2 优化与增强（D8-D14）
- **D8-D9**: 文案合规性整改
  - 行动项：替换敏感词汇，更新用户协议
  - 自测：合规审查

- **D10-D11**: 前端异常处理优化
  - 行动项：改进错误提示和重试机制
  - 自测：各种异常场景模拟测试

- **D12-D14**: 系统整体测试与文档完善
  - 行动项：运行端到端测试，更新运维文档
  - 自测：全流程回归测试，故障演练

---

# 验证闭环自测包说明

## 测试环境准备
1. 本地开发环境设置
2. 测试数据导入（包含5种不同状态订单）
3. 依赖服务启动（mock交易所API）

## 核心测试脚本
- `test_evidence_chain.sh`: 证据链一致性测试
- `test_verification.sh`: 交易所验证逻辑测试
- `test_payout_idempotent.sh`: 赔付幂等性测试
- `test_security.sh`: 安全配置测试

## 运行方法
```bash
# 运行全部测试套件
./run_all_tests.sh

# 运行单个测试
./test_evidence_chain.sh
```

## 期望结果文档
每个测试脚本对应一份期望结果文档，包含预期输出和成功标准。