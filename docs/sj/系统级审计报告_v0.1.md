# LiqPass 系统级审计报告 v0.1
**日期**：2025-11-04

## 0. 执行摘要
- Top P0：
  - 默认金库地址为 0x…dEaD，存在资金黑洞风险
  - 订单创建/列表无鉴权，paymentTx 未校验真实链上支付
  - 证据序列化与哈希未固化，Merkle 不可复现
- 72 小时行动：
  - 上线 `PAYMENT_VAULT_ADDRESS` 校验与链上回执验证；为订单路由加鉴权
  - 发布“证据序列化规范 + keccak 测试向量”并加端到端一致性测试
  - 限流/CORS 基线与日志脱敏

## 1. 架构与威胁模型
- 数据/信任边界：浏览器（钱包）→ US 前端 → US 后端（订单/验证）→ JP 验证（未来）→ 链上（Base）
- 攻击面：
  - 重放/伪造：创建订单、paymentTx 冒充、赔付重放
  - 绕过：无鉴权接口、过宽 CORS、内存路由 min/*
  - TOCTOU：报价 TTL 与实际付款/创建订单的时间差
- 风险矩阵：P0（资金/证据）、P1（权限/速率）、P2（SLO/可用性）

## 2. 证据链一致性（Merkle/EIP-712）
- 现状：evidence_blobs 已落库但未统一序列化/精度；未提供 hash 测试向量
- 建议：
  - 证据规范：键排序（ASCII）、数值统一字符串、时间戳 ISO 且 Z；数组顺序固定
  - 哈希：keccak256(bytes(json))，产出 3 组测试向量（最小/典型/边界）
  - 上链：记录 `merkle_roots(root, leaves, period_*, attested_tx)` 并在透明页对齐

## 3. 交易所验证正确性（OKX/币安）
- 对齐 normalized 与 raw 的映射，列清算/ADL 边界
- 回放用例：成功成交/撤单/部分成交/ADL/无效订单，形成真值表

## 4. 秘钥与数据安全
- API Key：迁移到 `api_credentials` 加密存储；日志仅留后 4 位
- CORS/CSRF：仅允许受信源；敏感接口要求签名；必要时 CSRF token
- 访问控制：订单/验证/赔付按用户/钱包隔离

## 5. 经济与赔付风险
- 定价/赔付：加入等待期与限额；黑名单策略；储备金阈值与自动降额
- 压力测试：场景 A/B/C；VaR 与资金覆盖率

## 6. 数据库与接口一致性
- 迁移：已新增 003/004，补齐 policy/merkle/claims_v2 与最小闭环四表
- 触发器：为核心表加 updated_at 触发器
- DAO/路由：检查字段映射与枚举取值；接口分页/过滤安全

## 7. 运维与可靠性
- SLO：下单/验证 99.9%；错误预算月度 43 分钟
- 熔断/重试/回退：对外部依赖（链上 RPC/交易所）加隔离与退避
- Runbook：金库误配、RPC 故障、交易积压 10 分钟内恢复步骤

## 8. 文案合规与 UX
- 用语：替换“保险”为“保障/赔付”
- 异常引导：下单失败/网络切换失败/复制失败应有明确动作指引

## 附录：问题清单（见 docs/审计_风险与不合理点清单.md）

