# LiqPass 风险清单与修复路线图（基线版）

本文档旨在梳理 LiqPass 项目当前面临的核心风险，并提出一个为期两周的迭代修复路线图。

## 1. 风险清单 (Risk Checklist)

基于对项目现状的初步评估，我们将风险划分为四个优先级：

| 优先级 | 定义 | 风险点举例 |
| :--- | :--- | :--- |
| **P0** | **紧急熔断级** | 可能导致资金损失、核心功能不可用或严重安全漏洞的风险。 |
| **P1** | **核心功能强化** | 影响功能健壮性、数据一致性或存在中等安全隐患的风险。 |
| **P2** | **体验与可观测性** | 影响用户体验、开发效率或系统监控能力的风险。 |
| **P3** | **长期技术债** | 不会立即引发问题，但长期来看会影响项目可维护性和扩展性的风险。 |

---

### P0 - 紧急熔断级 (Urgent/Critical)

- **[安全] 金库地址保护不足**:
  - `PAYMENT_VAULT_ADDRESS` 环境变量可能未设置或设置为无效地址。
  - 前端缺少对目标地址和链 ID 的校验，可能导致用户向错误地址付款。
- **[安全] 核心订单接口缺少鉴权**:
  - `/api/v1/orders*` 相关路由可被未经授权的访问，存在被攻击的风险。
- **[数据] 支付回执校验不严格**:
  - 创建订单时，未严格校验链上交易 `paymentTx` 的 `to`, `token`, `amount`, `chainId` 是否与报价一致，可能导致支付金额错误或支付到错误地址。
- **[标准] 证据序列化规范缺失**:
  - 缺乏统一的 JSON 序列化和哈希标准，可能导致证据校验失败或产生争议。

### P1 - 核心功能强化 (Core Functionality Hardening)

- **[安全] Web 安全防护薄弱**:
  - CORS 策略过于宽松，可能允许来自恶意站点的跨域请求。
  - 缺少 CSRF 保护，敏感操作可能被伪造。
  - 缺少速率限制，核心 API 可能被滥用或遭受 DoS 攻击。
- **[健壮性] 关键操作缺少幂等性保证**:
  - 订单创建、赔付等接口不支持幂等性，重试可能导致重复操作。
- **[合规] 日志记录不规范**:
  - API Key、密钥等敏感信息可能被直接记录在日志中，存在泄露风险。
  - 日志格式不统一，难以进行有效的监控和告警。
- **[功能] 赔付与对账功能不完善**:
  - 缺少 `payout_txs` 和 `audit_events` 等关键数据表，难以追踪赔付状态和进行资金对账。
  - 透明度页面依赖 Mock 数据，未与真实数据打通。

### P2 - 体验与可观测性 (User Experience & Observability)

- **[性能] 数据库查询效率低下**:
  - 核心数据表（如 `orders`, `claims`）缺少必要的索引，导致查询缓慢。
  - 缺少 `updated_at` 等时间戳的自动更新机制，难以进行增量数据同步。
- **[体验] 用户引导和异常处理不足**:
  - 部分产品文案（如“保险”）可能引起歧义或合规风险。
  - 关键流程（如支付、赔付）在发生异常时，缺少清晰的用户指引。
- **[运维] 系统可观测性差**:
  - 缺少完善的健康检查、重试、熔断等机制。
  - 缺乏明确的 SLO（服务等级目标）和错误预算。
  - Runbook（运维手册）不完整，难以应对突发事件。

### P3 - 长期技术债 (Long-term Technical Debt)

- **[代码质量] 测试覆盖率不足**:
  - 单元测试、集成测试和端到端测试覆盖范围有限，难以保证代码质量和快速迭代。
- **[架构] 前后端代码耦合度高**:
  - 部分业务逻辑可能散落在前端代码中，不利于维护和复用。
- **[文档] 项目文档过时或缺失**:
  - 部分设计文档、API 文档与当前实现不一致。
  - 缺少关键组件的架构图和详细说明。

---

## 2. 修复路线图 (Repair Roadmap)

为在两周内快速收敛核心风险，我们制定了以下 P0 → P1 → P2 的三阶段修复计划。

### **第一阶段：D1-D3 (P0 风险熔断)**

| 任务 | 负责人 | 产出/验收标准 |
| :--- | :--- | :--- |
| **加固金库地址** | 后端/前端 | - 后端启动时校验 `PAYMENT_VAULT_ADDRESS`。<br>- 前端下单前增加对目标地址和链 ID 的校验。 |
| **实现订单接口鉴权** | 后端 | - 所有 `/api/v1/orders*` 路由受 JWT 或其他机制保护。<br>- 增加签名和 nonce 机制防止重放。 |
| **完善支付回执校验** | 后端 | - 创建订单时，上链查询 `paymentTx` 并校验关键字段。 |
| **发布证据序列化规范** | 架构组 | - 提供至少 3 组 JSON 序列化与哈希的测试向量。<br>- 将校验逻辑集成到单元测试和端到端测试中。 |

### **第二阶段：D4-D7 (P1 功能强化)**

| 任务 | 负责人 | 产出/验收标准 |
| :--- | :--- | :--- |
| **实施 Web 安全策略** | 后端/运维 | - 收紧 CORS 策略，仅允许受信任的 Origin。<br>- 为敏感路由增加 CSRF Token 或签名校验。<br>- 实施基于滑动窗口的速率限制。 |
| **引入幂等性支持** | 后端 | - 在创建订单/赔付等接口中支持 `Idempotency-Key` 请求头。<br>- 建立 `idempotency_keys` 表用于记录和校验。 |
| **规范化日志与脱敏** | 后端/运维 | - 确保敏感信息（密钥、密码）不落盘。<br>- 统一日志为 JSON 格式，并对敏感字段进行脱敏处理。 |
| **打通赔付与对账** | 后端/DBA | - 创建 `payout_txs` 和 `audit_events` 表。<br>- 透明度页面后端视图完成开发，并替换前端 Mock 数据。 |

### **第三阶段：D8-D14 (P2 体验与可观测性)**

| 任务 | 负责人 | 产出/验收标准 |
| :--- | :--- | :--- |
| **优化数据库性能** | DBA/后端 | - 为核心表的常用查询字段（`user_id`, `status`, `created_at`）添加索引。<br>- 为核心表增加 `updated_at` 自动更新触发器。 |
| **改善 UX 与文案** | 前端/产品 | - 将“保险”等敏感词汇替换为“保障/赔付”。<br>- 为支付、赔付等关键流程的异常状态提供清晰的指引。 |
| **提升系统可观测性** | 运维/后端 | - 为核心服务添加 `/healthz` 和 `/readyz` 端点。<br>- 完善 Runbook，覆盖主要故障场景的应急预案。 |

---

## 3. 交付与验收

- **通过《验证闭环自测包》**: 所有测试用例 100% 通过。
- **风险清零**: P0 和 P1 风险点全部关闭，并形成回归测试用例。
- **真实数据上线**: 透明度页面完全接入后端真实事件数据。
