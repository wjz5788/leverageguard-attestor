# LiqPass è¿è¡Œè„šæœ¬æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›äº†LiqPassç³»ç»Ÿçš„è¿è¡Œè„šæœ¬è¯´æ˜ï¼ŒåŒ…æ‹¬éƒ¨ç½²è„šæœ¬ã€ç›‘æ§è„šæœ¬ã€ç»´æŠ¤è„šæœ¬ç­‰ã€‚æ‰€æœ‰è„šæœ¬éƒ½ä½äºé¡¹ç›®æ ¹ç›®å½•çš„`scripts/`æ–‡ä»¶å¤¹ä¸­ã€‚

## 1. è„šæœ¬ç›®å½•ç»“æ„

```
scripts/
â”œâ”€â”€ deploy/           # éƒ¨ç½²ç›¸å…³è„šæœ¬
â”‚   â”œâ”€â”€ deploy-us.sh          # USåç«¯éƒ¨ç½²è„šæœ¬
â”‚   â”œâ”€â”€ deploy-jp.sh          # JPéªŒè¯æœåŠ¡éƒ¨ç½²è„šæœ¬
â”‚   â”œâ”€â”€ deploy-frontend.sh    # å‰ç«¯éƒ¨ç½²è„šæœ¬
â”‚   â””â”€â”€ rollback.sh           # å›æ»šè„šæœ¬
â”œâ”€â”€ monitor/          # ç›‘æ§ç›¸å…³è„šæœ¬
â”‚   â”œâ”€â”€ monitor-verify.sh     # éªŒè¯æœåŠ¡ç›‘æ§è„šæœ¬
â”‚   â”œâ”€â”€ health-check.sh       # å¥åº·æ£€æŸ¥è„šæœ¬
â”‚   â”œâ”€â”€ performance-check.sh  # æ€§èƒ½æ£€æŸ¥è„šæœ¬
â”‚   â””â”€â”€ alert-notify.sh       # å‘Šè­¦é€šçŸ¥è„šæœ¬
â”œâ”€â”€ maintenance/      # ç»´æŠ¤ç›¸å…³è„šæœ¬
â”‚   â”œâ”€â”€ backup-db.sh          # æ•°æ®åº“å¤‡ä»½è„šæœ¬
â”‚   â”œâ”€â”€ cleanup-logs.sh      # æ—¥å¿—æ¸…ç†è„šæœ¬
â”‚   â”œâ”€â”€ update-dependencies.sh # ä¾èµ–æ›´æ–°è„šæœ¬
â”‚   â””â”€â”€ security-scan.sh      # å®‰å…¨æ‰«æè„šæœ¬
â””â”€â”€ utils/           # å·¥å…·è„šæœ¬
    â”œâ”€â”€ setup-env.sh         # ç¯å¢ƒè®¾ç½®è„šæœ¬
    â”œâ”€â”€ generate-keys.sh    # å¯†é’¥ç”Ÿæˆè„šæœ¬
    â””â”€â”€ test-end-to-end.sh   # ç«¯åˆ°ç«¯æµ‹è¯•è„šæœ¬
```

## 2. éƒ¨ç½²è„šæœ¬

### 2.1 USåç«¯éƒ¨ç½²è„šæœ¬ (`deploy-us.sh`)

**åŠŸèƒ½**: è‡ªåŠ¨åŒ–éƒ¨ç½²USåç«¯æœåŠ¡åˆ°ç”Ÿäº§ç¯å¢ƒ

**ä½¿ç”¨æ–¹å¼**:
```bash
./scripts/deploy/deploy-us.sh [ç¯å¢ƒ] [ç‰ˆæœ¬]
```

**å‚æ•°è¯´æ˜**:
- `ç¯å¢ƒ`: production/staging (é»˜è®¤: production)
- `ç‰ˆæœ¬`: Gitæ ‡ç­¾æˆ–æäº¤å“ˆå¸Œ (é»˜è®¤: latest)

**è„šæœ¬å†…å®¹**:
```bash
#!/bin/bash

# è®¾ç½®é»˜è®¤å‚æ•°
ENVIRONMENT=${1:-production}
VERSION=${2:-latest}

# é¢œè‰²è¾“å‡ºå‡½æ•°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
    exit 1
}

# æ£€æŸ¥å‰ç½®æ¡ä»¶
check_prerequisites() {
    log "æ£€æŸ¥å‰ç½®æ¡ä»¶..."
    
    # æ£€æŸ¥Node.js
    if ! command -v node &> /dev/null; then
        error "Node.jsæœªå®‰è£…"
    fi
    
    # æ£€æŸ¥npm
    if ! command -v npm &> /dev/null; then
        error "npmæœªå®‰è£…"
    fi
    
    # æ£€æŸ¥PM2
    if ! command -v pm2 &> /dev/null; then
        warn "PM2æœªå®‰è£…ï¼Œå°è¯•å®‰è£…..."
        npm install -g pm2
    fi
    
    log "å‰ç½®æ¡ä»¶æ£€æŸ¥å®Œæˆ"
}

# å¤‡ä»½å½“å‰ç‰ˆæœ¬
backup_current() {
    log "å¤‡ä»½å½“å‰ç‰ˆæœ¬..."
    
    if [ -d "/opt/liqpass/backend" ]; then
        BACKUP_DIR="/opt/liqpass/backups/$(date +%Y%m%d_%H%M%S)"
        mkdir -p "$BACKUP_DIR"
        cp -r /opt/liqpass/backend "$BACKUP_DIR/"
        log "å¤‡ä»½å®Œæˆ: $BACKUP_DIR"
    else
        warn "æ²¡æœ‰æ‰¾åˆ°å½“å‰ç‰ˆæœ¬ï¼Œè·³è¿‡å¤‡ä»½"
    fi
}

# éƒ¨ç½²æ–°ç‰ˆæœ¬
deploy_new() {
    log "éƒ¨ç½²æ–°ç‰ˆæœ¬: $VERSION"
    
    # è¿›å…¥éƒ¨ç½²ç›®å½•
    cd /opt/liqpass || error "éƒ¨ç½²ç›®å½•ä¸å­˜åœ¨"
    
    # æ¸…ç†æ—§ç‰ˆæœ¬
    if [ -d "backend" ]; then
        rm -rf backend
    fi
    
    # å…‹éš†ä»£ç 
    git clone https://github.com/your-org/liqpass-backend backend
    cd backend
    
    # åˆ‡æ¢åˆ°æŒ‡å®šç‰ˆæœ¬
    if [ "$VERSION" != "latest" ]; then
        git checkout "$VERSION"
    fi
    
    # å®‰è£…ä¾èµ–
    log "å®‰è£…ä¾èµ–..."
    npm ci --only=production
    
    # å¤åˆ¶ç¯å¢ƒé…ç½®
    if [ -f "/opt/liqpass/backend.env" ]; then
        cp /opt/liqpass/backend.env .env
    else
        warn "æœªæ‰¾åˆ°ç¯å¢ƒé…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
        cp .env.example .env
    fi
    
    # è¿è¡Œæ•°æ®åº“è¿ç§»
    log "è¿è¡Œæ•°æ®åº“è¿ç§»..."
    npm run db:migrate
    
    log "éƒ¨ç½²å®Œæˆ"
}

# å¯åŠ¨æœåŠ¡
start_service() {
    log "å¯åŠ¨æœåŠ¡..."
    
    cd /opt/liqpass/backend
    
    # åœæ­¢ç°æœ‰æœåŠ¡
    pm2 stop liqpass-backend 2>/dev/null || true
    pm2 delete liqpass-backend 2>/dev/null || true
    
    # å¯åŠ¨æ–°æœåŠ¡
    pm2 start npm --name "liqpass-backend" -- run start
    
    # ä¿å­˜PM2é…ç½®
    pm2 save
    
    log "æœåŠ¡å¯åŠ¨å®Œæˆ"
}

# å¥åº·æ£€æŸ¥
health_check() {
    log "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
    
    # ç­‰å¾…æœåŠ¡å¯åŠ¨
    sleep 10
    
    # æ£€æŸ¥æœåŠ¡çŠ¶æ€
    if curl -f http://localhost:3000/health > /dev/null 2>&1; then
        log "å¥åº·æ£€æŸ¥é€šè¿‡"
    else
        error "å¥åº·æ£€æŸ¥å¤±è´¥"
    fi
}

# ä¸»å‡½æ•°
main() {
    log "å¼€å§‹éƒ¨ç½²USåç«¯æœåŠ¡ (ç¯å¢ƒ: $ENVIRONMENT, ç‰ˆæœ¬: $VERSION)"
    
    check_prerequisites
    backup_current
    deploy_new
    start_service
    health_check
    
    log "éƒ¨ç½²å®Œæˆ!"
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
```

### 2.2 JPéªŒè¯æœåŠ¡éƒ¨ç½²è„šæœ¬ (`deploy-jp.sh`)

**åŠŸèƒ½**: è‡ªåŠ¨åŒ–éƒ¨ç½²JPéªŒè¯æœåŠ¡åˆ°æ—¥æœ¬æœåŠ¡å™¨

**ä½¿ç”¨æ–¹å¼**:
```bash
./scripts/deploy/deploy-jp.sh [ç¯å¢ƒ] [ç‰ˆæœ¬]
```

**è„šæœ¬ç‰¹ç‚¹**:
- æ”¯æŒPythonè™šæ‹Ÿç¯å¢ƒ
- è‡ªåŠ¨é…ç½®Supervisorè¿›ç¨‹ç®¡ç†
- æ—¥æœ¬æœ¬åœ°åŒ–ç½‘ç»œä¼˜åŒ–

### 2.3 å‰ç«¯éƒ¨ç½²è„šæœ¬ (`deploy-frontend.sh`)

**åŠŸèƒ½**: éƒ¨ç½²å‰ç«¯åº”ç”¨åˆ°CDNå’ŒWebæœåŠ¡å™¨

**ä½¿ç”¨æ–¹å¼**:
```bash
./scripts/deploy/deploy-frontend.sh [ç¯å¢ƒ] [ç‰ˆæœ¬]
```

## 3. ç›‘æ§è„šæœ¬

### 3.1 éªŒè¯æœåŠ¡ç›‘æ§è„šæœ¬ (`monitor-verify.sh`)

**åŠŸèƒ½**: ç›‘æ§JPéªŒè¯æœåŠ¡çš„å¯ç”¨æ€§å’Œæ€§èƒ½

**è„šæœ¬å†…å®¹**:
```bash
#!/bin/bash

# ç›‘æ§é…ç½®
VERIFY_URL="https://jp-verify.liqpass.com/health"
ALERT_THRESHOLD=3  # è¿ç»­å¤±è´¥æ¬¡æ•°é˜ˆå€¼
SLACK_WEBHOOK="https://hooks.slack.com/services/..."

# ç›‘æ§å‡½æ•°
monitor_verify() {
    FAIL_COUNT=0
    
    while true; do
        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
        RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$VERIFY_URL")
        
        if [ "$RESPONSE" -eq 200 ]; then
            echo "[$(date)] éªŒè¯æœåŠ¡æ­£å¸¸"
            FAIL_COUNT=0
        else
            FAIL_COUNT=$((FAIL_COUNT + 1))
            echo "[$(date)] éªŒè¯æœåŠ¡å¼‚å¸¸ (HTTP: $RESPONSE), å¤±è´¥æ¬¡æ•°: $FAIL_COUNT"
            
            # è§¦å‘å‘Šè­¦
            if [ "$FAIL_COUNT" -ge "$ALERT_THRESHOLD" ]; then
                send_alert "éªŒè¯æœåŠ¡è¿ç»­å¤±è´¥ $FAIL_COUNT æ¬¡"
            fi
        fi
        
        sleep 60  # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    done
}

# å‘é€å‘Šè­¦
send_alert() {
    MESSAGE="$1"
    
    curl -X POST -H 'Content-type: application/json' \
    --data "{\"text\":\"ğŸš¨ LiqPasså‘Šè­¦: $MESSAGE\"}" \
    "$SLACK_WEBHOOK"
}

# å¯åŠ¨ç›‘æ§
monitor_verify
```

### 3.2 å¥åº·æ£€æŸ¥è„šæœ¬ (`health-check.sh`)

**åŠŸèƒ½**: ç»¼åˆå¥åº·æ£€æŸ¥ï¼ŒåŒ…æ‹¬æœåŠ¡çŠ¶æ€ã€æ•°æ®åº“è¿æ¥ã€ç£ç›˜ç©ºé—´ç­‰

**ä½¿ç”¨æ–¹å¼**:
```bash
./scripts/monitor/health-check.sh [è¯¦ç»†æ¨¡å¼]
```

## 4. ç»´æŠ¤è„šæœ¬

### 4.1 æ•°æ®åº“å¤‡ä»½è„šæœ¬ (`backup-db.sh`)

**åŠŸèƒ½**: è‡ªåŠ¨åŒ–æ•°æ®åº“å¤‡ä»½å’Œæ¸…ç†

**è„šæœ¬å†…å®¹**:
```bash
#!/bin/bash

# å¤‡ä»½é…ç½®
BACKUP_DIR="/backup/liqpass"
RETENTION_DAYS=30
DB_PATH="/data/liqpass.db"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p "$BACKUP_DIR"

# ç”Ÿæˆå¤‡ä»½æ–‡ä»¶å
BACKUP_FILE="$BACKUP_DIR/liqpass_$(date +%Y%m%d_%H%M%S).db"

# æ‰§è¡Œå¤‡ä»½
log "å¼€å§‹æ•°æ®åº“å¤‡ä»½..."
cp "$DB_PATH" "$BACKUP_FILE"

# å‹ç¼©å¤‡ä»½æ–‡ä»¶
gzip "$BACKUP_FILE"

# æ¸…ç†æ—§å¤‡ä»½
log "æ¸…ç†è¿‡æœŸå¤‡ä»½..."
find "$BACKUP_DIR" -name "*.db.gz" -mtime +$RETENTION_DAYS -delete

log "å¤‡ä»½å®Œæˆ: ${BACKUP_FILE}.gz"
```

### 4.2 æ—¥å¿—æ¸…ç†è„šæœ¬ (`cleanup-logs.sh`)

**åŠŸèƒ½**: è‡ªåŠ¨æ¸…ç†å’Œå½’æ¡£æ—¥å¿—æ–‡ä»¶

**ä½¿ç”¨æ–¹å¼**:
```bash
./scripts/maintenance/cleanup-logs.sh [ä¿ç•™å¤©æ•°]
```

## 5. å·¥å…·è„šæœ¬

### 5.1 ç¯å¢ƒè®¾ç½®è„šæœ¬ (`setup-env.sh`)

**åŠŸèƒ½**: å¿«é€Ÿè®¾ç½®å¼€å‘ç¯å¢ƒ

**ä½¿ç”¨æ–¹å¼**:
```bash
./scripts/utils/setup-env.sh [ç¯å¢ƒç±»å‹]
```

**ç¯å¢ƒç±»å‹é€‰é¡¹**:
- `dev`: å¼€å‘ç¯å¢ƒ
- `test`: æµ‹è¯•ç¯å¢ƒ  
- `prod`: ç”Ÿäº§ç¯å¢ƒ

### 5.2 ç«¯åˆ°ç«¯æµ‹è¯•è„šæœ¬ (`test-end-to-end.sh`)

**åŠŸèƒ½**: æ‰§è¡Œå®Œæ•´çš„ç«¯åˆ°ç«¯æµ‹è¯•æµç¨‹

**è„šæœ¬å†…å®¹**:
```bash
#!/bin/bash

# ç«¯åˆ°ç«¯æµ‹è¯•è„šæœ¬
log() {
    echo "[E2Eæµ‹è¯•] $1"
}

# æµ‹è¯•é…ç½®
BASE_URL="http://localhost:3000"
TEST_API_KEY="test_key_$(date +%s)"

# 1. å¥åº·æ£€æŸ¥
log "æ­¥éª¤1: å¥åº·æ£€æŸ¥"
curl -f "$BASE_URL/health" || exit 1

# 2. åˆ›å»ºæµ‹è¯•è®¢å•
log "æ­¥éª¤2: åˆ›å»ºæµ‹è¯•è®¢å•"
ORDER_RESPONSE=$(curl -s -X POST "$BASE_URL/api/verify/okx" \
  -H "Content-Type: application/json" \
  -d '{
    "apiKey": "'$TEST_API_KEY'",
    "orderId": "test_order_123",
    "instrumentId": "BTC-USDT",
    "live": false
  }')

echo "è®¢å•å“åº”: $ORDER_RESPONSE"

# 3. éªŒè¯å“åº”æ ¼å¼
log "æ­¥éª¤3: éªŒè¯å“åº”æ ¼å¼"
echo "$ORDER_RESPONSE" | jq '.success' | grep -q true || exit 1

# 4. æ£€æŸ¥æ•°æ®åº“è®°å½•
log "æ­¥éª¤4: æ£€æŸ¥æ•°æ®åº“è®°å½•"
sqlite3 /data/liqpass.db "SELECT COUNT(*) FROM orders WHERE order_id='test_order_123';" | grep -q 1 || exit 1

log "ç«¯åˆ°ç«¯æµ‹è¯•é€šè¿‡!"
```

## 6. è„šæœ¬ä½¿ç”¨æœ€ä½³å®è·µ

### 6.1 æƒé™ç®¡ç†

```bash
# è®¾ç½®è„šæœ¬å¯æ‰§è¡Œæƒé™
chmod +x scripts/*/*.sh

# åˆ›å»ºä¸“ç”¨ç”¨æˆ·
sudo useradd -r -s /bin/false liqpass
sudo chown -R liqpass:liqpass /opt/liqpass
```

### 6.2 å®šæ—¶ä»»åŠ¡é…ç½®

```bash
# ç¼–è¾‘crontab
sudo crontab -e

# æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œå¤‡ä»½
0 2 * * * /opt/liqpass/scripts/maintenance/backup-db.sh

# æ¯5åˆ†é’Ÿæ‰§è¡Œå¥åº·æ£€æŸ¥
*/5 * * * * /opt/liqpass/scripts/monitor/health-check.sh
```

### 6.3 æ—¥å¿—è®°å½•

```bash
# é‡å®šå‘è„šæœ¬è¾“å‡ºåˆ°æ—¥å¿—æ–‡ä»¶
./scripts/deploy/deploy-us.sh >> /var/log/liqpass/deploy.log 2>&1
```

## 7. æ•…éšœæ’é™¤

### 7.1 å¸¸è§é—®é¢˜

**é—®é¢˜**: è„šæœ¬æƒé™ä¸è¶³
```bash
# è§£å†³æ–¹æ¡ˆ
chmod +x script.sh
sudo ./script.sh
```

**é—®é¢˜**: ç¯å¢ƒå˜é‡æœªè®¾ç½®
```bash
# è§£å†³æ–¹æ¡ˆ
source .env
./script.sh
```

**é—®é¢˜**: ä¾èµ–å‘½ä»¤ä¸å­˜åœ¨
```bash
# è§£å†³æ–¹æ¡ˆ
# æ£€æŸ¥å¹¶å®‰è£…ç¼ºå¤±çš„å‘½ä»¤
command -v jq >/dev/null || sudo apt install jq
```

### 7.2 è°ƒè¯•æ¨¡å¼

```bash
# å¯ç”¨è°ƒè¯•è¾“å‡º
bash -x ./script.sh

# æˆ–è€…æ·»åŠ set -xåˆ°è„šæœ¬å¼€å¤´
#!/bin/bash
set -x  # å¯ç”¨è°ƒè¯•
```

## 8. å®‰å…¨è€ƒè™‘

### 8.1 æ•æ„Ÿä¿¡æ¯ä¿æŠ¤

```bash
# ä½¿ç”¨ç¯å¢ƒå˜é‡æ–‡ä»¶
#!/bin/bash
source /etc/liqpass/secrets.env

# è®¾ç½®æ–‡ä»¶æƒé™
chmod 600 /etc/liqpass/secrets.env
```

### 8.2 è¾“å…¥éªŒè¯

```bash
# éªŒè¯è¾“å…¥å‚æ•°
if [[ ! "$1" =~ ^(dev|test|prod)$ ]]; then
    echo "é”™è¯¯: æ— æ•ˆçš„ç¯å¢ƒå‚æ•°"
    exit 1
fi
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2024-12-19  
**ç»´æŠ¤è€…**: LiqPasså¼€å‘å›¢é˜Ÿ