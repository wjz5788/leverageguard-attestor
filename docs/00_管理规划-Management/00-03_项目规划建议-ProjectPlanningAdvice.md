# LeverageGuard 项目规划建议

本文基于现有代码仓库与业务目标（爆仓验证、智能赔付、风险控制）的观察，提出一份分阶段的专业化实施规划，覆盖安全整改、架构完善、交付流程与运营支撑，供团队落地执行。

---

## 1. 项目愿景与关键目标
- **业务愿景**：提供面向高杠杆用户的爆仓保障方案，快速核验交易所订单、自动计算赔付、沉淀风控数据，保障资金池可持续。
- **成功标准**：
  1. 安全：密钥、资金、链上交互具备多层防护，合规可审计。
  2. 稳定：多微服务协作稳定、消息链路可靠、具备监控告警。
  3. 效率：订单验证与赔付流程自动化，24 小时可用。
  4. 可扩展：后续可接入多交易所、多资产及更多风控维度。

---

## 2. 当前状态评估
| 维度         | 现状摘要 | 主要风险 |
| ------------ | -------- | -------- |
| 代码安全     | 明文 API 密钥、审计接口错配 | `API_KEY` 被滥用、审计日志缺失 |
| 基础架构     | FastAPI 微服务 + RabbitMQ 设计，但关键组件未成型 | 消息队列、健康检查相关异常 |
| 区块链交互   | Web3 流程以模拟响应为主，未接入真实合约 | 缺少主网/测试网参数、重试逻辑不一致 |
| 测试与运维   | 缺少自动化测试、缺少容器化脚本 | 难以验证流程、缺少 CI/CD |
| 文档与流程   | 有部分需求与逻辑说明，但部署/配置文档缺失 | 新成员难以快速加入 |

结论：项目整体处于原型阶段，需先补足安全与基础设施，再推进业务功能。

---

## 3. 优先级与风险矩阵
| 优先级 | 任务 | 目标 | 风险 |
| ------ | ---- | ---- | ---- |
| P0 | 安全整改（密钥管理、日志接口、异常修复） | 阻止资金风险、恢复服务可用性 | 若不处理，系统不可上线 |
| P1 | 消息链路与服务稳定性 | 确保订单验证→赔付→报告链路可跑通 | 队列不稳会导致赔付延迟或丢单 |
| P1 | 测试与监控体系搭建 | 建立最小可用测试集与监控指标 | 缺少测试导致迭代风险高 |
| P2 | 区块链与资金管理完善 | 接入实盘节点、实现资金池管理策略 | 复杂度高，需要安全审计 |
| P2 | 数据分析与报告 | 提供风控与赔付报表、可视化 | 增强运营和合规支撑 |

---

## 4. 分阶段实施路线

### 阶段 A（安全兜底 & 基础修复，1-2 周）
1. 吊销仓库中的所有旧密钥，全部改为环境变量或 Secret Manager 管理。
2. 修复 `MessageQueueClient` 导入错误、补充 `connected` 状态接口，确保健康检查可用。
3. 梳理 `AuditLogger` 接口，统一调用方式并补充单元测试。
4. 重新实现赔付重试逻辑，使同步/异步函数一致，确保赔付流程不会因协程错误中断。
5. 建立仓库私密配置示例（`.env.example`）与安全合规清单。

### 阶段 B（稳定性建设，2-3 周）
1. 编写端到端集成测试：模拟 RabbitMQ、Web3，验证订单验证 → 赔付 → 报告生成。
2. 引入 docker-compose：包含 API Gateway、各微服务、RabbitMQ、Redis/Mongo，支持一键启动。
3. 加入基础监控指标（Prometheus exporter 或 OpenTelemetry），覆盖消息积压、服务健康、关键业务指标。
4. 完善异常处理和告警（如消息重试策略、死信队列监控、日志告警）。

### 阶段 C（业务功能迭代，3-4 周）
1. 按险种/杠杆策略细化赔付算法，结合风险系数和资金池状态动态调节。
2. 实现链上资金操作的真实流程（多签钱包、审批流程），并通过测试网演练。
3. 扩展风险服务，加入实时市场数据、用户画像、策略风控模型。
4. 提供报告生成与可视化模块，与风控团队和运营界面对接。

### 阶段 D（上线准备，2 周）
1. 安全审计：合约、密钥管理、系统权限审查；准备应急预案。
2. 压测与容量评估，确保消息队列与数据库可以承载预估流量。
3. 制定上线 Runbook 和运营流程，明确如何应对爆仓高峰、赔付仲裁。
4. 建立持续集成/交付流水线，确保每次变更都经过自动化测试与代码审查。

---

## 5. 专业化建议
1. **安全治理**  
   - 所有密钥、私钥、数据库凭据纳入统一的 Secret Store；部署环境强制读取，不落盘。
   - 赔付相关操作必须留存审计日志，确保可回溯；敏感操作需多因子或多签确认。
   - 定期进行渗透测试和合约审计，引入合规顾问评估保险业务的法律责任。

2. **技术规范**  
   - 建立代码风格与审查指南，关键微服务需具备覆盖核心逻辑的单元/集成测试。
   - 引入 API schema（OpenAPI/JSON Schema）、类型检查、静态分析工具（mypy、ruff 等）。
   - 对消息队列和数据库连接实现统一的重连、幂等控制，减少异常场景的分支。

3. **运营监控**  
   - 定义核心指标：日处理订单数、批量校验成功率、赔付处理时延、资金池余额、安全告警数量等。
   - 配置告警阈值，例如消息积压、服务 5xx 异常、Web3 连接失败等，确保及时响应。

4. **团队协作**  
   - 建立需求梳理 → 设计评审 → 开发 → 测试 → 上线的流程，关键迭代需伴随验收标准。
   - 为业务、风控、技术团队提供统一的文档库和知识库（Confluence/Notion）。
   - 建议创建运行手册和应急手册，覆盖爆仓高峰期的处理 SOP。

5. **未来扩展**  
   - 规划对多交易所（Binance、Bybit）与多链（BSC、Arbitrum）的支持，提前抽象数据层。
   - 考虑引入机器学习或规则引擎，提高风险预警准确度。
   - 与合规和法律团队协作，探索多区域上线策略（KYC/AML 要求、保险监管）。

---

## 6. 成功衡量指标（Milestones）
| 里程碑 | 指标 | 验收方式 |
| ------ | ---- | -------- |
| 安全整改完成 | 所有凭据来自 Secret Manager；审计日志覆盖 100% 核心操作 | 安全检查报告、自动化测试 |
| MVP 可运行 | 完整跑通订单验证→赔付→报告生成；平均处理时延 < 5 分钟 | 集成测试、灰度环境试跑 |
| 稳定版 | 队列延迟 < 30s；监控告警响应 < 10 分钟；无 P0 级事故 | 生产监控数据、事故复盘 |
| 扩展版 | 支持 2+ 交易所、资金池风控模型上线 | 功能验收、风控团队确认 |

---

## 7. 下一步行动建议
1. 组织一次安全紧急处理会议，按优先级分配责任人与完结时间。
2. 组建“平台基础”小组负责消息队列、配置、监控等共性能力，避免各服务重复造轮子。
3. 明确产品路线图和资源投入，确保阶段性目标（A/B/C/D）能够按季度执行。
4. 引入项目管理工具（如 Jira、Linear），将修复项转化为可跟踪的任务，建立迭代节奏。

---

通过上述规划，项目可从原型快速过渡到可控、安全、可持续迭代的服务平台，为高杠杆用户提供透明可信的保障体系。建议团队以安全整改为起点，建立跨团队协作机制，逐步实现商业化落地。***
