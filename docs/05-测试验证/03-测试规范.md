# LiqPass 对账与透明页打通规范（单一版）

- 结论：先赔付、每日一次锚定（03:30 UTC），按 UTC 自然日窗口聚合并公开 proofs。
- 产出：配置清单、接口清单、字段表、运行手册与运维要点。未知项留空或标“待补充”。

---

## 一、配置清单（配置+数据规范）

### 1) 链与地址
- 网络：Base Mainnet (8453)
- CheckoutUSDC：0x................................（全地址待补充；你给了 0xf9df…e3e7）
- TREASURY（金库/实时打款）：0x................................（待补充）
- ANCHOR_BOT（锚定签名地址）：0x................................（待补充）
- 锚定目标合约（EAS/LiqPass Anchor）：0x................................（待补充）
- 区块浏览器：https://basescan.org

### 2) 锚定节奏
- ANCHOR_CRON：03:30 UTC（建议）
- 窗口定义：UTC 自然日
  - windowStart：当日 00:00:00（UTC 秒）
  - windowEnd：当日 23:59:59（UTC 秒）
- 策略：先赔付、T+24h 在低 gas 时段锚定

### 3) 风控阈值
- dailyCapUSDC：50,000 USDC（建议；整数缩放=50,000,000,000）
- 单笔人工复核阈值：200 USDC（建议；≥阈值暂停自动打款，需二签）

### 4) 透明页域名与展示
- 透明页路由：/transparency
- 透明页域名或路径：https://................................（待补充；可与前端同域）
- 展示字段：`rootId, windowStart, windowEnd, leavesCount, sumPayout, metaHash, proofsURL`

### 5) 证据与证明发布位置
- proofsURL 根路径：https://................................（待补充；可为 CDN/S3/R2/同域静态）
- 文件清单：
  - proofs.json（全量叶与路径）
  - evidence.tar.gz（可选原始证据包）
- 目录建议：`/proofs/YYYY-MM-DD/proofs.json`（或 `/proofs/{windowStart}_{windowEnd}/proofs.json`）
- 文件保留期：≥180 天（建议 365 天）

### 6) policy 最小集（链上承诺）
- `sku: uint8`（1=24h定额；2=8h；3=月度回撤；4=无爆仓返现）
- `buyer: address`
- `startAt, endAt: uint40`（UTC 秒）
- `maxPayout: uint96`（USDC 6 位小数整数）
- `termsHash: bytes32`
- `policyId: bytes32` = `keccak256(buyer, sku, instIdHash, principal, leverage, startAt, endAt, salt)`

### 7) terms.json 规范（链下参数全集 → 链上只哈希）
- 规则：UTF‑8、固定键序、无多余空格；数值均为整数（USDC×10^6；leverage×10^2）
- 固定顺序：
  1. `version` (string)
  2. `exchange` (string)
  3. `instId` (string)
  4. `principal` (uint96, USDC 1e6)
  5. `leverage` (uint32, 放大1e2)
  6. `premium` (uint96, USDC 1e6)
  7. `payoutRule` (string)
  8. `windowStart` (uint40)
  9. `windowEnd` (uint40)
  10. `orderRefs` (string[])
  11. `nonce` (uint64)
  12. `salt` (bytes32)
- `termsHash = keccak256(bytes(canonicalJSONString))`

### 8) 叶子与证明格式（已付事实摘要）
- `LeafParams`（固定顺序）：
  - `leafId, policyId, buyer, token(USDC), amount, payoutTxHash, paidAt, eventType, eventId, instIdHash, sku, termsHash, windowStart, windowEnd`
- `leaf = keccak256(abi.encode(按上述固定顺序))`
- Merkle 路径：`siblings: bytes32[]`（每层严格 `left||right`，兄弟顺序依索引）
- 叶排序：`paidAt` 升序，同秒按 `payoutTxHash` 字典序
- 公布：数组项含 `{root, leaf, siblings, params}` 写入 `proofs.json`

### 9) 元信息 meta（随 root 上链的摘要）
- 字段：`windowStart, windowEnd, leavesCount, sumPayout, evidenceBundleHash, version`
- `evidenceBundleHash = keccak256`（对 proofs.json 或压缩包的文件字节）

### 10) 对账表与游标（链下数据库）
- `ClaimRecord{ claimId, policyId, buyer, amount, paidAt, payoutTxHash, anchored(bool), rootId? }`
- `AnchorWindow{ id, start, end, rootId, leavesCount, sumPayout, status }`
- `Cursor{ lastAnchoredPaidAt }`（首发建议全量回扫或设为最早未锚定的 `paidAt`）

### 11) 监控与告警
- 渠道：Telegram/Slack Webhook（待补充）
- 规则：锚定超时>24h+30m、锚定失败>3、`sumPayout` 异常、`dailyCap` 触发、透明页 5xx

### 12) 运营与法务文案
- SLA：采纳“赔付实时到账；证据将于 T+24h 的低 gas 时段上链锚定。”
- 纠错：如证据有误，将发布 `revoke(rootId)` 的更正说明

---

## 二、接口清单（透明页与证明发布）

### 1) 透明页 API（同域 `/api/v1/transparency` 建议）
- `GET /transparency/overview?range=7d|30d|all`
  - 响应：`{policiesSold,premiumUSDC,paidUSDC,lossRatio,activePolicies,treasuryBalance,requiredReserve?}`
- `GET /transparency/timeseries?range=7d|30d|all&interval=1d`
  - 响应：`[{date,premium,paid}]`
- `GET /transparency/distribution?range=7d|30d|all`
  - 响应：`{buckets:[{label,count,premium}]}`
- `GET /transparency/events?limit=20`
  - 响应：`[{ts_utc,type,amount_usdc,order_digest,tx_hash}]`
- `GET /transparency/audit`
  - 响应：`{contracts:[{name,address,chainId}],docHash(metaHash),evidenceRoots:[{label,merkleRoot}]}`

### 2) 静态证明发布（CDN/静态站）
- `GET {proofsURL}/{window}/proofs.json`
  - 结构：`{root, meta, leaves:[{leaf, params, siblings}]}`
- `GET {proofsURL}/{window}/evidence.tar.gz`（可选）

### 3) 证据链（单笔回溯）
- `GET /claims/{claimId}/evidence`
  - 摘要+`leafHash`+`merkleRoot`+`attestTx/payoutTx`+下载链接
- `GET /evidence/{id}/leaf.json`
- `GET /evidence/{id}/proof.json`
- `GET /evidence/{id}/raw.json`（脱敏，带 TTL）

---

## 三、字段表（最小必要集）

### 1) Policy（链上）
- `buyer: address`
- `sku: uint8`
- `startAt, endAt: uint40`
- `maxPayout: uint96`
- `termsHash: bytes32`
- `policyId: bytes32`

### 2) terms.json（链下，仅哈希上链）
- `version, exchange, instId, principal(1e6), leverage(1e2), premium(1e6), payoutRule, windowStart, windowEnd, orderRefs[], nonce, salt`

### 3) LeafParams（链下/对账）
- `leafId, policyId, buyer, token, amount, payoutTxHash, paidAt, eventType, eventId, instIdHash, sku, termsHash, windowStart, windowEnd`

### 4) Meta（锚定摘要）
- `windowStart, windowEnd, leavesCount, sumPayout, evidenceBundleHash, version`

### 5) Transparency Overview（前端展示）
- `policiesSold, premiumUSDC, paidUSDC, lossRatio, activePolicies, treasuryBalance, requiredReserve?`

### 6) Transparency Events（前端展示）
- `ts_utc, type(purchase|claim_paid|reserve_topup|reserve_withdraw), amount_usdc, order_digest, tx_hash`

---

## 四、运行手册（先赔付、每日一次锚定）

### A. 日内（实时）
- 到账即赔：执行打款，写 `ClaimRecord{amount,paidAt,payoutTxHash}`；累计 `sumPayout` ≤ `dailyCapUSDC`
- 风控：单笔≥人工阈值进入人工复核；记录原因与审批人

### B. 每日锚定（03:30 UTC）
- 取数：筛选 `Cursor.lastAnchoredPaidAt` 之后且 ≤ 昨日 `windowEnd` 的已付记录
- 生成：按固定顺序序列化 `LeafParams` → 计算 `leaf`；构建 Merkle 得 `root`
- 发布：写 `proofs.json` 至 `{proofsURL}/{window}/` 并计算 `evidenceBundleHash`
- 上链：`ANCHOR_BOT` 对 `{root, meta}` 做 `attest`（Base 8453）
- 落地：更新 `AnchorWindow` 与 `ClaimRecord.anchored`；推进 `Cursor.lastAnchoredPaidAt`
- 刷新透明页：更新 `overview/timeseries/distribution/events/audit` 缓存

### C. 异常与更正
- 自动重试：锚定失败 ≤3 次；仍失败报警
- 更正：发现错误发布 `revoke(rootId)` 公告；透明页“审计信息”标注 `supersededBy`

---

## 五、运维要点

- 账户与权限
  - `ANCHOR_BOT` 仅持有 attest 权限；`TREASURY` 控制实时打款；多签建议 2/3
- Cron 与时间
  - 服务器统一 UTC；Cron 守护在 03:30 UTC；容许 10 分钟抖动
- 存储与留存
  - `proofs.json` 与 evidence 包 CDN 冷存；保留 ≥180 天（建议 365 天）
- 监控
  - 健康：`/api/v1/health`；透明页 200 比例；锚定作业成功率；金库余额/所需准备金比

---

## 六、待补充项（请填入最终值）

- TREASURY: 0x................................
- ANCHOR_BOT: 0x................................
- CheckoutUSDC（全地址）: 0x................................
- 锚定目标合约（EAS/LiqPass Anchor）: 0x................................
- 透明页域名: https://................................
- proofsURL 根路径: https://................................
- 告警 Webhook: Telegram/Slack -> ............................

---

## 七、备注

- 前端透明页已就绪（/transparency），支持：`overview`、`timeseries`、`distribution`、`events`、`audit` 五类读接口；同域部署时 `API_BASE` 置空或指向 `/api`。
- Base 主网（chainId 0x2105）与 BaseScan 链接已在前端内置；tx/地址外链按 Base 主网展示。
- 本规范为“零代码执行手册”，按“配置 → 发布 proofs → 链上 attest → 透明页展示”的顺序落地即可。

