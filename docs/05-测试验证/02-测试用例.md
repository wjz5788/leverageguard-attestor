# 订单验证与赔付 · 字段设计与接口约定

面向 LiqPass US 项目，本文梳理“订单验证（exchange order verify）→ 赔付（claim）→ 赔付上链（on-chain payout）”流程涉及的核心数据字段与接口约定，供前后端与对账使用。

## 1. 总览

- 主体流程
  - 下单付款（已实现）：前端发起支付（USDC→金库），创建订单（paid/pending）。
  - 订单验证：对接交易所 API 或服务，拉取订单回显 + 一致性检查，生成可审计证据。
  - 赔付流程：验证可赔后，由用户或平台触发链上赔付交易，将 USDC 转至用户钱包。
  - 透明度/对账：将订单、验证与赔付记录聚合到透明度页与对账报表。

- 实体关系
  - Order（订单）1 — 0..1 VerifyResult（验证结果）
  - Order 1 — 0..n Claim（赔付申请）
  - Claim 1 — 0..1 PayoutTx（赔付上链交易）

## 2. 订单（Order）

- 关键字段（后端现有：`us-backend/src/services/orderService.ts`）
  - `id: string` 订单 ID（ord_UUID）
  - `skuId: string` SKU 标识（如 `sku_24h_liq`）
  - `principal: number` 本金（USDT 计）
  - `leverage: number` 杠杆
  - `wallet: string` 用户钱包地址（EVM）
  - `premiumUSDC: number` 保费（USDC 金额，2 位小数）
  - `payoutUSDC: number` 赔付上限（USDC）
  - `feeRatio: number` 保费比例（0-1，6 位小数）
  - `payoutRatio: number` 赔付比例（0-1，6 位小数）
  - `idempotencyKey: string` 幂等键（来自报价预览）
  - `paymentMethod: 'permit2' | 'approve_transfer'`
  - `paymentTx?: string` 上链支付交易哈希（USDC→金库）
  - `orderRef?: string` 交易所订单号（可选）
  - `exchange?: string` 交易所（OKX/Hyperliquid/Binance...）
  - `pair?: string` 合约/交易对
  - `status: 'pending' | 'paid'`
  - `createdAt: string` ISO 时间
  - `updatedAt: string` ISO 时间

- 订单接口
  - 预览：`POST /api/v1/orders/preview`
    - 入参：`{ skuId, principal, leverage, wallet }`
    - 出参：`{ quote: { idempotencyKey, premiumUSDC, feeRatio, payoutUSDC, payoutRatio, expiresAt, quoteTtl, payment } }`
      - `payment: { chainId, usdcContract, spenderOrVault, methods }`
  - 创建：`POST /api/v1/orders`
    - 入参：`{ skuId, principal, leverage, wallet, premiumUSDC, idempotencyKey, paymentMethod, paymentTx?, orderRef?, exchange?, pair? }`
    - 出参：`{ ok, order, order.payment }`
  - 列表：`GET /api/v1/orders`
    - 出参：`{ ok, orders: Order[] }`

## 3. 订单验证（VerifyResult）

- 目标：证明订单状态与持仓/清算事实，形成“可审计证据”。
- 字段建议（参考 `OrderVerifier.tsx` 结果结构）
  - `orderId: string` 关联订单 ID
  - `exchange: string` 交易所
  - `instId: string` 合约/交易对（如 BTC-USDT-SWAP）
  - `ordId: string` 交易所订单号
  - `verifiedAt: string` 验证时间 ISO
  - `live: boolean` 是否实时查询
  - `fresh: boolean` 是否强制新鲜
  - `requestId: string` 请求 ID（可用于追踪）
  - `normalized: { order, position }` 统一映射后的关键字段
    - `order: { side, px, sz, state, avgFillPx, accFillSz, fee, ts }`
    - `position: { lever, mode, liqPx, adl, liquidated, liquidatedAt, reason }`
  - `checks: {` 一致性检查摘要 `}`（可选）
    - `authOk, capsOk, orderFound, echoLast4Ok, arithmeticOk, pairOk, timeSkewMs, verdict: 'pass' | 'fail'`
  - `evidence: {` 证据包 `}`
    - `leaves: Array<{ path, hash }>`
    - `root: string`、`rootAlgo: string`、`bundleHash: string`、`evidenceId: string`、`parentRoot?: string`
  - `perf: { okxRttMs, totalMs, cache, rateLimit: { remaining, resetSec } }`
  - `error?: { code, msg, hint }` 验证失败时

- 验证接口（示例）
  - `POST /api/v1/verify/okx`
    - 入参：`{ ordId, instId, live, fresh, noCache, keyMode, apiKey, secretKey, passphrase, uid? }`
    - 出参：`VerifyResult`（结构如上）

## 4. 赔付申请（Claim）

- 字段设计
  - `id: string` 赔付申请 ID（clm_xxx）
  - `orderId: string` 关联订单 ID
  - `userWallet: string` 用户钱包地址（接收赔付）
  - `eligible: boolean` 是否可赔
  - `payoutAmount: number` 赔付金额（USDC）
  - `currency: 'USDC'`
  - `evidence?: { type, time, pair }` 简要证据摘要
  - `verifyRef?: string` 关联验证结果 ID/evidenceId
  - `status: 'in_review' | 'approved' | 'paid' | 'rejected' | 'onchain_failed'`
  - `reason?: string` 拒绝/失败原因
  - `createdAt: string`、`updatedAt: string`

- 接口建议
  - 预备：`POST /api/v1/claims/prepare`
    - 入参：`{ orderId }`
    - 出参：`{ claimToken }`（防重放）
  - 验证：`POST /api/v1/claims/verify`
    - 入参：`{ orderId, orderRef, claimToken }`
    - 出参：`{ eligible, payout, currency, evidence, claimId, expiresAt }`
  - 列表：`GET /api/v1/claims?orderId=...`
  - 详情：`GET /api/v1/claims/:id`

## 5. 赔付上链（PayoutTx）

- 字段设计
  - `id: string` 交易记录 ID
  - `claimId: string` 关联赔付申请 ID
  - `orderId: string` 关联订单 ID
  - `chainId: string` 链 ID（如 Base 主网 `0x2105`）
  - `token: string` 代币合约（USDC）
  - `from: string` 支付账户（赔付金库/合约）
  - `to: string` 接收账户（用户钱包）
  - `amount: string` on-chain amount（最小单位，6 位精度）
  - `txHash: string` 交易哈希
  - `blockNumber?: string` 区块号
  - `gasUsed?: string`、`effectiveGasPrice?: string`
  - `status: 'pending' | 'confirmed' | 'failed'`
  - `createdAt: string`、`confirmedAt?: string`

- 接口建议
  - 发起（由前端钱包或平台金库发起）：
    - 前端钱包路径：用户以个人钱包签名/支付 gas，`POST /api/v1/claims/:id/payout` 提交 `txHash` 回执
    - 平台金库路径：后端签名并广播，返回 `txHash`
  - 回执上报：`POST /api/v1/payouts/report`（幂等）
    - 入参：`{ claimId, orderId, chainId, token, from, to, amount, txHash }`
  - 轮询确认：后端或前端按 `txHash` 轮询，更新 `status=confirmed/failed`

## 6. 事件日志（审计/对账）

为透明度页与对账使用，统一事件格式：

- `eventId: string`、`eventType: 'purchase' | 'claim_paid' | 'reserve_topup' | 'reserve_withdraw' | 'verify_pass' | 'verify_fail'`
- `ts: string` ISO 时间（UTC）
- `orderId?: string`、`claimId?: string`、`evidenceId?: string`
- `chainId?: string`、`txHash?: string`
- `amount_usdc?: number` 金额
- `meta?: Record<string, any>` 扩展信息（如 exchange、ordId、instId、leverage 等）

## 7. 前端展示映射（OrdersPage / ClaimsPage）

- OrdersPage（订单卡）
  - 显示：`principal`、`leverage`、`premiumUSDC→premiumPaid`、`payoutUSDC→payoutMax`、`status`、倒计时（24h SKU 以 `createdAt+24h` 估算覆盖期）
  - 交易外链：`paymentTx` → Basescan

- ClaimsPage（赔付）
  - 验证区：输入 `orderRef/instId` → 调用验证接口 → 显示 `eligible/payout/evidence`
  - 赔付区：勾选确认后触发上链，回填 `txHash` 与状态

## 8. 对接要点

- 金库地址：通过 `PaymentConfig.spenderOrVault` 配置，禁止使用占位地址（当前默认 `0x...dEaD` 仅用于开发演示）。
- 金额精度：USDC 6 位精度；接口层保留 2 位小数给展示，但上链需按最小单位编码。
- 幂等：
  - 报价 `idempotencyKey` 用于创建订单幂等。
  - 赔付上报 `txHash` + `claimId` 作为唯一键，保证重试安全。
- 透明度与对账：所有关键动作产生日志事件，供聚合渲染与离线对账。

---

如需，我可以补充 JSON Schema 或示例请求/响应样例，或提供数据库表结构建议（orders/verify_results/claims/payout_txs/events）。

