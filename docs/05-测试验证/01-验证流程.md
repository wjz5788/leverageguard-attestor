# 验证闭环自测包（最小可跑）

目标：用最小接口跑通“保存账号 → 发起验证请求 → 落库结果与证据 → 查询”的闭环，产生可回放样例。

## 1. 先决条件
- 后端已启动（包含迁移 001/002/003/004）
- Base URL: http://localhost:3000 或实际端口

## 2. 样例数据（已在 004_min_loop.sql 中注入）
- 用户：`user_demo`
- 账号：OKX-只读-1
- 请求：
  - pending: ord_id=2940071038556348417
  - success: ord_id=SIM_DONE_001（含 result 与 evidence）

## 3. 一键回放（HTTPie / curl）

### 3.1 列出账号
```bash
http :3000/api/v1/min/api-accounts user_id==user_demo
```

### 3.2 新建验证请求（pending）
```bash
http POST :3000/api/v1/min/verify-requests \
  user_id=user_demo account_id:=1 exchange=okx \
  ord_id=2940071038556348417 inst_id=BTC-USDT-SWAP live:=1 fresh:=1 no_cache:=0
```

### 3.3 写入结果与证据
```bash
http POST :3000/api/v1/min/verify-results \
  request_id:=1 \
  normalized_json:='{"orderId":"SIM_DONE_001","side":"buy","size":0.64,"price":35000,"filled":0.64,"status":"filled"}' \
  raw_json:='{"code":"0","data":[{"ordId":"SIM_DONE_001","accFillSz":"0.64","fillPx":"35000"}]}' \
  meta_json:='{"durationMs":182,"jpHost":"127.0.0.1:8082","cache":false}' \
  evidence:='{"root":"0xabc123...deadbeef","leaves":["0x..1","0x..2"],"algo":"keccak256"}'
```

### 3.4 查询请求列表
```bash
http :3000/api/v1/min/verify-requests user_id==user_demo
```

## 4. 证据哈希测试向量（占位）
- 规范：`keccak256(utf8(JSON.stringify(obj, sorted)))`
- 示例：
```json
{"leaves":["0x..1","0x..2"],"algo":"keccak256"}
```
- 期望 root：`0xabc123...deadbeef`（请用实际实现更新）

## 5. 订单最小自测（可选）
- 预览报价
```bash
http POST :3000/api/v1/orders/preview \
  skuId=sku_24h_liq principal:=200 leverage:=20 wallet=0xYourWallet...
```
- 创建订单（需链上支付后带 txHash）
```bash
http POST :3000/api/v1/orders \
  skuId=sku_24h_liq principal:=200 leverage:=20 wallet=0xYourWallet... \
  premiumUSDC:=3.2 idempotencyKey=ipm_xxx paymentMethod=approve_transfer paymentTx=0xHash
```

## 6. 回归标准
- verify-requests: 新建为 pending → 写入结果后转 success
- verify-results: 与 evidence-blobs 一一对应
- orders: 创建成功且列表可见；后续需加入链上回执校验

