# LiqPass 接口契约文档

## 概述

本文档定义了 LiqPass 系统中各组件之间的接口契约，包括前端、后端、验证服务之间的数据交换格式和协议。

## 1. 前端与后端接口

### 1.1 验证接口

**接口路径**: `/api/verify/okx`

**请求方法**: POST

**请求头**:
```
Content-Type: application/json
Authorization: Bearer {token}
```

**请求体**:
```json
{
  "apiKey": "string",
  "secret": "string",
  "passphrase": "string",
  "orderId": "string",
  "instrumentId": "string",
  "live": "boolean",
  "fresh": "boolean",
  "noCache": "boolean"
}
```

**响应体**:
```json
{
  "success": "boolean",
  "data": {
    "normalized": {
      "orderId": "string",
      "instrumentId": "string",
      "side": "string",
      "size": "number",
      "price": "number",
      "timestamp": "string",
      "liquidated": "boolean",
      "liquidationPrice": "number",
      "marginRatio": "number",
      "leverage": "number"
    },
    "raw": {
      "originalResponse": "object"
    },
    "evidence": {
      "evidenceId": "string",
      "timestamp": "string",
      "source": "string",
      "hash": "string"
    }
  },
  "error": {
    "code": "string",
    "message": "string",
    "details": "object"
  }
}
```

### 1.2 订单查询接口

**接口路径**: `/api/orders`

**请求方法**: GET

**查询参数**:
- `page`: 页码 (默认: 1)
- `limit`: 每页数量 (默认: 20)
- `status`: 订单状态 (可选)

**响应体**:
```json
{
  "success": "boolean",
  "data": {
    "orders": [
      {
        "id": "string",
        "orderId": "string",
        "instrumentId": "string",
        "status": "string",
        "createdAt": "string",
        "liquidated": "boolean"
      }
    ],
    "pagination": {
      "page": "number",
      "limit": "number",
      "total": "number",
      "pages": "number"
    }
  }
}
```

## 2. 后端与验证服务接口

### 2.1 验证服务调用接口

**服务地址**: `http://127.0.0.1:8082/api/verify` (本地开发)

**请求方法**: POST

**请求头**:
```
Content-Type: application/json
X-Service-Key: {service_key}
```

**请求体**:
```json
{
  "apiKey": "string",
  "secret": "string",
  "passphrase": "string",
  "orderId": "string",
  "instrumentId": "string",
  "live": "boolean"
}
```

**响应体**:
```json
{
  "success": "boolean",
  "normalized": {
    "orderId": "string",
    "instrumentId": "string",
    "side": "string",
    "size": "number",
    "price": "number",
    "timestamp": "string",
    "liquidated": "boolean",
    "liquidationPrice": "number",
    "marginRatio": "number",
    "leverage": "number"
  },
  "raw": {
    "originalResponse": "object"
  },
  "evidence": {
    "evidenceId": "string",
    "timestamp": "string",
    "source": "string",
    "hash": "string"
  }
}
```

## 3. 数据库接口契约

### 3.1 订单表 (orders)

```sql
CREATE TABLE orders (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  order_id TEXT UNIQUE NOT NULL,
  instrument_id TEXT NOT NULL,
  api_key TEXT NOT NULL,
  status TEXT NOT NULL DEFAULT 'pending',
  liquidated BOOLEAN NOT NULL DEFAULT FALSE,
  normalized_data TEXT NOT NULL,
  raw_data TEXT NOT NULL,
  evidence_id TEXT NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 3.2 API密钥表 (api_keys)

```sql
CREATE TABLE api_keys (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT NOT NULL,
  alias TEXT,
  api_key TEXT NOT NULL,
  secret TEXT NOT NULL,
  passphrase TEXT,
  key_mode TEXT NOT NULL DEFAULT 'inline',
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 3.3 赔付表 (claims)

```sql
CREATE TABLE claims (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  order_id TEXT NOT NULL,
  user_id TEXT NOT NULL,
  amount DECIMAL(18,8) NOT NULL,
  status TEXT NOT NULL DEFAULT 'pending',
  evidence_id TEXT NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  processed_at DATETIME
);
```

### 3.4 审计日志表 (audit_logs)

```sql
CREATE TABLE audit_logs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT NOT NULL,
  action TEXT NOT NULL,
  resource TEXT NOT NULL,
  details TEXT,
  ip_address TEXT,
  user_agent TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

## 4. 证据存储契约

### 4.1 证据文件结构

```
reports/evidence/
├── {YYYY-MM-DD}/
│   ├── {evidenceId}.json
│   ├── {evidenceId}.root
│   └── metadata.json
```

### 4.2 证据JSON格式

```json
{
  "evidenceId": "string",
  "orderId": "string",
  "instrumentId": "string",
  "timestamp": "string",
  "normalizedData": {
    "orderId": "string",
    "instrumentId": "string",
    "side": "string",
    "size": "number",
    "price": "number",
    "timestamp": "string",
    "liquidated": "boolean",
    "liquidationPrice": "number",
    "marginRatio": "number",
    "leverage": "number"
  },
  "rawData": {
    "originalResponse": "object"
  },
  "metadata": {
    "source": "string",
    "hash": "string",
    "signature": "string"
  }
}
```

## 5. 错误代码契约

### 5.1 通用错误代码

| 代码 | 描述 | HTTP状态码 |
|------|------|------------|
| 1001 | 认证失败 | 401 |
| 1002 | 权限不足 | 403 |
| 1003 | 资源不存在 | 404 |
| 1004 | 请求参数错误 | 400 |
| 1005 | 服务器内部错误 | 500 |

### 5.2 业务错误代码

| 代码 | 描述 | HTTP状态码 |
|------|------|------------|
| 2001 | 订单验证失败 | 400 |
| 2002 | API密钥无效 | 400 |
| 2003 | 验证服务不可用 | 503 |
| 2004 | 证据生成失败 | 500 |
| 2005 | 数据库操作失败 | 500 |

## 6. 性能指标契约

### 6.1 响应时间要求

- 前端API调用: < 5秒
- 验证服务调用: < 10秒
- 数据库查询: < 1秒

### 6.2 可用性要求

- 前端服务: 99.9%
- 后端API: 99.5%
- 验证服务: 99.0%

## 7. 安全契约

### 7.1 数据传输安全

- 所有API调用必须使用HTTPS
- 敏感数据必须加密传输
- API密钥必须安全存储

### 7.2 访问控制

- 实现基于角色的访问控制(RBAC)
- 所有敏感操作必须记录审计日志
- 实现请求频率限制

## 8. 版本控制

### 8.1 API版本

- 当前版本: v1
- 版本前缀: `/api/v1/`
- 向后兼容性: 至少维护2个主要版本

## 9. 监控与日志

### 9.1 日志格式

```json
{
  "timestamp": "string",
  "level": "string",
  "service": "string",
  "message": "string",
  "correlationId": "string",
  "userId": "string",
  "requestId": "string",
  "duration": "number",
  "statusCode": "number"
}
```

### 9.2 关键指标

- 请求成功率
- 响应时间分布
- 错误率
- 并发用户数

---

**文档版本**: v1.0  
**最后更新**: 2024-12-19  
**维护者**: LiqPass开发团队