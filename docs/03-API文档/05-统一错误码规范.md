# 统一错误码规范文档

## 概述

本文档统一前后端错误码，确保用户界面友好的错误提示，并提供清晰的API错误处理机制。

## 错误码表

| HTTP状态码 | 错误码 | 错误类型 | 前端Toast提示 | 用户操作建议 |
|-----------|--------|----------|---------------|-------------|
| 200 | OPERATION_PENDING | 异步处理中 | "确认中，请稍候..." | 等待系统处理完成 |
| 400 | VALIDATION_ERROR | 参数校验失败 | "字段不匹配，请检查输入" | 检查并修正输入参数 |
| 401 | UNAUTHORIZED | 认证失败 | "系统繁忙，请稍后再试" | 重新登录或检查凭据 |
| 409 | CONFLICT | 幂等冲突/重复请求 | "系统繁忙，请稍后再试" | 稍后重试或联系客服 |
| 422 | SEMANTIC_ERROR | 业务逻辑不通过 | "字段不匹配，请检查输入" | 根据业务规则调整请求 |
| 503 | SERVICE_UNAVAILABLE | 服务暂时不可用 | "系统繁忙，请稍后再试" | 等待服务恢复后重试 |
| 500 | INTERNAL_ERROR | 服务器内部错误 | "系统繁忙，请稍后再试" | 联系技术支持 |

## 前端Toast文案规范

### 最小提示三条
1. **字段不匹配，请检查输入** - 用于参数校验、业务规则验证
2. **确认中，请稍候...** - 用于异步处理、操作确认
3. **系统繁忙，请稍后再试** - 用于服务器错误、网络问题、限流等

### Toast组件规范
```javascript
// Toast类型映射
const TOAST_MESSAGES = {
  // 字段不匹配类错误
  'VALIDATION_ERROR': '字段不匹配，请检查输入',
  'SEMANTIC_ERROR': '字段不匹配，请检查输入',
  'PARAM_MISMATCH': '字段不匹配，请检查输入',
  
  // 确认处理类
  'OPERATION_PENDING': '确认中，请稍候...',
  'PROCESSING': '确认中，请稍候...',
  'CONFIRMING': '确认中，请稍候...',
  
  // 系统繁忙类
  'SERVICE_UNAVAILABLE': '系统繁忙，请稍后再试',
  'INTERNAL_ERROR': '系统繁忙，请稍后再试',
  'RATE_LIMITED': '系统繁忙，请稍后再试',
  'NETWORK_ERROR': '系统繁忙，请稍后再试'
};
```

## API错误响应格式

### 标准错误响应
```json
{
  "success": false,
  "error": {
    "code": "400_VALIDATION",
    "message": "参数校验失败",
    "details": {
      "field": "premiumUSDC_6d",
      "expected": "字符串形式的微USDC整数",
      "received": "0.01"
    }
  },
  "requestId": "req_20241219_123456_abc123"
}
```

### 业务错误响应示例
```json
{
  "success": false,
  "error": {
    "code": "422_SEMANTIC",
    "message": "金额超出允许范围",
    "details": {
      "field": "premiumUSDC_6d",
      "min": "10000",
      "max": "100000000",
      "received": "150000000"
    }
  }
}
```

### 异步处理响应
```json
{
  "success": true,
  "data": {
    "jobId": "job_20241219_123456_abc123",
    "status": "processing",
    "estimatedTime": 30
  },
  "message": "确认中，请稍候..."
}
```

## 错误处理最佳实践

### 前端错误处理
```javascript
// 统一错误处理
export const handleApiError = (error) => {
  const { code, message } = error;
  
  // Toast显示
  let toastMessage = '系统繁忙，请稍后再试';
  
  if (TOAST_MESSAGES[code]) {
    toastMessage = TOAST_MESSAGES[code];
  }
  
  showToast(toastMessage, getToastType(code));
  
  // 记录错误
  console.error('API Error:', error);
  logError(error);
};
```

### 后端错误处理
```typescript
// 错误码枚举
export enum ErrorCode {
  VALIDATION_ERROR = '400_VALIDATION',
  UNAUTHORIZED = '401_UNAUTHORIZED', 
  CONFLICT = '409_CONFLICT',
  SEMANTIC_ERROR = '422_SEMANTIC',
  SERVICE_UNAVAILABLE = '503_SERVICE_UNAVAILABLE',
  INTERNAL_ERROR = '500_INTERNAL'
}

// 统一错误响应
export const createErrorResponse = (
  code: ErrorCode,
  message: string,
  details?: any
) => ({
  success: false,
  error: {
    code,
    message,
    details
  }
});
```

## 日志与监控

### 错误日志格式
```json
{
  "timestamp": "2024-12-19T12:34:56Z",
  "level": "error",
  "message": "API调用失败",
  "requestId": "req_20241219_123456_abc123",
  "userId": "user_123",
  "endpoint": "/api/v1/verify",
  "errorCode": "400_VALIDATION",
  "responseTime": 150,
  "ip": "192.168.1.100"
}
```

### 监控指标
- 错误率按错误码分组
- 平均响应时间
- 用户操作失败率
- 高频错误码统计

## 版本兼容性

### 错误码版本控制
```yaml
# 错误码版本说明
v1.0:
  - 400: VALIDATION_ERROR
  - 401: UNAUTHORIZED
  - 422: SEMANTIC_ERROR

v1.1: 
  - 新增: 409_CONFLICT
  - 新增: 503_SERVICE_UNAVAILABLE
  - Toast文案统一
```

---

**文档版本**: v1.1  
**最后更新**: 2024-12-19  
**维护者**: LiqPass开发团队