# 美国-日本服务器交互架构文档

## 📋 文档概述

本文档详细描述了美国服务器（前端+后端）与日本服务器（后端）之间的交互架构、API接口、数据流和安全机制。

## 🏗️ 整体架构

### 架构模式
**直接调用模式**（当前实现）：
```
美国前端 → 直接调用 → 日本验证服务器(/verify/order)
```

**代理模式**（架构设计但未实现）：
```
美国前端 → 美国后端(/api/verify/order) → 日本验证服务器(/verify/order)
```

### 服务器配置

| 服务器 | 端口 | 环境变量 | 部署路径 |
|--------|------|----------|-----------|
| **美国前端** | 5173 | `VITE_US_BACKEND_BASE`, `VITE_JP_VERIFY_BASE` | `/srv/web/us` |
| **美国后端** | 8080 | `JP_VERIFY_BASE`, `SERVICE_TOKEN` | `/opt/liqpass/us-backend` |
| **日本验证服务器** | 8787 | `JP_PORT`, `VERIFY_MODE`, `OKX_BASE_URL`, `BINANCE_BASE_URL` | `/opt/liqpass/attestor` |

## 🔌 API接口规范

### 1. 验证订单接口

**接口路径：** `POST /verify/order`

**请求参数：**
```typescript
interface VerificationRequest {
  exchange: 'binance' | 'okx';      // 交易所类型
  pair: string;                      // 交易对
  orderRef: string;                  // 订单引用
  wallet: string;                    // 钱包地址
}
```

**响应格式：**
```typescript
interface VerificationResponse {
  status: 'ok' | 'fail';             // 验证状态
  exchange: string;                  // 交易所
  pair: string;                      // 交易对
  orderRef: string;                  // 订单引用
  wallet: string;                    // 钱包地址
  diagnostics: {                     // 诊断信息
    message: string;
    verifyMode: string;
    receivedAt: string;
  };
}
```

### 2. 健康检查接口

**接口路径：** `GET /healthz`

**响应格式：**
```typescript
interface HealthCheckResponse {
  status: 'ok';
  verifyMode: string;                // 验证模式
  okxBaseUrl: string;                // OKX基础URL
  binanceBaseUrl: string;           // Binance基础URL
  timestamp: string;                 // 时间戳
}
```

## 🔑 API密钥管理

### 交易所API密钥头格式

#### Binance交易所
```http
X-MBX-APIKEY: ${apiKey}
```

#### OKX交易所
```http
OK-ACCESS-KEY: ${apiKey}
OK-ACCESS-SIGN: ${signature}
OK-ACCESS-TIMESTAMP: ${timestamp}
OK-ACCESS-PASSPHRASE: ${passphrase}
```

### 密钥管理机制

1. **前端密钥存储：** React Context API管理
2. **传输安全：** HTTPS加密传输
3. **密钥轮换：** 支持动态密钥更新

## 📊 数据流与处理

### 验证流程

1. **前端发起验证：**
   - 用户输入订单信息
   - 选择交易所类型
   - 调用 `jpApiRequestWithKeys('/verify/order')`

2. **日本服务器处理：**
   - 接收验证请求
   - 调用交易所API验证订单
   - 返回验证结果

3. **前端结果展示：**
   - 解析验证响应
   - 显示验证状态和详细信息
   - 处理错误情况

### 错误处理机制

#### 前端错误处理
```typescript
class ApiError extends Error {
  readonly status: number;
  readonly body?: unknown;
  
  constructor(payload: ApiErrorPayload) {
    super(payload.message);
    this.name = 'ApiError';
    this.status = payload.status;
    this.body = payload.body;
  }
}
```

#### 日本服务器错误响应
```typescript
{
  status: 'fail',
  reason: 'Missing exchange, pair, orderRef, or wallet'
}
```

## 🔒 安全机制

### 1. CORS配置
```javascript
const corsOptions = {
  origin: '*',
  methods: ['GET', 'POST', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization', 'Idempotency-Key'],
  optionsSuccessStatus: 204,
  maxAge: 600,
};
```

### 2. 请求限制
- 请求体大小限制：512KB
- JSON解析深度限制
- 请求超时：8秒

### 3. 日志与监控
- 请求日志记录
- 错误日志追踪
- 性能监控指标

## 🛠️ 部署配置

### 环境变量配置

#### 美国前端 (.env)
```bash
VITE_US_BACKEND_BASE=/api/verify
VITE_JP_VERIFY_BASE=http://127.0.0.1:8787
```

#### 日本服务器 (.env)
```bash
JP_PORT=8787
VERIFY_MODE=real
OKX_BASE_URL=https://www.okx.com
BINANCE_BASE_URL=https://api.binance.com
```

### CI/CD流程

1. **代码检查：** ESLint + 构建测试
2. **部署验证：** 健康检查 + 版本验证
3. **回滚机制：** 版本回滚支持

## 📈 性能优化

### 1. 缓存策略
- 静态资源缓存
- API响应缓存
- 交易所数据缓存

### 2. 连接优化
- HTTP/2支持
- 连接复用
- 请求压缩

### 3. 负载均衡
- 多实例部署
- 健康检查机制
- 自动故障转移

## 🔍 监控与日志

### 关键指标
- API响应时间
- 错误率统计
- 并发连接数
- 内存使用率

### 日志级别
- ERROR: 系统错误
- WARN: 警告信息
- INFO: 业务日志
- DEBUG: 调试信息

## 🚨 故障排查

### 常见问题

1. **连接超时：** 检查网络连通性和防火墙设置
2. **API密钥错误：** 验证密钥格式和权限
3. **CORS错误：** 检查CORS配置和域名白名单
4. **数据格式错误：** 验证请求参数格式

### 排查工具
- 网络抓包工具
- 日志分析系统
- 性能监控平台

## 📋 附录

### 交易对白名单

#### OKX交易所
- `BTC-USDT-SWAP`
- `BTC-USDC-SWAP`

#### Binance交易所
- `BTCUSDT`
- `BTCUSDC`

### 版本历史

| 版本 | 日期 | 变更说明 |
|------|------|----------|
| 1.0 | 2024-01-01 | 初始版本，直接调用架构 |
| 1.1 | 2024-01-15 | 添加API密钥管理机制 |

### 相关文档

1. [部署配置文档](./部署配置文档.md)
2. [API接口规范](./API接口规范.md)
3. [安全策略文档](./安全策略文档.md)

---

**文档维护：** 技术团队  
**最后更新：** 2024-01-01  
**版本：** 1.0