# LiqPass 数据库表结构设计（订单/验证/赔付/上链）

本文依据前端交互与现有后端能力，沉淀订单购买→验证→赔付→上链的数据库设计规范，避免命名冲突并对齐现有迁移文件（001、002）。字段命名采用下划线风格（snake_case），时间统一为 UTC ISO 或数据库 `TIMESTAMP`。

注意：现有 `002_verify_schema.sql` 已存在名为 `orders` 的“验证记录表”。为避免冲突，本设计将“购买订单”表命名为 `purchase_orders`。

## 1. 命名与通用字段

- 命名规范
  - 表名：复数（如 `purchase_orders`, `claims`）
  - 主键：`id TEXT`（如 `ord_xxx`, `clm_xxx`, `tx_xxx`，或使用 ULID/UUID）
  - 时间：`created_at`, `updated_at`, `deleted_at`（软删除可选）
  - JSON：尽量只存“证据/快照”，结构化字段独立建列
- 枚举
  - 订单状态：`pending, paid, failed`（购买支付）
  - 赔付状态：`pending, in_review, approved, rejected, paid, onchain_failed`
  - 链上交易状态：`pending, confirmed, failed`
- 金额精度
  - 存储数值栏位使用 `DECIMAL(20,8)` 以覆盖汇总；上链金额另存最小单位（如 USDC 6 位）为 `TEXT` 或 `NUMERIC`

## 2. 购买订单（purchase_orders）

购买页面（Products/Payment）创建的“保单订单”，与验证系统 `orders` 区分。

```sql
CREATE TABLE IF NOT EXISTS purchase_orders (
  id TEXT PRIMARY KEY,                                 -- ord_xxx
  user_id TEXT NOT NULL,                               -- 归属用户
  sku_id TEXT NOT NULL,                                -- sku_24h_liq
  principal DECIMAL(20,8) NOT NULL,                    -- 本金（USDT计）
  leverage INTEGER NOT NULL,
  wallet TEXT NOT NULL,                                -- 用户钱包地址（EVM）
  premium_usdc DECIMAL(20,8) NOT NULL,                 -- 保费（2位小数展示，存8位以便对账）
  payout_usdc DECIMAL(20,8) NOT NULL,                  -- 赔付上限
  fee_ratio DECIMAL(20,8) NOT NULL,                    -- 0-1
  payout_ratio DECIMAL(20,8) NOT NULL,                 -- 0-1
  idempotency_key TEXT NOT NULL,                       -- 报价幂等键
  payment_method TEXT NOT NULL,                        -- permit2 / approve_transfer
  payment_tx TEXT NULL,                                -- 支付上链交易哈希（USDC→金库）
  status TEXT NOT NULL DEFAULT 'pending',              -- pending/paid/failed
  quote_expires_at TIMESTAMP NULL,
  coverage_start_at TIMESTAMP NULL,                    -- 可选，若需要覆盖期精确边界
  coverage_end_at TIMESTAMP NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE UNIQUE INDEX IF NOT EXISTS uniq_po_idem ON purchase_orders(idempotency_key);
CREATE INDEX IF NOT EXISTS idx_po_user ON purchase_orders(user_id, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_po_wallet ON purchase_orders(wallet);
CREATE INDEX IF NOT EXISTS idx_po_status ON purchase_orders(status);
```

映射前端字段
- Products.tsx: principal, leverage, feeRatio, payoutRatio, feeUSDC→premium_usdc, payoutUSDC→payout_usdc
- Payment.tsx: paymentTx → payment_tx，状态变更为 `paid`

## 3. 报价快照（order_quotes）可选

如需持久化报价（而非内存 Map）
```sql
CREATE TABLE IF NOT EXISTS order_quotes (
  idempotency_key TEXT PRIMARY KEY,
  sku_id TEXT NOT NULL,
  principal DECIMAL(20,8) NOT NULL,
  leverage INTEGER NOT NULL,
  fee_ratio DECIMAL(20,8) NOT NULL,
  payout_ratio DECIMAL(20,8) NOT NULL,
  premium_usdc DECIMAL(20,8) NOT NULL,
  payout_usdc DECIMAL(20,8) NOT NULL,
  wallet TEXT NOT NULL,
  consumed BOOLEAN NOT NULL DEFAULT 0,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  expires_at TIMESTAMP NOT NULL
);
CREATE INDEX IF NOT EXISTS idx_oq_wallet ON order_quotes(wallet, created_at DESC);
```

## 4. 订单支付记录（order_payments）

即使 `purchase_orders.payment_tx` 已记录，仍建议独立支付表，支持多支付尝试与对账。
```sql
CREATE TABLE IF NOT EXISTS order_payments (
  id TEXT PRIMARY KEY,                   -- pay_xxx
  order_id TEXT NOT NULL,
  chain_id TEXT NOT NULL,                -- 0x2105(Base)
  token TEXT NOT NULL,                   -- USDC 合约
  from_addr TEXT NOT NULL,               -- 用户地址
  to_addr TEXT NOT NULL,                 -- 金库/合约地址
  amount_min_unit TEXT NOT NULL,         -- 6位精度最小单位字符串
  amount_usdc DECIMAL(20,8) NOT NULL,    -- 便于报表
  tx_hash TEXT NOT NULL,
  status TEXT NOT NULL DEFAULT 'pending',-- pending/confirmed/failed
  block_number TEXT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  confirmed_at TIMESTAMP NULL,
  FOREIGN KEY (order_id) REFERENCES purchase_orders(id)
);
CREATE UNIQUE INDEX IF NOT EXISTS uniq_op_tx ON order_payments(tx_hash);
CREATE INDEX IF NOT EXISTS idx_op_order ON order_payments(order_id);
```

## 5. 订单验证结果（verify_results）

对应前端 `OrderVerifier` 与 `ApiSettings` 回显。避免与 `002` 的 `orders` 冲突，命名为 `verify_results`。
```sql
CREATE TABLE IF NOT EXISTS verify_results (
  id TEXT PRIMARY KEY,                   -- vrf_xxx
  order_id TEXT NULL,                    -- 可为空：有时先验证再下单
  user_id TEXT NOT NULL,
  exchange TEXT NOT NULL,
  ord_id TEXT NOT NULL,
  inst_id TEXT NOT NULL,
  normalized_json TEXT NULL,             -- 统一映射 {order,position}
  checks_json TEXT NULL,
  evidence_id TEXT NULL,
  evidence_json TEXT NULL,               -- {leaves,root,algo,bundleHash,...}
  perf_json TEXT NULL,
  verdict TEXT NULL,                     -- pass/fail
  error_json TEXT NULL,                  -- 验证失败详情
  verified_at TIMESTAMP NOT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
CREATE UNIQUE INDEX IF NOT EXISTS uniq_vr_ord ON verify_results(exchange, ord_id);
CREATE INDEX IF NOT EXISTS idx_vr_user ON verify_results(user_id, verified_at DESC);
```

## 6. 赔付申请（claims）

```sql
CREATE TABLE IF NOT EXISTS claims (
  id TEXT PRIMARY KEY,                   -- clm_xxx
  order_id TEXT NOT NULL,
  user_id TEXT NOT NULL,
  user_wallet TEXT NOT NULL,
  eligible BOOLEAN NOT NULL DEFAULT 0,
  payout_amount DECIMAL(20,8) NULL,
  currency TEXT NOT NULL DEFAULT 'USDC',
  verify_ref TEXT NULL,                  -- 关联 evidence_id/verify_results.id
  status TEXT NOT NULL DEFAULT 'pending',-- pending/in_review/approved/rejected/paid/onchain_failed
  reason TEXT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  decided_at TIMESTAMP NULL,
  FOREIGN KEY (order_id) REFERENCES purchase_orders(id)
);
CREATE INDEX IF NOT EXISTS idx_claims_user ON claims(user_id, status);
CREATE INDEX IF NOT EXISTS idx_claims_order ON claims(order_id);
```

## 7. 赔付上链（payout_txs）

```sql
CREATE TABLE IF NOT EXISTS payout_txs (
  id TEXT PRIMARY KEY,                   -- ptx_xxx
  claim_id TEXT NOT NULL,
  order_id TEXT NOT NULL,
  chain_id TEXT NOT NULL,
  token TEXT NOT NULL,
  from_addr TEXT NOT NULL,               -- 金库/合约
  to_addr TEXT NOT NULL,                 -- 用户
  amount_min_unit TEXT NOT NULL,
  amount_usdc DECIMAL(20,8) NOT NULL,
  tx_hash TEXT NOT NULL,
  status TEXT NOT NULL DEFAULT 'pending',-- pending/confirmed/failed
  block_number TEXT NULL,
  gas_used TEXT NULL,
  effective_gas_price TEXT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  confirmed_at TIMESTAMP NULL,
  FOREIGN KEY (claim_id) REFERENCES claims(id),
  FOREIGN KEY (order_id) REFERENCES purchase_orders(id)
);
CREATE UNIQUE INDEX IF NOT EXISTS uniq_ptx_tx ON payout_txs(tx_hash);
CREATE INDEX IF NOT EXISTS idx_ptx_claim ON payout_txs(claim_id);
```

## 8. 审计/对账事件（audit_events）

统一事件流，供透明度页与离线对账。
```sql
CREATE TABLE IF NOT EXISTS audit_events (
  id TEXT PRIMARY KEY,                    -- evt_xxx
  event_type TEXT NOT NULL,               -- purchase/claim_paid/reserve_topup/verify_pass/verify_fail...
  ts TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  order_id TEXT NULL,
  claim_id TEXT NULL,
  evidence_id TEXT NULL,
  chain_id TEXT NULL,
  tx_hash TEXT NULL,
  amount_usdc DECIMAL(20,8) NULL,
  meta_json TEXT NOT NULL DEFAULT '{}'
);
CREATE INDEX IF NOT EXISTS idx_evt_type_ts ON audit_events(event_type, ts DESC);
```

## 9. 复用/对齐现有表

- 已有 `payment_links`（001）：保持不变，面向链接创建与管理
- 已有 `exchange_accounts/*` 与 `exchange_account_verifications/*`（001）：与 `verify_results` 互补
- 已有 `002` 中 `orders/claims/audit_logs`：若继续沿用，可迁移命名或仅保留为验证侧历史库

## 10. 与前端/接口的映射要点

- 下单（Products → POST /api/v1/orders/preview → POST /api/v1/orders）
  - 将 `purchase_orders` 作为主记录，`order_payments` 记录付款流水；成功则 `status=paid`
- 列表（OrdersPage → GET /api/v1/orders）
  - 返回 `purchase_orders` 并附 `payment_tx`；前端用以跳转 Basescan
- 验证（OrderVerifier/ApiSettings → POST /api/v1/verify/...）
  - 结果入 `verify_results`；必要时通过 `ord_id/inst_id` 与 `purchase_orders` 绑定
- 赔付（ClaimsPage）
  - `claims` 记录审核与状态，`payout_txs` 记录链上支付；完成后写入 `audit_events`

---

需要我把以上 DDL 拆分为增量迁移（003_purchase_orders.sql 等）并补充示例查询与视图（如透明度聚合 `daily_kpis`）吗？

