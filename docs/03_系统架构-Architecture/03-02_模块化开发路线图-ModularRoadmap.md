# LeverageGuard 模块化开发路线图

本文对现有架构进行分模块梳理，明确哪些通用能力可以提前开发、哪些业务模块应顺序推进，并对每个模块的交付内容、依赖关系与验证手段给出专业建议，便于团队按阶段迭代。

---

## 1. 模块分层总览
| 层级 | 模块 | 职责 | 依赖 |
| ---- | ---- | ---- | ---- |
| **基础设施层** | 配置中心、日志体系、消息队列 SDK、数据库接入、密钥管理/认证、观察性 (metrics/tracing) | 为所有微服务提供统一运行时支撑 | 需先行完成 |
| **平台服务层** | API 网关、订单验证服务、赔付服务、资金管理、风险评估、报告生成、用户管理、智能合约服务 | 面向业务的核心服务 | 依赖基础设施层 |
| **业务增强层** | 数据可视化、风控模型、AI 预测、外部系统适配、运营工具 | 增强用户体验与运营效率 | 依赖平台服务层 |

---

## 2. 通用基础模块（可提前开发、可独立测试）

### 2.1 配置与密钥管理 (`microservices/common/config_manager.py`)
- **交付内容**：统一加载优先级（环境变量 > Secret Manager > 配置文件）、热更新能力、Schema 校验、配置快照。
- **可提前开发原因**：与具体业务无耦合，提供参数约束，后续服务只需声明依赖。
- **验证方式**：单元测试覆盖多种配置源；引入 `pydantic`/`jsonschema` 校验；在 CI 中用 mock 配置确保不读真实密钥。

### 2.2 日志与审计体系 (`microservices/common/logger.py`, `logging_system.py`)
- **交付内容**：结构化日志、日志级别动态调整、审计日志接口、追踪 ID 注入、日志切分策略。
- **可提前开发原因**：所有服务需要统一输出格式，有利于监控与合规。
- **依赖**：配置管理；无业务依赖。
- **验证方式**：构建日志模拟器，确保并发写入、安全红线事件可追踪；为审计方法提供契约测试。

### 2.3 消息队列 SDK (`microservices/common/message_queue.py`)
- **交付内容**：连接池、发布/消费封装、幂等与重试、死信队列策略、健康检查接口。
- **可提前开发原因**：所有服务需要与 RabbitMQ 交互，先行完成后其余服务可专注业务逻辑。
- **验证方式**：利用 docker-compose 启动 RabbitMQ，编写集成测试覆盖发布、消费、死信、重连路径。

### 2.4 数据库与缓存访问层 (`microservices/common/database.py`, `microservices/common/cache.py`)
- **交付内容**：SQLAlchemy 会话管理、事务封装、连接池监控、Redis 分布式锁/缓存策略。
- **可提前开发原因**：后续资金、用户、报告等服务均需持久化。
- **验证方式**：单元+集成测试覆盖连接失败、事务回滚、读写分离（如有）；提供本地 docker 数据库镜像用于 CI。

### 2.5 身份与鉴权 (`microservices/common/authentication.py`)
- **交付内容**：JWT/Token 校验、角色与权限模型、内外部接口隔离、密钥轮换。
- **可提前开发原因**：API 网关、管理后台均需统一身份层。
- **验证方式**：安全测试覆盖 token 伪造、过期、权限越权；提供 Mock 身份服务供其他模块开发。

### 2.6 观察性组件
- **交付内容**：Prometheus 指标导出、结构化 tracing (OpenTelemetry)、集中化日志收集规范。
- **可提前开发原因**：后续所有服务可直接埋点；减少重复改造。
- **验证方式**：部署本地 Prometheus/Grafana，编写 smoke test 确保指标存在；Tracing 通过 Jaeger/Tempo 验证链路。

> 以上通用模块建议在“阶段 A 安全兜底”期间同步完成，可由基础架构小组独立推进，并为业务团队提供 Mock/SDK 包，确保后续服务开发不被阻塞。

---

## 3. 平台服务模块（需按依赖顺序推进）

### 3.1 API 网关 (`microservices/api_gateway`)
- **职责**：统一入口、认证、限流、路由、审计。
- **依赖**：配置管理、日志、鉴权、消息队列健康检查。
- **开发顺序**：基础设施完成后第一时间搭建，确保后续服务均能在统一入口下对接。
- **关键任务**：
  1. 定义服务发现配置（静态/服务注册表）。
  2. 实现请求签名/鉴权、速率限制、熔断策略。
  3. 集成审计日志，确保请求全链路可追踪。
  4. 编写集成测试模拟常见路由与异常场景。

### 3.2 订单验证服务 (`microservices/order_verification`)
- **职责**：调用交易所 API、验证签名、评估风险、生成验证结果。
- **依赖**：消息队列 SDK、配置、日志、数据库、外部 API 客户端。
- **开发顺序**：与赔付服务共同构成核心链路，应在网关之后优先实现。
- **关键任务**：
  - 抽象交易所适配器（OKX、Binance 等），统一字段映射。
  - 提供同步/异步两类接口，支持批量校验。
  - 设计验证结果的持久化 schema，为报告与赔付提供数据源。
  - 实现风险规则引擎（阈值、白名单、人工复核机制）。

### 3.3 赔付处理服务 (`microservices/payout_processing`)
- **职责**：校验赔付请求、计算金额、调用智能合约/资金池。
- **依赖**：订单验证结果、消息队列、Web3 接口、资金管理策略。
- **开发顺序**：完成订单验证后立即推进，以打通“验证→赔付”的核心业务闭环。
- **关键任务**：
  - 状态机设计（pending/processing/completed/failed）。
  - 幂等与重试机制，实现链上事务回滚兜底。
  - 审计日志与资金对账（关联资金管理服务）。
  - 引入补偿逻辑（人工审批、争议处理入口）。

### 3.4 资金管理服务 (`microservices/fund_management`)
- **职责**：资金池余额管理、资产调度、费用结算、对账。
- **依赖**：数据库、消息队列、支付/托管接口、风险评估。
- **开发顺序**：在核心赔付流程稳定后开展（阶段 B 后期或阶段 C 初期），为真实资金落地做准备。
- **关键任务**：
  - 设计资产科目、资金流水、估值、敞口指标。
  - 引入多签或托管方接口，确保安全合规。
  - 提供自动/手动调度策略，与风险服务联动。
  - 构建对账与报表输出机制。

### 3.5 风险评估服务 (`microservices/risk_assessment`)
- **职责**：实时风险评分、市场波动监测、预警触发。
- **依赖**：市场数据源、订单验证/资金管理数据、消息队列。
- **开发顺序**：在核心环节跑通后同步迭代，可并行于资金管理。
- **关键任务**：
  - 建立风险模型权重，支持动态调整。
  - 维护用户画像与历史数据缓存。
  - 与消息队列整合，实现自动预警、限额。
  - 输出可视化指标供运营/风控团队使用。

### 3.6 报告生成服务 (`microservices/report_generation`)
- **职责**：生成月/周/日度报表、合规文件、数据导出。
- **依赖**：订单验证、赔付、资金、风险数据。
- **开发顺序**：待核心数据稳定后开展，建议阶段 C。
- **关键任务**：
  - 设计数据建模层（DataMart），支持多维度查询。
  - 输出 PDF/CSV/BI API 等多格式报表。
  - 与可视化前端或运营后台联动。

### 3.7 用户管理服务 (`microservices/user_management`)
- **职责**：账户、认证、KYC、套餐/权益管理。
- **依赖**：数据库、鉴权、资金管理。
- **开发顺序**：若 MVP 面向内部运营，可延后至阶段 C；若需开放用户自助入口，应提前规划。
- **关键任务**：
  - 用户生命周期管理（注册、KYC、权限、账户状态）。
  - 与订单验证、赔付服务联动，实现用户级别的额度与风险策略。
  - 审计与隐私合规（GDPR、数据脱敏）。

### 3.8 智能合约服务 (`microservices/smart_contract_service`)
- **职责**：抽象链上交互、提供统一合约调用接口、管理私钥使用。
- **依赖**：配置、密钥管理、Web3、资金管理策略。
- **开发顺序**：若赔付暂为模拟，可延后；准备真实链上操作时必须完成。
- **关键任务**：
  - 提供合约 ABI 管理、网络切换、Gas 估算。
  - 引入私钥托管或硬件签名方案，多签流程。
  - 对接安全审计结果，实现版本控制。

---

## 4. 业务增强模块（可并行推进，根据资源安排）

### 4.1 数据可视化服务
- **职责**：运营看板、风控仪表盘、实时告警展示。
- **依赖**：报告服务、风险服务的 API；可使用 Grafana/Metabase 等工具。
- **开发建议**：在基础数据接口稳定后迅速搭建，辅助运营决策。

### 4.2 AI 风控与预测
- **职责**：使用机器学习对用户行为、市场数据进行预测，提高预警准确度。
- **依赖**：历史数据仓库、风险评估模块输出。
- **开发建议**：作为阶段 D 及以后拓展项目，需要数据科学团队与风控团队协作。

### 4.3 外部系统适配/合作方接口
- **职责**：对接交易所、KYC 服务、支付通道、第三方风控等。
- **依赖**：API 网关、用户管理、资金管理。
- **开发建议**：根据合作节奏滚动规划，抽象统一 Adapter 层，减少硬编码。

---

## 5. 开发节奏建议

### 阶段 0：基础保障（并行完成）
1. 完成通用基础模块（配置、日志、MQ、DB、鉴权、观察性）。
2. 搭建 CI 流水线：lint、单测、集成测试、密钥扫描。
3. 提供基础设施开发文档（环境准备、依赖说明）。

### 阶段 1：核心闭环（顺序推进）
1. API 网关 → 订单验证 → 赔付服务打通消息链路。
2. 引入 Mock/Stub 保证在真实交易所或链上不可用时仍可开发。
3. 发布 MVP 版本，验证核心业务流程。

### 阶段 2：资金与风险深化
1. 完成资金管理、风险评估模块，上线实时监控与策略。
2. 对接真实链上合约，实盘小规模演练。
3. 扩展报告服务，为运营/合规提供数据支持。

### 阶段 3：商业化扩展
1. 完善用户管理、外部合作接口。
2. 搭建数据可视化、运营工具，支持大规模用户使用。
3. 探索 AI 风控、预测模型，为产品升级做准备。

---

## 6. 依赖管理与合规建议
- 在每个模块启动之前完成“依赖清单”评审，避免跨服务循环依赖。
- 为共用模块建立版本化机制（如内部 PyPI/NPM 私仓），发布后再由业务服务升级。
- 制定变更管理流程：共性模块改动必须伴随影响评估与回归测试。
- 安全与合规优先级：基础设施完成后立即安排第三方安全评估；链上操作上线前需完成审计与法律评估。

---

## 7. 验收与里程碑
| 里程碑 | 关键检查项 | 验收标准 |
| ------ | ---------- | -------- |
| 通用基础模块完成 | SDK/工具库可独立测试，文档完备 | CI 通过 + Mock 集成环境 |
| 核心闭环上线 | API 网关 → 订单验证 → 赔付全链路；监控上线 | 端到端测试、试点用户反馈 |
| 资金与风险上线 | 资金池管理、风险预警稳定运行 | 运营日报、无重大风控漏报 |
| 商业化扩展 | 用户自助入口、可视化、合作接口可用 | SLA 达标、合规审计通过 |

---

通过上述模块化规划，可以在保证安全与合规的前提下，实现高效、分阶段的迭代。建议先由基础架构团队快速交付通用能力，再由业务小组按照依赖顺序推进核心流程、资金风控与商业化扩展，各阶段均需配套测试与监控，确保上线质量。***
