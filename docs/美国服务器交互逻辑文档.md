# ç¾å›½æœåŠ¡å™¨äº¤äº’é€»è¾‘æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº†ç¾å›½æœåŠ¡å™¨å†…éƒ¨å‰ç«¯ä¸åç«¯ä¹‹é—´çš„äº¤äº’é€»è¾‘ï¼ŒåŒ…æ‹¬è®¢å•åˆ›å»ºã€éªŒè¯ã€ç†èµ”ç­‰æ ¸å¿ƒä¸šåŠ¡æµç¨‹çš„å®ç°ç»†èŠ‚ã€‚

## ğŸ—ï¸ æ•´ä½“æ¶æ„

### æ¶æ„æ¨¡å¼
**å‰åç«¯åˆ†ç¦»æ¶æ„**ï¼š
```
ç¾å›½å‰ç«¯ (React + TypeScript) â†’ ç¾å›½åç«¯ (Node.js + Express)
```

### æœåŠ¡å™¨é…ç½®

| ç»„ä»¶ | ç«¯å£ | æŠ€æœ¯æ ˆ | ä¸»è¦åŠŸèƒ½ |
|------|------|--------|----------|
| **ç¾å›½å‰ç«¯** | 5173 | React, TypeScript, TailwindCSS | ç”¨æˆ·ç•Œé¢ã€è®¢å•åˆ›å»ºã€éªŒè¯æäº¤ |
| **ç¾å›½åç«¯** | 8080 | Node.js, Express, SQLite | APIæœåŠ¡ã€è®¢å•ç®¡ç†ã€ç†èµ”å¤„ç† |

## ğŸ”Œ APIæ¥å£è§„èŒƒ

### 1. å¥åº·æ£€æŸ¥æ¥å£

**æ¥å£è·¯å¾„ï¼š** `GET /healthz`

**å“åº”æ ¼å¼ï¼š**
```json
{
  "status": "ok",
  "payoutMode": "simulate",
  "defaultPayoutAddress": "0x00195EcF4FF21aB985b13FC741Cdf276C71D88A1",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

### 2. äº§å“ç›®å½•æ¥å£

**æ¥å£è·¯å¾„ï¼š** `GET /catalog/skus`

**å“åº”æ ¼å¼ï¼š**
```json
[
  {
    "id": "DAY_24H_FIXED",
    "title": "DAY_24H_FIXED",
    "premium": 5000,
    "payout": 100000,
    "exchange": "binance"
  },
  {
    "id": "DAY_24H_OKX",
    "title": "DAY_24H_OKX",
    "premium": 4000,
    "payout": 80000,
    "exchange": "okx"
  }
]
```

### 3. è®¢å•åˆ›å»ºæ¥å£

**æ¥å£è·¯å¾„ï¼š** `POST /orders`

**è¯·æ±‚å¤´ï¼š**
```
Idempotency-Key: <å”¯ä¸€å¹‚ç­‰é”®>
Content-Type: application/json
```

**è¯·æ±‚å‚æ•°ï¼š**
```typescript
interface CreateOrderRequest {
  skuId: string;           // äº§å“SKU ID
  exchange: string;        // äº¤æ˜“æ‰€
  pair: string;           // äº¤æ˜“å¯¹
  orderRef: string;       // è®¢å•å¼•ç”¨
  wallet: string;         // é’±åŒ…åœ°å€
  premium: number;        // ä¿è´¹ï¼ˆåˆ†ï¼‰
  payout: number;         // èµ”ä»˜é‡‘é¢ï¼ˆåˆ†ï¼‰
  paymentMethod: string;  // æ”¯ä»˜æ–¹å¼
}
```

**å“åº”æ ¼å¼ï¼š**
```json
{
  "orderId": "uuid",
  "status": "created",
  "createdAt": "2024-01-01T00:00:00.000Z"
}
```

### 4. è®¢å•å†å²æŸ¥è¯¢æ¥å£

**æ¥å£è·¯å¾„ï¼š** `GET /orders/history?wallet=<é’±åŒ…åœ°å€>`

**å“åº”æ ¼å¼ï¼š**
```json
[
  {
    "id": "uuid",
    "wallet": "0x...",
    "skuId": "DAY_24H_FIXED",
    "exchange": "binance",
    "pair": "BTCUSDT",
    "orderRef": "è®¢å•å·",
    "premium": 5000,
    "payout": 100000,
    "status": "created",
    "createdAt": "2024-01-01T00:00:00.000Z"
  }
]
```

### 5. ç†èµ”æäº¤æ¥å£

**æ¥å£è·¯å¾„ï¼š** `POST /claim`

**è¯·æ±‚å¤´ï¼š**
```
Idempotency-Key: <å”¯ä¸€å¹‚ç­‰é”®>
Content-Type: application/json
```

**è¯·æ±‚å‚æ•°ï¼š**
```typescript
interface SubmitClaimRequest {
  orderId: string;        // è®¢å•ID
  wallet: string;         // é’±åŒ…åœ°å€
  evidenceHash: string;   // è¯æ®å“ˆå¸Œ
  reason?: string;        // ç†èµ”åŸå› ï¼ˆé»˜è®¤ï¼šliquidationï¼‰
}
```

**å“åº”æ ¼å¼ï¼š**
```json
{
  "claimId": "uuid",
  "status": "received",
  "createdAt": "2024-01-01T00:00:00.000Z"
}
```

### 6. ç®¡ç†å‘˜èµ”ä»˜æ¥å£

**æ¥å£è·¯å¾„ï¼š** `POST /admin/payout`

**è¯·æ±‚å‚æ•°ï¼š**
```typescript
interface AdminPayoutRequest {
  claimId: string;        // ç†èµ”ID
}
```

**å“åº”æ ¼å¼ï¼š**
```json
{
  "message": "Payout transaction sent successfully",
  "claimId": "uuid",
  "recipient": "0x...",
  "amount": "1000000000",
  "transactionHash": "0x..."
}
```

## ğŸ”„ æ•°æ®æµå¤„ç†

### 1. è®¢å•åˆ›å»ºæµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant F as å‰ç«¯
    participant B as åç«¯
    participant DB as æ•°æ®åº“

    U->>F: é€‰æ‹©äº§å“å¹¶æäº¤è®¢å•
    F->>B: POST /orders (å¸¦å¹‚ç­‰é”®)
    B->>DB: æ£€æŸ¥å¹‚ç­‰æ€§è®°å½•
    alt å¹‚ç­‰è®°å½•å­˜åœ¨
        B->>F: è¿”å›ç¼“å­˜å“åº”
    else æ–°è¯·æ±‚
        B->>DB: ç”Ÿæˆè®¢å•IDå¹¶ä¿å­˜
        B->>F: è¿”å›è®¢å•åˆ›å»ºæˆåŠŸ
    end
    F->>U: æ˜¾ç¤ºè®¢å•åˆ›å»ºç»“æœ
```

### 2. ç†èµ”å¤„ç†æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant F as å‰ç«¯
    participant B as åç«¯
    participant DB as æ•°æ®åº“
    participant C as æ™ºèƒ½åˆçº¦

    U->>F: æäº¤ç†èµ”ç”³è¯·
    F->>B: POST /claim (å¸¦è¯æ®å“ˆå¸Œ)
    B->>DB: éªŒè¯è®¢å•å­˜åœ¨æ€§
    B->>DB: ä¿å­˜ç†èµ”è®°å½•
    B->>F: è¿”å›ç†èµ”æ¥æ”¶æˆåŠŸ
    F->>U: æ˜¾ç¤ºç†èµ”æäº¤ç»“æœ
    
    Note over B,C: ç®¡ç†å‘˜è§¦å‘èµ”ä»˜
    B->>DB: æŸ¥è¯¢ç†èµ”çŠ¶æ€
    B->>C: è°ƒç”¨æ™ºèƒ½åˆçº¦èµ”ä»˜
    C->>U: æ‰§è¡ŒUSDCè½¬è´¦
    B->>DB: æ›´æ–°ç†èµ”çŠ¶æ€ä¸ºpaid
```

## ğŸ”’ å®‰å…¨æœºåˆ¶

### 1. å¹‚ç­‰æ€§ä¿æŠ¤
- æ‰€æœ‰å†™æ“ä½œå¿…é¡»åŒ…å« `Idempotency-Key` è¯·æ±‚å¤´
- åç«¯åŸºäºå¹‚ç­‰é”®ç¼“å­˜è¯·æ±‚å“åº”
- é˜²æ­¢é‡å¤æäº¤å’Œé‡å¤å¤„ç†

### 2. CORSé…ç½®
```javascript
const corsOptions = {
  origin: ['http://localhost:5173'],
  methods: ['GET', 'POST', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization', 'Idempotency-Key'],
  credentials: true,
  optionsSuccessStatus: 204,
  maxAge: 600,
};
```

### 3. è¯·æ±‚éªŒè¯
- è¯·æ±‚ä½“å¤§å°é™åˆ¶ï¼š1MB
- JSONè§£ææ·±åº¦é™åˆ¶
- å¿…å¡«å­—æ®µéªŒè¯
- æ•°æ®ç±»å‹éªŒè¯

### 4. æ•°æ®åº“å®‰å…¨
- ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢é˜²æ­¢SQLæ³¨å…¥
- æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
- äº‹åŠ¡å¤„ç†ä¿è¯æ•°æ®ä¸€è‡´æ€§

## ğŸ’¾ æ•°æ®åº“è®¾è®¡

### è®¢å•è¡¨ (orders)
```sql
CREATE TABLE orders (
  id TEXT PRIMARY KEY,
  wallet TEXT NOT NULL,
  skuId TEXT NOT NULL,
  exchange TEXT NOT NULL,
  pair TEXT NOT NULL,
  orderRef TEXT NOT NULL,
  premium INTEGER NOT NULL,
  payout INTEGER NOT NULL,
  status TEXT NOT NULL,
  createdAt TEXT NOT NULL
);
```

### ç†èµ”è¡¨ (claims)
```sql
CREATE TABLE claims (
  id TEXT PRIMARY KEY,
  orderId TEXT NOT NULL,
  wallet TEXT NOT NULL,
  evidenceHash TEXT NOT NULL,
  reason TEXT NOT NULL,
  status TEXT NOT NULL,
  createdAt TEXT NOT NULL
);
```

### å¹‚ç­‰é”®è¡¨ (idempotency_keys)
```sql
CREATE TABLE idempotency_keys (
  key TEXT NOT NULL,
  route TEXT NOT NULL,
  reqHash TEXT NOT NULL,
  respJson TEXT NOT NULL,
  createdAt TEXT NOT NULL,
  PRIMARY KEY (key, route)
);
```

## ğŸ› ï¸ å‰ç«¯äº¤äº’å®ç°

### 1. APIå®¢æˆ·ç«¯é…ç½®

**æ–‡ä»¶ï¼š** `src/services/apiClient.ts`

```typescript
// åŸºç¡€APIé…ç½®
const DEFAULT_US_BASE = '/api/verify';
const DEFAULT_JP_BASE = 'http://127.0.0.1:8787';

// ç¯å¢ƒå˜é‡åŠ è½½
const US_API_BASE = import.meta.env.VITE_US_BACKEND_BASE || DEFAULT_US_BASE;
const JP_API_BASE = import.meta.env.VITE_JP_VERIFY_BASE || DEFAULT_JP_BASE;

// æ ¸å¿ƒè¯·æ±‚å‡½æ•°
async function apiRequest<T>(path: string, options?: RequestInit): Promise<T> {
  const url = resolvePath(US_API_BASE, path);
  const response = await fetch(url, {
    headers: {
      'Content-Type': 'application/json',
      ...options?.headers,
    },
    ...options,
  });
  
  return readResponseBody<T>(response);
}
```

### 2. éªŒè¯æœåŠ¡å®ç°

**æ–‡ä»¶ï¼š** `src/services/verify.ts`

```typescript
// è®¢å•éªŒè¯æäº¤
export async function submitVerification(
  request: VerificationRequest,
  apiKeys?: ExchangeApiKeys
): Promise<VerificationResponse> {
  const auth = getAuthState();
  const payload = {
    exchange: mapExchangeId(request.exchange),
    pair: request.pairId,
    orderRef: request.orderId,
    wallet: request.wallet,
  };

  const headers: Record<string, string> = {
    'Content-Type': 'application/json',
  };
  
  if (auth.token) {
    headers.Authorization = `Bearer ${auth.token}`;
  }

  // APIå¯†é’¥å¤„ç†
  if (apiKeys) {
    switch (request.exchange) {
      case 'Binance':
        if (apiKeys.binanceApiKey) {
          headers['X-MBX-APIKEY'] = apiKeys.binanceApiKey;
        }
        break;
      case 'OKX':
        if (apiKeys.okxApiKey) {
          headers['OK-ACCESS-KEY'] = apiKeys.okxApiKey;
          if (apiKeys.okxPassphrase) {
            headers['OK-ACCESS-PASSPHRASE'] = apiKeys.okxPassphrase;
          }
        }
        break;
    }
  }

  const raw = await jpApiRequestWithKeys<RawVerificationResponse>('/verify/order', {
    method: 'POST',
    headers,
    body: JSON.stringify(payload),
  });

  return normalizeVerificationResponse(raw, request);
}
```

### 3. äº§å“ç›®å½•æœåŠ¡

**æ–‡ä»¶ï¼š** `src/services/catalog.ts`

```typescript
// è·å–äº§å“åˆ—è¡¨
export async function getSkus(): Promise<Sku[]> {
  const response = await apiRequest<unknown>('/catalog/skus');
  
  if (Array.isArray(response)) {
    return response.map(normaliseSku).filter(item => Boolean(item.id));
  }
  
  // é»˜è®¤äº§å“åˆ—è¡¨
  return [
    {
      id: 'DAY_24H_FIXED',
      title: 'DAY_24H_FIXED',
      premium: 5000,
      payout: 100000,
      exchange: 'binance',
    }
  ];
}
```

## ğŸš€ éƒ¨ç½²é…ç½®

### ç¯å¢ƒå˜é‡é…ç½®

**å‰ç«¯ (.env)ï¼š**
```bash
VITE_US_BACKEND_BASE=/api/verify
VITE_JP_VERIFY_BASE=http://127.0.0.1:8787
```

**åç«¯ (.env.us)ï¼š**
```bash
US_PORT=8080
PAYOUT_MODE=simulate
DEFAULT_PAYOUT_ADDRESS=0x00195EcF4FF21aB985b13FC741Cdf276C71D88A1
LOG_PATH=./logs/us-backend.log
ALLOW_ORIGIN=http://localhost:5173
PAYOUT_PRIVATE_KEY=<ç§é’¥>
BASE_RPC_URL=https://mainnet.base.org
CONTRACT_ADDRESS=0x9552b58d323993f84d01e3744f175f47a9462f94
```

### å¯åŠ¨è„šæœ¬

**å‰ç«¯å¯åŠ¨ï¼š**
```bash
cd packages/us-frontend
npm run dev
```

**åç«¯å¯åŠ¨ï¼š**
```bash
cd packages/us-backend
node src/server.js
```

## ğŸ“Š ç›‘æ§ä¸æ—¥å¿—

### æ—¥å¿—æ ¼å¼
```json
{
  "ts": "2024-01-01T00:00:00.000Z",
  "level": "info",
  "reqId": "uuid",
  "route": "/orders",
  "wallet": "0x...",
  "orderId": "uuid",
  "claimId": "uuid",
  "skuId": "DAY_24H_FIXED",
  "idempoKey": "å¹‚ç­‰é”®",
  "httpStatus": 201,
  "latencyMs": 150,
  "msg": "order created"
}
```

### é”™è¯¯å¤„ç†
- ç»“æ„åŒ–é”™è¯¯å“åº”
- è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- é”™è¯¯ç åˆ†ç±»
- é”™è¯¯æ—¥å¿—è®°å½•

## ğŸ” å…³é”®å‘ç°ä¸å»ºè®®

### å½“å‰å®ç°çŠ¶æ€
1. âœ… **è®¢å•åˆ›å»ºæµç¨‹** - å®Œæ•´å®ç°ï¼ŒåŒ…å«å¹‚ç­‰æ€§ä¿æŠ¤
2. âœ… **ç†èµ”æäº¤æµç¨‹** - åŸºç¡€å®ç°ï¼Œæ”¯æŒè¯æ®å“ˆå¸Œ
3. âœ… **ç®¡ç†å‘˜èµ”ä»˜** - é›†æˆæ™ºèƒ½åˆçº¦è°ƒç”¨
4. âš ï¸ **éªŒè¯æµç¨‹** - ä¾èµ–æ—¥æœ¬æœåŠ¡å™¨ï¼Œå½“å‰ä¸ºå­˜æ ¹å®ç°
5. âš ï¸ **èº«ä»½éªŒè¯** - åŸºç¡€tokenæ”¯æŒï¼Œéœ€è¦å®Œå–„

### å»ºè®®ä¼˜åŒ–
1. **å®Œå–„éªŒè¯é€»è¾‘** - å®ç°å®Œæ•´çš„è®¢å•éªŒè¯æµç¨‹
2. **å¢å¼ºå®‰å…¨æ€§** - æ·»åŠ JWTè®¤è¯ã€è¯·æ±‚ç­¾å
3. **æ€§èƒ½ä¼˜åŒ–** - æ•°æ®åº“ç´¢å¼•ã€ç¼“å­˜ç­–ç•¥
4. **ç›‘æ§å‘Šè­¦** - æ·»åŠ å¥åº·æ£€æŸ¥å’Œå‘Šè­¦æœºåˆ¶

## ğŸ“ æ€»ç»“

ç¾å›½æœåŠ¡å™¨çš„äº¤äº’é€»è¾‘è®¾è®¡åˆç†ï¼Œé‡‡ç”¨äº†å‰åç«¯åˆ†ç¦»æ¶æ„ï¼Œå®ç°äº†æ ¸å¿ƒçš„ä¸šåŠ¡æµç¨‹ã€‚é€šè¿‡å¹‚ç­‰æ€§ä¿æŠ¤ã€æ•°æ®åº“äº‹åŠ¡ã€æ™ºèƒ½åˆçº¦é›†æˆç­‰æŠ€æœ¯æ‰‹æ®µï¼Œç¡®ä¿äº†ç³»ç»Ÿçš„å¯é æ€§å’Œå®‰å…¨æ€§ã€‚å»ºè®®åç»­é‡ç‚¹å®Œå–„éªŒè¯é€»è¾‘å’Œå¢å¼ºå®‰å…¨æœºåˆ¶ã€‚