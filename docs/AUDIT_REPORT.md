# LiqPass 架构与安全审计报告

**审计官：** Gemini (资深架构与安全审计官)
**日期：** 2025-11-04
**版本：** 1.0

---

## **Go/No-Go 结论：NO-GO**

**健康度评分: 55/100**
*   **功能 (20/40):** 核心流程存在数据一致性和完整性问题。
*   **安全 (15/40):** 存在多个 P0 级严重漏洞，包括密钥明文存储、权限控制缺失、核心服务暴露等，可能导致资金损失。
*   **运维 (20/20):** 运维层面问题多为 P1/P2，基础尚可，但缺乏自动化和监控。

**核心理由：** 审计发现 **2 个 P0 级（红线）风险**，根据上线门槛“任一 P0 存在即 NO-GO”的原则，**当前版本严禁上线**。必须在所有 P0 风险清零并完成至少一轮 P1 修复后，才能重新评估。

---

## 1. 上线红线（P0 风险列表）

以下是必须在上线前 100% 解决的致命风险：

| ID | 风险标题 | 领域 | 证据与说明 |
| :--- | :--- | :--- | :--- |
| **CON-001** | **合约缺少基于角色的访问控制** | `contracts` | **证据:** `contracts/LiqPass.sol` 中，`setPricingFormula` 等关键函数缺少 `onlyOwner` 或类似权限修饰符。<br>**风险:** 任何地址都可以调用这些函数，篡改合约的核心参数，可能导致资金被盗或系统瘫痪。 |
| **JPV-001** | **验证服务对公网完全开放** | `jp-verify` | **证据:** 缺少防火墙或反向代理配置。<br>**风险:** `jp-verify` 服务（端口 8082）可被任意 IP 访问，攻击者可直接探测、攻击该服务，或在 `us-backend` 防护被绕过时伪造验证结果。 |
| **USB-001** | **API 密钥在数据库中明文存储** | `us-backend` | **证据:** 数据库 schema 中 `api_keys.secret_key` 字段为 TEXT 类型。<br>**风险:** 一旦数据库被拖库，所有用户的 OKX API 密钥将完全泄露，攻击者可直接操作用户账户，造成不可挽回的资金损失。 |

---

## 2. 高优先修复路线图

建议按以下时间表推进，目标是在两周内达到可上线的安全基线。

### **第一周：D1-D3 (P0 风险清零)**

*   **目标：** 解决所有红线问题，消除直接资金风险。
*   **任务:**
    1.  **[CON-001]** 为所有合约特权函数添加 `onlyOwner` 修饰符。
    2.  **[USB-001]** 对数据库中的存量和增量 API 密钥进行加密存储（应急方案：AES 对称加密；长期方案：KMS）。
    3.  **[JPV-001]** 配置 JP 服务器防火墙，仅允许 `us-backend` 的 IP 地址访问 8082 端口。

### **第二周：D4-D7 (P1 核心强化)**

*   **目标：** 提升系统健壮性，防止数据不一致和滥用。
*   **任务:**
    1.  **[CON-002]** 修复合约中的 USDC approve 问题，防止额度滥用。
    2.  **[JPV-002]** 为 `jp-verify` 增加严格的 nonce 和时间戳校验，防止重放攻击。
    3.  **[USB-002]** 为 `us-backend` 的创建订单接口实现幂等性保护。
    4.  **[EVI-001]** 在证据结构中补充 `orderFingerprint` 和 `merkleRoot`，确保证据链完整性。
    5.  **[OPS-001]** 部署基础的服务器资源告警（磁盘、内存）。

### **上线观察期：D8-D14 (P2 体验与监控)**

*   **目标：** 优化用户体验，完善监控和合规性。
*   **任务:**
    1.  **[CON-003]** 为合约事件添加索引，提升查询效率。
    2.  **[USF-001]** 修复前端 API Key 的显示问题，保护用户隐私。
    3.  **[CMP-001]** 全面审查并替换产品文案中的高风险法律词汇。

---

## 3. 批量上链策略建议

根据业务需求和成本效益分析，推荐采用 **T-批量窗口** 策略。

**决策卡:**
*   **推荐窗口时间 (T):** **60 秒**。
    *   *理由:* 在用户体验（等待时间）和 Gas 成本之间取得了良好平衡。30 秒过于频繁，300 秒则可能让用户感觉延迟过长。
*   **聚合阈值 (N):** **10 笔订单**。
    *   *理由:* 当交易量较大时，达到 10 笔订单即触发上链，可以进一步提高 Gas 利用效率。窗口时间和聚合阈值构成“或”关系（whichever comes first）。
*   **降级策略:** **窗口失败 → 即时上链**。
    *   *理由:* 如果批量上链任务因 Gas 波动或节点问题失败，系统应自动降级为单笔“即时上链”模式进行重试，确保关键的购买记录不错过。失败的批量任务应触发 P1 级告警。
*   **用户态说明文案:**
    > “您的购买请求已提交，正在等待网络确认。通常需要 1-2 分钟，您可以在‘我的订单’页面查看最新状态。”

---

## 4. 风控与透明度改进点

为了提升用户信任和系统安全性，建议进行以下对用户可见的改进：

1.  **API 密钥安全指引:**
    *   在用户输入 API Key 的地方，明确提示“LiqPass 只会临时使用您的密钥进行订单验证，绝不会永久存储明文密钥”，并链接到一篇详细的安全说明文档。
2.  **费用明细:**
    *   在支付页面，清晰地列出“服务费 (Op Fee)”和“网络费 (Gas Load)”，让用户了解费用的构成。
3.  **赔付模拟器:**
    *   提供一个简单的计算器，让用户可以输入杠杆、保证金等参数，模拟在不同市场条件下可能获得的赔付金额，增加产品透明度。
4.  **透明度页面增强:**
    *   在现有的“证据”页面基础上，增加“系统状态”模块，展示批量上链任务的最新状态（如“最近一次上链：3 分钟前，包含 8 笔订单”），并提供到 Base Scan 的直接链接。
