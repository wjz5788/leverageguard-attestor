做法如下。先在**服务器**完成 1–4，再在**你电脑**做 5–6。US 与 JP 各执行一遍。

## 服务器上（root 登录）

1. 新建用户

```bash
adduser --disabled-password --gecos "" deploy
mkdir -p /home/deploy/.ssh
chmod 700 /home/deploy/.ssh
```

2. 写入公钥（把你本机公钥内容替换到下面）

```bash
echo 'ssh-ed25519 AAAA...你的公钥...' > /home/deploy/.ssh/authorized_keys
chown -R deploy:deploy /home/deploy/.ssh
chmod 600 /home/deploy/.ssh/authorized_keys
```

3. 建部署目录并授权

* US 机：

```bash
mkdir -p /srv/web/us/{releases,shared,current}
chown -R deploy:deploy /srv/web/us
```

* JP 机：

```bash
mkdir -p /srv/app/jp/{releases,shared,current}
chown -R deploy:deploy /srv/app/jp
```

4. 最小 sudo 权限

* US 机（Nginx 重载 + ln）：

```bash
cat >/etc/sudoers.d/deploy <<'EOF'
deploy ALL=(root) NOPASSWD: /usr/bin/ln, /usr/sbin/nginx, /usr/bin/systemctl reload nginx, /usr/bin/systemctl restart nginx
EOF
visudo -cf /etc/sudoers.d/deploy
```

* JP 机（ln + 重启后端服务，替换 <svc> 为你的 systemd 名）：

```bash
cat >/etc/sudoers.d/deploy <<'EOF'
deploy ALL=(root) NOPASSWD: /usr/bin/ln, /usr/bin/systemctl restart <svc>, /usr/bin/systemctl status <svc>
EOF
visudo -cf /etc/sudoers.d/deploy
```

## 你电脑上

5. 生成专用密钥并下发到服务器

```bash
ssh-keygen -t ed25519 -C "deploy-us" -f ~/.ssh/deploy-us
ssh-copy-id -i ~/.ssh/deploy-us.pub -p <US_SSH_PORT> deploy@<US_HOST>

ssh-keygen -t ed25519 -C "deploy-jp" -f ~/.ssh/deploy-jp
ssh-copy-id -i ~/.ssh/deploy-jp.pub -p <JP_SSH_PORT> deploy@<JP_HOST>
```

6. 写入 known_hosts 并自测

```bash
ssh-keyscan -p <US_SSH_PORT> <US_HOST> >> ~/.ssh/known_hosts
ssh-keyscan -p <JP_SSH_PORT> <JP_HOST> >> ~/.ssh/known_hosts

ssh -i ~/.ssh/deploy-us -p <US_SSH_PORT> deploy@<US_HOST> 'sudo -n /usr/sbin/nginx -t'
ssh -i ~/.ssh/deploy-jp -p <JP_SSH_PORT> deploy@<JP_HOST> 'sudo -n /usr/bin/systemctl status <svc> >/dev/null'
```

返回正常即完成“deploy 用户 + 免密 + 最小 sudo”。随后按 `deploy/vars` 配置并运行 `deploy/release.sh`。
