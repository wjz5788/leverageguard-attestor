<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noindex,nofollow" />
    <title>LiqPass — 合并版 (UX + P/L 测算 + 取证上链)</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
      * { box-sizing: border-box; }
      body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    </style>
  </head>
  <body class="bg-slate-950 text-slate-100">
    <div id="root"></div>

    <script type="module">
      import React, { useEffect, useMemo, useState, useCallback } from "https://esm.sh/react@18.2.0";
      import { createRoot } from "https://esm.sh/react-dom@18.2.0/client";
      import { ethers } from "https://esm.sh/ethers@6.9.0";
      import {
        Calculator, Upload, ListChecks, Hash, Shield, CheckCircle2, HelpCircle
      } from "https://esm.sh/lucide-react@0.323.0";
      import { marked } from "https://esm.sh/marked@9.1.2";

      marked.setOptions({ gfm: true, breaks: true });

      const ADMIN_QS_KEY = "admin";
      const ADMIN_TRUE_VALUES = ["1", "true", "yes"];
      function detectAdminFlag() {
        if (typeof window === "undefined") return false;
        try {
          const params = new URLSearchParams(window.location.search);
          const qs = params.get(ADMIN_QS_KEY);
          if (qs && ADMIN_TRUE_VALUES.includes(qs.toLowerCase())) {
            window.localStorage?.setItem("liqpass.admin", "1");
            return true;
          }
          if (qs === "0" || qs === "false") {
            window.localStorage?.removeItem("liqpass.admin");
            return false;
          }
        } catch (_) {}
        try {
          const stored = window.localStorage?.getItem("liqpass.admin");
          return stored === "1";
        } catch (_) {
          return false;
        }
      }
      const ADMIN_ENABLED = detectAdminFlag();

      /* -------------------- Locale Core (from prototype, slightly simplified) -------------------- */
      const SUPPORTED_LOCALES = ["zh-CN", "en-US"];
      const LANGUAGE_LABELS = { "zh-CN": "中", "en-US": "EN" };

      function formatMessage(template, vars = {}) {
        if (typeof template !== "string") return "";
        return template.replace(/\\{(\\w+)\\}/g, (_, key) => (key in vars ? String(vars[key]) : `{${key}}`));
      }

      const LocaleContext = React.createContext({
        locale: "zh-CN",
        setLocale: () => {},
        tr: (zh, en, vars) => formatMessage(zh, vars)
      });

      function useLocale() { return React.useContext(LocaleContext); }
      function detectInitialLocale() {
        if (typeof window !== "undefined") {
          try {
            const stored = window.localStorage?.getItem("liqpass.locale");
            if (stored && SUPPORTED_LOCALES.includes(stored)) return stored;
          } catch (_) {}
          if (typeof navigator !== "undefined") {
            const navLang = (navigator.language || navigator.userLanguage || "").toLowerCase();
            if (navLang.startsWith("en")) return "en-US";
          }
        }
        return "zh-CN";
      }

      /* -------------------- Part A: P/L Quote + Claim + Attest (from liq_pass_pl_flow_base_02) -------------------- */
      const DICT = {
        zh: {
          brand: "LiqPass",
          chain: "Base 主网",
          tab_ux: "OKX 合约险 · UX",
          tab_quote: "报价（P/L→保费/赔付）",
          tab_claim: "爆仓证据上传",
          tab_attest: "证明封装",
          tab_status: "状态追踪",
          tab_appeal: "人工申诉",
          hero_title: "输入 P / L 出报价 → 上传爆仓证据 → 自动生成证明包 → 查看状态",
          hero_sub: "仅围绕 本金 / 杠杆 / 保费 / 赔付额；自动生成 proof.json 并随申赔提交。",
          pill_base: "Base 主网",
          pill_okx: "OKX · 首发",

          quote_title: "报价计算（仅演示）",
          principal: "本金 (USDT)",
          leverage: "杠杆 (×，≤100)",
          btn_get_quote: "生成报价",
          premium: "保费",
          payout: "赔付额",
          premium_ratio: "保费比例",
          payout_ratio: "赔付比例",
          quote_id: "报价编号",
          valid_until: "有效期（10 分钟）",
          pricing_ver: "价格版本",
          err_range: "本金需在 50–500 USDT，杠杆需在 1–100。",

          claim_title: "上传爆仓证据（OKX / JSON）",
          choose_sample: "选择示例",
          sample_none: "不使用示例",
          sample_okx_liq: "示例：OKX 爆仓（LINK-USDT 强平）",
          sample_binance_liq: "示例：币安爆仓（BTCUSDT 强平）",
          or_paste: "或粘贴 JSON 文本",
          json_input_label: "JSON 凭证（可选）",
          appeal_title: "申诉通道",
          appeal_intro: "自动校验未通过时，可提交申诉以人工复核。",
          appeal_reason_label: "申诉说明",
          appeal_reason_placeholder: "请描述强平细节、截图链接等补充信息。",
          appeal_contact_label: "联系邮箱或 Telegram（可选）",
          appeal_contact_placeholder: "例如：user@example.com / @handle",
          btn_submit_appeal: "提交申诉",
          appeal_submitted: "申诉已接收，我们将尽快处理。",
          appeal_require_reason: "请填写申诉说明后再提交。",
          appeal_reference: "申诉编号",
          appeal_module_title: "人工申诉通道",
          appeal_module_intro: "如对自动校验结果有疑问，请在此提交补充说明与截图。",
          appeal_upload_label: "上传截图",
          appeal_upload_helper: "支持 PNG、JPG、WEBP，单个文件 ≤ 5 MB。",
          appeal_upload_selected: "已选择",
          appeal_upload_remove: "移除截图",
          appeal_preview_label: "截图预览",
          appeal_file_too_large: "截图文件需小于 5 MB，请压缩后再试。",
          appeal_file_error: "截图读取失败，请重试。",
          btn_validate: "校验证据",
          validation_result: "校验结果",
          order_id_label: "订单号",
          order_id_placeholder: "请输入与交易所一致的订单号",
          pass: "通过",
          fail: "失败",
          claim_highlights: [
            { title: "申诉", desc: "触发仲裁或人工复核；与链上记录保持一致，确保申诉闭环。" },
            { title: "订单号", desc: "请填写交易所原始订单号，便于匹配 Merkle proof 与订单指纹。" },
            { title: "凭证材料", desc: "上传 CSV/JSON 或截图提取的最小字段，支持本地验证器重新补交。" },
          ],

          attest_title: "证明封装（生成 Root & 模拟 Tx）",
          btn_build_root: "生成 Root",
          btn_attest: "提交存证 (Mock)",
          root: "Merkle Root (演示)",
          txhash: "交易哈希 (模拟)",

          status_title: "最近申赔 / 存证（演示数据）",
          steps_title: "用户路径（UX Flow）",
          s1: { title: "报价", body: "输入本金与杠杆，计算保费/赔付额，生成 quote_id。" },
          s2: { title: "申赔", body: "出现强平/ADL 时，上传样例或 JSON，自动校验关键信息。" },
          s3: { title: "证明", body: "对关键字段做哈希生成 root，封装 proof.json 并可选上传链上（演示）。" },
          s4: { title: "状态", body: "公开最近 N 笔 root/tx，评审可一键核对。" },
          disclaimer: "免责声明：本组件为演示 UX，不构成投资建议；样例数据与上链交易均为模拟。"
        },
        en: {
          brand: "LiqPass",
          chain: "Base Mainnet",
          tab_ux: "OKX Insurance · UX",
          tab_quote: "Quote (P/L → Premium/Payout)",
          tab_claim: "Liquidation Evidence",
          tab_attest: "Proof Builder",
          tab_status: "Status",
          tab_appeal: "Appeal",
          hero_title: "Enter P/L → Upload Liq Evidence → Auto proof bundle → Track status",
          hero_sub: "Only principal / leverage / premium / payout. proof.json is generated automatically for claims.",
          pill_base: "Base Mainnet",
          pill_okx: "OKX · First Launch",

          quote_title: "Quote (Demo)",
          principal: "Principal (USDT)",
          leverage: "Leverage (×, ≤100)",
          btn_get_quote: "Get Quote",
          premium: "Premium",
          payout: "Payout",
          premium_ratio: "Premium Ratio",
          payout_ratio: "Payout Ratio",
          quote_id: "Quote ID",
          valid_until: "Valid Until (10 min)",
          pricing_ver: "Pricing Version",
          err_range: "Principal must be 50–500 USDT and leverage 1–100.",

          claim_title: "Upload Liquidation Evidence (OKX / JSON)",
          choose_sample: "Choose Sample",
          sample_none: "No Sample",
          sample_okx_liq: "Sample: OKX Liquidation (LINK-USDT)",
          sample_binance_liq: "Sample: Binance Liquidation (BTCUSDT)",
          or_paste: "or paste JSON text",
          json_input_label: "JSON Evidence (optional)",
          appeal_title: "Appeal Channel",
          appeal_intro: "Auto validation failed. Provide details for manual review.",
          appeal_reason_label: "Appeal Notes",
          appeal_reason_placeholder: "Describe liquidation details, links to proofs, etc.",
          appeal_contact_label: "Contact Email or Telegram (optional)",
          appeal_contact_placeholder: "e.g. user@example.com / @handle",
          btn_submit_appeal: "Submit Appeal",
          appeal_submitted: "Appeal received. We'll review soon.",
          appeal_require_reason: "Please add appeal notes before submitting.",
          appeal_reference: "Appeal Reference",
          appeal_module_title: "Manual Appeal Desk",
          appeal_module_intro: "If auto validation fails, add context and screenshots here for manual review.",
          appeal_upload_label: "Upload Screenshot",
          appeal_upload_helper: "Supports PNG, JPG, WEBP up to 5 MB.",
          appeal_upload_selected: "Selected",
          appeal_upload_remove: "Remove Screenshot",
          appeal_preview_label: "Screenshot Preview",
          appeal_file_too_large: "Screenshot must be smaller than 5 MB. Please compress and retry.",
          appeal_file_error: "Failed to read screenshot. Please try again.",
          btn_validate: "Validate Evidence",
          validation_result: "Validation Result",
          order_id_label: "Order ID",
          order_id_placeholder: "Enter the exact exchange order ID",
          pass: "PASS",
          fail: "FAIL",
          claim_highlights: [
            { title: "Appeal", desc: "Trigger arbitration/manual review to close the loop with on-chain records." },
            { title: "Order ID", desc: "Provide original exchange order ID to match Merkle proof & trade fingerprint." },
            { title: "Evidence", desc: "Upload CSV/JSON or minimal fields; local validator may resubmit." },
          ],

          attest_title: "Proof Builder (Build Root & Mock Tx)",
          btn_build_root: "Build Root",
          btn_attest: "Submit Attestation (Mock)",
          root: "Merkle Root (Demo)",
          txhash: "Tx Hash (Mock)",

          status_title: "Recent Claims / Attestations (Demo)",
          steps_title: "User Flow",
          s1: { title: "Quote", body: "Enter principal & leverage → compute premium/payout & quote_id." },
          s2: { title: "Claim", body: "When liquidation/ADL occurs, upload sample or JSON for auto-validation." },
          s3: { title: "Proof", body: "Hash key fields to form a root, wrap proof.json, optionally record on-chain (mock)." },
          s4: { title: "Status", body: "Expose latest root/tx for auditability." },
          disclaimer: "Disclaimer: Demo UX only; samples & on-chain tx are mocked with no real payout."
        },
      };

      const SAMPLE_OKX_LIQ = {
        exchange: "OKX",
        pair: "LINK-USDT-SWAP",
        event: "LIQUIDATION",
        side: "LONG",
        quantity: 176,
        price: 13.516,
        timestamp: "2024-05-02T13:30:50Z",
      };
      const SAMPLE_BINANCE_LIQ = {
        exchange: "BINANCE",
        pair: "BTCUSDT-PERP",
        event: "LIQUIDATION",
        side: "LONG",
        quantity: 3,
        price: 61000.5,
        timestamp: "2024-05-02T13:31:12Z",
      };

      function classNames(...a) { return a.filter(Boolean).join(" "); }
      async function sha256Hex(text) {
        const enc = new TextEncoder();
        const data = enc.encode(text);
        const digest = await crypto.subtle.digest("SHA-256", data);
        return [...new Uint8Array(digest)].map(b=>b.toString(16).padStart(2,"0")).join("");
      }
      const QUOTE_TTL_MIN = 10;
      const LEVERAGE_MAX = 100;
      const MAX_APPEAL_FILE_SIZE = 5 * 1024 * 1024;
      function calcPremium(principal, leverage) {
        const baseRatio = 0.05 + (leverage - 20) * 0.001 + (principal / 500) * 0.02;
        const premiumRatio = Math.min(0.15, baseRatio);
        return { premium: +(premiumRatio * principal).toFixed(2), premiumRatio: +premiumRatio.toFixed(4) };
      }
      function calcPayoutRatio(principal, leverage) {
        const baseRatio = 0.25 + (leverage - 50) * 0.005 - (principal / 500) * 0.1;
        return Math.min(0.5, Math.max(0.1, baseRatio));
      }
      function calcPayout(principal, leverage) {
        const ratio = calcPayoutRatio(principal, leverage);
        return { payout: +(ratio * principal).toFixed(2), payoutRatio: +ratio.toFixed(4) };
      }

      function PLFlow() {
        const { locale } = useLocale();
        const langKey = locale === "en-US" ? "en" : "zh";
        const t = DICT[langKey];
        const [active, setActive] = useState("quote");

        const [principal, setPrincipal] = useState(500);
        const [leverage, setLeverage] = useState(10);
        const [quote, setQuote] = useState(null);
        const [quoteErr, setQuoteErr] = useState("");

        const [sample, setSample] = useState("none");
        const [jsonText, setJsonText] = useState("");
        const [claimRes, setClaimRes] = useState(null);
        const [orderId, setOrderId] = useState("");
        const [appealNote, setAppealNote] = useState("");
        const [appealContact, setAppealContact] = useState("");
        const [appealStatus, setAppealStatus] = useState("");
        const [appealTicket, setAppealTicket] = useState("");
        const [manualAppealReason, setManualAppealReason] = useState("");
        const [manualAppealContact, setManualAppealContact] = useState("");
        const [manualAppealStatus, setManualAppealStatus] = useState("");
        const [manualAppealTicket, setManualAppealTicket] = useState("");
        const [manualAppealScreenshotName, setManualAppealScreenshotName] = useState("");
        const [manualAppealScreenshotData, setManualAppealScreenshotData] = useState("");

        const [root, setRoot] = useState("");
        const [tx, setTx] = useState("");
        const [status, setStatus] = useState([
          {
            when: "2025-10-11 05:30:57 UTC",
            root: "0xb815fb0e7b1a244c84e366fe6203adb963122ef7379d7ad9b2411240639900ff",
            tx: "0x27fd052c9450674457ad5f7f560fc2ea8fbe78534653b70f409a9d633720853e",
            order: "wjz5788.com demo"
          }
        ]);
        const [attachedProof, setAttachedProof] = useState(() => {
          if (typeof window === "undefined") return null;
          try {
            const raw = window.localStorage?.getItem("liqpass.latestProof");
            return raw ? JSON.parse(raw) : null;
          } catch (_) {
            return null;
          }
        });
        const isAdmin = ADMIN_ENABLED;
        useEffect(() => {
          if (!isAdmin && active === "attest") {
            setActive("quote");
          }
        }, [isAdmin, active]);
        useEffect(() => {
          if (typeof window === "undefined") return;
          const sync = () => {
            try {
              const raw = window.localStorage?.getItem("liqpass.latestProof");
              setAttachedProof(raw ? JSON.parse(raw) : null);
            } catch (_) {}
          };
          sync();
          const onUpdate = () => sync();
          window.addEventListener("storage", onUpdate);
          window.addEventListener("liqpass:proof-updated", onUpdate);
          return () => {
            window.removeEventListener("storage", onUpdate);
            window.removeEventListener("liqpass:proof-updated", onUpdate);
          };
        }, []);

        const PRICING_VERSION = "pl-formula-v1";
        useEffect(() => {
          if (manualAppealStatus === "missing" && manualAppealReason.trim()) {
            setManualAppealStatus("");
          }
        }, [manualAppealStatus, manualAppealReason]);
        const computeQuote = useCallback((P, L) => {
          const { premium, premiumRatio } = calcPremium(P, L);
          const { payout, payoutRatio } = calcPayout(P, L);
          const quoteId = `Q-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
          const validTs = Date.now() + QUOTE_TTL_MIN * 60 * 1000;
          const valid = new Date(validTs).toLocaleString();
          return { payout, premium, premiumRatio, payoutRatio, quoteId, valid, validTs, pricingVersion: PRICING_VERSION };
        }, []);

        const handleGetQuote = useCallback(() => {
          const P = Number(principal), L = Number(leverage);
          if (!Number.isFinite(P) || !Number.isFinite(L) || P < 50 || P > 500 || L < 1 || L > LEVERAGE_MAX) {
            setQuote(null);
            setQuoteErr(t.err_range);
            return;
          }
          setQuoteErr("");
          const q = computeQuote(P, L);
          setQuote(q);
        }, [principal, leverage, computeQuote, t.err_range]);

        const currentOrderRef = orderId || quote?.quoteId || "";
        const proofMatchState = attachedProof
          ? (!attachedProof.orderId || !currentOrderRef || attachedProof.orderId === currentOrderRef ? "match" : "mismatch")
          : "none";

        const buildEvidenceSummary = useCallback(() => {
          const evidence =
            sample === "okx_liq" ? SAMPLE_OKX_LIQ : sample === "binance_liq" ? SAMPLE_BINANCE_LIQ
              : (() => { try { return JSON.parse(jsonText || "{}"); } catch { return {}; } })();
          const requestedOrderId = currentOrderRef || `DEMO-${Date.now()}`;
          const summary = {
            order_id: requestedOrderId,
            principal: Number(principal || 0),
            leverage: Number(leverage || 0),
            payout: quote?.payout ?? calcPayout(Number(principal||0), Number(leverage||0)).payout,
            premium: quote?.premium ?? calcPremium(Number(principal||0), Number(leverage||0)).premium,
            pricing_version: PRICING_VERSION,
            evidence,
          };
          if (attachedProof) {
            summary.proof_bundle = attachedProof;
          }
          return summary;
        }, [sample, jsonText, quote, principal, leverage, attachedProof, currentOrderRef]);

        const handleValidate = useCallback(async () => {
          const summary = buildEvidenceSummary();
          const input = JSON.stringify(summary);
          const ok = summary.evidence?.event === "LIQUIDATION";
          const proofBundle = attachedProof && (!attachedProof.orderId || attachedProof.orderId === summary.order_id) ? attachedProof : null;
          const proofRoot = proofBundle?.root ?? await sha256Hex(input);
          setClaimRes({ res: { ok, proof: proofRoot, proofBundle }, summary });
          setRoot(proofRoot);
          setAppealNote("");
          setAppealContact("");
          setAppealStatus("");
          setAppealTicket("");
        }, [buildEvidenceSummary, attachedProof]);

        const handleBuildRoot = useCallback(async () => {
          if (attachedProof?.root) {
            setRoot(attachedProof.root);
            return;
          }
          if (claimRes?.res && !claimRes.res.ok) return;
          if (!claimRes) {
            const summary = buildEvidenceSummary();
            const proof = await sha256Hex(JSON.stringify(summary));
            setClaimRes({ res: { ok: true, proof }, summary });
            setRoot(proof);
            return;
          }
          const leaf = JSON.stringify(claimRes.summary);
          const newRoot = await sha256Hex(leaf + Date.now());
          setRoot(newRoot);
        }, [attachedProof, claimRes, buildEvidenceSummary]);

        const handleAttest = useCallback(async () => {
          if (claimRes?.res && !claimRes.res.ok) return;
          if (!root) return;
          const mockTx = await sha256Hex(root + Math.random());
          setTx(mockTx);
          setStatus((prev) => [
            { when: new Date().toISOString(), root, tx: mockTx, order: claimRes?.summary?.order_id ?? "demo-order" },
            ...prev.slice(0, 4),
          ]);
        }, [root, claimRes]);
        const copyStatusValue = useCallback((value) => {
          if (!value) return;
          copyToClipboard(value);
        }, []);

        const submitAppeal = useCallback(async ({
          reason,
          contact,
          summary,
          screenshotData,
          screenshotName,
          setStatus,
          setTicket,
        } = {}) => {
          const note = (reason ?? "").trim();
          const contactInfo = (contact ?? "").trim();
          const updateStatus = setStatus ?? setAppealStatus;
          const updateTicket = setTicket ?? setAppealTicket;
          if (!note) {
            updateStatus("missing");
            updateTicket("");
            return;
          }
          updateStatus("submitting");
          const baseSummary = summary ?? buildEvidenceSummary();
          const payload = {
            ...baseSummary,
            appeal: {
              reason: note,
              contact: contactInfo || undefined,
              submitted_at: new Date().toISOString(),
              screenshot_name: screenshotName || undefined,
              screenshot_data_url: screenshotData || undefined,
            }
          };
          const ticket = await sha256Hex(JSON.stringify(payload));
          updateTicket(ticket);
          updateStatus("submitted");
        }, [buildEvidenceSummary]);

        const handleSubmitAppeal = useCallback(async () => {
          if (!claimRes || claimRes.res.ok) return;
          await submitAppeal({
            reason: appealNote,
            contact: appealContact,
            summary: claimRes.summary,
            setStatus: setAppealStatus,
            setTicket: setAppealTicket,
          });
        }, [claimRes, appealNote, appealContact, submitAppeal]);

        const handleManualAppealFile = useCallback((file) => {
          setManualAppealTicket("");
          if (!file) {
            setManualAppealScreenshotName("");
            setManualAppealScreenshotData("");
            setManualAppealStatus("");
            return;
          }
          if (file.size > MAX_APPEAL_FILE_SIZE) {
            setManualAppealScreenshotName("");
            setManualAppealScreenshotData("");
            setManualAppealStatus("file-too-large");
            return;
          }
          const reader = new FileReader();
          reader.onload = () => {
            if (typeof reader.result === "string") {
              setManualAppealScreenshotData(reader.result);
              setManualAppealScreenshotName(file.name);
              setManualAppealStatus("");
            } else {
              setManualAppealScreenshotData("");
              setManualAppealScreenshotName("");
              setManualAppealStatus("file-error");
            }
          };
          reader.onerror = () => {
            setManualAppealScreenshotData("");
            setManualAppealScreenshotName("");
            setManualAppealStatus("file-error");
          };
          reader.readAsDataURL(file);
        }, []);

        const handleManualAppealRemoveFile = useCallback(() => {
          setManualAppealScreenshotName("");
          setManualAppealScreenshotData("");
          setManualAppealStatus("");
          setManualAppealTicket("");
        }, []);

        const handleManualAppealSubmit = useCallback(async () => {
          if (manualAppealStatus === "submitting" || manualAppealStatus === "file-too-large" || manualAppealStatus === "file-error") return;
          await submitAppeal({
            reason: manualAppealReason,
            contact: manualAppealContact,
            summary: buildEvidenceSummary(),
            screenshotData: manualAppealScreenshotData,
            screenshotName: manualAppealScreenshotName,
            setStatus: setManualAppealStatus,
            setTicket: setManualAppealTicket,
          });
        }, [
          manualAppealStatus,
          manualAppealReason,
          manualAppealContact,
          manualAppealScreenshotData,
          manualAppealScreenshotName,
          submitAppeal,
          buildEvidenceSummary
        ]);

        const Tab = ({ id, label, icon: Icon }) => (
          React.createElement("button", {
              onClick: () => setActive(id),
              className: classNames(
                "inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm",
                active === id ? "bg-white/90 text-slate-900" : "bg-white/10 text-white hover:bg-white/20"
              )
            },
            Icon ? React.createElement(Icon, { size: 16 }) : null,
            " ", label
          )
        );

        const Stat = ({ label, value }) => (
          React.createElement("div", { className: "flex flex-col p-4 rounded-2xl bg-white/5 border border-white/10" },
            React.createElement("div", { className: "text-xs text-white/60" }, label),
            React.createElement("div", { className: "text-lg font-semibold mt-1" }, value)
          )
        );

        const StepCard = ({ idx, title, body, icon: Icon }) => (
          React.createElement("div", { className: "p-5 rounded-2xl bg-white/5 border border-white/10 h-full" },
            React.createElement("div", { className: "flex items-center gap-2 text-white/80 text-xs tracking-wide" },
              React.createElement("span", { className: "px-2 py-0.5 rounded-full bg-white/10" }, `STEP ${idx}`)
            ),
            React.createElement("div", { className: "flex items-center gap-2 mt-3" },
              Icon ? React.createElement(Icon, { size: 18, className: "text-white/80" }) : null,
              React.createElement("div", { className: "font-semibold" }, title)
            ),
            React.createElement("div", { className: "text-sm text-white/70 mt-2 leading-relaxed" }, body)
          )
        );

        const highlightIcons = [Shield, CheckCircle2, HelpCircle];
        const renderAppealFeedback = (status, ticket) => {
          if (!status && !ticket) return null;
          if (status === "missing") {
            return React.createElement("p", { className: "text-sm text-rose-300" }, t.appeal_require_reason);
          }
          if (status === "submitting") {
            return React.createElement("p", { className: "text-sm text-white/70" }, locale === "en-US" ? "Submitting..." : "提交中...");
          }
          if (status === "submitted") {
            return React.createElement("div", { className: "space-y-1 text-sm text-emerald-300" },
              React.createElement("p", null, t.appeal_submitted),
              ticket ? React.createElement("p", { className: "text-xs text-emerald-200/80 break-all" }, `${t.appeal_reference}：${ticket}`) : null
            );
          }
          if (status === "file-too-large") {
            return React.createElement("p", { className: "text-sm text-rose-300" }, t.appeal_file_too_large);
          }
          if (status === "file-error") {
            return React.createElement("p", { className: "text-sm text-rose-300" }, t.appeal_file_error);
          }
          return ticket ? React.createElement("p", { className: "text-xs text-white/60 break-all" }, `${t.appeal_reference}：${ticket}`) : null;
        };

        const quoteView = React.createElement("div", { className: "space-y-6" },
          React.createElement("div", { className: "grid gap-6 lg:grid-cols-[1.2fr,0.8fr]" },
            React.createElement("div", { className: "rounded-3xl border border-white/10 bg-white/5 p-6 space-y-4" },
              React.createElement("h3", { className: "text-lg font-semibold" }, t.quote_title),
              React.createElement("div", { className: "grid gap-4 sm:grid-cols-2" },
                React.createElement("label", { className: "flex flex-col gap-2 text-sm text-white/70" },
                  React.createElement("span", null, t.principal),
                  React.createElement("input", {
                    className: "rounded-xl border border-white/10 bg-black/30 px-3 py-2 text-white focus:border-indigo-400 focus:outline-none",
                    type: "number",
                    min: "0",
                    value: principal,
                    onChange: (e) => setPrincipal(e.target.value)
                  })
                ),
                React.createElement("label", { className: "flex flex-col gap-2 text-sm text-white/70" },
                  React.createElement("span", null, t.leverage),
                  React.createElement("input", {
                    className: "rounded-xl border border-white/10 bg-black/30 px-3 py-2 text-white focus:border-indigo-400 focus:outline-none",
                    type: "number",
                    min: "1",
                    max: String(LEVERAGE_MAX),
                    value: leverage,
                    onChange: (e) => setLeverage(e.target.value)
                  })
                )
              ),
              React.createElement("div", { className: "flex flex-wrap items-center gap-3" },
                React.createElement("button", {
                  type: "button",
                  onClick: handleGetQuote,
                  className: "rounded-full bg-indigo-500 px-5 py-2 text-sm font-medium text-white shadow-lg shadow-indigo-700/30 transition hover:bg-indigo-400"
                }, t.btn_get_quote),
                React.createElement("span", { className: "text-xs text-white/60" }, `${t.valid_until}：${QUOTE_TTL_MIN} ${locale === "en-US" ? "minutes" : "分钟"}`)
              ),
              quoteErr ? React.createElement("p", { className: "text-sm text-rose-300" }, quoteErr) : null,
              quote ? React.createElement("div", { className: "space-y-1 text-xs text-white/60" },
                React.createElement("p", null, `${t.quote_id}：${quote.quoteId}`),
                React.createElement("p", null, `${t.valid_until}：${quote.valid}`),
                React.createElement("p", null, `${t.pricing_ver}：${quote.pricingVersion}`)
              ) : null
            ),
            React.createElement("div", { className: "space-y-4" },
              React.createElement("div", { className: "grid gap-3 sm:grid-cols-2" },
                React.createElement(Stat, { label: t.premium, value: quote ? `${quote.premium.toFixed(2)} USDT` : "—" }),
                React.createElement(Stat, { label: t.payout, value: quote ? `${quote.payout.toFixed(2)} USDT` : "—" }),
                React.createElement(Stat, { label: t.premium_ratio, value: quote ? `${(quote.premiumRatio * 100).toFixed(2)}%` : "—" }),
                React.createElement(Stat, { label: t.payout_ratio, value: quote ? `${(quote.payoutRatio * 100).toFixed(2)}%` : "—" })
              ),
              React.createElement("div", { className: "rounded-3xl border border-white/10 bg-white/5 p-5 text-sm text-white/70 leading-relaxed" }, t.hero_sub)
            )
          )
        );

        const claimView = React.createElement("div", { className: "space-y-6" },
          React.createElement("div", { className: "grid gap-6 lg:grid-cols-[1.2fr,0.8fr]" },
            React.createElement("div", { className: "rounded-3xl border border-white/10 bg-white/5 p-6 space-y-4" },
              React.createElement("h3", { className: "text-lg font-semibold" }, t.claim_title),
              React.createElement("div", { className: "space-y-4 text-sm" },
                React.createElement("label", { className: "block space-y-2 text-sm text-white/70" },
                  React.createElement("span", null, t.choose_sample),
                  React.createElement("select", {
                    className: "w-full rounded-xl border border-white/10 bg-black/30 px-3 py-2 focus:border-indigo-400 focus:outline-none",
                    value: sample,
                    onChange: (e) => setSample(e.target.value)
                  },
                    React.createElement("option", { value: "none" }, t.sample_none),
                    React.createElement("option", { value: "okx_liq" }, t.sample_okx_liq),
                    React.createElement("option", { value: "binance_liq" }, t.sample_binance_liq)
                  )
                ),
                React.createElement("label", { className: "block space-y-2 text-sm text-white/70" },
                  React.createElement("span", null, t.order_id_label),
                  React.createElement("input", {
                    className: "w-full rounded-xl border border-white/10 bg-black/30 px-3 py-2 text-sm text-white focus:border-indigo-400 focus:outline-none",
                    value: orderId,
                    onChange: (e) => setOrderId(e.target.value),
                    placeholder: t.order_id_placeholder
                  })
                )
              ),
              proofMatchState === "match"
                ? React.createElement("div", { className: "rounded-2xl border border-emerald-400/30 bg-emerald-500/10 p-3 text-xs text-emerald-200" },
                    locale === "en-US"
                      ? `Detected proof.json (order ${attachedProof?.orderId || "N/A"}) — it will be auto-attached.`
                      : `已载入 proof.json（订单 ${attachedProof?.orderId || "未填写"}），提交时将自动附带。`
                  )
                : proofMatchState === "mismatch"
                  ? React.createElement("div", { className: "rounded-2xl border border-amber-400/40 bg-amber-500/10 p-3 text-xs text-amber-200" },
                      locale === "en-US"
                        ? `proof.json belongs to order ${attachedProof?.orderId}; current order is ${currentOrderRef || "N/A"}. Please align before submitting.`
                        : `当前 proof.json 关联订单 ${attachedProof?.orderId || "未知"}，与表单订单 ${currentOrderRef || "未填写"} 不一致，请对齐后提交。`
                    )
                  : React.createElement("div", { className: "rounded-2xl border border-white/10 border-dashed bg-black/20 p-3 text-xs text-white/60" },
                      locale === "en-US"
                        ? "No proof.json detected yet. The form will generate a temporary proof automatically."
                        : "尚未检测到 proof.json；提交时将自动生成临时证明。"
                    ),
              React.createElement("div", { className: "flex flex-wrap items-center gap-3" },
                React.createElement("button", {
                  type: "button",
                  onClick: handleValidate,
                  className: "rounded-full bg-emerald-500 px-5 py-2 text-sm font-medium text-white shadow-lg shadow-emerald-700/30 transition hover:bg-emerald-400"
                }, t.btn_validate),
                claimRes && claimRes.res && !claimRes.res.ok
                  ? React.createElement("span", { className: "text-xs text-amber-300" }, locale === "en-US" ? "Auto-check failed — please submit an appeal." : "自动校验未通过，请提交申诉。")
                  : null
              ),
              claimRes ? React.createElement("div", {
                className: classNames(
                  "rounded-2xl border p-4 text-sm",
                  claimRes.res.ok ? "border-emerald-400/60 bg-emerald-400/10 text-emerald-200" : "border-rose-400/60 bg-rose-400/10 text-rose-200"
                )
              },
                React.createElement("div", { className: "font-medium" }, t.validation_result),
                React.createElement("div", { className: "mt-1 text-sm" }, claimRes.res.ok ? t.pass : t.fail),
                React.createElement("div", { className: "mt-2 text-xs text-white/90 break-all" }, `${locale === "en-US" ? "root" : "根"}: ${claimRes.res.proof}`),
                claimRes.res.proofBundle
                  ? React.createElement("div", { className: "mt-2 space-y-1 rounded-xl bg-black/20 p-3 text-xs text-white/70" },
                      React.createElement("p", { className: "break-all" }, `leafHash: ${claimRes.res.proofBundle.leafHash}`),
                      React.createElement("p", { className: "break-all" }, `fileSha256: ${claimRes.res.proofBundle.fileSha256}`),
                      React.createElement("p", null, `${locale === "en-US" ? "proof length" : "Merkle 节点数"}: ${claimRes.res.proofBundle.merkleProof?.length ?? 0}`)
                    )
                  : null,
                React.createElement("div", { className: "mt-2 max-h-48 overflow-auto rounded-xl bg-black/30 p-3 text-xs text-white/80" },
                  React.createElement("pre", { className: "whitespace-pre-wrap break-all" }, JSON.stringify(claimRes.summary, null, 2))
                )
              ) : null
            ),
            React.createElement("div", { className: "space-y-4" },
              React.createElement("div", { className: "rounded-3xl border border-white/10 bg-white/5 p-6 space-y-4" },
                React.createElement("h4", { className: "text-sm font-semibold uppercase tracking-[0.2em] text-white/60" }, locale === "en-US" ? "Claim Highlights" : "申赔要点"),
                t.claim_highlights.map((item, idx) =>
                  React.createElement("div", { key: idx, className: "rounded-2xl border border-white/10 bg-black/30 p-4" },
                    React.createElement("div", { className: "flex items-center gap-3" },
                      React.createElement(highlightIcons[idx % highlightIcons.length], { size: 18, className: "text-white/70" }),
                      React.createElement("div", { className: "font-semibold text-white" }, item.title)
                    ),
                    React.createElement("p", { className: "mt-2 text-sm text-white/70 leading-relaxed" }, item.desc)
                  )
                )
              )
            )
          ),
        );

        const appealView = React.createElement("div", { className: "space-y-6" },
          React.createElement("div", { className: "grid gap-6 lg:grid-cols-2" },
            React.createElement("div", { className: "rounded-3xl border border-white/10 bg-white/5 p-6 space-y-4" },
              React.createElement("h3", { className: "text-lg font-semibold" }, t.appeal_title),
              React.createElement("p", { className: "text-sm text-white/70" }, t.appeal_intro),
              React.createElement("label", { className: "block space-y-2 text-sm text-white/70" },
                React.createElement("span", null, t.appeal_reason_label),
                React.createElement("textarea", {
                  className: "min-h-[120px] w-full rounded-xl border border-white/10 bg-black/30 px-3 py-2 text-sm text-white focus:border-indigo-400 focus:outline-none",
                  value: appealNote,
                  onChange: (e) => setAppealNote(e.target.value),
                  placeholder: t.appeal_reason_placeholder
                })
              ),
              React.createElement("label", { className: "block space-y-2 text-sm text-white/70" },
                React.createElement("span", null, t.appeal_contact_label),
                React.createElement("input", {
                  className: "w-full rounded-xl border border-white/10 bg-black/30 px-3 py-2 text-sm text-white focus:border-indigo-400 focus:outline-none",
                  value: appealContact,
                  onChange: (e) => setAppealContact(e.target.value),
                  placeholder: t.appeal_contact_placeholder
                })
              ),
              React.createElement("div", { className: "flex items-center gap-3" },
                React.createElement("button", {
                  type: "button",
                  onClick: handleSubmitAppeal,
                  className: "rounded-full bg-indigo-500 px-5 py-2 text-sm font-medium text-white shadow-lg shadow-indigo-700/30 transition hover:bg-indigo-400",
                  disabled: appealStatus === "submitting"
                }, t.btn_submit_appeal),
                appealStatus === "submitting"
                  ? React.createElement("span", { className: "text-xs text-white/70" }, locale === "en-US" ? "Submitting..." : "提交中...")
                  : null
              ),
              renderAppealFeedback(appealStatus, appealTicket)
            ),
            React.createElement("div", { className: "rounded-3xl border border-white/10 bg-white/5 p-6 space-y-4" },
              React.createElement("h3", { className: "text-lg font-semibold" }, t.appeal_module_title),
              React.createElement("p", { className: "text-sm text-white/70" }, t.appeal_module_intro),
              React.createElement("label", { className: "block space-y-2 text-sm text-white/70" },
                React.createElement("span", null, t.appeal_reason_label),
                React.createElement("textarea", {
                  className: "min-h-[120px] w-full rounded-xl border border-white/10 bg-black/30 px-3 py-2 text-sm text-white focus:border-indigo-400 focus:outline-none",
                  value: manualAppealReason,
                  onChange: (e) => setManualAppealReason(e.target.value),
                  placeholder: t.appeal_reason_placeholder
                })
              ),
              React.createElement("label", { className: "block space-y-2 text-sm text-white/70" },
                React.createElement("span", null, t.appeal_contact_label),
                React.createElement("input", {
                  className: "w-full rounded-xl border border-white/10 bg-black/30 px-3 py-2 text-sm text-white focus:border-indigo-400 focus:outline-none",
                  value: manualAppealContact,
                  onChange: (e) => setManualAppealContact(e.target.value),
                  placeholder: t.appeal_contact_placeholder
                })
              ),
              React.createElement("label", { className: "block space-y-2 text-sm text-white/70" },
                React.createElement("span", null, t.appeal_upload_label),
                React.createElement("input", {
                  type: "file",
                  accept: "image/png,image/jpeg,image/webp",
                  onChange: (e) => handleManualAppealFile(e.target.files?.[0] ?? null),
                  className: "w-full text-xs text-white/70"
                }),
                React.createElement("p", { className: "text-xs text-white/40" }, t.appeal_upload_helper),
                manualAppealScreenshotName
                  ? React.createElement("div", { className: "flex items-center gap-3 text-xs text-white/60" },
                      React.createElement("span", null, `${t.appeal_upload_selected}：${manualAppealScreenshotName}`),
                      React.createElement("button", { type: "button", className: "rounded-full border border-white/20 px-2 py-1 text-xs text-white hover:border-indigo-300/60", onClick: handleManualAppealRemoveFile }, t.appeal_upload_remove)
                    )
                  : null
              ),
              React.createElement("div", { className: "flex items-center gap-3" },
                React.createElement("button", {
                  type: "button",
                  onClick: handleManualAppealSubmit,
                  className: "rounded-full bg-emerald-500 px-5 py-2 text-sm font-medium text-white shadow-lg shadow-emerald-700/30 transition hover:bg-emerald-400",
                  disabled: manualAppealStatus === "submitting"
                }, t.btn_submit_appeal),
                manualAppealStatus === "submitting"
                  ? React.createElement("span", { className: "text-xs text-white/70" }, locale === "en-US" ? "Submitting..." : "提交中...")
                  : null
              ),
              renderAppealFeedback(manualAppealStatus, manualAppealTicket)
            )
          )
        );

        const attestView = React.createElement("div", { className: "space-y-6" },
          React.createElement("div", { className: "grid gap-6 lg:grid-cols-[1.1fr,0.9fr]" },
            React.createElement("div", { className: "rounded-3xl border border-white/10 bg-white/5 p-6 space-y-4" },
              React.createElement("h3", { className: "text-lg font-semibold" }, t.attest_title),
              React.createElement("div", { className: "flex flex-wrap items-center gap-3" },
                React.createElement("button", {
                  type: "button",
                  onClick: handleBuildRoot,
                  className: "rounded-full bg-indigo-500 px-5 py-2 text-sm font-medium text-white shadow-lg shadow-indigo-700/30 transition hover:bg-indigo-400"
                }, t.btn_build_root),
                claimRes && claimRes.res && !claimRes.res.ok
                  ? React.createElement("span", { className: "text-xs text-amber-300" }, locale === "en-US" ? "Fix validation issues before building a root." : "请先修正校验结果，再生成 Root。")
                  : null
              ),
              root
                ? React.createElement("div", { className: "rounded-2xl border border-white/10 bg-black/30 p-4 text-xs text-white/80 break-all" }, `${t.root}：${root}`)
                : React.createElement("p", { className: "text-sm text-white/70" }, locale === "en-US" ? "Validate the claim first to prepare a Merkle leaf." : "请先完成证据校验，生成 Merkle leaf。"),
              React.createElement("div", { className: "flex flex-wrap items-center gap-3" },
                React.createElement("button", {
                  type: "button",
                  onClick: handleAttest,
                  className: "rounded-full bg-emerald-500 px-5 py-2 text-sm font-medium text-white shadow-lg shadow-emerald-700/30 transition hover:bg-emerald-400 disabled:opacity-40 disabled:cursor-not-allowed",
                  disabled: !root || (claimRes && claimRes.res && !claimRes.res.ok)
                }, t.btn_attest),
                tx
                  ? React.createElement("span", { className: "text-xs text-white/70 break-all" }, `${t.txhash}：${tx}`)
                  : null
              )
            ),
            React.createElement("div", { className: "rounded-3xl border border-white/10 bg-white/5 p-6 space-y-4" },
              React.createElement("h3", { className: "text-lg font-semibold" }, t.validation_result),
              claimRes
                ? React.createElement("div", { className: "max-h-72 overflow-auto rounded-2xl bg-black/30 p-4 text-xs text-white/80" },
                    React.createElement("pre", { className: "whitespace-pre-wrap break-all" }, JSON.stringify(claimRes.summary, null, 2))
                  )
                : React.createElement("p", { className: "text-sm text-white/70" }, locale === "en-US" ? "Validate liquidation evidence to preview the proof payload." : "完成证据校验后，可预览证明 payload。"),
              status.length
                ? React.createElement("div", { className: "space-y-2 text-xs text-white/60" },
                    React.createElement("p", null, locale === "en-US" ? "Latest Merkle root also appears under Status." : "最新 Root 记录可在“状态追踪”卡片查看。")
                  )
                : null
            )
          )
        );

        const statusView = React.createElement("div", { className: "space-y-6" },
          React.createElement("div", { className: "rounded-3xl border border-white/10 bg-white/5 p-6 space-y-4" },
            React.createElement("h3", { className: "text-lg font-semibold" }, t.status_title),
            status.length
              ? status.map((item, idx) =>
                  React.createElement("div", { key: idx, className: "rounded-2xl border border-white/10 bg-black/30 p-4 space-y-1 text-xs text-white/70" },
                    React.createElement("div", { className: "text-sm font-semibold text-white" }, item.order),
                    React.createElement("p", null, `${locale === "en-US" ? "Timestamp" : "时间"}：${item.when}`),
                    React.createElement("p", { className: "break-all" }, `root：${item.root}`),
                    React.createElement("p", { className: "break-all" }, `tx：${item.tx || "—"}`),
                    React.createElement("div", { className: "flex flex-wrap gap-2 pt-2" },
                      React.createElement("button", {
                        className: "rounded-full border border-white/15 px-3 py-1 text-xs hover:border-indigo-300/70",
                        onClick: () => copyStatusValue(item.root)
                      }, locale === "en-US" ? "Copy root" : "复制 Root"),
                      item.tx ? React.createElement("button", {
                        className: "rounded-full border border-white/15 px-3 py-1 text-xs hover:border-indigo-300/70",
                        onClick: () => copyStatusValue(item.tx)
                      }, locale === "en-US" ? "Copy tx" : "复制 Tx") : null,
                      item.tx ? React.createElement("a", {
                        className: "rounded-full bg-indigo-500/20 px-3 py-1 text-xs text-indigo-200 hover:bg-indigo-500/40",
                        target: "_blank",
                        rel: "noreferrer",
                        href: `https://basescan.org/tx/${item.tx}`
                      }, "Basescan") : null
                    )
                  )
                )
              : React.createElement("p", { className: "text-sm text-white/70" }, locale === "en-US" ? "No on-chain attestations yet." : "暂未有上链存证记录。")
          ),
          React.createElement("div", { className: "space-y-4" },
            React.createElement("h3", { className: "text-sm font-semibold uppercase tracking-[0.3em] text-white/60" }, t.steps_title),
            React.createElement("div", { className: "grid gap-4 md:grid-cols-2 xl:grid-cols-4" },
              React.createElement(StepCard, { idx: 1, title: t.s1.title, body: t.s1.body, icon: Calculator }),
              React.createElement(StepCard, { idx: 2, title: t.s2.title, body: t.s2.body, icon: Upload }),
              React.createElement(StepCard, { idx: 3, title: t.s3.title, body: t.s3.body, icon: Hash }),
              React.createElement(StepCard, { idx: 4, title: t.s4.title, body: t.s4.body, icon: ListChecks })
            )
          )
        );

        const tabItems = [
          { id: "quote", label: t.tab_quote, icon: Calculator },
          { id: "claim", label: t.tab_claim, icon: Upload },
          { id: "appeal", label: t.tab_appeal, icon: Shield },
          ...(isAdmin ? [{ id: "attest", label: t.tab_attest, icon: Hash }] : []),
          { id: "status", label: t.tab_status, icon: ListChecks }
        ];
        const currentView =
          active === "quote" ? quoteView :
          active === "claim" ? claimView :
          active === "appeal" ? appealView :
          (active === "attest" && isAdmin) ? attestView :
          statusView;

        return React.createElement(React.Fragment, null,
          React.createElement("div", { className: "max-w-6xl mx-auto px-4 mt-6" },
            React.createElement("div", { className: "rounded-3xl p-6 bg-white/5 border border-white/10" },
              React.createElement("div", { className: "text-2xl md:text-3xl font-semibold tracking-wide leading-relaxed" }, t.hero_title),
              React.createElement("div", { className: "text-white/70 mt-2 leading-relaxed" }, t.hero_sub)
            )
          ),
          React.createElement("div", { className: "max-w-6xl mx-auto px-4 py-10 space-y-8" },
            React.createElement("div", { className: "flex flex-wrap gap-2" },
              tabItems.map((tab) =>
                React.createElement(Tab, { key: tab.id, id: tab.id, label: tab.label, icon: tab.icon })
              )
            ),
            currentView,
            React.createElement("div", { className: "text-xs text-white/50 text-center" }, t.disclaimer)
          )
        );
      }

      /* -------------------- Part B: UX + Attestor (from liqpass-prototype.html, slightly compact) -------------------- */
      const BASE_CHAIN_ID = 8453;
      const BASE_RPC = "https://mainnet.base.org";
      const ATTESTOR_ADDR = "0x9552b58d323993f84d01e3744f175f47a9462f94";
      const ATTESTOR_ABI = [
        "function attest(bytes32 root, string uri)",
        "function has(bytes32) view returns (bool)"
      ];

      function makeLocalizedMessage(zh, en, vars = {}) {
        return { zh: formatMessage(zh ?? "", vars), en: formatMessage(en ?? zh ?? "", vars) };
      }
      function getLocalized(message, locale) {
        if (message == null) return "";
        if (typeof message === "string") return message;
        if (typeof message === "object") {
          const lk = locale === "en-US" ? "en" : "zh";
          if (message[lk]) return message[lk];
          if (message.zh) return message.zh;
          if (message.en) return message.en;
          const first = Object.values(message)[0];
          if (typeof first === "string") return first;
        }
        return String(message);
      }
      function useTr() {
        const { locale } = useLocale();
        return useCallback((msg) => getLocalized(msg, locale), [locale]);
      }

      const UX_PRODUCTS = [
        {
          id: "OKX-DAY-100",
          name: makeLocalizedMessage("当日爆仓保 · 定额赔付 100 USDT", "Same-day liquidation cover · Flat payout 100 USDT"),
          premium: makeLocalizedMessage("10 USDC", "10 USDC"),
          leverageCap: makeLocalizedMessage("≤ 20x", "≤ 20x"),
          payoutCap: makeLocalizedMessage("100 USDT", "100 USDT"),
          waitPeriod: makeLocalizedMessage("30 分钟等待期", "30-minute waiting period"),
          coverageWindow: makeLocalizedMessage("订单当日（UTC）内的强平/ADL 触发", "Liquidation/ADL within order day (UTC)"),
          caution: makeLocalizedMessage("限每个钱包每日 1 单；仅支持 USDT 线性合约。", "Max 1 policy per wallet per day; USDT linear only."),
          faq: [{ q: makeLocalizedMessage("是否必须先绑定交易所？", "Do I need to link the exchange first?"),
                  a: makeLocalizedMessage("购买时可跳过；申赔前需绑定（托管密钥/本地验证器二选一）。", "May skip at purchase; bind before claims (custodial key or local validator).")}],
          pricingFormula: makeLocalizedMessage("premium = max(基础费率, notional × maintenanceMarginRate × 18%)",
                                               "premium = max(base rate, notional × maintenanceMarginRate × 18%)"),
          sampleRates: [
            { leverage: makeLocalizedMessage("≤10x","≤10x"), notional: makeLocalizedMessage("≤ 5,000 USDT","≤ 5,000 USDT"), premium: makeLocalizedMessage("6 USDC","6 USDC"), payout: makeLocalizedMessage("60 USDT","60 USDT") },
            { leverage: makeLocalizedMessage("10x–20x","10x–20x"), notional: makeLocalizedMessage("≤ 10,000 USDT","≤ 10,000 USDT"), premium: makeLocalizedMessage("10 USDC","10 USDC"), payout: makeLocalizedMessage("100 USDT","100 USDT") },
            { leverage: makeLocalizedMessage(">20x",">20x"), notional: makeLocalizedMessage("≤ 15,000 USDT","≤ 15,000 USDT"), premium: makeLocalizedMessage("14 USDC","14 USDC"), payout: makeLocalizedMessage("100 USDT (封顶)","100 USDT (cap)") }
          ],
          claimRules: [
            makeLocalizedMessage("窗口内发生强平或 ADL。", "Liquidation/ADL within the window."),
            makeLocalizedMessage("同一订单仅可赔付一次；重复自动拒绝。", "One payout per order; duplicates rejected."),
            makeLocalizedMessage("等待期后生效，同时校验 policy_ref 与 uid_hash。", "Activates after wait period; validates both policy_ref and uid_hash.")
          ],
          blacklist: [
            makeLocalizedMessage("自成交/刷量/操纵行为。","Self-trading/wash/manipulation."),
            makeLocalizedMessage("同一 KYC 关联地址累计超限。","Linked KYC addresses exceeding limits."),
            makeLocalizedMessage("被 OKX 标记为高风险或合约禁用。","Accounts flagged high-risk or futures-disabled.")
          ]
        }
      ];

      function LiqPassUX({ exchange = "OKX" }) {
        const { locale } = useLocale();
        const tr = useTr();
        const [selectedProductId, setSelectedProductId] = useState(UX_PRODUCTS[0]?.id ?? "");
        const selectedProduct = UX_PRODUCTS.find(p => p.id === selectedProductId) ?? UX_PRODUCTS[0];
        function L(msg){ return getLocalized(msg, locale); }

        const [walletAddress, setWalletAddress] = useState("");
        const [walletMessage, setWalletMessage] = useState("");
        const [siweStatus, setSiweStatus] = useState(L({zh:"未登录", en:"Not signed in"}));
        const [sessionToken, setSessionToken] = useState("");

        async function handleConnectWallet() {
          try {
            if (!window.ethereum) { setWalletMessage(L({zh:"未检测到以太坊钱包扩展",en:"No Ethereum wallet detected."})); return; }
            const provider = new ethers.BrowserProvider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            const net = await provider.getNetwork();
            if (Number(net.chainId) !== BASE_CHAIN_ID) {
              try {
                await window.ethereum.request({ method:"wallet_switchEthereumChain", params:[{ chainId: ethers.toQuantity(BASE_CHAIN_ID) }] });
              } catch {
                await window.ethereum.request({ method:"wallet_addEthereumChain", params:[{
                  chainId: ethers.toQuantity(BASE_CHAIN_ID),
                  chainName: "Base Mainnet",
                  nativeCurrency: { name:"Ether", symbol:"ETH", decimals:18 },
                  rpcUrls: [BASE_RPC],
                  blockExplorerUrls: ["https://basescan.org"]
                }]});
              }
            }
            const signer = await provider.getSigner();
            const account = await signer.getAddress();
            setWalletAddress(account);
            setWalletMessage(L({zh:"已连接 Base 钱包", en:"Connected to Base wallet."}));
          } catch (err) {
            const reason = err?.message ?? String(err);
            setWalletMessage(L({zh:`连接失败：${reason}`, en:`Connection failed: ${reason}`}));
          }
        }

        async function handleSiweLogin() {
          if (!walletAddress) { setWalletMessage(L({zh:"请先连接钱包", en:"Connect wallet first."})); return; }
          const nonce = Math.random().toString(36).slice(2);
          setSiweStatus(L({zh:"签名中...", en:"Awaiting signature..."}));
          try {
            const provider = new ethers.BrowserProvider(window.ethereum);
            const signer = await provider.getSigner();
            await signer.signMessage(`LiqPass 登录，nonce=${nonce}`);
            const tokenSuffix = walletAddress.slice(2, 8);
            const mockToken = `demo.${tokenSuffix}.${nonce}`;
            setSessionToken(mockToken);
            setSiweStatus(L({zh:"SIWE 已通过", en:"SIWE completed"}));
            setWalletMessage(L({zh:"后端将验证签名并返回 JWT（此处模拟）。", en:"Backend will verify signature and return JWT (mock)."}));
          } catch (err) {
            const reason = err?.message ?? String(err);
            setSiweStatus(L({zh:"未登录", en:"Not signed in"}));
            setWalletMessage(L({zh:`签名失败：${reason}`, en:`Signature failed: ${reason}`}));
          }
        }

        return (
          React.createElement("div", { className: "bg-slate-950 text-slate-100" },
            React.createElement("div", { className: "relative overflow-hidden bg-gradient-to-br from-indigo-900 via-slate-900 to-slate-950" },
              React.createElement("div", { className: "max-w-6xl mx-auto px-6 py-12 md:py-16" },
                React.createElement("p", { className: "text-sm uppercase tracking-[0.3em] text-indigo-200/80" }, L({zh:"多交易所合约保险（OKX 首发） · UX 流", en:"Multi-exchange insurance (OKX first) · UX flow"})),
                React.createElement("h1", { className: "mt-4 text-3xl font-semibold md:text-4xl" }, L({zh:`连接钱包 → 浏览产品 → 绑定 ${exchange} → 购买 → 交易监控 → 申赔 / 申诉`, en:`Connect wallet → browse products → link ${exchange} → purchase → monitor trades → claim / appeal`})),
                React.createElement("p", { className: "mt-4 max-w-3xl text-base text-indigo-100/80" }, L({zh:`支持 SIWE / EIP-4361 登录，钱包地址即用户 ID。既可托管密钥（只读）也可启用本地验证器，确保 ${exchange} 凭证不出端。`, en:`Supports SIWE / EIP-4361 with wallet as user ID. Choose custodial read-only keys or local validator to keep ${exchange} credentials on-device.`})),
                React.createElement("div", { className: "mt-6 flex flex-wrap gap-3" },
                  React.createElement("button", { type:"button", onClick: handleConnectWallet, className:"rounded-full bg-indigo-500 px-5 py-2 text-sm font-medium text-white shadow-lg shadow-indigo-700/30 transition hover:bg-indigo-400" }, L({zh:"1. 连接钱包", en:"1. Connect wallet"})),
                  React.createElement("button", { type:"button", onClick: handleSiweLogin, className:"rounded-full border border-indigo-300/60 px-5 py-2 text-sm font-medium text-indigo-100 transition hover:border-indigo-200 hover:bg-indigo-500/10" }, L({zh:"2. SIWE 登录（模拟）", en:"2. SIWE login (mock)"})),
                  walletAddress && React.createElement("span", { className:"rounded-full border border-white/10 px-4 py-2 text-xs text-indigo-100/80" }, `${walletAddress.slice(0, 10)}...${walletAddress.slice(-6)}`)
                ),
                React.createElement("div", { className: "mt-4 space-y-1 text-sm text-indigo-100/70" },
                  React.createElement("p", null, `${L({zh:"登录状态：",en:"Login status: "})}${siweStatus}${sessionToken ? L({zh:` · JWT(模拟) = ${sessionToken}`, en:` · JWT (mock) = ${sessionToken}`}) : ""}`),
                  walletMessage && React.createElement("p", null, walletMessage)
                )
              )
            ),
            React.createElement("div", { className: "max-w-6xl mx-auto px-6 pb-16 space-y-12" },
              React.createElement("section", { className:"space-y-4 pt-12" },
                React.createElement("h2", { className:"text-2xl font-semibold" }, L({zh:"用户路径（UX Flow）", en:"User journey (UX flow)"})),
                React.createElement("div", { className:"grid gap-4 md:grid-cols-3" },
                  [
                    { t: {zh:"连接钱包",en:"Connect wallet"}, d: {zh:"前端请求钱包；用户签署 SIWE，后端返回 JWT。", en:"Front-end requests wallet; user signs SIWE and backend returns JWT."} },
                    { t: {zh:"浏览产品",en:"Browse products"}, d: {zh:"无需登录即可查看保费、杠杆/赔付上限、等待期、FAQ。", en:"View premium, leverage/payout caps, waiting period, FAQs without login."} },
                    { t: {zh:`绑定 ${exchange}`,en:`Link ${exchange}`}, d: {zh:"托管密钥（只读）或本地验证器（密钥不出端）。", en:"Custodial read-only keys or local validator (keys stay on device)."} },
                  ].map((step, idx) =>
                    React.createElement("div", { key: idx, className:"rounded-2xl border border-white/10 bg-white/5 p-5 backdrop-blur" },
                      React.createElement("p", { className:"text-xs uppercase tracking-[0.3em] text-indigo-200/70" }, `Step ${idx+1}`),
                      React.createElement("h3", { className:"mt-3 text-lg font-semibold text-white" }, L(step.t)),
                      React.createElement("p", { className:"mt-2 text-sm text-slate-200/80" }, L(step.d))
                    )
                  )
                )
              ),
              React.createElement("section", { className:"space-y-4" },
                React.createElement("h2", { className:"text-2xl font-semibold" }, L({zh:"合约保险产品列表", en:"Insurance product catalog"})),
                React.createElement("div", { className:"grid gap-4 md:grid-cols-3" },
                  UX_PRODUCTS.map((product) => {
                    const isActive = product.id === selectedProductId;
                    return React.createElement("button", {
                      type: "button", key: product.id, onClick: () => setSelectedProductId(product.id),
                      className: `rounded-2xl border p-5 text-left transition ${isActive ? "border-indigo-400 bg-indigo-400/10 shadow-lg shadow-indigo-500/20" : "border-white/10 bg-white/5 hover:border-indigo-400/60"}`
                    },
                      React.createElement("div", { className:"flex items-center justify-between text-xs uppercase tracking-widest" },
                        React.createElement("span", { className:"text-indigo-200/80" }, product.id),
                        isActive && React.createElement("span", { className:"rounded-full bg-indigo-500/30 px-2 py-0.5 text-indigo-100" }, L({zh:"当前",en:"Selected"}))
                      ),
                      React.createElement("h3", { className:"mt-3 text-lg font-semibold text-white" }, L(product.name)),
                      React.createElement("ul", { className:"mt-4 space-y-1 text-sm text-slate-200/80" },
                        React.createElement("li", null, `${L({zh:"保费：",en:"Premium: "})}${L(product.premium)}`),
                        React.createElement("li", null, `${L({zh:"杠杆上限：",en:"Leverage cap: "})}${L(product.leverageCap)}`),
                        React.createElement("li", null, `${L({zh:"赔付额上限：",en:"Payout cap: "})}${L(product.payoutCap)}`),
                        React.createElement("li", null, `${L({zh:"等待期：",en:"Waiting period: "})}${L(product.waitPeriod)}`)
                      )
                    );
                  })
                )
              )
            )
          )
        );
      }

      /* ------ Utility from prototype for Attestor ------ */
      function parseCSV(text) {
        const lines = text.replace(/\\r\\n/g, "\\n").replace(/\\r/g, "\\n").split("\\n");
        if (!lines.length) return { headers: [], rows: [] };
        const headers = splitCSVLine(lines[0]);
        const normalizedHeaders = headers.map((h) => h.trim());
        const rows = [];
        for (let i = 1; i < lines.length; i++) {
          const originalLine = lines[i];
          const line = originalLine.trim();
          if (!line) continue;
          const cols = splitCSVLine(line);
          if (cols.length !== normalizedHeaders.length) {
            throw new Error(`第 ${i + 1} 行字段数 ${cols.length} ≠ 表头 ${normalizedHeaders.length}`);
          }
          const row = {};
          normalizedHeaders.forEach((h, idx) => (row[h] = (cols[idx] ?? "").trim()));
          rows.push(row);
        }
        return { headers: normalizedHeaders, rows };
      }
      function splitCSVLine(line) {
        const out = []; let cur = ""; let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          if (ch === '"') {
            if (inQuotes && line[i + 1] === '"') { cur += '"'; i++; }
            else { inQuotes = !inQuotes; }
          } else if (ch === "," && !inQuotes) { out.push(cur); cur = ""; }
          else { cur += ch; }
        }
        out.push(cur); return out;
      }
      function canonicalizeRow(row, exchange = "OKX") {
        const pick = (keys) => { for (const k of keys) if (k in row && String(row[k]).length) return String(row[k]).trim(); return ""; };
        const id = pick(["id","ID","orderId","订单ID","关联订单id"]);
        const inst = pick(["交易品种","instId","Instrument","Symbol"]);
        const side = pick(["交易类型","side","方向","Side"]);
        const qty = pick(["数量","size","Qty","FilledQty","accFillSz"]);
        const unit = pick(["交易单位","QtyUnit","Unit"]);
        const px = pick(["成交价","fillPx","price","Price"]);
        const pnl = pick(["收益","pnl","RealizedPnL","盈亏"]);
        const ts = pick(["时间","ts","Time","timestamp"]);
        return { exchange, id, inst, side, qty, unit, px, pnl, ts };
      }
      function stableJSONString(obj) {
        const keys = ["exchange","id","inst","side","qty","unit","px","pnl","ts"];
        const ordered = {}; for (const k of keys) ordered[k] = obj[k] ?? ""; return JSON.stringify(ordered);
      }
      function keccakJson(obj) { const s = stableJSONString(obj); const bytes = ethers.toUtf8Bytes(s); return ethers.keccak256(bytes); }
      function buildMerkle(leavesHex) {
        if (leavesHex.length === 0) return { root: ethers.ZeroHash, levels: [] };
        let level = leavesHex.map(h=>h.toLowerCase()); level.sort();
        const levels = [level];
        while (level.length > 1) {
          const next = [];
          for (let i = 0; i < level.length; i += 2) {
            if (i + 1 === level.length) { next.push(level[i]); }
            else {
              const a = level[i], b = level[i+1];
              const [left, right] = a <= b ? [a, b] : [b, a];
              const concat = ethers.concat([ethers.getBytes(left), ethers.getBytes(right)]);
              next.push(ethers.keccak256(concat));
            }
          }
          level = next.sort(); levels.push(level);
        }
        return { root: level[0], levels };
      }
      function buildMerkleProofPath(leavesHex, targetLeaf) {
        const leaves = leavesHex.map((h) => h.toLowerCase());
        const target = targetLeaf.toLowerCase();
        if (!leaves.includes(target)) return [];
        const proof = [];
        let level = [...leaves].sort();
        let current = target;
        while (level.length > 1) {
          const idx = level.indexOf(current);
          if (idx === -1) break;
          const siblingIdx = idx % 2 === 0 ? idx + 1 : idx - 1;
          if (siblingIdx >= 0 && siblingIdx < level.length) {
            proof.push(level[siblingIdx]);
          }
          const nextTemp = [];
          for (let i = 0; i < level.length; i += 2) {
            if (i + 1 === level.length) { nextTemp.push(level[i]); }
            else {
              const a = level[i], b = level[i+1];
              const [left, right] = a <= b ? [a, b] : [b, a];
              const concat = ethers.concat([ethers.getBytes(left), ethers.getBytes(right)]);
              nextTemp.push(ethers.keccak256(concat));
            }
          }
          const parentIdx = Math.floor(idx / 2);
          current = nextTemp[parentIdx];
          level = [...nextTemp].sort();
        }
        return proof;
      }
      async function sha256HexOfFile(file) {
        const buf = await file.arrayBuffer();
        const digest = await crypto.subtle.digest("SHA-256", buf);
        const hex = Array.from(new Uint8Array(digest)).map(b=>b.toString(16).padStart(2,"0")).join("");
        return hex;
      }
      function downloadAs(name, data) { const blob = new Blob([data], { type: "application/json" }); const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = name; a.click(); URL.revokeObjectURL(url); }
      function persistLatestProof(bundle) {
        if (typeof window === "undefined") return;
        try {
          window.localStorage?.setItem("liqpass.latestProof", JSON.stringify(bundle));
          window.dispatchEvent(new CustomEvent("liqpass:proof-updated"));
        } catch (_) {}
      }
      async function uploadToFiles(filename, jsonString) {
        if (typeof fetch === "undefined") return { url: null, fallback: true };
        try {
          const form = new FormData();
          form.append("file", new Blob([jsonString], { type: "application/json" }), filename);
          const res = await fetch("/files/upload", { method: "POST", body: form });
          if (res.ok) {
            const data = await res.json().catch(() => ({}));
            if (data?.url) return { url: data.url, fallback: false };
            if (data?.location) return { url: data.location, fallback: false };
          }
        } catch (err) {
          console.warn("files upload failed", err);
        }
        const fallbackHost = "https://files-demo.liqpass.dev";
        return { url: `${fallbackHost}/${filename}`, fallback: true };
      }
      async function copyToClipboard(text) {
        try {
          if (navigator?.clipboard?.writeText) {
            await navigator.clipboard.writeText(text);
            return true;
          }
          const textarea = document.createElement("textarea");
          textarea.value = text;
          textarea.style.position = "fixed";
          textarea.style.opacity = "0";
          document.body.appendChild(textarea);
          textarea.focus();
          textarea.select();
          const ok = document.execCommand("copy");
          document.body.removeChild(textarea);
          return ok;
        } catch (_) {
          return false;
        }
      }

      function AttestorWorkbench({ exchange = "OKX", isAdmin = false }) {
        const [csvText, setCsvText] = useState(""); const [csvFile, setCsvFile] = useState(null);
        const [rows, setRows] = useState([]); const [headers, setHeaders] = useState([]);
        const [orderId, setOrderId] = useState(""); const [merkleRoot, setMerkleRoot] = useState("");
        const [proofBundle, setProofBundle] = useState(null); const [fileSha, setFileSha] = useState("");
        const [attestUrl, setAttestUrl] = useState(""); const [status, setStatus] = useState("");
        const [txHash, setTxHash] = useState(""); const [hasOnchain, setHasOnchain] = useState(null);
        const chainWritesEnabled = Boolean(isAdmin);
        const notifyCopy = useCallback(async (value, label) => {
          if (!value) return;
          const ok = await copyToClipboard(value);
          setStatus(ok ? `${label} 已复制到剪贴板。` : `复制失败，请手动复制 ${label}。`);
        }, [setStatus]);
        const parsed = useMemo(() => { if (!csvText) return { headers: [], rows: [] }; try { return parseCSV(csvText); } catch (e) { console.error(e); return { headers: [], rows: [] } } }, [csvText]);
        useEffect(() => { setHeaders(parsed.headers); setRows(parsed.rows); }, [parsed.headers, parsed.rows]);
        useEffect(() => {
          if (typeof window === "undefined") return;
          try {
            const storedUrl = window.localStorage?.getItem("liqpass.latestAttestUrl");
            if (storedUrl) setAttestUrl(storedUrl);
          } catch (_) {}
        }, []);

        async function handleFile(f){
          setCsvFile(f);
          setProofBundle(null);
          setMerkleRoot("");
          setTxHash("");
          setAttestUrl("");
          setHasOnchain(null);
          const text = await f.text();
          setCsvText(text);
          try {
            const sha = await sha256HexOfFile(f);
            setFileSha(sha);
          } catch (err) {
            console.warn("failed to hash file", err);
            setFileSha("");
          }
          try {
            const parsedResult = parseCSV(text);
            const hasOrderIdField = parsedResult.headers.some((h) => /id/i.test(h));
            setStatus(hasOrderIdField ? "CSV 已载入，可生成 root。" : "CSV 已载入，但未检测到包含 id 的订单号字段，请检查表头。");
          } catch (err) {
            setStatus(`解析失败：${err?.message ?? err}`);
          }
        }
        async function buildRoot(){
          if (!rows.length){ setStatus("请先上传 CSV"); return; }
          const canonRows = rows.map(r => canonicalizeRow(r, exchange));
          const leaves = canonRows.map(keccakJson);
          const { root } = buildMerkle(leaves);
          setMerkleRoot(root);
          let targetIdx = 0;
          if (orderId) {
            const foundIdx = canonRows.findIndex(row => row.id === orderId);
            if (foundIdx !== -1) targetIdx = foundIdx;
          }
          const targetRow = canonRows[targetIdx] ?? canonRows[0];
          const leafHash = leaves[targetIdx] ?? leaves[0];
          const merkleProof = buildMerkleProofPath(leaves, leafHash);
          const schema = {
            version: "liqpass-proof-v1",
            exchange,
            leafFormat: "keccak256(utf8(JSON.stringify({exchange,id,inst,side,qty,unit,px,pnl,ts})))",
            fields: ["exchange","id","inst","side","qty","unit","px","pnl","ts"]
          };
          const fallbackSha = csvText ? await sha256Hex(csvText) : "";
          const proof = {
            root,
            orderId: targetRow?.id ?? orderId ?? "",
            leafHash,
            merkleProof,
            leafData: targetRow,
            fileSha256: fileSha || fallbackSha,
            schema,
            generatedAt: new Date().toISOString()
          };
          setProofBundle(proof);
          persistLatestProof(proof);
          downloadAs("proof.json", JSON.stringify(proof, null, 2));
          setStatus("Merkle root 与 proof.json 已生成，并写入浏览器缓存。");
        }
        async function genAttestJson(){
          if (!merkleRoot){ setStatus("请先生成 Merkle root"); return; }
          const sha = fileSha || (csvText ? await sha256Hex(csvText) : "");
          const payload = { merkleRoot, chainId: BASE_CHAIN_ID, contract: ATTESTOR_ADDR, dataset: { uri:"", sha256Hex: sha, rows: rows.length }, generator:{ name:"liqpass-web-attestor", version:"0.1.1" }, market:{ exchange, symbols: [], timeWindow:{ startISO:"", endISO:"", timezone: Intl.DateTimeFormat().resolvedOptions().timeZone } }, counts:{ positions: rows.length }, method:{ treeAlgo:"keccak256", leafFormat:"keccak256(utf8(JSON.stringify({exchange,id,inst,side,qty,unit,px,pnl,ts})))", proofFormat:"array<bytes32>" }, createdAt: new Date().toISOString() };
          const json = JSON.stringify(payload, null, 2);
          const filename = `attest_${Date.now()}.json`;
          downloadAs(filename, json);
          setStatus("attest.json 已生成，正在尝试上传到 /files...");
          const { url, fallback } = await uploadToFiles(filename, json);
          if (url) {
            payload.dataset.uri = url;
            setAttestUrl(url);
            setStatus(fallback
              ? `attest.json 已上传到演示 CDN：${url} （请上线后切换为真实 /files 服务）。`
              : `attest.json 已自动上传并回填 URL：${url}`);
            try { window.localStorage?.setItem("liqpass.latestAttestUrl", url); } catch (_) {}
          } else {
            setStatus("上传失败，请手动检查 /files 服务后重试。");
          }
        }
        async function connectAndAttest(){
          if (!chainWritesEnabled) {
            setStatus("公开环境默认禁用链上写入。请在 URL 追加 ?admin=1 或使用白名单域名后刷新。");
            return;
          }
          try {
            if (!window.ethereum){ setStatus("未检测到钱包"); return; }
            const provider = new ethers.BrowserProvider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            const net = await provider.getNetwork();
            if (Number(net.chainId) !== BASE_CHAIN_ID) {
              try { await window.ethereum.request({ method:"wallet_switchEthereumChain", params:[{ chainId: ethers.toQuantity(BASE_CHAIN_ID) }] }); }
              catch { await window.ethereum.request({ method:"wallet_addEthereumChain", params:[{ chainId: ethers.toQuantity(BASE_CHAIN_ID), chainName:"Base Mainnet", nativeCurrency:{ name:"Ether", symbol:"ETH", decimals:18 }, rpcUrls:[BASE_RPC], blockExplorerUrls:["https://basescan.org"] }] }); }
            }
            const signer = await provider.getSigner();
            const c = new ethers.Contract(ATTESTOR_ADDR, ATTESTOR_ABI, signer);
            if (!merkleRoot){ setStatus("缺少 merkleRoot，请先生成"); return; }
            if (!attestUrl || !attestUrl.startsWith("http")){ setStatus("请粘贴 attest.json 的公网 URL"); return; }
            setStatus("发送交易中...");
            const tx = await c.attest(merkleRoot, attestUrl);
            await tx.wait();
            setTxHash(tx.hash); setStatus("已上链。下面可点击 Basescan 查看。");
            const ok = await c.has(merkleRoot); setHasOnchain(ok);
          } catch (e) { console.error(e); setStatus(`失败：${e?.message ?? e}。可留在演示模式或稍后重试。`); }
        }
        async function checkHas(){
          try { const provider = new ethers.JsonRpcProvider(BASE_RPC); const c = new ethers.Contract(ATTESTOR_ADDR, ATTESTOR_ABI, provider); const ok = await c.has(merkleRoot); setHasOnchain(ok); setStatus("已查询链上 has(root)"); }
          catch (e) { setStatus(`查询失败：${e?.message ?? e}`); }
        }

        return (
          React.createElement("div", { className: "min-h-screen bg-slate-50 text-slate-900" },
            React.createElement("div", { className: "max-w-4xl mx-auto p-6" },
              React.createElement("h1", { className: "text-3xl font-bold mb-2" }, "LiqPass — 本地验证 & 一键上链留痕"),
              React.createElement("p", { className: "text-sm opacity-70" }, `不连 ${exchange} API；不上传隐私；所有计算在浏览器完成。`),
              !chainWritesEnabled
                ? React.createElement("div", { className: "mt-3 rounded-xl border border-amber-400/40 bg-amber-200/10 p-3 text-xs text-amber-800" },
                    "链上写入已锁定：演示版仅供取证 / Merkle 生成。管理员可通过 ?admin=1 开启。"
                  )
                : null,
              React.createElement("p", { className: "text-xs uppercase tracking-[0.3em] opacity-60 mb-6" }, `当前选择交易所：${exchange}`),
              React.createElement("div", { className: "bg-white rounded-2xl shadow p-5 mb-6" },
                React.createElement("h2", { className: "text-xl font-semibold mb-2" }, `步骤 1 / 上传 ${exchange} 导出的 CSV`),
                React.createElement("div", { className: "flex items-center gap-3 mb-3" },
                  React.createElement("input", { type: "file", accept: ".csv,text/csv", onChange: (e)=> e.target.files?.[0] && handleFile(e.target.files[0]) }),
                  React.createElement("button", { className: "px-3 py-2 rounded-xl bg-slate-800 text-white", onClick: () => {
                    if (!csvText) return;
                    try {
                      const { headers, rows } = parseCSV(csvText);
                      setHeaders(headers);
                      setRows(rows);
                      const hasOrderIdField = headers.some((h) => /id/i.test(h));
                      setStatus(hasOrderIdField ? "CSV 已重新解析。" : "已解析，但缺少订单号字段。");
                    } catch (err) {
                      setStatus(`解析失败：${err?.message ?? err}`);
                    }
                  } }, "解析")
                ),
                React.createElement("textarea", { className: "w-full h-28 p-3 rounded-xl border", placeholder: "或直接粘贴 CSV 文本...", value: csvText, onChange: e=>setCsvText(e.target.value) }),
                React.createElement("div", { className: "mt-3 rounded-2xl border border-dashed border-slate-300 bg-slate-100 p-3 text-xs text-slate-600 space-y-1" },
                  React.createElement("p", null, "字段模版：id, instId, side, qty, QtyUnit, px, pnl, ts"),
                  React.createElement("p", null, "示例行：123456, BTCUSDT, long, 1, contract, 26000, -150, 2023-10-21T06:30:00Z"),
                  React.createElement("p", { className: "text-[11px] text-slate-500" }, "若解析失败，请检查列头与逗号分隔格式，系统会标出报错行。")
                ),
                React.createElement("div", { className: "text-xs mt-2 opacity-70" }, "提示：OKX 可在「资产 → 订单中心」导出 CSV。")
              ),
              React.createElement("div", { className: "bg-white rounded-2xl shadow p-5 mb-6" },
                React.createElement("h2", { className: "text-xl font-semibold mb-2" }, "步骤 2 / 生成 Merkle Root"),
                React.createElement("div", { className: "flex items-center gap-3 mb-3" },
                  React.createElement("input", { className: "flex-1 border rounded-xl p-2", placeholder: "输入订单号（可选，用于样例展示/校验）", value: orderId, onChange: e=>setOrderId(e.target.value) }),
                  React.createElement("button", { className: "px-3 py-2 rounded-xl bg-slate-800 text-white", onClick: () => buildRoot() }, "生成 Root")
                ),
                merkleRoot && React.createElement("div", { className: "text-sm break-all" }, "merkleRoot：", React.createElement("code", { className: "bg-slate-100 px-2 py-1 rounded" }, merkleRoot))
              ),
              React.createElement("div", { className: "bg-white rounded-2xl shadow p-5 mb-6" },
                React.createElement("h2", { className: "text-xl font-semibold mb-2" }, "步骤 3 / 生成 attest.json 并下载"),
                React.createElement("div", { className: "flex items-center gap-3 mb-3" },
                  React.createElement("button", { className: "px-3 py-2 rounded-xl bg-slate-800 text-white", onClick: genAttestJson }, "生成 & 下载")
                ),
                React.createElement("div", { className: "text-xs opacity-70" }, "系统已尝试将 attest.json 上传至 /files 服务；如需覆盖，可将下载文件连同原始 CSV 手动上传并在下方替换 URL。")
              ),
              React.createElement("div", { className: "bg-white rounded-2xl shadow p-5 mb-6" },
                React.createElement("h2", { className: "text-xl font-semibold mb-2" }, "步骤 4 / 上链留痕（Base 主网）"),
                React.createElement("input", { className: "w-full border rounded-xl p-2 mb-3", placeholder: "粘贴 attest.json 的公网 URL (https://...)", value: attestUrl, onChange: e=>setAttestUrl(e.target.value) }),
                React.createElement("div", { className: "flex items-center gap-3" },
                  React.createElement("button", {
                    className: `px-3 py-2 rounded-xl ${chainWritesEnabled ? "bg-emerald-600 text-white hover:bg-emerald-500" : "bg-slate-200 text-slate-500 cursor-not-allowed"}`,
                    onClick: connectAndAttest,
                    disabled: !chainWritesEnabled
                  }, chainWritesEnabled ? "连接钱包并上链" : "链上写入已关闭"),
                  React.createElement("button", { className: "px-3 py-2 rounded-xl bg-slate-200", onClick: checkHas }, "检查 has(root)")
                ),
                txHash && React.createElement("div", { className: "text-sm mt-3" }, "Tx: ", React.createElement("a", { className: "text-blue-600 underline", target: "_blank", href: `https://basescan.org/tx/${txHash}` }, txHash)),
                hasOnchain !== null && React.createElement("div", { className: "text-sm mt-1" }, "合约 has(root)：", String(hasOnchain))
              ),
              proofBundle && React.createElement("div", { className: "bg-white rounded-2xl shadow p-5 mb-6" },
                React.createElement("h2", { className: "text-xl font-semibold mb-2" }, "步骤 5 / proof.json 已封装"),
                React.createElement("div", { className: "grid gap-1 text-xs text-slate-600" },
                  React.createElement("p", { className: "break-all" }, `orderId: ${proofBundle.orderId || "—"}`),
                  React.createElement("p", { className: "break-all" }, `root: ${proofBundle.root}`),
                  React.createElement("p", { className: "break-all" }, `leafHash: ${proofBundle.leafHash}`),
                  React.createElement("p", { className: "break-all" }, `fileSha256: ${proofBundle.fileSha256}`),
                  React.createElement("p", null, `merkleProof 节点数：${proofBundle.merkleProof?.length ?? 0}`)
                ),
                React.createElement("div", { className: "flex flex-wrap gap-2 mt-3" },
                  React.createElement("button", { className: "px-3 py-2 rounded-xl bg-slate-800 text-white text-xs", onClick: () => notifyCopy(proofBundle.root, "Merkle root") }, "复制 Root"),
                  React.createElement("button", { className: "px-3 py-2 rounded-xl bg-slate-800/80 text-white text-xs", onClick: () => notifyCopy(proofBundle.leafHash, "leafHash") }, "复制 leafHash"),
                  React.createElement("button", { className: "px-3 py-2 rounded-xl bg-slate-200 text-slate-700 text-xs", onClick: () => downloadAs("proof.json", JSON.stringify(proofBundle, null, 2)) }, "重新下载 proof.json")
                )
              ),
              React.createElement("div", { className: "mt-4 text-sm opacity-80" }, status),
              rows.length > 0 && React.createElement("div", { className: "bg-white rounded-2xl shadow p-5 mt-6" },
                React.createElement("h3", { className: "font-semibold mb-2" }, "CSV 预览（前 10 行）"),
                React.createElement("div", { className: "overflow-auto" },
                  React.createElement("table", { className: "min-w-full text-sm" },
                    React.createElement("thead", null,
                      React.createElement("tr", null, headers.map((h,i)=> React.createElement("th", { key: i, className:"px-2 py-1 border-b text-left whitespace-nowrap" }, h)))
                    ),
                    React.createElement("tbody", null,
                      rows.slice(0,10).map((r,idx)=> (
                        React.createElement("tr", { key: idx, className: "odd:bg-slate-50" },
                          headers.map((h,i)=> React.createElement("td", { key: i, className:"px-2 py-1 border-b whitespace-nowrap" }, r[h]))
                        )
                      ))
                    )
                  )
                )
              )
            )
          )
        );
      }

      function HelpCenter() {
        const { locale } = useLocale();
        const isHelpRoute = typeof window !== "undefined" && window.location.pathname.replace(/\/+$/, "") === "/help";
        const [html, setHtml] = useState("");
        const [loading, setLoading] = useState(isHelpRoute);
        const [error, setError] = useState(null);

        const docUrl = locale === "en-US"
          ? "https://raw.githubusercontent.com/wjz5788/leverageguard-attestor/dev/docs/LiqPass_HelpDoc_EN.md"
          : "https://raw.githubusercontent.com/wjz5788/leverageguard-attestor/dev/docs/LiqPass_HelpDoc_CN.md";

        useEffect(() => {
          if (!isHelpRoute) return;
          let cancelled = false;
          setLoading(true);
          setError(null);
          setHtml("");
          fetch(docUrl)
            .then((res) => {
              if (!res.ok) throw new Error(`HTTP ${res.status}`);
              return res.text();
            })
            .then((markdown) => {
              if (!cancelled) setHtml(marked.parse(markdown));
            })
            .catch((err) => {
              if (!cancelled) setError(err?.message || "unknown");
            })
            .finally(() => {
              if (!cancelled) setLoading(false);
            });
          return () => { cancelled = true; };
        }, [docUrl, isHelpRoute]);

        const openLabel = locale === "en-US" ? "Open on GitHub" : "在 GitHub 查看";
        const loadingLabel = locale === "en-US" ? "Loading help document..." : "正在加载帮助文档...";
        const errorLabel = locale === "en-US" ? "Failed to load help document. Please retry." : "帮助文档加载失败，请重试。";

        if (!isHelpRoute) {
          return React.createElement("section", { className: "mx-auto max-w-4xl px-6 py-10" },
            React.createElement("div", { className: "rounded-2xl border border-white/10 bg-white/5 p-6 text-sm text-white/70" },
              React.createElement("p", null, locale === "en-US"
                ? "Help docs now live at /help/. Use this link for sharing and SEO-safe previews."
                : "帮助文档已迁移至 /help/ 路由，可直接分享该链接给用户查阅。"),
              React.createElement("a", {
                className: "mt-3 inline-flex items-center gap-2 rounded-full border border-indigo-400/40 bg-indigo-500/10 px-4 py-2 text-indigo-200 hover:bg-indigo-500/20",
                href: "/help/",
                rel: "noopener noreferrer"
              }, locale === "en-US" ? "Open /help/" : "前往 /help/ 页面")
            )
          );
        }

        return (
          React.createElement("section", { className: "mx-auto max-w-5xl px-6 py-10" },
            React.createElement("div", { className: "flex items-center justify-between gap-3" },
              React.createElement("div", { className: "flex items-center gap-3" },
                React.createElement("span", { className: "flex h-10 w-10 items-center justify-center rounded-full bg-indigo-500/20 text-indigo-300" },
                  React.createElement(HelpCircle, { className: "h-5 w-5" })
                ),
                React.createElement("div", null,
                  React.createElement("h1", { className: "text-2xl font-semibold" }, locale === "en-US" ? "Help Center" : "帮助中心"),
                  React.createElement("p", { className: "text-sm text-slate-400" }, locale === "en-US"
                    ? "Guides for onboarding, claims, and on-chain attestation."
                    : "覆盖开户、申赔与上链存证等关键流程的指引。")
                )
              ),
              React.createElement("a", {
                className: "rounded-full border border-white/10 bg-white/5 px-4 py-2 text-sm text-slate-200 hover:border-indigo-300/60",
                href: docUrl,
                target: "_blank",
                rel: "noreferrer"
              }, openLabel)
            ),
            loading
              ? React.createElement("p", { className: "mt-8 text-sm text-slate-400" }, loadingLabel)
              : error
                ? React.createElement("div", { className: "mt-8 rounded-xl border border-red-500/30 bg-red-500/10 p-4 text-sm text-red-300" },
                    React.createElement("p", null, errorLabel),
                    React.createElement("p", { className: "mt-1 opacity-70" }, error)
                  )
                : React.createElement("article", {
                    className: "prose prose-invert max-w-none mt-8 prose-headings:text-white prose-a:text-indigo-300",
                    dangerouslySetInnerHTML: { __html: html }
                  })
          )
        );
      }

      /* -------------------- App Shell: merge the three views -------------------- */
      function AppShell() {
        const [locale, setLocale] = useState(() => detectInitialLocale());
        useEffect(() => { try { window.localStorage?.setItem("liqpass.locale", locale); } catch(_){} }, [locale]);
        const isHelpRoute = typeof window !== "undefined" && window.location.pathname.replace(/\/+$/, "") === "/help";
        const [view, setView] = useState(() => {
          if (isHelpRoute) return "help";
          if (ADMIN_ENABLED) {
            try {
              const params = new URLSearchParams(window.location.search);
              const forced = params.get("view");
              if (forced) return forced;
            } catch (_) {}
          }
          return "plflow";
        }); // plflow | ux | attestor | help
        const exchange = "OKX";
        const isAdmin = ADMIN_ENABLED;
        const value = useMemo(() => ({ locale, setLocale, tr: (zh, en, vars)=> formatMessage(locale === "en-US" ? (en ?? zh ?? "") : (zh ?? en ?? ""), vars) }), [locale]);
        useEffect(() => {
          if (!isAdmin && !isHelpRoute && (view === "attestor" || view === "help")) {
            setView("plflow");
          }
        }, [isAdmin, isHelpRoute, view]);
        const navItems = [
          { id: "plflow", label: locale === "en-US" ? "Quote & Claim" : "报价 / 申赔" },
          { id: "ux", label: locale === "en-US" ? "Product Experience" : "产品体验" }
        ];
        if (isAdmin) {
          navItems.push(
            { id: "attestor", label: locale === "en-US" ? "Attestor Workbench" : "取证 / 上链" },
            { id: "help", label: locale === "en-US" ? "Help Center" : "帮助文档" }
          );
        }
        const handleNavClick = useCallback((id) => {
          if (id === "help") {
            window.location.href = "/help/";
            return;
          }
          setView(id);
        }, [setView]);

        return (
          React.createElement(LocaleContext.Provider, { value },
            React.createElement("div", { className: "min-h-screen flex flex-col" },
              React.createElement("header", { className: "border-b border-slate-800 bg-slate-950/90 backdrop-blur" },
                React.createElement("div", { className: "mx-auto flex max-w-6xl flex-col gap-3 px-6 py-4 md:flex-row md:items-center md:justify-between" },
                  React.createElement("div", null,
                    React.createElement("div", { className: "flex items-center gap-2" },
                      React.createElement("span", { className: "text-lg font-semibold text-white" }, "LiqPass"),
                      React.createElement("span", { className: "rounded-full border border-white/10 px-2 py-0.5 text-xs text-slate-400" }, "Base Mainnet")
                    ),
                    React.createElement("p", { className: "mt-1 text-xs text-slate-400" }, locale === "en-US" ? "Demo focus: retail quote → purchase → claim. Attestor tools stay gated." : "演示主线：报价 → 购买 → 申赔；取证工具默认后台可见。")
                  ),
                  React.createElement("div", { className: "flex items-center gap-2" },
                    navItems.map(({ id, label }) =>
                      React.createElement("button", {
                        key: id,
                        type: "button",
                        onClick: () => handleNavClick(id),
                        className: `rounded-full px-4 py-2 text-sm transition ${view===id?"bg-indigo-500 text-white shadow-lg shadow-indigo-700/30":"border border-white/10 bg-white/5 text-slate-200 hover:border-indigo-300/60"}`
                      }, label)
                    ),
                    React.createElement("div", { className: "ml-3 flex items-center gap-1 text-xs" },
                      React.createElement("span", { className: "opacity-70" }, locale==="en-US"?"Language:":"语言："),
                      SUPPORTED_LOCALES.map((code) =>
                        React.createElement("button", { key: code, type:"button", onClick: ()=>setLocale(code), className:`rounded-full px-2 py-1 border ${locale===code?"bg-indigo-500 text-white border-indigo-400":"border-white/10 text-slate-200"}` }, LANGUAGE_LABELS[code])
                      )
                    )
                  )
                )
              ),
              React.createElement("main", { className: "flex-1" },
                (() => {
                  if (view === "ux") return React.createElement(LiqPassUX, { key: "ux", exchange });
                  if (view === "attestor") return isAdmin ? React.createElement(AttestorWorkbench, { key: "attestor", exchange, isAdmin }) : React.createElement(PLFlow, { key: "plflow" });
                  if (view === "help") return (isAdmin || isHelpRoute) ? React.createElement(HelpCenter, { key: "help" }) : React.createElement(PLFlow, { key: "plflow" });
                  return React.createElement(PLFlow, { key: "plflow" });
                })()
              ),
              React.createElement("section", { className: "border-t border-slate-900/70 bg-slate-950/80" },
                React.createElement("div", { className: "mx-auto max-w-6xl px-6 py-6" },
                  React.createElement("details", { className: "group rounded-2xl border border-white/10 bg-white/5 p-4 text-xs text-slate-200" },
                    React.createElement("summary", { className: "cursor-pointer text-sm font-medium text-white" }, locale === "en-US" ? "Developer info" : "开发者信息"),
                    React.createElement("div", { className: "mt-3 space-y-2 leading-relaxed" },
                      React.createElement("p", { className: "text-xs text-slate-300" }, locale === "en-US" ? "Base mainnet attestor contract" : "Base 主网 attestor 合约"),
                      React.createElement("p", { className: "break-all font-mono text-[11px] bg-black/40 px-3 py-2 rounded-xl border border-white/10" }, ATTESTOR_ADDR),
                      React.createElement("p", { className: "text-xs text-slate-400" }, locale === "en-US"
                        ? "Append ?admin=1 to the URL (or use an allowlisted domain) to unlock on-chain writes."
                        : "在地址栏追加 ?admin=1（或使用白名单域名）后刷新，可解锁链上写入工具。")
                    )
                  )
                )
              ),
              React.createElement("footer", { className: "py-8 text-center text-xs text-slate-500" },
                locale==="en-US"
                  ? "Note: All flows are front-end prototypes; on-chain calls are mocked unless you connect a wallet on Base."
                  : "说明：以上交互为前端原型；除非连接 Base 钱包，否则链上调用均为演示/模拟。"
              )
            )
          )
        );
      }

      const root = createRoot(document.getElementById("root"));
      root.render(React.createElement(AppShell));
    </script>
</body>
</html>
