用 VS Code + Codex 辅助，按这条最短路径做。我标明每一步是否会要密码。

## A. VS Code 侧准备（本机）

1. 打开 VS Code → 安装扩展：Remote - SSH。
2. 打开 `~/.ssh/config`，追加：

```
Host jp-liqpass
  HostName 103.76.85.191
  User root
  Port 50455
Host us-liqpass
  HostName 107.173.223.175
  User root
  Port 22
```

3. Command Palette → “Remote-SSH: Connect to Host…” → 选 `jp-liqpass`。
   提示：**会要 root 密码**。输入即可。

> 若连不上，用云商控制台的 VNC 打开一台“本地终端”，下面所有命令在那边输入也行。

---

## B. 在 JP 机用 VS Code 修好 deploy 的密钥登录

1. VS Code 左下角显示“SSH: 103.76.85.191”后，打开终端（JP 服务器会话）。
2. 运行：

```bash
adduser --disabled-password --gecos "" deploy || true
usermod -aG sudo deploy || true
install -d -m 700 -o deploy -g deploy /home/deploy/.ssh
nano /home/deploy/.ssh/authorized_keys
```

3. 在你本机 VS Code 打开 `~/.ssh/lg_deploy.pub`，**整行复制**。回到远程 nano 窗口，粘贴，保存（Ctrl+O 回车），退出（Ctrl+X）。
4. 设权限：

```bash
chown -R deploy:deploy /home/deploy/.ssh
chmod 700 /home/deploy/.ssh
chmod 600 /home/deploy/.ssh/authorized_keys
```

5. 确保 sshd 允许公钥：

```bash
grep -qi '^PubkeyAuthentication' /etc/ssh/sshd_config || echo 'PubkeyAuthentication yes' >> /etc/ssh/sshd_config
grep -qi '^AuthorizedKeysFile'   /etc/ssh/sshd_config || echo 'AuthorizedKeysFile .ssh/authorized_keys' >> /etc/ssh/sshd_config
systemctl reload sshd
```

6. 测试从**你本机**无密码登录：

```bash
ssh -i ~/.ssh/lg_deploy -p 50455 deploy@103.76.85.191 'echo OK'
```

预期：直接输出 `OK`，**不再要密码**。

---

## C. US 机同样操作（VS Code Remote-SSH 选 `us-liqpass`）

在 US 机终端执行：

```bash
adduser --disabled-password --gecos "" deploy || true
usermod -aG sudo deploy || true
install -d -m 700 -o deploy -g deploy /home/deploy/.ssh
nano /home/deploy/.ssh/authorized_keys   # 粘贴同一行公钥，保存退出
chown -R deploy:deploy /home/deploy/.ssh
chmod 700 /home/deploy/.ssh
chmod 600 /home/deploy/.ssh/authorized_keys
grep -qi '^PubkeyAuthentication' /etc/ssh/sshd_config || echo 'PubkeyAuthentication yes' >> /etc/ssh/sshd_config
grep -qi '^AuthorizedKeysFile'   /etc/ssh/sshd_config || echo 'AuthorizedKeysFile .ssh/authorized_keys' >> /etc/ssh/sshd_config
systemctl reload sshd
```

本机测试：

```bash
ssh -i ~/.ssh/lg_deploy deploy@107.173.223.175 'echo OK'
```

预期：输出 `OK`，**不再要密码**。

---

## D. VS Code 提交工作流（三个文件，分支 `dev`）

在 VS Code 打开仓库 → 新建：

* `.github/workflows/ci.yml`
* `.github/workflows/deploy-jp.yml`
* `.github/workflows/release-us.yml`

把我之前给你的三段 YAML 原样粘贴保存，**提交到 `dev`**。
提示：此步**不需要任何服务器密码**。

---

## E. GitHub Environments 补齐

你已配好大部分。确认：

* `jp-verify`：`JP_HOST=103.76.85.191`，`JP_PORT=50455`，`JP_USER=deploy`，`JP_PATH=/srv/attestor`，`JP_SSH_KEY=~/.ssh/lg_deploy 私钥全文`，`KNOWN_HOSTS=你生成的6行`。
* `us-web`：已就绪。

此步在网页点选，**不需要密码**。

---

## F. 触发并验证（全程用网页+Actions）

1. 在 GitHub 开一个到 `dev` 的 PR（改 README 也行）→ 等 `ci` 绿灯 → 合并到 `dev`。
2. 查看 Actions `deploy-jp` 日志应看到最后 `curl ... /api/ping` 成功。
3. 浏览器访问 `http://103.76.85.191/api/ping`，应 200。
4. 打标签 `v0.1.0` → 触发 `release-us` → 成功后 US 机 `/srv/web/current/web/__version` 存在。
   这些步骤**不需要服务器密码**。

---

## 常见卡点与处理

* 第 C6 步还在要密码：回 US/JP 机检查
  `ls -ld /home/deploy /home/deploy/.ssh ; ls -l /home/deploy/.ssh/authorized_keys`
  权限必须是 `.ssh=700`，`authorized_keys=600`，属主 `deploy:deploy`。
* VS Code 远程连不上：先用供应商控制台（VNC）执行 B/C 的命令，再回 VS Code。

照此执行。卡在具体哪一步，贴命令与提示行。
