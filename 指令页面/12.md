{"id":"P0-01","title":"订单创建直接信任 paymentTx 造成伪造已支付风险","severity":"P0","area":"us-backend","file":"us-backend/src/services/orderService.ts†L177-L212","evidence":"createOrder 只要传入 paymentTx 就将订单标记为 paid，未校验链上或金库流水","repro_steps":"1) 生成有效 quote；2) 向 POST /orders 提交任意 paymentTx 字符串；3) 返回订单 status=paid 且无链上校验","quick_fix":["在 createOrder 中拒绝没有链上/金库校验结果的 paymentTx","增加调用合约/金库 API 校验 to/token/amount 与 quote 一致","校验失败时回滚订单状态为 pending"],"long_fix":"将支付流程改为：先在链上合约确认 permit2/transfer 事件，再由后端根据事件写入订单；未确认前保持 pending 并提供补偿任务扫描。","eta":"16h","owner":"backend","status":"todo"}
{"id":"P0-02","title":"JP 验证服务返回硬编码 liquidated 结果导致赔付伪造","severity":"P0","area":"jp-verify","file":"jp-verify/main.py†L208-L327","evidence":"normalized_data 固定写死 liquidated=True 和示例字段，未基于 OKX 响应计算","repro_steps":"1) 向 /api/verify 提交任意有效密钥；2) 响应 normalized.position.liquidated 总为 True；3) 赔付判断完全失真","quick_fix":["禁止使用占位 normalized_data，先返回错误提示服务未上线","上线前阻断对 us-backend 的调用","添加集成测试覆盖非爆仓订单的断言"],"long_fix":"实现真实的 OKX 响应解析与条件判断，并将逻辑抽象为可审计函数；引入双人复核确认关键字段映射后再放行。","eta":"24h","owner":"jp-verify","status":"todo"}
{"id":"P1-03","title":"JP 验证服务暴露在公网且缺乏请求签名/重放防护","severity":"P1","area":"jp-verify","file":"jp-verify/main.py†L17-L24","evidence":"全量 CORS * 开放且未对 /api/verify 调用做 HMAC 或 timestamp 验证，validate_timestamp 函数未调用","repro_steps":"1) 观察 CORS allow_origins=*；2) 构造任意 POST 请求即可触发 OKX 带密钥调用；3) 重放同一请求成功","quick_fix":["关闭 CORS 或限制到 US 后端域名","在路由入口校验客户端签名与时间戳","对连续失败加入速率限制"],"long_fix":"在 API 网关层引入双向 TLS / mTLS 并要求所有调用携带 HMAC 签名，结合 Redis 滑动窗口限流与 requestId 幂等存档；部署前置 WAF 限定来源 IP。","eta":"20h","owner":"jp-verify","status":"todo"}
{"id":"P1-04","title":"后端 JWT 与 API 密钥治理不安全","severity":"P1","area":"us-backend","file":"us-backend/src/services/authService.ts†L73-L135","evidence":"AuthService 默认回落到 'dev-secret'，会话/用户信息存放在进程内 Map；APIKey 中间件仅在内存 Map 保存密钥","repro_steps":"1) 未配置 JWT_SECRET 时自动使用弱口令；2) 重启服务后 API key / session 全部失效；3) 缺乏持久化和加密","quick_fix":["部署前强制校验 JWT_SECRET 长度并禁止默认值","APIKey/Session 改为数据库持久化并加盐存储","限制 ApiKey 提交渠道仅限 Authorization 头"],"long_fix":"接入托管密钥服务（AWS KMS / GCP Secret Manager）管理 JWT/ApiKey 秘钥；提供密钥轮换、分环境隔离与审计日志；APIKey 生成时仅返回一次并以 HMAC 摘要入库。","eta":"24h","owner":"backend","status":"todo"}
{"id":"P1-05","title":"透明度页静默切换为随机 mock 数据","severity":"P1","area":"us-frontend","file":"us-frontend/src/pages/TransparencyPage.tsx†L104-L221","evidence":"API 请求失败时直接调用 genMock 返回随机 premium/claims 且未显式告警","repro_steps":"1) 断开后端 transparency API；2) 前端仍展示“真实”保费/赔付曲线；3) 用户无法分辨数据为演示","quick_fix":["当 fallback 启动时显示明显 Banner 并禁止导出","在 UI 中要求用户确认 demo 模式","记录遥测告警后端不可用"],"long_fix":"前端接入签名透明度快照（含 Merkle root 与时间戳）；若未验证签名则页面直接进入维护模式。","eta":"12h","owner":"frontend","status":"todo"}
{"id":"P2-06","title":"API 配置与验证结果在前端明文持久化","severity":"P2","area":"us-frontend","file":"us-frontend/src/utils.ts†L9-L29","evidence":"readKey 与 API Base 明文写入 localStorage；验证抽屉允许下载全量 raw 响应","repro_steps":"1) 在 API 设置页保存 readKey；2) 浏览器 localStorage 可直接读取；3) 点击下载 JSON 得到 raw.trade/order 原始数据","quick_fix":["改存 sessionStorage 并默认遮蔽下载按钮","对敏感字段使用 WebCrypto 加密后再存储","为下载操作增加二次确认与掩码"],"long_fix":"提供后端托管的临时凭证体系，前端仅保存短期 token；验证结果中的 raw 数据按字段脱敏或仅提供哈希摘要供校验。","eta":"16h","owner":"frontend","status":"todo"}
{"id":"P2-07","title":"证据链持久化缺乏父子 root 与存储治理","severity":"P2","area":"evidence","file":"jp-verify/main.py†L137-L160","evidence":"save_evidence 直接写入本地文件夹且 parentRoot 永远为 None，缺少不可变日志或保留策略","repro_steps":"1) 调用 /api/verify；2) 在 reports/evidence/{date} 生成 .json/.root 文件；3) 无链上锚定、无法追溯 parentRoot","quick_fix":["在保存时至少记录上一次 root 并写入 append-only 日志","限制文件系统权限并定期备份","将路径改为可配置的持久存储"],"long_fix":"构建独立证据链服务：以 append-only Merkle tree 维护根哈希并定期发布链上；文件存储使用 WORM 对象存储并加签。","eta":"24h","owner":"secops","status":"todo"}
{"id":"P2-08","title":"JP 验证服务缺乏运维防护","severity":"P2","area":"ops","file":"jp-verify/start.sh†L1-L25","evidence":"start.sh 仅执行 pip install & python main.py，缺少 systemd、资源限制、白名单与重启策略","repro_steps":"1) 查看 start.sh；2) 无任何 ulimit/Restart=always/防火墙；3) 服务异常退出即停机","quick_fix":["提供 systemd 单元或 supervisord 配置并启用 Restart=always","在部署手册中加入 UFW 白名单和 fail2ban","设定 venv 并锁定 requirements 版本"],"long_fix":"以容器化方式部署 jp-verify，结合 Kubernetes HPA、PodSecurityPolicy、NetworkPolicy 实施最小暴露；引入集中化日志与资源告警。","eta":"20h","owner":"infra","status":"todo"}
1）上线红线（P0 列表 + 证据）
伪造支付即可生成 paid 订单：createOrder 仅凭请求体中的 paymentTx 将订单状态置为 paid，完全缺乏链上或金库对账，攻击者可跳过支付直接获得赔付资格。

验证服务返回硬编码强平结果：jp-verify 未解析 OKX 响应而是返回固定 liquidated: True 的示例数据，使任何订单都被视为满足赔付条件，直接导致赔付逻辑被绕过。

以上任意一项未修复前禁止上线。

2）高优先修复路线图
D1-D3（即刻）

下线当前 jp-verify /api/verify 接口或改为显式报错，修补硬编码结果并补充签名/时间戳校验。

调整 createOrder 工作流：支付凭证经合约事件或金库 webhook 校验后才可写 paid 状态，并实现失败回滚与补偿任务。

D4-D7

将 JWT 秘钥、API Key 管理迁移到安全存储（KMS/Secret Manager），同时为 API Key/Session 提供持久化、失效与轮换机制。

为 jp-verify 部署网关限流、来源白名单与日志审计，并把证据落盘改为 append-only 存储，补齐 parentRoot 链路。

D8-D14

透明度页增加“模拟数据”明显提示并接入签名快照；前端停止在 localStorage 明文保存读密钥与验证原始响应。

制定 jp-verify 的 systemd/容器化部署脚本，启用 Restart、资源限制与依赖版本锁定；同时建立集中化告警与备份策略。

3）批量上链策略建议（决策卡）
推荐方案：T-批量窗口 60 秒

窗口 T：60s，满足“购买即上链”在 1 分钟内可见，兼顾 Gas。

聚合阈值 N：最多 10 单/批；若 60s 未达 N 也强制提交。

降级策略：若 2 个连续窗口合约写入失败（链拥堵/回滚），立即切换到即时上链直到恢复；同时回放失败队列。

用户文案：在回执与透明度页提示“订单提交后 ≤60 秒写入 Base，若链路拥堵将自动改为即时上链并补录”。

运维要求：批量任务需记录批次 ID、哈希列表与 Merkle root，失败批次触发 PagerDuty。

4）风控与透明度改进点（用户可见）
在透明度页显示“数据来源：链上签名快照（最后更新时间）”，若 fallback 为演示数据则以红色 Banner 提示。

订单/赔付详情页增加“链上凭证”模块，展示支付与赔付交易哈希、Merkle root 与签名者指纹，支持一键复制。

API 设置页在展示验证结果时默认脱敏（隐藏 raw 字段、二次确认下载），并提醒用户凭证仅用于验证且不会保存。

后端审计日志补充 requestId、调用者身份、幂等键命中结果，以支持事后追踪与风控模型。

C. Go/No-Go 结论

结论：NO-GO（存在 P0 风险未清零）。

健康度评分：功能 25 / 安全 20 / 运维 10 → 55 / 100。

放行条件：至少修复 P0-01、P0-02 并完成 D1-D3 的缓释措施，复测通过后再评估其余高优先项。