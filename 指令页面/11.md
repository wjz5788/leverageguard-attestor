给你两套“可直接复制”的审计提示词：一套全量复审；一套增量回归（只看你这次修改）。都按你项目的真实结构与上线目标来设计，输出严格、可落地。

---

# 全量复审提示词（V2）

> 复制后，只改花括号里的占位符即可。

**角色**：你是资深架构与安全审计官，目标是在1次运行内给出**可执行**的修复清单与上线门槛评估。
**审计对象**：Crypto 零售“杠杆清算保护 / LiqPass”，三段式架构（前端 us-frontend、后端 us-backend、验证 jp-verify），合约在 Base。
**背景**：上线目标是“购买即上链、满足条件即赔付（链上记录）”，前期仅对接 OKX，JP 服务器只做验证与证据链（Merkle root）。
**代码/资源**：

* 仓库：{{REPO_URL，例如 [https://github.com/wjz5788/LiqPass}}](https://github.com/wjz5788/LiqPass}})
* 主要模块：`us-frontend/`、`us-backend/`、`jp-verify/`、`contracts/`、`docs/`、`reports/`
* 运行环境：US（前后端）、JP（验证 8082）、Base（合约）
* 约束：**不要泄露或回显任何用户密钥**，不要输出长段源码，必要时仅给出关键片段路径与行号。

**必须完成的检查面**（逐一给出结论、证据与修复方案）：

1. **合约安全与流程一致性**

   * 购买路径是否**必上链**，赔付触发与额度是否与“参数化定价/阈值”一致；事件（Attested/Claimed/Revoked）是否完整、可追溯；权限与资金流是否有**单点风险**。
   * 检查：访问控制（onlyOwner/roles）、USDC 处理（Permit2/allowance/重入）、价格/阈值边界、溢出/舍入、可冻结与撤销流程、回滚与重放防护。
2. **验证服务（JP-verify）**

   * OKX HMAC/时间戳/重放防护；**从不回显密钥**；`/healthz`、`/api/verify` 行为、**超时与错误码**；证据包（normalized/raw/evidence/perf）结构与**Merkle root**生成/父 root 链。
   * **防火墙**：仅白名单 US-IP 访问 8082；速率限制；日志审计；系统资源配额与崩溃自愈（systemd/Restart=always）。
3. **后端（US-backend）与密钥治理**

   * API 密钥存储与加密（KMS/静态加密/分环境 .env）、最小化可见面（不可被前端拉取）、访问令牌与过期策略、请求签名与重放防护、审计日志字段。
   * 订单→验证→证据落盘→上链的**幂等性**与**补偿机制**。
4. **前端安全与业务闸门**

   * XSS/CSRF/CORS、错误态与风控提示、**API Key 入库与再用**的 UX（显式遮蔽、局部更新）、参数化定价组件的**边界校验**与**只读化**策略。
5. **参数化定价与赔付引擎**

   * 公式：`premium = P(loss) × payout × (1+load) + op_fee` 的**实现一致性**；输入域（杠杆/本金/时段）合法值与舍入策略；**批量上链窗口**的费用-可用性权衡。
6. **证据链与可审计性**

   * 证据 JSON 字段：订单指纹、叶子集合、Merkle root、parentRoot、时间戳、签名者；**不可变日志**与**对外透明页**一致性。
7. **运维与上线门槛**

   * SSH/Fail2ban/UFW/MOSH、系统时钟同步、磁盘/内存阈值告警、进程存活探针、滚动发布与回滚脚本、依赖与镜像固定版本。
8. **合规模块（措辞/地区）**

   * 面向 C 端的表述避免“insurance”等法律风险词；披露“参数化赔付工具”定位与限制；隐私与数据保留策略。

**输出物（必须全部给出）**：

* **A. 审计结论表（JSON Lines）**：每行一个问题，字段如下：
  `id, title, severity(P0/P1/P2/P3), area(contracts/jp-verify/us-backend/us-frontend/ops/pricing/evidence), file(path:line?), evidence(简要日志/路径/配置), repro_steps(复现步骤), quick_fix(1-3步), long_fix(方案), eta(h/d), owner(role), status(todo/wip/done)`
* **B. Markdown 报告**：
  1）**上线红线**（P0 列表+证据）
  2）**高优先修复路线图**（D1-D3/D4-D7/D8-D14）
  3）**批量上链策略建议**（见下“决策卡”）
  4）**风控与透明度改进点**（用户可见）
* **C. Go/No-Go 结论**：基于红线是否清零+健康度评分（0-100）。

**判分与门槛**：

* P0=资金/密钥/合约不可逆风险/验证伪造 → **任一存在即 NO-GO**
* 评分：功能40 + 安全40 + 运维20；≥85 且无 P0 → GO

**附：批量上链策略—决策卡（让你给出具体数值）**

* 选项：

  * **即时上链**：每单直上，Gas 高，最透明
  * **T-批量窗口**（推荐默认）：T=30s/60s/300s 可选；聚合 N 笔购买写入；**失败重试与回填**
  * **离线对账上链**（仅限低风险产品页展示用，不承载赔付条件）
* 需要给出：推荐 T、聚合阈值 N、降级策略（窗口失败→即时）、用户态说明文案（不暴露实现细节）。

**你可以使用的上下文**：仅做静态/语义/配置级审查；若需运行命令，只给出命令清单与预期输出，不实际执行。

---

# 增量回归审计提示词（只看这次改动）

**背景**：我已做了部分修改，需要确认是否引入新风险，并快速给出阻断上线的点与最快修复法。

* 仓库：{{REPO_URL}}
* 比较范围：{{COMMIT_RANGE 或 “自 {{TAG/日期}} 起的所有改动”}}
* 高风险区域优先：contracts、jp-verify 验证与证据链、us-backend 密钥与签名、前端 API Key 流程。

**任务**：

1. 基于 `git diff {{COMMIT_RANGE}}` 的文件与配置变化，列出**潜在回归**与**新引入风险**（按 P0→P3）。
2. 对每个变更，给出：影响面、复现步骤、是否需要数据迁移/回填、**回滚点**和**热修**。
3. 汇总成“**Delta 风险表（JSON Lines）**”+“**两小时修复清单（Markdown）**”。
4. 输出**上线结论**：只要存在 P0 → **立即阻断**并给出最短修复路径；否则给出放行条件与观察指标。

**输出格式**：与全量版的 A/B/C 相同，但只包含**发生变化的条目**，并额外增加字段 `change_type(add/remove/modify)`、`risk_diff(before→after)`。

---

# 速用版（超短指令）

> 适合你频繁触发：“看下我刚改的有没有雷”。

```
对 LiqPass 做一次【增量回归审计】：
- 仓库：{{REPO_URL}}
- 范围：{{COMMIT_RANGE 或 “最近 48 小时”}}
- 先扫 contracts、jp-verify、us-backend，再到前端与运维
- 按 P0→P3 输出 JSON Lines + 2 小时修复清单 + Go/No-Go
- 严禁回显任何密钥；只给出路径、行号与命令清单
```

---

# 小贴士（保证产出可执行）

* 让 AI **必须给出复现步骤**与**命令清单**（而不是泛泛建议）。
* **JSON Lines**便于你后续一键导入任务系统（Jira/Linear）。
* “批量上链窗口”请它给**具体数值**与**降级策略**，避免空话。
* “证据链”一定要求列出**根字段清单**（orderIdHash/leaves/root/parentRoot/timestamps/signer/log-path），确保链上/链下可对照。

---

需要我把模板里的占位符（仓库地址、范围、服务器端口/IP、合约地址）**直接填成你当前项目的版本**，我可以立刻给出一份**已填好的最终提示词**与**示例输出骨架**，方便你马上跑一遍审计。
