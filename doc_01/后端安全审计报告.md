# LiqPass 后端安全审计报告

## 审计概述
- **审计时间**: 2024年
- **审计范围**: 认证/鉴权/输入校验/越权/签名验证
- **审计深度**: 代码级安全分析

## P0 高风险列表

### P0-1: SIWE挑战消息缺乏EIP-4361标准格式
**文件**: `authService.ts:280-300`
**证据**: 
```typescript
private buildChallengeMessage(wallet: string, nonce: string, issuedAt: Date, context: LoginContext): string {
  const domain = process.env.AUTH_CHALLENGE_DOMAIN ?? 'LiqPass';
  const lines = [
    `${domain} wants you to sign in with your Ethereum account.`,
    '',
    `Wallet: ${wallet}`,
    `Nonce: ${nonce}`,
    `Issued At: ${issuedAt.toISOString()}`
  ];
  // 缺少URI、版本、链ID等EIP-4361必需字段
}
```
**风险**: 不符合EIP-4361标准，可能导致签名验证被绕过
**拒绝策略**: 返回错误码 `INVALID_CHALLENGE_FORMAT`，提示文案："挑战消息格式不符合安全标准"
**验收步骤**: 验证挑战消息包含完整的EIP-4361字段

### P0-2: API Key认证缺乏密钥轮换机制
**文件**: `apiKeyAuth.ts:120-150`
**证据**: 
```typescript
// 密钥验证逻辑，但缺乏过期和轮换机制
const isValid = await this.verifySecretHash(keyId, secretFragment);
if (!isValid) {
  await this.recordFailedAttempt(keyId, req.ip);
  return res.status(401).json({
    ok: false,
    code: 'INVALID_API_KEY',
    message: 'Invalid API key or secret'
  });
}
```
**风险**: 长期有效的API密钥一旦泄露，攻击窗口无限
**拒绝策略**: 返回错误码 `API_KEY_EXPIRED`，提示文案："API密钥已过期，请重新生成"
**验收步骤**: 实现密钥过期时间和强制轮换机制

### P0-3: 订单创建缺乏金额上限校验
**文件**: `orders.ts:85-120`
**证据**: 
```typescript
const createOrderSchema = z.object({
  amountUSDC: z.number().positive(), // 仅验证正数，无上限检查
  // ... 其他字段
});
```
**风险**: 可能通过超大金额订单进行资金攻击
**拒绝策略**: 返回错误码 `AMOUNT_EXCEEDS_LIMIT`，提示文案："订单金额超过系统限制"
**验收步骤**: 添加基于用户等级和业务规则的金额上限校验

### P0-4: 权限控制缺乏资源级绑定验证
**文件**: `claims.ts:85-120`
**证据**: 
```typescript
// 仅检查用户ID匹配，缺乏订单与用户的绑定验证
if (!isAdmin && claim.userId !== userId) {
  return res.status(403).json({
    ok: false,
    code: 'FORBIDDEN',
    message: '无权查看此赔付申请'
  });
}
```
**风险**: 用户可能通过修改URL参数访问他人资源
**拒绝策略**: 返回错误码 `RESOURCE_ACCESS_DENIED`，提示文案："无权访问该资源"
**验收步骤**: 实现资源与用户的强绑定验证

## P1 中风险列表

### P1-1: CORS配置依赖环境变量但缺乏默认值
**文件**: `app.ts:25-40`
**证据**: 
```typescript
const allowedOrigins = process.env.ALLOWED_ORIGINS?.split(',') || [];
// 环境变量为空时允许所有来源，存在安全风险
```
**风险**: 生产环境配置错误可能导致跨域攻击
**拒绝策略**: 生产环境强制要求ALLOWED_ORIGINS配置
**验收步骤**: 添加环境检测和严格的白名单验证

### P1-2: 日志记录可能泄露敏感信息
**文件**: `authService.ts:480-500`
**证据**: 
```typescript
await this.recordAuthLog(userId, 'wallet', true, null, context);
// 日志可能包含IP、User-Agent等敏感信息
```
**风险**: 日志泄露可能被用于用户追踪和攻击
**拒绝策略**: 实施日志脱敏和访问控制
**验收步骤**: 建立日志分类和敏感信息过滤机制

### P1-3: 输入校验缺乏深度格式验证
**文件**: 多个路由文件
**证据**: 
```typescript
// 地址格式仅进行基础验证
walletAddress: z.string().min(1)
// 缺乏EIP-55校验和验证
```
**风险**: 无效地址可能导致业务逻辑错误
**拒绝策略**: 返回错误码 `INVALID_FORMAT`，提示文案："输入格式不符合要求"
**验收步骤**: 实现严格的格式验证和标准化处理

### P1-4: 会话管理缺乏并发控制
**文件**: `authService.ts:350-380`
**证据**: 
```typescript
// 会话创建缺乏设备绑定和并发检测
const session = this.createSession(userId);
```
**风险**: 同一账户可能在不同设备同时登录
**拒绝策略**: 返回错误码 `SESSION_CONFLICT`，提示文案："检测到异常登录行为"
**验收步骤**: 实现设备指纹识别和会话并发控制

## 安全防线速查清单

### 防线1: EIP-4361标准SIWE挑战实现
**实施位置**: `authService.ts`
**配置要求**: 
- 挑战消息必须包含完整EIP-4361字段
- 实现链ID验证和域名绑定
- 添加签名重放防护时间窗口

### 防线2: API密钥生命周期管理
**实施位置**: `apiKeyAuth.ts` + 数据库表
**配置要求**:
- 密钥默认有效期90天
- 实现密钥轮换提醒机制
- 添加密钥使用统计和异常检测

### 防线3: 资源级权限中间件
**实施位置**: 新增 `resourceAuthMiddleware.ts`
**配置要求**:
- 实现资源与用户的强绑定验证
- 支持多级权限继承
- 添加权限变更审计日志

### 防线4: 输入校验标准化库
**实施位置**: 新增 `validationSchemas.ts`
**配置要求**:
- 统一地址格式验证(EIP-55)
- 实现金额上限动态配置
- 添加黑名单词过滤

### 防线5: 安全头强化配置
**实施位置**: `app.ts`
**配置要求**:
- 强化Helmet安全头配置
- 实施CSP内容安全策略
- 添加HSTS强制HTTPS

## 总结与建议

LiqPass后端在认证和权限控制方面有较好的基础实现，但仍存在一些关键安全风险需要立即处理。建议优先解决P0级别风险，特别是SIWE标准合规性和API密钥生命周期管理。同时，通过实施上述5条安全防线，可以显著提升系统的整体安全性。