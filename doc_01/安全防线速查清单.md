# LiqPass 安全防线速查清单

## 防线1: EIP-4361标准SIWE挑战实现

### 实施位置
- **文件**: `apps/us-backend/src/services/authService.ts`
- **方法**: `buildChallengeMessage()`
- **行号**: 280-300

### 配置要求
```typescript
// 标准EIP-4361挑战消息格式
const challengeMessage = `${domain} wants you to sign in with your Ethereum account:
${walletAddress}

URI: ${requestUri}
Version: 1
Chain ID: ${chainId}
Nonce: ${nonce}
Issued At: ${issuedAt}
Expiration Time: ${expirationTime}
Resources:
- ${resourceUrl}`;
```

### 立即行动项
1. 修改 `buildChallengeMessage` 方法实现完整EIP-4361格式
2. 添加链ID验证（环境变量 `REQUIRED_CHAIN_ID`）
3. 实现签名重放防护（5分钟时间窗口）

### 验收标准
- [ ] 挑战消息包含所有EIP-4361必需字段
- [ ] 签名验证通过率100%
- [ ] 重放攻击被有效阻止

---

## 防线2: API密钥生命周期管理

### 实施位置
- **文件**: `apps/us-backend/src/middleware/apiKeyAuth.ts`
- **数据库**: 新增 `api_key_expiry` 字段
- **配置**: 环境变量 `API_KEY_MAX_AGE=90d`

### 配置要求
```typescript
// API密钥验证逻辑增强
const isExpired = apiKey.createdAt < Date.now() - config.maxAge;
if (isExpired) {
  throw new AuthError('API_KEY_EXPIRED', 'API密钥已过期');
}

// 密钥轮换提醒（提前7天）
const shouldRotate = apiKey.createdAt < Date.now() - (config.maxAge - 7*24*60*60*1000);
if (shouldRotate) {
  // 发送轮换提醒
}
```

### 立即行动项
1. 数据库表添加 `expires_at` 字段
2. 修改API密钥验证逻辑包含过期检查
3. 实现密钥轮换提醒机制

### 验收标准
- [ ] 过期API密钥被拒绝访问
- [ ] 密钥轮换提醒正常工作
- [ ] 密钥使用统计准确

---

## 防线3: 资源级权限中间件

### 实施位置
- **新文件**: `apps/us-backend/src/middleware/resourceAuthMiddleware.ts`
- **集成**: 替换现有权限检查逻辑
- **配置**: 资源权限映射表

### 配置要求
```typescript
export class ResourceAuthMiddleware {
  static forOrder(orderId: string) {
    return async (req: Request, res: Response, next: NextFunction) => {
      const userId = req.auth?.userId;
      const order = await orderService.getOrder(orderId);
      
      if (!order || order.userId !== userId) {
        return res.status(403).json({
          code: 'RESOURCE_ACCESS_DENIED',
          message: '无权访问该资源'
        });
      }
      next();
    };
  }
}
```

### 立即行动项
1. 创建资源权限中间件
2. 修改订单、赔付等路由使用新中间件
3. 实现权限变更审计日志

### 验收标准
- [ ] 资源访问权限验证100%准确
- [ ] 越权访问被有效阻止
- [ ] 权限变更有完整审计记录

---

## 防线4: 输入校验标准化库

### 实施位置
- **新文件**: `apps/us-backend/src/utils/validationSchemas.ts`
- **集成**: 所有路由输入验证
- **配置**: 验证规则配置文件

### 配置要求
```typescript
export const validationSchemas = {
  // EIP-55校验和地址验证
  ethereumAddress: z.string().refine((addr) => {
    return /^0x[a-fA-F0-9]{40}$/.test(addr) && isChecksumAddress(addr);
  }, 'Invalid Ethereum address'),
  
  // 金额上限验证（动态配置）
  amountUSDC: z.number().positive().max(config.maxOrderAmount),
  
  // 黑名单词过滤
  safeText: z.string().refine((text) => {
    return !blacklistWords.some(word => text.toLowerCase().includes(word));
  }, 'Contains prohibited content')
};
```

### 立即行动项
1. 创建标准化验证库
2. 统一所有路由的输入验证
3. 实现动态配置管理

### 验收标准
- [ ] 所有输入验证通过标准化库
- [ ] 无效输入被100%拦截
- [ ] 验证规则可动态配置

---

## 防线5: 安全头强化配置

### 实施位置
- **文件**: `apps/us-backend/src/app.ts`
- **配置**: Helmet安全头配置
- **环境**: 生产环境专用配置

### 配置要求
```typescript
// 强化Helmet配置
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      scriptSrc: ["'self'", "'unsafe-inline'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      imgSrc: ["'self'", "data:", "https:"],
    },
  },
  hsts: {
    maxAge: 31536000,
    includeSubDomains: true,
    preload: true
  }
}));

// 生产环境专用配置
if (process.env.NODE_ENV === 'production') {
  app.set('trust proxy', 1); // 信任第一个代理
}
```

### 立即行动项
1. 强化Helmet安全头配置
2. 实施CSP内容安全策略
3. 添加HSTS强制HTTPS

### 验收标准
- [ ] 安全头在所有响应中正确设置
- [ ] CSP策略有效阻止XSS攻击
- [ ] HSTS头强制HTTPS连接

---

## 总结

这5条安全防线覆盖了认证、授权、输入验证和传输安全等关键领域，实施后可以显著提升LiqPass系统的整体安全性。建议按优先级顺序逐步实施，并建立相应的监控和审计机制。