# LiqPass 仓库静态审查报告

## 🔴 红灯清单（P0→P2）
| 严重级别 | 模块/文件:行号 | 证据摘要 | 影响 | 建议修复 | 验收步骤 |
| --- | --- | --- | --- | --- | --- |
| P0 | `apps/us-backend/src/services/contractListenerService.ts:225-255` | `validateEvent` 将链上 `chainId` (`BigInt`) 与 `provider.getNetwork().chainId` (`number`) 用 `!==` 比较，类型不同导致每次都抛出 `链ID不匹配`。 | PremiumPaid 事件永远被 reject，链上回填永远不会触发，24h爆仓保链路卡死。 | 统一比较类型（如将网络链ID也转为 `BigInt` / `BigInt(network.chainId)`，或先转成 `number`），并添加单位测试。 | 启动服务 (`npm run dev`)，模拟 `PremiumPaid` 事件并确认 `contract_events` 有记录且订单状态变为 `paid`（或通过现有监听脚本观察 `console.log` 不再报 `链ID不匹配`）。 |
| P1 | `apps/us-backend/src/middleware/enhancedAuth.ts:33-80` | 中间件接受 `requiredPermissions` 配置，但 `middleware` 函数内部没有任何权限检查，只要通过 JWT/API Key 即刻 `handleSuccess`。 | 所有受保护路由（订单、赔付、管理）没有细粒度授权，任意任意认证凭证都能调用 `claims`、`payment-proofs` 等接口。 | 在认证成功后从 JWT / API Key 中读取权限/作用域，与 `requiredPermissions` 逐一比对，不满足则返回 403，并记录审计日志。 | 使用缺少权限的 JWT/API Key 访问 `/api/v1/claims`，确认返回 403 并且 `X-Auth-Identity` 头仍然打印；用有效权限凭证则通过。 |
| P1 | `apps/us-backend/src/services/orderService.ts:295-311` | `markPaidByWalletAndAmount` 仅依赖钱包地址 + 6 位金额，在事件中没有比对 `orderId` / `quoteHash`，先以时间倒序取第一个 pending。 | 恶意或重放事件可以选中另一个订单完成支付，错误标记 order 状态导致错账/赔付错误。 | 新增 `order` ↔ `quoteHash/orderId` 索引，事件处理时先用链上 `orderId`/`quoteHash` 精准定位订单，再才允许 `paid`；不应再仅靠金额。 | 构造两个相同钱包+金额的订单，先后发送两个 PremiumPaid 事件（其中一个 orderId/quoteHash 匹配订阅），确认只有匹配的订单被标记 `paid`。 |
| P1 | `apps/us-backend/src/services/orderService.ts:40-47` | `OrderService` 所有报价、订单信息都存在内存 `Map`，不读写数据库。 | 服务重启会丢失所有订单/quote，链上事件取不到对应订单，审计链路被打断；无法满足 MOP-1 “链上事件→入库→可审计日志” 要求。 | 将订单/quote 持久化到迁移好的 SQLite（可复用 `orderServiceDb` 框架），启动时加载旧数据，并在 `createOrder`/`markPaid...` 内同步状态。 | 创建订单、重启服务、调用 `/api/v1/orders/:id`，确认仍返回状态并且 `contract_events` + `orders` 表可以关联（`sqlite3 data/us-backend.db 'select ...'`）。 |
| P1 | `apps/us-backend/src/services/authService.ts:77-85` | `AuthService` 在找不到 `process.env.JWT_SECRET` 时直接套用 `'dev-secret'`，且没有内部 fail-fast。 | 一旦部署时 env 配置漏了 `JWT_SECRET`（或绕过 `npm start`）就可以用公开的 `'dev-secret'` 伪造 JWT，绕过所有认证。 | 将 JWT 秘钥的检查移到运行时（构造函数中或 `EnvValidator` 中）并抛错，不允许使用 `dev-secret`。 | 删除 `JWT_SECRET` 或改为空值后直接 `npm run dev`，确认服务在日志中报错并退出；重新提供安全秘钥后正常启动。 |

## ✅ 合规性矩阵
| 项目 | 状态 | 说明 |
| --- | --- | --- |
| 只追加而不破坏事件/接口/数据库契约？ | ✓ | 所有代码都在当前契约基础上追加行为，事件监听仍订阅 `PremiumPaid`，路由路径（如 `/api/v1/claims`）与数据库结构（migrations/0xx.sql 系列）未见重命名或删除。 |
| 启动时 env 缺失是否 fail-fast？ | ✗ | 虽然 `scripts/envCheck.mjs` 提供了 `JWT_SECRET`+keys 的检查（预启动 hook），但 `AuthService` 构造函数仍会回退到 `'dev-secret'`，没有代码级别 fail-fast，部署遗漏这个 env 就直接用公开密钥。 |
| 订单状态是否仅由链上事件驱动（默认 pending）？ | ✗ | `createOrder` 将 `paymentStatus/status` 初始化为 `pending`，但唯一的状态更新 `markPaidByWalletAndAmount` 是按钱包+金额匹配，缺少事件 `orderId`/`quoteHash` 绑定，链上事件可以错误地驱动其他订单。 |
| 审计日志是否能串起一次订单全链路？ | ✗ | `contract_events` 表里记录事件，`OrderService` 仅在内存维护订单，重启后订单记录消失，无法将事件关联到具体订单，审计链路中断。 |

## 🔧 最小改动修复序列（每步 ≤30min）
1. **硬化 JWT 密钥检查** — 在 `AuthService` 构造器或 `EnvValidator` 中抛出错误而非使用 `'dev-secret'`，确保任何启动都必须提供 ≥32 字符的 `JWT_SECRET`。回滚：恢复原始 fallback。验证：删除 `JWT_SECRET` 重新 `npm run dev`，应在启动时报错并退出。影响：防止令牌伪造攻击。
2. **修正链 ID 比对** — 将 `ContractListenerService.validateEvent` 中的 `chainIdBigInt !== network.chainId` 替换为 `chainIdBigInt !== BigInt(network.chainId)`（或者把两端都转为 `number`），消除类型差导致的误判。回滚：还原标题比较。验证：重启监听器并发出链上 PremiumPaid 事件，确认不再抛 `链ID不匹配` 且 `contract_events` 表插入成功。影响：恢复链事件入库与订单回填。
3. **实现权限检查** — 在 `EnhancedAuthMiddleware.middleware` 的 `handleSuccess` 之前校验 `authInfo`（JWT profile/ API key scopes）是否包含 `fullConfig.requiredPermissions`，权限不足返回 403，并写入审计。回滚：删除权限校验逻辑。验证：用无权限 JWT 访问 `/api/v1/claims` 仍得 403；有权限的凭证继续通过。影响：封闭关键接口，防止横向越权。
4. **建立事件与订单的稳定索引 + 持久化** — 让 `OrderService` 在创建订单时写入 SQLite（或使用已有 `orderServiceDb`），同时记录链上可校验的标识，如 `orderIdHash/quoteHash`；`ContractListenerService` 通过该索引而非钱包+金额将订单置为 `paid`。回滚：退回到只读内存实现。验证：创建订单后重启服务并查询 `/api/v1/orders/:id`、`sqlite3` 表，确认订单仍在库；发 PremiumPaid 事件时通过订单索引而非纯金额匹配。影响：保证数据不丢失，事件只能作用于对应订单。 |

## ✅ DoD 勾选
| 检查项 | 状态 | 说明 |
| --- | --- | --- |
| TypeCheck | ✗ | 未执行（没有运行 `npm run typecheck`/`tsc --noEmit`）。
| Lint | ✗ | 未执行（仓库未提供统一 lint，需补充后运行）。
| env:check | ✗ | 未执行（虽然存在 `apps/us-backend/scripts/envCheck.mjs`，但本次审查未实际调用）。
| 迁移 dry-run | ✗ | 未执行（未在 SQLite 上运行 `npm run migrate` 或 `sqlite3 ... < migration`）。
| 最小 e2e（下单→监听→入库） | ✗ | 未执行（未运行链路脚本或集成测试）。
