# 约束与索引补充（数据层 SSOT）

## 目的
这份文档是数据库层面的“主文档/Single Source of Truth”，任何改库、改约束、补索引都必须先对照这里。它只关心数据模型、约束、索引、审计与幂等，不讨论接口、业务算法或前端。

## 范围声明
- **全局口径**：金额字段必须使用微 USDC 整数（`*_usdc_6d` / `*_usdc` + `*_min_unit`）；链上记录附带 `amount_token_raw` + `token_decimals`（未来准入）以支持任意精度；时间戳统一用 UTC/ISO（数据库默认 `CURRENT_TIMESTAMP`、代码层 `Date.toISOString()`）。
- **枚举/取值域**：每张表的状态值必须被列出、审核通过才能扩展；无效值不写入。
- **唯一性/不变量**：钱包地址唯一归属、链上 `tx_hash` + `log_index` 唯一、报价/订单/凭证等幂等键不可重复。
- **外键与引用**：先有用户/API key→再有订单→再有验证/证据/理赔；`order_references` 统一暴露外部指针。
- **审计边界**：`audit_events` 永远只追加；整个流程只认钱包登录，email 分支必须被禁用/视作历史，所有实时登录均走 `wallet_login_challenges`。
- **索引策略**：常用查询必须靠显式索引命中，索引用途需要在表旁说明。
- **幂等与对账**：`idempotency_store`/`idempotency_keys` + `order_references` 先登记再归属。
- **隐私与留存**：敏感原文不入库；API 密钥只存 `enc_*` 或 `enc_payload`（BLOB/JSON），JIT 解密；审计可追溯且最小权限。
- **验收清单**：立项/PR 前逐条对照本页红线，冲突以本页为准。
- **新项目默认**：直接根据本页建表或字段，不在本文档里写迁移脚本。

## 现状概览（项目中已有的表/约束）
| 模块 | 表 / 关键字段 | 约束与索引 | 来源 |
| --- | --- | --- | --- |
| Auth & Users | `users(wait)` `email/wallet_address` `status IN ('active','inactive','suspended')` | `idx_users_email`, `idx_users_wallet`; `sessions` 通过 `login_type` 标记 wallet；`wallet_login_challenges` 支持 SIWE | `apps/us-backend/src/database/migrations/002_org_structure.sql`、`005_auth_sessions.sql`、`011_wallet_login_challenges.sql` |
| API Key & Credentials | `api_keys / api_credentials` 加密字段 `enc_payload`、`enc_api_key` 等 | `FOREIGN KEY(user_id)`, `UNIQUE (user_id, exchange, label/key_alias)`，`idx_api_user_exchange` | `002_verify_schema.sql`, `003_policy_claim_payout.sql`, `008_api_keys.sql` |
| Orders & Quotes | `orders`（pending/paid/active/expired/claimed）、`quotes`、`skus`、`products`、`purchase_orders` | `idx_orders_user`, `idx_orders_status`, `uniq_po_idem`, `idx_quotes_consumed`, `idx_skus_status` | `010_persist_memory_tables.sql`, `003_purchase_orders.sql` |
| Contract & Listener | `contract_events`（`UNIQUE(tx_hash,log_index)`）、`payment_proofs`（pending/confirmed/failed）、`order_payments`、`payout_txs` | 对 `tx_hash` 建唯一索引，`idx_order_payments_status`、`idx_ptx_status`、`idx_payment_proofs_status` | `001_create_contract_events.sql`、`004_order_payments.sql`、`006_payment_proofs.sql`、`007_payout_txs.sql` |
| Verification / Evidence | `verification_jobs` (`queued`/`in_progress`/`completed`/`failed`)、`evidence_bundles`、`merkle_roots` | `FOREIGN KEY(job_uid)`, `idx_vjobs_status`, `idx_evi_hash`, `idx_mrk_period` | `003_policy_claim_payout.sql` |
| Claims & Payouts | `claims / claims_v2`（pending/approved/rejected/paid）、`payouts` | `FOREIGN KEY`, `idx_claims_status`, `idx_payouts_tx`, `idx_ptx_claim` | `002_verify_schema.sql`、`003_policy_claim_payout.sql` |
| Audit / Transparency | `audit_logs`、`audit_events`（purchase/claim_paid/verify_* 等） | `idx_evt_type_ts`, `idx_evt_order`, `idx_evt_tx`；表只允许 `INSERT`，任何更新/DELETE 都需有专项说明 | `002_verify_schema.sql`、`008_audit_events.sql` |
| Idempotency & References | `idempotency_store`、`idempotency_keys`（scope + expires）、`order_references` | `UNIQUE(idempotency_key)`, `idx_idempotency_expires`, `FOREIGN KEY(order_id)`, `idx_order_refs_type` | `010_idempotency_store.sql`、`010_persist_memory_tables.sql` |
| Scheduler / Cursor | `event_cursors`、`verification_jobs`、`payment_links` | `UNIQUE(cursor_key)`, `idx_sessions_expires`, `idx_pl_user` | `001_initial_schema.sql`、`005_auth_sessions.sql` |

## 具体约束 & 说明

### 1. 全局命名与精度
- 所有金额使用 `premiumUSDC_6d` / `principal_usdc` / `amount_min_unit`（micro units）；后续链上记录必须再加 `amount_token_raw` + `token_decimals` 字段，并记录 `token` 合约地址（见 `payment_proofs`, `order_payments`, `payout_txs`）。
- 所有时间戳默认 UTC/ISO，数据库字段放 `TIMESTAMP DEFAULT CURRENT_TIMESTAMP`，代码调用 `toISOString()`，禁止带本地时区。

### 2. 枚举与状态机
- `orders.status`: `pending` → `paid` → `active` → `expired` → `claimed`; `payment_status`: `pending`, `awaiting_payment`, `paid`, `failed`。
- `purchase_orders.status`: `pending`, `paid`, `failed`；`verification_jobs.status`: `queued`, `pending`, `in_progress`, `completed`, `failed`。
- `payment_proofs/order_payments/payout_txs.status`: `pending`, `confirmed`, `failed`。
- `claims.status`: `pending`, `approved`, `rejected`, `paid`（`claims_v2` 对应字段同样受限）。
- `skus.status`: `active` / `inactive`。
- `audit_events.event_type` 目前限定为 `purchase`, `claim_paid`, `reserve_topup`, `verify_pass`, `verify_fail`，新增类型需要提前登记。
- `login_type` 只允许 `wallet`（虽然代码仍保留 `email` 枚举，生产环境中须强制不暴露该分支；所有新 session 必须来自 `wallet_login_challenges`）。

### 3. 唯一性 / 不变量
- `users.id`, `sessions.token`, `api_keys.id`, `api_credentials.id` 均为主键；`users.email`/`wallet_address`需唯一索引；钱包登录后 `user.last_login_at` 更新但 `wallet_address` 不得重复归属。
- `orders.id`/`order_id`/`quote.id`/`purchase_orders.id`、`policy_uid`、`claim_uid`、`payout_uid`、`evidence_uid`、`payment_proofs.tx_hash`、`order_payments.tx_hash`、`payout_txs.tx_hash`、`contract_events(tx_hash,log_index)` 均不能重复。
- `api_credentials`、`api_keys` 限制 `(user_id, exchange, label)` 唯一；`idempotency_key`、`quotes.id`、`order_references.external_ref` 唯一。
- `order_references` 记录外部 `ref_type`（`payment_proof`/`contract_event`/`api`）与内部 `order_id`，所有对外 API 用该表统一返回 order_id。

### 4. 外键与依赖顺序
1. 用户表 `users` → API 凭据 `api_keys/api_credentials` → `orders`/`policies`/`purchase_orders`。
2. 订单 → `verification_jobs` → `evidence_bundles` → `claims_v2` → `payouts`/`payout_txs`。
3. `payment_proofs/order_payments` → `purchase_orders`；`order_references` 可指向前端/链上对象。
4. `idempotency_store/idempotency_keys` 只是写入日志，不建外键，但按 `user_id` 建索引方便追踪。

### 5. 审计边界
- `audit_events`、`audit_logs` 仅追加：写入时使用 `INSERT`, 后续只允许 `UPDATE`/`DELETE` 在法务/审计指定的紧急流程里，并需发起专门 PR。
- 任何敏感审计（API key访问、登录）都要写 `event_type`、`resource_type/id`、`tx_hash`，并在 `audit_events` 上加 `idx_evt_tx` 支持对账。
- Transparent 页面定期从 `audit_events` 拉取事件，因而该表最大检索依赖 `idx_evt_type_ts`、`idx_evt_tx`、`idx_evt_order`。

### 6. 索引担保
- `orders(user_id, status)`、`orders(status, created_at)`、`quotes(user_id, expires_at)`、`payment_proofs(status)`、`order_payments(tx_hash)`、`payout_txs(status, created_at)` 等索引都是必须的，用于常规查询/对账。
- 新增字段涉及查询热点（wallet、tx、status）必须补对应索引（可参考现有 `idx_*` 命名方案）。
- `order_references`/`idempotency_keys` 需在 `order_id` / `ref_type` / `scope` 上保持索引，避免线性扫描。

### 7. 幂等与对账流程
- 新订单先生成 `quotes`（带 `idempotency_key`），客户端复用该 key 提交 `purchase_orders`、`orders`；`orderService` 里先写 `idempotency_keys`/`order_references`，再创建订单，确保“外部证据先登记再归属”。
- `idempotency_store` 只写响应快照；`idempotency_keys` 仅用于 API，`expires_at` = `created_at + TTL`，并需定时清理。

### 8. 隐私与留存
- 所有密钥字段使用 `enc_*` 前缀或 `enc_payload` JSON（`api_secrets`, `api_credentials`, `api_keys`）并只在 JIT 解密；不允许存 raw API key、secret、passphrase。
- `payment_links` 仅保存 `url`, `product`, `symbol`, `amount`, `duration`, `status`，不存用户 API 详情。
- `audit_events.meta_json` 只能存脱敏数据，若包含原始请求体需先清洗。

### 9. 验收清单（PR / 合库前红线）
1. 是否按 `*_usdc_6d` / `amount_min_unit` 命名；是否有 token-decimals 字段？
2. 相关枚举值有没有在本页或 Migration 中列出；有变更必须加 CHECK 或更新文档。
3. 所有关联字段都有对应外键 + 索引（`FOREIGN KEY` + `idx_*`）。
4. 缓存/幂等表新增一条记录前有没有写 `idempotency_keys/store` + `order_references`。
5. 是否有审计事件需要写入 `audit_events`；是否配套 `INSERT`。
6. 敏感数据是否仅以 `enc_*` 存储，是否有审计轨迹。

## 当前差异 / 待补齐
- 现有迁移中常见字段（`amount_min_unit`、`amount_usdc`）已经覆盖了 `payment_proofs/order_payments/payout_txs`，但尚未在所有表中统一 `token_decimals`。引入新链资产需补齐。
- `authService` 兼容 `email` 登录；但 SSOT 明确业务面只认 `wallet`，开发/部署时要把 `email` 相关分支的路由/Schema 视作“历史数据”，并在配置中禁用。
- 需在数据库 Schema 文档 `05-数据库Schema_v1.1.md` 中指向本文件，使后续 PR 直接评估覆盖率。

## 结语
本文件即为当前项目数据库层面的 SSOT，自此以后的表、索引、约束变更都需围绕这里开展。参考已有 Log/迁移，确认本地数据库满足上述约束再进行业务开发。
