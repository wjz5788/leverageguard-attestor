<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LiqPass Prototype</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
      body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    </style>
  </head>
  <body class="bg-slate-950 text-slate-100">
    <div id="root"></div>

    <script type="module">
      import React, { useEffect, useMemo, useState, useCallback } from "https://esm.sh/react@18.2.0";
      import { createRoot } from "https://esm.sh/react-dom@18.2.0/client";
      import { ethers } from "https://esm.sh/ethers@6.9.0";

      const BASE_CHAIN_ID = 8453;
      const BASE_RPC = "https://mainnet.base.org";
      const ATTESTOR_ADDR = "0x9552b58d323993f84d01e3744f175f47a9462f94";
      const ATTESTOR_ABI = [
        "function attest(bytes32 root, string uri)",
        "function has(bytes32) view returns (bool)"
      ];

      const SUPPORTED_LOCALES = ["zh-CN", "en-US"];
      const LANGUAGE_LABELS = { "zh-CN": "中", "en-US": "EN" };

      function formatMessage(template, vars = {}) {
        if (typeof template !== "string") return "";
        return template.replace(/\{(\w+)\}/g, (_, key) =>
          key in vars ? String(vars[key]) : `{${key}}`
        );
      }

      const LocaleContext = React.createContext({
        locale: "zh-CN",
        setLocale: () => {},
        translate: (zh, en, vars) => formatMessage(zh, vars)
      });

      function useLocale() {
        return React.useContext(LocaleContext);
      }

      function useTranslate() {
        const { translate } = useLocale();
        return translate;
      }

      function makeLocalizedMessage(zh, en, vars = {}) {
        return {
          zh: formatMessage(zh ?? "", vars),
          en: formatMessage(en ?? zh ?? "", vars)
        };
      }

      function getLocalized(message, locale) {
        if (message == null) return "";
        if (typeof message === "string") return message;
        if (typeof message === "object") {
          if (message[locale]) return message[locale];
          if (message.zh) return message.zh;
          if (message.en) return message.en;
          const first = Object.values(message)[0];
          if (typeof first === "string") return first;
        }
        return String(message);
      }

      function detectInitialLocale() {
        if (typeof window !== "undefined") {
          try {
            const stored = window.localStorage?.getItem("liqpass.locale");
            if (stored && SUPPORTED_LOCALES.includes(stored)) return stored;
          } catch (_) {}
          if (typeof navigator !== "undefined") {
            const navLang = navigator.language || navigator.userLanguage;
            if (typeof navLang === "string" && navLang.toLowerCase().startsWith("en")) {
              return "en-US";
            }
          }
        }
        return "zh-CN";
      }

      function LocalizedRoot() {
        const [locale, setLocale] = useState(() => detectInitialLocale());
        const translate = React.useCallback(
          (zh, en, vars = {}) => {
            const template = locale === "en-US" ? (en ?? zh ?? "") : (zh ?? en ?? "");
            return formatMessage(template, vars);
          },
          [locale]
        );
        useEffect(() => {
          try {
            window.localStorage?.setItem("liqpass.locale", locale);
          } catch (_) {}
        }, [locale]);
        const value = useMemo(
          () => ({ locale, setLocale, translate }),
          [locale, translate]
        );
        return React.createElement(
          LocaleContext.Provider,
          { value },
          React.createElement(RootApp)
        );
      }

      function parseCSV(text) {
        const lines = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n").split("\n");
        if (!lines.length) return { headers: [], rows: [] };
        const headers = splitCSVLine(lines[0]);
        const rows = [];
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;
          const cols = splitCSVLine(line);
          const row = {};
          headers.forEach((h, idx) => (row[h.trim()] = (cols[idx] ?? "").trim()));
          rows.push(row);
        }
        return { headers, rows };
      }

      function splitCSVLine(line) {
        const out = [];
        let cur = "";
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          if (ch === '"') {
            if (inQuotes && line[i + 1] === '"') {
              cur += '"';
              i++;
            } else {
              inQuotes = !inQuotes;
            }
          } else if (ch === "," && !inQuotes) {
            out.push(cur);
            cur = "";
          } else {
            cur += ch;
          }
        }
        out.push(cur);
        return out;
      }

      function canonicalizeRow(row, exchange = "OKX") {
        const pick = (keys) => {
          for (const k of keys) if (k in row && String(row[k]).length) return String(row[k]).trim();
          return "";
        };
        // TODO: 按 exchange 做字段映射以兼容不同交易所的 CSV 格式。
        const id = pick(["id", "ID", "orderId", "订单ID", "关联订单id"]);
        const inst = pick(["交易品种", "instId", "Instrument", "Symbol"]);
        const side = pick(["交易类型", "side", "方向", "Side"]);
        const qty = pick(["数量", "size", "Qty", "FilledQty", "accFillSz"]);
        const unit = pick(["交易单位", "QtyUnit", "Unit"]);
        const px = pick(["成交价", "fillPx", "price", "Price"]);
        const pnl = pick(["收益", "pnl", "RealizedPnL", "盈亏"]);
        const ts = pick(["时间", "ts", "Time", "timestamp"]);
        return {
          exchange,
          id,
          inst,
          side,
          qty,
          unit,
          px,
          pnl,
          ts,
        };
      }

      function stableJSONString(obj) {
        const keys = ["exchange","id","inst","side","qty","unit","px","pnl","ts"];
        const ordered = {};
        for (const k of keys) ordered[k] = obj[k] ?? "";
        return JSON.stringify(ordered);
      }

      function keccakJson(obj) {
        const s = stableJSONString(obj);
        const bytes = ethers.toUtf8Bytes(s);
        return ethers.keccak256(bytes);
      }

      function buildMerkle(leavesHex) {
        if (leavesHex.length === 0) return { root: ethers.ZeroHash, levels: [] };
        let level = leavesHex.map(h => h.toLowerCase());
        level.sort();
        const levels = [level];
        while (level.length > 1) {
          const next = [];
          for (let i = 0; i < level.length; i += 2) {
            if (i + 1 === level.length) {
              next.push(level[i]);
            } else {
              const a = level[i];
              const b = level[i + 1];
              const [left, right] = a <= b ? [a, b] : [b, a];
              const concat = ethers.concat([ethers.getBytes(left), ethers.getBytes(right)]);
              next.push(ethers.keccak256(concat));
            }
          }
          level = next.sort();
          levels.push(level);
        }
        return { root: level[0], levels };
      }

      async function sha256HexOfFile(file) {
        const buf = await file.arrayBuffer();
        const digest = await crypto.subtle.digest("SHA-256", buf);
        const hex = Array.from(new Uint8Array(digest)).map(b => b.toString(16).padStart(2, "0")).join("");
        return hex;
      }

      function downloadAs(name, data) {
        const blob = new Blob([data], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = name;
        a.click();
        URL.revokeObjectURL(url);
      }

      const UX_PRODUCTS = [
        {
          id: "OKX-DAY-100",
          name: makeLocalizedMessage("当日爆仓保 · 定额赔付 100 USDT", "Same-day liquidation cover · Flat payout 100 USDT"),
          premium: makeLocalizedMessage("10 USDC", "10 USDC"),
          leverageCap: makeLocalizedMessage("≤ 20x", "≤ 20x"),
          payoutCap: makeLocalizedMessage("100 USDT", "100 USDT"),
          waitPeriod: makeLocalizedMessage("30 分钟等待期", "30-minute waiting period"),
          coverageWindow: makeLocalizedMessage("订单当日（UTC）内的强平/ADL 触发", "Liquidation/ADL triggered within the order day (UTC)"),
          caution: makeLocalizedMessage("限每个钱包每日 1 单；仅支持 USDT 结算的正向合约。", "Max 1 policy per wallet per day; only USDT-settled linear contracts."),
          faq: [
            {
              q: makeLocalizedMessage("是否必须先绑定交易所？", "Do I need to link the exchange account first?"),
              a: makeLocalizedMessage("购买时可跳过，但申赔前需完成绑定；托管密钥或本地验证器任意一种即可。", "You may skip during purchase, but must complete binding before submitting a claim; either custodial API keys or the local validator works.")
            },
            {
              q: makeLocalizedMessage("如何判断强平？", "How do you detect liquidation?"),
              a: makeLocalizedMessage("索引器读取 OKX 订单的 state=liquidated 或 adl=true，生成 Merkle proof 并上链。", "The indexer reads OKX orders with state=liquidated or adl=true, builds a Merkle proof, and submits it on-chain.")
            }
          ],
          pricingFormula: makeLocalizedMessage(
            "premium = max(基础费率, notional × maintenanceMarginRate × 18%)",
            "premium = max(base rate, notional × maintenanceMarginRate × 18%)"
          ),
          sampleRates: [
            {
              leverage: makeLocalizedMessage("≤10x", "≤10x"),
              notional: makeLocalizedMessage("≤ 5,000 USDT", "≤ 5,000 USDT"),
              premium: makeLocalizedMessage("6 USDC", "6 USDC"),
              payout: makeLocalizedMessage("60 USDT", "60 USDT")
            },
            {
              leverage: makeLocalizedMessage("10x–20x", "10x–20x"),
              notional: makeLocalizedMessage("≤ 10,000 USDT", "≤ 10,000 USDT"),
              premium: makeLocalizedMessage("10 USDC", "10 USDC"),
              payout: makeLocalizedMessage("100 USDT", "100 USDT")
            },
            {
              leverage: makeLocalizedMessage(">20x", ">20x"),
              notional: makeLocalizedMessage("≤ 15,000 USDT", "≤ 15,000 USDT"),
              premium: makeLocalizedMessage("14 USDC", "14 USDC"),
              payout: makeLocalizedMessage("100 USDT (封顶)", "100 USDT (cap)")
            }
          ],
          claimRules: [
            makeLocalizedMessage("订单在保障窗口内发生强平或 ADL。", "Liquidation or ADL occurs within the coverage window."),
            makeLocalizedMessage("同一订单仅可赔付一次；重复提交自动拒绝。", "Each order can be reimbursed only once; duplicate submissions are rejected."),
            makeLocalizedMessage("等待期结束后保单才生效，需同时校验 policy_ref 与 uid_hash。", "Policy activates after the waiting period and validates both policy_ref and uid_hash.")
          ],
          blacklist: [
            makeLocalizedMessage("账户存在自成交、刷量或明显操纵行为。", "Accounts with self-trading, wash trading, or obvious manipulation."),
            makeLocalizedMessage("同一 KYC 关联地址累计赔付超出额度。", "Linked KYC addresses exceeding aggregated payout limits."),
            makeLocalizedMessage("被 OKX 标记为高风险或合约禁用账户。", "Accounts flagged high-risk or futures-disabled by OKX.")
          ]
        },
        {
          id: "OKX-8H-60",
          name: makeLocalizedMessage("8 小时时段保 · 赔付 60 USDT", "8-hour window cover · Payout 60 USDT"),
          premium: makeLocalizedMessage("6 USDC", "6 USDC"),
          leverageCap: makeLocalizedMessage("≤ 15x", "≤ 15x"),
          payoutCap: makeLocalizedMessage("60 USDT", "60 USDT"),
          waitPeriod: makeLocalizedMessage("15 分钟等待期", "15-minute waiting period"),
          coverageWindow: makeLocalizedMessage("自购买起 8 小时的交易窗口", "8-hour trading window after purchase"),
          caution: makeLocalizedMessage("适合高频交易者；提前平仓不影响保障但保费不退。", "Ideal for active traders; early position closing keeps coverage but premium is non-refundable."),
          faq: [
            {
              q: makeLocalizedMessage("如何处理多订单？", "How are multiple orders handled?"),
              a: makeLocalizedMessage("支持同一 uid_hash 在窗口内多次强平，先到先得，赔付次数受限于产品设定。", "Supports multiple liquidations for the same uid_hash within the window, processed first-come-first-served up to the product limits.")
            },
            {
              q: makeLocalizedMessage("是否覆盖反向合约？", "Does this cover inverse contracts?"),
              a: makeLocalizedMessage("默认仅覆盖 USDT 计价；如需币本位需单独 SKU。", "By default only USDT-margined contracts are covered; coin-margined requires a separate SKU.")
            }
          ],
          pricingFormula: makeLocalizedMessage(
            "premium = baseFee + fundingVolatilityAdjustment",
            "premium = baseFee + fundingVolatilityAdjustment"
          ),
          sampleRates: [
            {
              leverage: makeLocalizedMessage("≤5x", "≤5x"),
              notional: makeLocalizedMessage("≤ 2,500 USDT", "≤ 2,500 USDT"),
              premium: makeLocalizedMessage("4 USDC", "4 USDC"),
              payout: makeLocalizedMessage("40 USDT", "40 USDT")
            },
            {
              leverage: makeLocalizedMessage("5x–10x", "5x–10x"),
              notional: makeLocalizedMessage("≤ 5,000 USDT", "≤ 5,000 USDT"),
              premium: makeLocalizedMessage("6 USDC", "6 USDC"),
              payout: makeLocalizedMessage("60 USDT", "60 USDT")
            },
            {
              leverage: makeLocalizedMessage("10x–15x", "10x–15x"),
              notional: makeLocalizedMessage("≤ 8,000 USDT", "≤ 8,000 USDT"),
              premium: makeLocalizedMessage("8 USDC", "8 USDC"),
              payout: makeLocalizedMessage("60 USDT", "60 USDT")
            }
          ],
          claimRules: [
            makeLocalizedMessage("限订单的触发时间在购买后 8 小时内。", "Liquidation must occur within 8 hours after purchase."),
            makeLocalizedMessage("ADL 事件同样视作触发，需提供订单号或 CSV 粘贴行。", "ADL events also qualify; provide order ID or CSV excerpt."),
            makeLocalizedMessage("当窗口内总赔付达到资金池上限时，将触发排队或退款。", "If pool limits are hit within the window, claims queue or refund.")
          ],
          blacklist: [
            makeLocalizedMessage("API 快速开仓/平仓触发风控限速的用户。", "Users triggering API rate limits with rapid open/close actions."),
            makeLocalizedMessage("存在多地址共享 API Key 的情况。", "Multiple addresses sharing the same API key."),
            makeLocalizedMessage("被列入风险观察名单的策略账户。", "Strategy accounts flagged on the risk watchlist.")
          ]
        },
        {
          id: "OKX-MONTH-200",
          name: makeLocalizedMessage("月度回撤保 · 赔付 200 USDT", "Monthly drawdown cover · Payout 200 USDT"),
          premium: makeLocalizedMessage("20 USDC", "20 USDC"),
          leverageCap: makeLocalizedMessage("≤ 10x", "≤ 10x"),
          payoutCap: makeLocalizedMessage("200 USDT", "200 USDT"),
          waitPeriod: makeLocalizedMessage("24 小时等待期", "24-hour waiting period"),
          coverageWindow: makeLocalizedMessage("保障 30 天；聚合整月爆仓记录", "30-day coverage aggregating the month's liquidations"),
          caution: makeLocalizedMessage("需完成 KYC；黑名单账户或重复理赔将被拒绝。", "KYC required; blacklisted or repeat-abuse accounts are rejected."),
          faq: [
            {
              q: makeLocalizedMessage("是否支持分批理赔？", "Can payouts be split?"),
              a: makeLocalizedMessage("一个月内可累计多次理赔，直至达到赔付上限或触发限赔阈值。", "Multiple claims within the month are allowed until the payout cap or throttle is hit.")
            },
            {
              q: makeLocalizedMessage("如何续期？", "How do I renew coverage?"),
              a: makeLocalizedMessage("合约支持自动续期参数，或由用户手动再次购买 SKU。", "Smart contract supports auto-renew parameters or users can repurchase the SKU manually.")
            }
          ],
          pricingFormula: makeLocalizedMessage(
            "premium = 月度名义本金 × 风险系数表 (按杠杆分段)",
            "premium = monthly notional × risk coefficient table (per leverage band)"
          ),
          sampleRates: [
            {
              leverage: makeLocalizedMessage("≤5x", "≤5x"),
              notional: makeLocalizedMessage("≤ 20,000 USDT", "≤ 20,000 USDT"),
              premium: makeLocalizedMessage("16 USDC", "16 USDC"),
              payout: makeLocalizedMessage("160 USDT", "160 USDT")
            },
            {
              leverage: makeLocalizedMessage("5x–10x", "5x–10x"),
              notional: makeLocalizedMessage("≤ 30,000 USDT", "≤ 30,000 USDT"),
              premium: makeLocalizedMessage("20 USDC", "20 USDC"),
              payout: makeLocalizedMessage("200 USDT", "200 USDT")
            },
            {
              leverage: makeLocalizedMessage(">10x", ">10x"),
              notional: makeLocalizedMessage("≤ 40,000 USDT", "≤ 40,000 USDT"),
              premium: makeLocalizedMessage("26 USDC", "26 USDC"),
              payout: makeLocalizedMessage("200 USDT (封顶)", "200 USDT (cap)")
            }
          ],
          claimRules: [
            makeLocalizedMessage("保单生效后记录用户 uid_hash 的所有强平订单，月末统一结算。", "After activation, all liquidations for the uid_hash are aggregated and settled monthly."),
            makeLocalizedMessage("用户需保证关联地址一致，防止账号转移规避等待期。", "Users must keep the associated address consistent to prevent waiting-period evasion."),
            makeLocalizedMessage("若本月无强平，可在到期后领取返还奖励（如设置）。", "If no liquidation occurs, optional rebate rewards can be redeemed after expiry.")
          ],
          blacklist: [
            makeLocalizedMessage("同一实体操作多个钱包规避额度的行为。", "One entity using multiple wallets to bypass limits."),
            makeLocalizedMessage("存在异常订单撤销或恶意刷量的策略。", "Strategies with abnormal cancelations or wash trading."),
            makeLocalizedMessage("列入 OKX 黑名单或司法冻结的账户。", "Accounts on OKX blacklist or under judicial freeze.")
          ]
        }
      ];

      function LiqPassUX({ exchange = "OKX" }) {
        const { locale, translate: tr } = useLocale();
        const text = useCallback(
          (msg, zh, en, vars = {}) => {
            if (msg && typeof msg === "object" && !Array.isArray(msg)) {
              return formatMessage(getLocalized(msg, locale), vars);
            }
            if (typeof msg === "string" || typeof msg === "number") {
              return formatMessage(String(msg), vars);
            }
            const zhStr = zh ?? en ?? "";
            const enStr = en ?? zh ?? "";
            const template = locale === "en-US" ? enStr : zhStr;
            return formatMessage(template || "", vars);
          },
          [locale]
        );
        const UX_FLOW = useMemo(() => [
          {
            title: makeLocalizedMessage("连接钱包", "Connect wallet"),
            description: makeLocalizedMessage(
              "前端请求以太坊钱包；用户签署 SIWE 字符串，后端校验返回 JWT，会话以 walletAddress 为唯一 ID。",
              "Front-end requests the Ethereum wallet; user signs a SIWE message, backend validates and returns a JWT, using walletAddress as the session ID."
            )
          },
          {
            title: makeLocalizedMessage("浏览产品", "Browse products"),
            description: makeLocalizedMessage(
              "访客无需登录即可查看保费、杠杆/赔付上限、等待期、注意事项和 FAQ。",
              "Visitors can review premium, leverage/payout caps, waiting periods, notes and FAQs without logging in."
            )
          },
          {
            title: makeLocalizedMessage(`绑定 ${exchange}`, `Link ${exchange}`),
            description: makeLocalizedMessage(
              "支持托管密钥（只读）或本地验证器（密钥不出端）两种模式。",
              "Supports custodial API keys (read-only) or the local validator (keys stay client-side)."
            )
          },
          {
            title: makeLocalizedMessage("购买保单", "Purchase policy"),
            description: makeLocalizedMessage(
              "在 Base 链调用 purchasePolicy(skuId, params) 收款并生成 policyId / policy_ref。",
              "Call purchasePolicy(skuId, params) on Base to collect premium and issue policyId / policy_ref."
            )
          },
          {
            title: makeLocalizedMessage("正常交易", "Normal trading"),
            description: makeLocalizedMessage(
              "索引器/本地验证器拉取 uid_hash 的订单 → 生成 Merkle 根 → 上链 attest(root, uri)。",
              "Indexer or local validator fetches orders for uid_hash, generates Merkle root, and calls attest(root, uri) on-chain."
            )
          },
          {
            title: makeLocalizedMessage("申赔/申诉", "Claim / appeal"),
            description: makeLocalizedMessage(
              "用户输入订单号自动匹配 proof；失败时可上传最小证据或由本地验证器重传。",
              "User inputs order ID to auto-match proofs; if missing, they can upload minimal evidence or let the local validator resubmit."
            )
          }
        ], [exchange]);
        const [selectedProductId, setSelectedProductId] = useState(UX_PRODUCTS[0]?.id ?? "");
        const selectedProduct = useMemo(
          () => UX_PRODUCTS.find((p) => p.id === selectedProductId) ?? UX_PRODUCTS[0],
          [selectedProductId]
        );
        const currentProduct = selectedProduct ?? UX_PRODUCTS[0];
        const localizedProduct = useMemo(() => {
          if (!currentProduct) return null;
          return {
            ...currentProduct,
            name: text(currentProduct.name),
            premium: text(currentProduct.premium),
            leverageCap: text(currentProduct.leverageCap),
            payoutCap: text(currentProduct.payoutCap),
            waitPeriod: text(currentProduct.waitPeriod),
            coverageWindow: text(currentProduct.coverageWindow),
            caution: text(currentProduct.caution),
            pricingFormula: text(currentProduct.pricingFormula),
            sampleRates: (currentProduct.sampleRates ?? []).map((row) => ({
              leverage: text(row.leverage),
              notional: text(row.notional),
              premium: text(row.premium),
              payout: text(row.payout),
            })),
            claimRules: (currentProduct.claimRules ?? []).map((rule) => text(rule)),
            blacklist: (currentProduct.blacklist ?? []).map((rule) => text(rule)),
            faq: (currentProduct.faq ?? []).map((item) => ({
              q: text(item.q),
              a: text(item.a),
            })),
          };
        }, [currentProduct, text]);
        const [walletAddress, setWalletAddress] = useState("");
        const [walletMessage, setWalletMessage] = useState(null);
        const [siweStatus, setSiweStatus] = useState(() => makeLocalizedMessage("未登录", "Not signed in"));
        const [sessionToken, setSessionToken] = useState("");
        const [activeBindMode, setActiveBindMode] = useState("custodial");
        const [bindStatus, setBindStatus] = useState(null);
        const [custodialForm, setCustodialForm] = useState({ apiKey: "", secretKey: "", passphrase: "" });
        const [localValidatorReady, setLocalValidatorReady] = useState(false);
        const [localFingerprint, setLocalFingerprint] = useState("");
        const [purchaseStatus, setPurchaseStatus] = useState(null);
        const [orderInput, setOrderInput] = useState("");
        const [claimStatus, setClaimStatus] = useState(null);
        const [appealStatus, setAppealStatus] = useState(null);

        async function handleConnectWallet() {
          try {
            if (!window.ethereum) {
              setWalletMessage(makeLocalizedMessage("未检测到以太坊钱包扩展", "No Ethereum wallet extension detected."));
              return;
            }
            const provider = new ethers.BrowserProvider(window.ethereum);
            const accounts = await provider.send("eth_requestAccounts", []);
            const net = await provider.getNetwork();
            if (Number(net.chainId) !== BASE_CHAIN_ID) {
              try {
                await window.ethereum.request({
                  method: "wallet_switchEthereumChain",
                  params: [{ chainId: ethers.toQuantity(BASE_CHAIN_ID) }]
                });
              } catch {
                await window.ethereum.request({
                  method: "wallet_addEthereumChain",
                  params: [{
                    chainId: ethers.toQuantity(BASE_CHAIN_ID),
                    chainName: "Base Mainnet",
                    nativeCurrency: { name: "Ether", symbol: "ETH", decimals: 18 },
                    rpcUrls: [BASE_RPC],
                    blockExplorerUrls: ["https://basescan.org"]
                  }]
                });
              }
            }
            const signer = await provider.getSigner();
            const account = accounts[0] ?? (await signer.getAddress());
            setWalletAddress(account);
            setWalletMessage(makeLocalizedMessage("已连接 Base 钱包", "Connected to Base wallet."));
          } catch (err) {
            const reason = err && err.message ? err.message : String(err);
            setWalletMessage(makeLocalizedMessage(`连接失败：${reason}`, `Connection failed: ${reason}`));
          }
        }

        async function handleSiweLogin() {
          if (!walletAddress) {
            setWalletMessage(makeLocalizedMessage("请先连接钱包", "Please connect your wallet first."));
            return;
          }
          const nonce = Math.random().toString(36).slice(2);
          setSiweStatus(makeLocalizedMessage("签名中...", "Awaiting signature..."));
          try {
            if (!window.ethereum) throw new Error("钱包不可用");
            const provider = new ethers.BrowserProvider(window.ethereum);
            const signer = await provider.getSigner();
            const statement = `LiqPass 登录，nonce=${nonce}`;
            await signer.signMessage(statement);
            const tokenSuffix = walletAddress.slice(2, 8);
            const mockToken = `demo.${tokenSuffix}.${nonce}`;
            setSessionToken(mockToken);
            setSiweStatus(makeLocalizedMessage("SIWE 已通过", "SIWE completed"));
            setWalletMessage(makeLocalizedMessage("后端将验证签名并返回 JWT（此处模拟）。", "Backend will verify the signature and return a JWT (simulated)."));
          } catch (err) {
            const reason = err && err.message ? err.message : String(err);
            setSiweStatus(makeLocalizedMessage("未登录", "Not signed in"));
            setWalletMessage(makeLocalizedMessage(`签名失败：${reason}`, `Signature failed: ${reason}`));
          }
        }

        function handleCustodialSubmit() {
          if (!custodialForm.apiKey || !custodialForm.secretKey || !custodialForm.passphrase) {
            setBindStatus(makeLocalizedMessage("请完整填写 API Key / Secret Key / Passphrase。", "Please fill in API Key / Secret Key / Passphrase."));
            return;
          }
          const masked = `ciphertext://${custodialForm.apiKey.slice(0, 4)}***`;
          setBindStatus(makeLocalizedMessage(
            `已本地加密并提交密文：${masked}（仅服务器可见密文，原文保留在前端内存中立即销毁）。`,
            `Encrypted locally and submitted cipher: ${masked} (only backend sees the ciphertext; plaintext cleared immediately).`
          ));
        }

        function handleLocalValidator() {
          setLocalValidatorReady(true);
          const fingerprint = `uid_hash_${Date.now().toString(16)}`;
          setLocalFingerprint(fingerprint);
          setBindStatus(makeLocalizedMessage(
            `本地验证器已启动，将定期拉取 ${exchange} 订单并生成最小化指纹。`,
            `Local validator started; it will periodically pull ${exchange} orders and produce minimal fingerprints.`
          ));
        }

        function handlePurchase() {
          const ref = `${currentProduct?.id ?? "SKU"}-${Date.now().toString(16)}`;
          const randomSuffix = Math.random().toString(16).slice(2, 10);
          const mockTx = `0x${ref.replace(/[^0-9a-zA-Z]/g, "").slice(0, 12)}${Date.now().toString(16)}${randomSuffix}`;
          setPurchaseStatus(makeLocalizedMessage(
            `链上调用 purchasePolicy 已提交。policy_ref = ${ref}，txHash ≈ ${mockTx}`,
            `On-chain purchasePolicy submitted. policy_ref = ${ref}, txHash ≈ ${mockTx}`
          ));
        }

        function handleClaim() {
          if (!orderInput.trim()) {
            setClaimStatus(makeLocalizedMessage("请输入订单号。", "Please enter an order ID."));
            return;
          }
          setClaimStatus(makeLocalizedMessage(
            `已匹配订单 ${orderInput}，准备 submitClaim(policyId, ${orderInput}, order_hash, rootId, proof)。`,
            `Matched order ${orderInput}, preparing submitClaim(policyId, ${orderInput}, order_hash, rootId, proof).`
          ));
        }

        function handleAppeal() {
          setAppealStatus(makeLocalizedMessage("申诉已创建，仲裁角色将在 24 小时内复核。", "Appeal created; arbitration role will review within 24 hours."));
        }

        return (
          React.createElement("div", { className: "bg-slate-950 text-slate-100" },
            React.createElement("div", { className: "relative overflow-hidden bg-gradient-to-br from-indigo-900 via-slate-900 to-slate-950" },
              React.createElement("div", { className: "max-w-6xl mx-auto px-6 py-12 md:py-16" },
                React.createElement("p", { className: "text-sm uppercase tracking-[0.3em] text-indigo-200/80" }, text(null, "多交易所合约保险（OKX 首发） · UX 流", "Multi-exchange insurance (OKX first) · UX flow")),
                React.createElement("h1", { className: "mt-4 text-3xl font-semibold md:text-4xl" }, text(null, "连接钱包 → 浏览产品 → 绑定 {exchange} → 购买 → 交易监控 → 申赔 / 申诉", "Connect wallet → browse products → link {exchange} → purchase → monitor trades → claim / appeal", { exchange })),
                React.createElement("p", { className: "mt-4 max-w-3xl text-base text-indigo-100/80" }, text(null, "支持 SIWE / EIP-4361 登录，钱包地址即用户 ID。既可托管密钥（只读）也可启用本地验证器，确保 {exchange} 凭证不出端。", "Supports SIWE / EIP-4361 login with wallet address as the user ID. Choose custodial read-only keys or the local validator to keep {exchange} credentials on-device.", { exchange })),
                React.createElement("div", { className: "mt-6 flex flex-wrap gap-3" },
                  React.createElement("button", {
                    type: "button",
                    onClick: handleConnectWallet,
                    className: "rounded-full bg-indigo-500 px-5 py-2 text-sm font-medium text-white shadow-lg shadow-indigo-700/30 transition hover:bg-indigo-400"
                  }, text(null, "1. 连接钱包", "1. Connect wallet")),
                  React.createElement("button", {
                    type: "button",
                    onClick: handleSiweLogin,
                    className: "rounded-full border border-indigo-300/60 px-5 py-2 text-sm font-medium text-indigo-100 transition hover:border-indigo-200 hover:bg-indigo-500/10"
                  }, text(null, "2. SIWE 登录（模拟）", "2. SIWE login (mock)")),
                  walletAddress && React.createElement("span", {
                    className: "rounded-full border border-white/10 px-4 py-2 text-xs text-indigo-100/80"
                  }, `${walletAddress.slice(0, 10)}...${walletAddress.slice(-6)}`)
                ),
                React.createElement("div", { className: "mt-4 space-y-1 text-sm text-indigo-100/70" },
                  React.createElement("p", null,
                    `${text(null, "登录状态：", "Login status: ")}${text(siweStatus)}${sessionToken ? `${text(null, " · JWT(模拟) = ", " · JWT (mock) = ")}${sessionToken}` : ""}`
                  ),
                  walletMessage && React.createElement("p", null, text(walletMessage))
                )
              )
            ),
            React.createElement("div", { className: "max-w-6xl mx-auto px-6 pb-16 space-y-12" },
              React.createElement("section", { className: "space-y-4 pt-12" },
                React.createElement("h2", { className: "text-2xl font-semibold" }, text(null, "用户路径（UX Flow）", "User journey (UX flow)")),
                React.createElement("div", { className: "grid gap-4 md:grid-cols-3" },
                  UX_FLOW.map((step, idx) => {
                    const stepTitle = text(step.title);
                    const stepDesc = text(step.description);
                    return (
                    React.createElement("div", {
                      key: `${stepTitle}-${idx}`,
                      className: "rounded-2xl border border-white/10 bg-white/5 p-5 backdrop-blur"
                    },
                      React.createElement("p", { className: "text-xs uppercase tracking-[0.3em] text-indigo-200/70" }, `Step ${idx + 1}`),
                      React.createElement("h3", { className: "mt-3 text-lg font-semibold text-white" }, stepTitle),
                      React.createElement("p", { className: "mt-2 text-sm text-slate-200/80" }, stepDesc)
                    )
                    );
                  })
                )
              ),
              React.createElement("section", { className: "space-y-4" },
                React.createElement("h2", { className: "text-2xl font-semibold" }, text(null, "合约保险产品列表", "Insurance product catalog")),
                React.createElement("div", { className: "grid gap-4 md:grid-cols-3" },
                  UX_PRODUCTS.map((product) => {
                    const isActive = product.id === selectedProductId;
                    const productName = text(product.name);
                    const premium = text(product.premium);
                    const leverageCap = text(product.leverageCap);
                    const payoutCap = text(product.payoutCap);
                    const waitPeriod = text(product.waitPeriod);
                    const caution = text(product.caution);
                    return React.createElement("button", {
                      type: "button",
                      key: product.id,
                      onClick: () => {
                        setSelectedProductId(product.id);
                        setPurchaseStatus(null);
                      },
                      className: `rounded-2xl border p-5 text-left transition ${isActive ? "border-indigo-400 bg-indigo-400/10 shadow-lg shadow-indigo-500/20" : "border-white/10 bg-white/5 hover:border-indigo-400/60"}`
                    },
                      React.createElement("div", { className: "flex items-center justify-between text-xs uppercase tracking-widest" },
                        React.createElement("span", { className: "text-indigo-200/80" }, product.id),
                        isActive && React.createElement("span", { className: "rounded-full bg-indigo-500/30 px-2 py-0.5 text-indigo-100" }, text(null, "当前", "Selected"))
                      ),
                      React.createElement("h3", { className: "mt-3 text-lg font-semibold text-white" }, productName),
                      React.createElement("ul", { className: "mt-4 space-y-1 text-sm text-slate-200/80" },
                        React.createElement("li", null, `${text(null, "保费：", "Premium: ")}${premium}`),
                        React.createElement("li", null, `${text(null, "杠杆上限：", "Leverage cap: ")}${leverageCap}`),
                        React.createElement("li", null, `${text(null, "赔付额上限：", "Payout cap: ")}${payoutCap}`),
                        React.createElement("li", null, `${text(null, "等待期：", "Waiting period: ")}${waitPeriod}`),
                        React.createElement("li", null, `${text(null, "注意事项：", "Notes: ")}${caution}`)
                      ),
                      product.faq[0] && React.createElement("p", { className: "mt-4 text-xs text-indigo-200/70" }, `${text(null, "FAQ：", "FAQ: ")}${text(product.faq[0].q)}`)
                    );
                  })
                )
              ),
              React.createElement("section", { className: "rounded-2xl border border-white/10 bg-white/5 p-6 text-sm text-slate-200/80" },
                React.createElement("h2", { className: "text-2xl font-semibold text-white" }, "为什么在 Base"),
                React.createElement("ul", { className: "mt-4 space-y-2" },
                  React.createElement("li", null, "强平/ADL 事件 → ", React.createElement("span", { className: "font-semibold text-indigo-200" }, "Base 上的 Attestation"), "（可验证、可审计）"),
                  React.createElement("li", null, "理赔 & 申诉在 Base 合约执行，资金与规则", React.createElement("span", { className: "font-semibold text-indigo-200" }, "链上透明")),
                  React.createElement("li", null, "计划集成 ", React.createElement("span", { className: "font-semibold text-indigo-200" }, "Paymaster"), " 降低 gas；连接器越多，", React.createElement("span", { className: "font-semibold text-indigo-200" }, "Base 写入/交互越多"))
                )
              ),
              localizedProduct && React.createElement("section", { className: "space-y-4" },
                React.createElement("h2", { className: "text-2xl font-semibold" }, text(null, "产品详情", "Product details")),
                React.createElement("div", { className: "grid gap-6 md:grid-cols-2" },
                  React.createElement("div", { className: "rounded-2xl bg-white p-6 shadow-lg shadow-slate-900/10" },
                    React.createElement("h3", { className: "text-lg font-semibold text-slate-900" }, text(null, "参数化定价公式", "Parameterized pricing formula")),
                    React.createElement("p", { className: "mt-3 rounded-xl bg-slate-100 px-4 py-3 text-sm text-slate-800" }, localizedProduct.pricingFormula),
                    React.createElement("h3", { className: "mt-6 text-lg font-semibold text-slate-900" }, text(null, "示例费率表", "Sample rate table")),
                    React.createElement("div", { className: "mt-3 overflow-hidden rounded-xl border border-slate-200" },
                      React.createElement("table", { className: "min-w-full text-sm text-slate-800" },
                        React.createElement("thead", { className: "bg-slate-100" },
                          React.createElement("tr", null,
                            React.createElement("th", { className: "px-3 py-2 text-left" }, text(null, "杠杆区间", "Leverage band")),
                            React.createElement("th", { className: "px-3 py-2 text-left" }, text(null, "名义本金", "Notional")),
                            React.createElement("th", { className: "px-3 py-2 text-left" }, text(null, "保费", "Premium")),
                            React.createElement("th", { className: "px-3 py-2 text-left" }, text(null, "赔付", "Payout"))
                          )
                        ),
                        React.createElement("tbody", null,
                          localizedProduct.sampleRates.map((row, idx) =>
                            React.createElement("tr", { key: idx, className: idx % 2 === 0 ? "bg-white" : "bg-slate-50" },
                              React.createElement("td", { className: "px-3 py-2" }, row.leverage),
                              React.createElement("td", { className: "px-3 py-2" }, row.notional),
                              React.createElement("td", { className: "px-3 py-2" }, row.premium),
                              React.createElement("td", { className: "px-3 py-2" }, row.payout)
                            )
                          )
                        )
                      )
                    )
                  ),
                  React.createElement("div", { className: "rounded-2xl border border-white/10 bg-white/5 p-6" },
                    React.createElement("h3", { className: "text-lg font-semibold text-white" }, text(null, "理赔规则", "Claim rules")),
                    React.createElement("ul", { className: "mt-3 space-y-2 text-sm text-slate-200/80" },
                      localizedProduct.claimRules.map((rule, idx) =>
                        React.createElement("li", { key: idx, className: "list-inside list-disc" }, rule)
                      )
                    ),
                    React.createElement("h3", { className: "mt-6 text-lg font-semibold text-white" }, text(null, "黑名单 / 限赔", "Blacklist / limits")),
                    React.createElement("ul", { className: "mt-3 space-y-2 text-sm text-slate-200/80" },
                      localizedProduct.blacklist.map((rule, idx) =>
                        React.createElement("li", { key: idx, className: "list-inside list-disc" }, rule)
                      )
                    ),
                    React.createElement("h3", { className: "mt-6 text-lg font-semibold text-white" }, "FAQ"),
                    React.createElement("div", { className: "mt-3 space-y-3" },
                      localizedProduct.faq.map((item, idx) =>
                        React.createElement("div", { key: idx, className: "rounded-xl border border-white/10 bg-black/20 p-4" },
                          React.createElement("p", { className: "text-sm font-medium text-indigo-200" }, item.q),
                          React.createElement("p", { className: "mt-1 text-sm text-slate-200/70" }, item.a)
                        )
                      )
                    )
                  )
                )
              ),
              React.createElement("section", { className: "space-y-4" },
                React.createElement("h2", { className: "text-2xl font-semibold" }, `绑定 ${exchange} 账户（只读）`),
                React.createElement("p", { className: "text-xs uppercase tracking-[0.2em] text-indigo-200/60" }, "绑定交易所（首发：OKX）"),
                React.createElement("p", { className: "text-sm text-slate-200/70" }, "支持托管密钥（只读）与本地验证器双轨，满足不同的安全/合规需求。"),
                React.createElement("div", { className: "flex flex-wrap gap-3" },
                  React.createElement("button", {
                    type: "button",
                    onClick: () => {
                      setActiveBindMode("custodial");
                      setBindStatus(null);
                    },
                    className: `rounded-full px-4 py-2 text-sm transition ${activeBindMode === "custodial" ? "bg-indigo-500 text-white shadow-lg shadow-indigo-700/30" : "border border-white/10 bg-white/5 text-slate-200 hover:border-indigo-300/60"}`
                  }, "模式 A · 托管密钥（只读权限）"),
                  React.createElement("button", {
                    type: "button",
                    onClick: () => {
                      setActiveBindMode("local");
                      setBindStatus(null);
                    },
                    className: `rounded-full px-4 py-2 text-sm transition ${activeBindMode === "local" ? "bg-indigo-500 text-white shadow-lg shadow-indigo-700/30" : "border border-white/10 bg-white/5 text-slate-200 hover:border-indigo-300/60"}`
                  }, "模式 B · 本地验证器（密钥不出端）")
                ),
                React.createElement("div", { className: "rounded-2xl border border-white/10 bg-white/5 p-6 text-sm text-slate-200/80" },
                  activeBindMode === "custodial"
                    ? React.createElement(React.Fragment, null,
                        React.createElement("p", null, text(null, `填写 ${exchange} 提供的 API Key / Secret Key / Passphrase（只读权限），前端用钱包公钥或后端 KMS 公钥进行加密。`, `Enter the ${exchange} API Key / Secret Key / Passphrase (read-only); encrypt locally with the wallet public key or backend KMS public key.`)),
                        React.createElement("div", { className: "mt-4 grid gap-4 md:grid-cols-3" },
                          React.createElement("input", {
                            className: "rounded-xl border border-white/10 bg-black/40 px-3 py-2 text-white placeholder:text-slate-500",
                            placeholder: "API Key",
                            value: custodialForm.apiKey,
                            onChange: (e) => setCustodialForm((prev) => ({ ...prev, apiKey: e.target.value }))
                          }),
                          React.createElement("input", {
                            className: "rounded-xl border border-white/10 bg-black/40 px-3 py-2 text-white placeholder:text-slate-500",
                            placeholder: "Secret Key",
                            value: custodialForm.secretKey,
                            onChange: (e) => setCustodialForm((prev) => ({ ...prev, secretKey: e.target.value }))
                          }),
                          React.createElement("input", {
                            className: "rounded-xl border border-white/10 bg-black/40 px-3 py-2 text-white placeholder:text-slate-500",
                            placeholder: "Passphrase",
                            value: custodialForm.passphrase,
                            onChange: (e) => setCustodialForm((prev) => ({ ...prev, passphrase: e.target.value }))
                          })
                        ),
                        React.createElement("p", { className: "mt-3 text-xs text-slate-400" }, text(null, "数据在本地加密后上传；服务器仅保存密文和 uid_hash，对应钱包地址即账户 ID。", "Data is encrypted locally before upload; backend only stores ciphertext + uid_hash, using wallet address as the account ID.")),
                        React.createElement("button", {
                          type: "button",
                          onClick: handleCustodialSubmit,
                          className: "mt-4 rounded-xl bg-emerald-500 px-4 py-2 text-sm font-medium text-slate-900 transition hover:bg-emerald-400"
                        }, text(null, "本地加密并上传密文", "Encrypt locally and upload cipher"))
                      )
                    : React.createElement(React.Fragment, null,
                        React.createElement("p", null, text(null, "下载或启动「LiqPass Local Validator」插件，密钥留在本机，由插件拉取订单并仅上报最小化指纹。", "Download or launch the “LiqPass Local Validator” plugin. Keys stay local; the plugin pulls orders and uploads only minimal fingerprints.")),
                        React.createElement("div", { className: "mt-4 flex flex-wrap gap-3" },
                          React.createElement("button", {
                            type: "button",
                            onClick: handleLocalValidator,
                            className: "rounded-xl bg-emerald-500 px-4 py-2 text-sm font-medium text-slate-900 transition hover:bg-emerald-400"
                          }, text(null, localValidatorReady ? "验证器已运行" : "启动本地验证器", localValidatorReady ? "Validator running" : "Start local validator")),
                          React.createElement("button", {
                            type: "button",
                            onClick: () => setBindStatus(makeLocalizedMessage("浏览器插件下载链接将通过内测邮箱下发（占位展示）。", "Browser plugin download link will be shared via private beta email (placeholder).")),
                            className: "rounded-xl border border-white/10 bg-white/10 px-4 py-2 text-sm text-slate-200 transition hover:border-indigo-300/60"
                          }, text(null, "下载浏览器插件（占位）", "Download browser plugin (placeholder)"))
                        ),
                        localValidatorReady && React.createElement("div", {
                          className: "mt-4 rounded-xl border border-indigo-400/40 bg-indigo-500/10 p-4 text-xs text-indigo-100"
                        },
                          React.createElement("p", null, text(null, `uid_hash（示例）：${localFingerprint}`, `uid_hash (example): ${localFingerprint}`)),
                          React.createElement("p", { className: "mt-2" }, text(null, "插件将在本地生成 Merkle root，并定期将 rootId + proof 上报给后端索引器。", "The plugin generates Merkle roots locally and periodically reports rootId + proof to the backend indexer."))
                        )
                      ),
                  bindStatus && React.createElement("div", { className: "mt-4 text-sm text-emerald-300" }, text(bindStatus))
                )
              ),
              React.createElement("section", { className: "space-y-4" },
                React.createElement("h2", { className: "text-2xl font-semibold" }, text(null, "购买链上保单", "Purchase on-chain policy")),
                React.createElement("div", { className: "rounded-2xl border border-white/10 bg-white/5 p-6 text-sm text-slate-200/80" },
                  React.createElement("p", null, text(null, "选择 SKU 后，合约 `purchasePolicy(skuId, params)` 将收取保费（USDC）并返回 policyId / policy_ref，同时记录到链上。", "After selecting a SKU, the contract `purchasePolicy(skuId, params)` collects premium (USDC), returns policyId / policy_ref, and records on-chain.")),
                  React.createElement("div", { className: "mt-4 grid gap-4 md:grid-cols-2" },
                    React.createElement("div", null,
                      React.createElement("p", { className: "text-xs uppercase tracking-[0.3em] text-indigo-200/70" }, text(null, "当前 SKU", "Current SKU")),
                      React.createElement("p", { className: "mt-2 text-lg font-semibold text-white" }, localizedProduct?.name ?? text(null, "请选择产品", "Select a product")),
                      React.createElement("p", { className: "mt-2 text-sm text-slate-300/80" }, localizedProduct?.coverageWindow ?? "")
                    ),
                    React.createElement("div", { className: "rounded-xl border border-white/10 bg-black/20 p-4" },
                      React.createElement("p", null, React.createElement("span", { className: "font-medium text-indigo-100" }, text(null, "保费：", "Premium: ")), localizedProduct?.premium ?? ""),
                      React.createElement("p", { className: "mt-2" }, React.createElement("span", { className: "font-medium text-indigo-100" }, text(null, "杠杆上限：", "Leverage cap: ")), localizedProduct?.leverageCap ?? ""),
                      React.createElement("p", { className: "mt-2" }, React.createElement("span", { className: "font-medium text-indigo-100" }, text(null, "赔付上限：", "Payout cap: ")), localizedProduct?.payoutCap ?? ""),
                      React.createElement("p", { className: "mt-2" }, React.createElement("span", { className: "font-medium text-indigo-100" }, text(null, "等待期：", "Waiting period: ")), localizedProduct?.waitPeriod ?? "")
                    )
                  ),
                  React.createElement("button", {
                    type: "button",
                    onClick: handlePurchase,
                    className: "mt-4 rounded-xl bg-emerald-500 px-4 py-2 text-sm font-medium text-slate-900 transition hover:bg-emerald-400"
                  }, text(null, "使用钱包支付并生成 policy_ref", "Pay with wallet and mint policy_ref")),
                  purchaseStatus && React.createElement("div", { className: "mt-3 text-sm text-emerald-300" }, text(purchaseStatus))
                )
              ),
              React.createElement("section", { className: "rounded-2xl border border-white/10 bg-white/5 p-6 text-sm text-slate-200/80" },
                React.createElement("h3", { className: "text-lg font-semibold text-white" }, "后台监控（索引器 / 本地验证器）"),
                React.createElement("p", { className: "mt-2" }, "后端服务根据 policy_ref → uid_hash 关联关系，定期拉取订单 → 生成 Merkle root → 调用 attest(root, uri)。链上记录 rootId，供后续 submitClaim 验证。"),
                React.createElement("p", { className: "mt-2" }, "本地验证器模式下，插件直接与后端共享最小化指纹（order_hash、proof），无需上传 API Key。")
              ),
              React.createElement("section", { className: "space-y-4" },
                React.createElement("h2", { className: "text-2xl font-semibold" }, "申赔：输入订单号即可"),
                React.createElement("div", { className: "rounded-2xl border border-white/10 bg-white/5 p-6 text-sm text-slate-200/80" },
                  React.createElement("p", null, "用户重新连接原钱包后，输入订单号，后端即基于 (wallet → policy_ref → uid_hash) 查找 proof 并校验额度/窗口。"),
                  React.createElement("div", { className: "mt-4 flex flex-col gap-3 md:flex-row" },
                    React.createElement("input", {
                      className: "flex-1 rounded-xl border border-white/10 bg-black/30 px-3 py-2 text-white placeholder:text-slate-500",
                      placeholder: "输入订单号（如 253875629349...）",
                      value: orderInput,
                      onChange: (e) => setOrderInput(e.target.value)
                    }),
                    React.createElement("button", {
                      type: "button",
                      onClick: handleClaim,
                      className: "rounded-xl bg-emerald-500 px-4 py-2 text-sm font-medium text-slate-900 transition hover:bg-emerald-400"
                    }, "验证并提交 submitClaim")
                  ),
                  React.createElement("p", { className: "mt-3 text-xs text-slate-400" }, "合约校验 Merkle proof → 通过即自动赔付 / 记账；失败则返回原因并可发起申诉。"),
                  claimStatus && React.createElement("div", { className: "mt-3 text-sm text-emerald-300" }, text(claimStatus))
                )
              ),
              React.createElement("section", { className: "space-y-4" },
                React.createElement("h2", { className: "text-2xl font-semibold" }, "申诉流程"),
                React.createElement("div", { className: "rounded-2xl border border-white/10 bg-white/5 p-6 text-sm text-slate-200/80" },
                  React.createElement("p", null, "若自动校验失败，可补充最小字段或整行 CSV（允许遮蔽 PII），也可让本地验证器重新生成证据。"),
                  React.createElement("textarea", {
                    className: "mt-4 h-28 w-full rounded-xl border border-white/10 bg-black/30 px-3 py-2 text-white placeholder:text-slate-500",
                    placeholder: '粘贴订单最小字段，例如 {"orderId":"...","fillPx":"..."}'
                  }),
                  React.createElement("div", { className: "mt-4 flex flex-wrap gap-3" },
                    React.createElement("button", {
                      type: "button",
                      onClick: handleAppeal,
                      className: "rounded-xl bg-indigo-500 px-4 py-2 text-sm font-medium text-white transition hover:bg-indigo-400"
                    }, "提交申诉"),
                    React.createElement("button", {
                      type: "button",
                      onClick: () => setBindStatus("已请求本地验证器重新计算并上报证据（模拟）。"),
                      className: "rounded-xl border border-white/10 bg-white/10 px-4 py-2 text-sm text-slate-200 transition hover:border-indigo-300/60"
                    }, "让本地验证器重新上报")
                  ),
                  React.createElement("p", { className: "mt-3 text-xs text-slate-400" }, "后台人工 / 规则机审接口将触发仲裁角色或合约的二次提交函数，确保漏单也可赔付。"),
                  appealStatus && React.createElement("div", { className: "mt-3 text-sm text-emerald-300" }, text(appealStatus))
                )
              ),
              React.createElement("section", { className: "rounded-2xl border border-white/10 bg-white/5 p-6 text-sm text-slate-200/80" },
                React.createElement("h2", { className: "text-2xl font-semibold text-white" }, "1 分钟 Demo 讲词"),
                React.createElement("ol", { className: "mt-4 space-y-2 list-decimal pl-5" },
                  React.createElement("li", null, "打开页面，展示 Binance / Gate 按钮处于灰置态，OKX 首发已选中。"),
                  React.createElement("li", null, "连接 Base 钱包，点击「购买链上保单」，展示生成的 policy_ref（模拟）。"),
                  React.createElement("li", null, "切换到「本地取证 / 上链工具」，上传 OKX CSV → 生成 Merkle root → 生成 attest.json → 粘贴站点 URL → 上链并展示 Basescan 交易链接。"),
                  React.createElement("li", null, "回到“申赔”，输入订单号，提示“已匹配，准备 submitClaim …”，说明闭环。")
                )
              ),
              React.createElement("footer", { className: "pt-8 text-xs text-slate-500" }, "提示：以上交互为前端原型演示，链上调用 / 索引器流程可与现有 Attestor 与 PolicyManager 合约复用。")
            )
          )
        );
      }

      function AttestorWorkbench({ exchange = "OKX" }) {
        const [csvText, setCsvText] = useState("");
        const [csvFile, setCsvFile] = useState(null);
        const [rows, setRows] = useState([]);
        const [headers, setHeaders] = useState([]);
        const [orderId, setOrderId] = useState("");
        const [merkleRoot, setMerkleRoot] = useState("");
        const [attestUrl, setAttestUrl] = useState("");
        const [status, setStatus] = useState("");
        const [txHash, setTxHash] = useState("");
        const [hasOnchain, setHasOnchain] = useState(null);
        const parsed = useMemo(() => {
          if (!csvText) return { headers: [], rows: [] };
          try { return parseCSV(csvText); } catch (e) { console.error(e); return { headers: [], rows: [] } }
        }, [csvText]);
        const isOkx = exchange === "OKX";

        useEffect(() => {
          setHeaders(parsed.headers);
          setRows(parsed.rows);
        }, [parsed.headers, parsed.rows]);

        async function handleFile(f) {
          setCsvFile(f);
          const text = await f.text();
          setCsvText(text);
        }

        function buildRoot() {
          if (!rows.length) { setStatus("请先上传 CSV"); return; }
          const leaves = rows.map(r => keccakJson(canonicalizeRow(r, exchange)));
          const { root } = buildMerkle(leaves);
          setMerkleRoot(root);
          setStatus("Merkle root 已生成");
        }

        async function genAttestJson() {
          if (!merkleRoot) { setStatus("请先生成 Merkle root"); return; }
          const sha = csvFile ? await sha256HexOfFile(csvFile) : "";
          const exampleRow = orderId ? findRowById(rows, orderId) : rows[0];
          const payload = {
            merkleRoot,
            chainId: BASE_CHAIN_ID,
            contract: ATTESTOR_ADDR,
            dataset: {
              uri: "<请上传CSV到你的网站后粘贴URL>",
              sha256Hex: sha,
              rows: rows.length
            },
            generator: {
              name: "liqpass-web-attestor",
              version: "0.1.0",
              repo: "https://github.com/your-org/liqpass-web-attestor"
            },
            market: {
              exchange,
              symbols: deduceSymbols(rows),
              timeWindow: { startISO: "", endISO: "", timezone: Intl.DateTimeFormat().resolvedOptions().timeZone }
            },
            counts: { positions: rows.length, liquidations: null, adl: null },
            method: {
              treeAlgo: "keccak256",
              leafFormat: "keccak256(utf8(JSON.stringify({exchange,id,inst,side,qty,unit,px,pnl,ts})))",
              proofFormat: "array<bytes32>"
            },
            createdAt: new Date().toISOString(),
            notes: `本文件由前端本地生成；未触达 ${exchange} API。用户需自行上传 CSV 与本 attest.json 到可公开访问的URL后，再执行上链。`,
            sample: {
              selectedOrder: exampleRow ? canonicalizeRow(exampleRow, exchange) : null
            }
          };
          downloadAs(`attest_${Date.now()}.json`, JSON.stringify(payload, null, 2));
          setStatus("attest.json 已生成并下载。请将其上传到你的网站 /files/ ，然后把URL粘贴到下方。");
        }

        function findRowById(_rows, id) {
          const candidates = ["id","ID","orderId","订单ID","关联订单id"];
          for (const r of _rows) {
            for (const k of candidates) {
              if (r[k] && String(r[k]).trim() === String(id).trim()) return r;
            }
          }
          return null;
        }

        function deduceSymbols(_rows) {
          const set = new Set();
          for (const r of _rows) {
            const c = canonicalizeRow(r, exchange);
            if (c.inst) set.add(c.inst);
          }
          return Array.from(set);
        }

        async function connectAndAttest() {
          try {
            if (!window.ethereum) { setStatus("未检测到钱包（MetaMask等）"); return; }
            const provider = new ethers.BrowserProvider(window.ethereum);
            const [acc] = await provider.send("eth_requestAccounts", []);
            const net = await provider.getNetwork();
            if (Number(net.chainId) !== BASE_CHAIN_ID) {
              try {
                await window.ethereum.request({
                  method: "wallet_switchEthereumChain",
                  params: [{ chainId: ethers.toQuantity(BASE_CHAIN_ID) }]
                });
              } catch (e) {
                await window.ethereum.request({
                  method: "wallet_addEthereumChain",
                  params: [{
                    chainId: ethers.toQuantity(BASE_CHAIN_ID),
                    chainName: "Base Mainnet",
                    nativeCurrency: { name: "Ether", symbol: "ETH", decimals: 18 },
                    rpcUrls: [BASE_RPC],
                    blockExplorerUrls: ["https://basescan.org"]
                  }]
                });
              }
            }
            const signer = await provider.getSigner();
            const c = new ethers.Contract(ATTESTOR_ADDR, ATTESTOR_ABI, signer);
            if (!merkleRoot) { setStatus("缺少 merkleRoot，请先生成"); return; }
            if (!attestUrl || !attestUrl.startsWith("http")) { setStatus("请粘贴 attest.json 的公网 URL"); return; }
            setStatus("发送交易中...");
            const tx = await c.attest(merkleRoot, attestUrl);
            const rcpt = await tx.wait();
            setTxHash(tx.hash);
            setStatus("已上链。下面可点击 Basescan 查看。");
            const ok = await c.has(merkleRoot);
            setHasOnchain(ok);
          } catch (e) {
            console.error(e);
            setStatus(`失败：${e?.message ?? e}`);
          }
        }

        async function checkHas() {
          try {
            const provider = new ethers.JsonRpcProvider(BASE_RPC);
            const c = new ethers.Contract(ATTESTOR_ADDR, ATTESTOR_ABI, provider);
            const ok = await c.has(merkleRoot);
            setHasOnchain(ok);
            setStatus("已查询链上 has(root)");
          } catch (e) {
            setStatus(`查询失败：${e?.message ?? e}`);
          }
        }

        return (
          React.createElement("div", { className: "min-h-screen bg-slate-50 text-slate-900" },
            React.createElement("div", { className: "max-w-4xl mx-auto p-6" },
              React.createElement("h1", { className: "text-3xl font-bold mb-2" }, "LiqPass — 本地验证 & 一键上链留痕"),
              React.createElement("p", { className: "text-sm opacity-70" }, `不连 ${exchange} API；不上传隐私；所有计算在浏览器完成。合约：${ATTESTOR_ADDR}`),
              React.createElement("p", { className: "text-xs uppercase tracking-[0.3em] opacity-60 mb-6" }, `当前选择交易所：${exchange}`),
              React.createElement("div", { className: "bg-white rounded-2xl shadow p-5 mb-6" },
                React.createElement("h2", { className: "text-xl font-semibold mb-2" }, `步骤 1 / 上传 ${exchange} 导出的 CSV`),
                React.createElement("div", { className: "flex items-center gap-3 mb-3" },
                  React.createElement("input", { type: "file", accept: ".csv,text/csv", onChange: (e)=> e.target.files?.[0] && handleFile(e.target.files[0]) }),
                  React.createElement("button", { className: "px-3 py-2 rounded-xl bg-slate-800 text-white", onClick: () => {
                    if (!csvText) return;
                    const { headers, rows } = parseCSV(csvText);
                    setHeaders(headers); setRows(rows);
                  } }, "解析")
                ),
                React.createElement("textarea", { className: "w-full h-28 p-3 rounded-xl border", placeholder: "或直接粘贴 CSV 文本...", value: csvText, onChange: e=>setCsvText(e.target.value) }),
                React.createElement("div", { className: "text-xs mt-2 opacity-70" }, "提示：OKX 可在「资产 → 订单中心」导出 CSV；Binance / Gate 占位连接器将接入同等导出引导。")
              ),
              React.createElement("div", { className: "bg-white rounded-2xl shadow p-5 mb-6" },
                React.createElement("h2", { className: "text-xl font-semibold mb-2" }, "步骤 2 / 选择订单并生成 Merkle Root"),
                React.createElement("div", { className: "flex items-center gap-3 mb-3" },
                  React.createElement("input", { className: "flex-1 border rounded-xl p-2", placeholder: "输入订单号（可选，用于样例展示/校验）", value: orderId, onChange: e=>setOrderId(e.target.value) }),
                  React.createElement("button", { className: "px-3 py-2 rounded-xl bg-slate-800 text-white", onClick: buildRoot }, "生成 Root")
                ),
                merkleRoot && React.createElement("div", { className: "text-sm break-all" }, "merkleRoot：", React.createElement("code", { className: "bg-slate-100 px-2 py-1 rounded" }, merkleRoot))
              ),
              React.createElement("div", { className: "bg-white rounded-2xl shadow p-5 mb-6" },
                React.createElement("h2", { className: "text-xl font-semibold mb-2" }, "步骤 3 / 生成 attest.json 并下载"),
                React.createElement("div", { className: "flex items-center gap-3 mb-3" },
                  React.createElement("button", { className: "px-3 py-2 rounded-xl bg-slate-800 text-white", onClick: genAttestJson }, "生成 & 下载")
                ),
                React.createElement("div", { className: "text-xs opacity-70" }, "将下载的 attest.json 与原始 CSV 一并上传到你的网站（例如 ", React.createElement("code", null, "/files/"), " 目录），复制它的公网 URL。")
              ),
              React.createElement("div", { className: "bg-white rounded-2xl shadow p-5 mb-6" },
                React.createElement("h2", { className: "text-xl font-semibold mb-2" }, "步骤 4 / 上链留痕（Base 主网）"),
                React.createElement("input", { className: "w-full border rounded-xl p-2 mb-3", placeholder: "粘贴 attest.json 的公网 URL (https://...)", value: attestUrl, onChange: e=>setAttestUrl(e.target.value) }),
                React.createElement("div", { className: "flex items-center gap-3" },
                  React.createElement("button", { className: "px-3 py-2 rounded-xl bg-emerald-600 text-white", onClick: connectAndAttest }, "连接钱包并上链"),
                  React.createElement("button", { className: "px-3 py-2 rounded-xl bg-slate-200", onClick: checkHas }, "检查 has(root)")
                ),
                txHash && React.createElement("div", { className: "text-sm mt-3" }, "Tx: ", React.createElement("a", { className: "text-blue-600 underline", target: "_blank", href: `https://basescan.org/tx/${txHash}` }, txHash)),
                hasOnchain !== null && React.createElement("div", { className: "text-sm mt-1" }, "合约 has(root)：", String(hasOnchain))
              ),
              React.createElement("div", { className: "mt-4 text-sm opacity-80" }, status),
              rows.length > 0 && React.createElement("div", { className: "bg-white rounded-2xl shadow p-5 mt-6" },
                React.createElement("h3", { className: "font-semibold mb-2" }, "CSV 预览（前 10 行）"),
                React.createElement("div", { className: "overflow-auto" },
                  React.createElement("table", { className: "min-w-full text-sm" },
                    React.createElement("thead", null,
                      React.createElement("tr", null,
                        headers.map((h,i) => React.createElement("th", { key: i, className: "px-2 py-1 border-b text-left whitespace-nowrap" }, h))
                      )
                    ),
                    React.createElement("tbody", null,
                      rows.slice(0,10).map((r,idx)=> (
                        React.createElement("tr", { key: idx, className: "odd:bg-slate-50" },
                          headers.map((h,i)=> React.createElement("td", { key: i, className: "px-2 py-1 border-b whitespace-nowrap" }, r[h]))
                        )
                      ))
                    )
                  )
                )
              ),
              React.createElement("div", { className: "prose max-w-none mt-8" },
                React.createElement("h2", null, "使用说明 / 无需服务器访问交易所"),
                React.createElement("ol", null,
                  React.createElement("li", null, "登录交易所账号（OKX 首发：资产 → 订单中心），导出交易/订单 CSV。"),
                  React.createElement("li", null, "将 CSV 上传到本页面，点击“生成 Root”。"),
                  React.createElement("li", null, "点击“生成 & 下载”，得到 ", React.createElement("code", null, "attest.json"), "。"),
                  React.createElement("li", null, "把 ", React.createElement("code", null, "attest.json"), " 与原始 CSV 上传到你的网站。"),
                  React.createElement("li", null, "粘贴 ", React.createElement("code", null, "attest.json"), " 的公网 URL，连接钱包并调用链上函数。")
                ),
                React.createElement("p", null, isOkx ? "（可选）OKX 在 2025 年推出了「订单分享」功能，用户也可以在 OKX 端开启分享并提供分享链接作为佐证材料。" : `${exchange} 分享链接 / 导出指引将在连接器接入后补充。`)
              )
            )
          )
        );
      }

      function RootApp() {
        const { locale, setLocale, translate: tr } = useLocale();
        const [view, setView] = useState("ux");
        const [exchange, setExchange] = useState("OKX");
        return (
          React.createElement("div", { className: "flex min-h-screen flex-col bg-slate-950 text-slate-100" },
            React.createElement("header", { className: "border-b border-slate-800 bg-slate-950/90 backdrop-blur" },
              React.createElement("div", { className: "mx-auto flex max-w-6xl flex-col gap-3 px-6 py-4 md:flex-row md:items-center md:justify-between" },
                React.createElement("div", null,
                  React.createElement("div", { className: "flex items-center gap-2" },
                    React.createElement("span", { className: "text-lg font-semibold text-white" }, "LiqPass"),
                    React.createElement("span", { className: "rounded-full border border-white/10 px-2 py-0.5 text-xs text-slate-400" }, "Base Mainnet")
                  ),
                  React.createElement("p", { className: "mt-1 text-xs text-slate-400" }, tr("多交易所适配器原型（OKX 首发）＋ 本地验证 & 上链留痕工具。", "Multi-exchange adapter prototype (OKX first) + local attestation & on-chain logging toolkit."))
                ),
                React.createElement("div", { className: "flex items-center gap-2" },
                  React.createElement("button", {
                    type: "button",
                    onClick: () => setView("ux"),
                    className: `rounded-full px-4 py-2 text-sm transition ${view === "ux" ? "bg-indigo-500 text-white shadow-lg shadow-indigo-700/30" : "border border-white/10 bg-white/5 text-slate-200 hover:border-indigo-300/60"}`
                  }, tr("OKX 合约保险 UX", "OKX insurance UX")),
                  React.createElement("button", {
                    type: "button",
                    onClick: () => setView("attestor"),
                    className: `rounded-full px-4 py-2 text-sm transition ${view === "attestor" ? "bg-indigo-500 text-white shadow-lg shadow-indigo-700/30" : "border border-white/10 bg-white/5 text-slate-200 hover:border-indigo-300/60"}`
                  }, tr("本地取证 / 上链工具", "Local attestation / on-chain tool")),
                  React.createElement("div", { className: "ml-2 flex items-center gap-1 text-xs" },
                    React.createElement("span", { className: "opacity-70" }, tr("交易所：", "Exchange:")),
                    ["OKX", "Binance", "Gate"].map((ex) =>
                      React.createElement("button", {
                        key: ex,
                        type: "button",
                        onClick: () => setExchange(ex),
                        className: `rounded-full px-2 py-1 border ${exchange === ex ? "bg-indigo-500 text-white border-indigo-400" : "border-white/10 text-slate-200"}`
                      }, `${ex}${ex === "OKX" ? tr(" · 首发", " · live") : tr(" · 规划中", " · planned")}`)
                    )
                  ),
                  React.createElement("div", { className: "ml-3 flex items-center gap-1 text-xs" },
                    React.createElement("span", { className: "opacity-70" }, tr("语言：", "Language:")),
                    SUPPORTED_LOCALES.map((code) =>
                      React.createElement("button", {
                        key: code,
                        type: "button",
                        onClick: () => setLocale(code),
                        className: `rounded-full px-2 py-1 border ${locale === code ? "bg-indigo-500 text-white border-indigo-400" : "border-white/10 text-slate-200"}`
                      }, LANGUAGE_LABELS[code] ?? code)
                    )
                  )
                )
              )
            ),
            React.createElement("main", { className: "flex-1" },
              view === "ux"
                ? React.createElement(LiqPassUX, { key: "ux", exchange })
                : React.createElement(AttestorWorkbench, { key: "attestor", exchange })
            )
          )
        );
      }

      const root = createRoot(document.getElementById("root"));
      root.render(React.createElement(LocalizedRoot));
    </script>
  </body>
</html>
