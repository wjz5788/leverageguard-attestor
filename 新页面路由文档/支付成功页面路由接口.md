结论：这是**购买下单页**的零代码架构规范。对齐你仓库与双机架构，兼容“直接上链收款（合约）”与“备用批准+转账”两条通道。AI 可据此直接实现；人可据此验收。

# 「购买下单 · Base USDC」架构规范

## 0. 定义

* 目标：用户选择 SKU，输入本金与杠杆，获取报价并用 **Base 原生 USDC** 支付，生成 `orderId` 供后续理赔使用。
* 边界：前端不自行计算价格；所有报价与校验由 US-backend 完成；链交互仅在 Base 主网。

---

## 1. 路由与页面

* 路由：`/buy`
* 页面名：`BuyPage`
* 访问：需钱包 S3（已连接且在 Base）

---

## 2. 前置条件

* 钱包：MetaMask 已连接；链 = Base 主网（chainId 十六进制 `0x2105`）。
* 资产：Base 原生 USDC 合约（精度 6）；余额充足；ETH 用于 gas。
* 后端：`/catalog/skus` 可用；`/orders/preview` 与 `/orders` 可用；合约或金库地址在 `/orders/preview` 响应中给出。

---

## 3. 用户流程（四步）

1. **选择与输入**

   * 选 SKU（如 `24h 固定赔付` / `8h 时段保` / `月度回撤保` / `无爆仓返现`）。
   * 输入 `本金` 与 `杠杆`。
   * 点击“预览价格”。
2. **报价与校验**

   * 后端返回保费、公式说明、有效期（如 60s）、可用支付通道、USDC 与合约/金库地址。
   * 展示倒计时与“条款确认”勾选。
3. **支付与创建订单**

   * 用户选择支付通道 → 触发签名或批准 → 发送交易或完成转账。
   * 前端携带 `idempotencyKey` 调用 `/orders` 完成落单（或后端监听链上事件回填）。
4. **结果与回执**

   * 展示 `orderId`、支付 tx、可下载回执（JSON），并提供“去理赔页”入口。

---

## 4. 页面元素与 ID

* 选择区：

  * SKU：`#sel-sku`（从 `/catalog/skus` 动态渲染）
  * 本金：`#in-principal`（USDT/USDC 计价，前端只收数字）
  * 杠杆：`#in-leverage`（整数或步长由 SKU 限定）
* 报价区：

  * 保费：`#out-premium`
  * 公式说明：`#out-formula`
  * 倒计时：`#out-quote-ttl`
  * 条款勾选：`#chk-terms`
* 支付区：

  * 通道选择：`#sel-payment-method`（`permit2` / `approve_transfer`）
  * 支付按钮：`#btn-pay`
* 结果区：

  * 订单号：`#out-order-id`
  * 支付哈希：`#out-payment-tx`
  * 下载回执：`#btn-download-receipt`
  * 去理赔：`#btn-go-claims`

---

## 5. 报价与规则

* 由后端据参数化定价计算：`保费 = 概率 × 赔付 × (1 + load) + 运营费`。
* 约束：

  * `本金范围`、`杠杆范围`、`可赔上限`、`时间窗口` 由 SKU 定义并在响应中回显。
  * 报价有效期（如 60 秒）；过期需重新预览。
* 前端仅展示，不参与数学计算。

---

## 6. 接口契约（最小集合）

### 6.1 SKU 列表

* `GET /catalog/skus`

  * 出参：`[{ skuId, title, desc, leverageMin, leverageMax, principalMin, principalMax, payoutCap, enabled }]`

### 6.2 报价预览

* `POST /orders/preview`

  * 入参：`{ skuId, principal, leverage, wallet }`
  * 出参：

    ```
    {
      ok: true,
      premiumUSDC: "12.34",
      quoteTTL: 60,
      formulaNote: "p=..., payout=..., load=...",
      payment: {
        usdc: "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913",
        method: ["permit2","approve_transfer"],
        spenderOrVault: "0x...",          // 合约或金库
        chainId: "0x2105"
      },
      idempotencyKey: "ipm_xxx"
    }
    ```
  * 失败码：`SKU_DISABLED` `LEVERAGE_OUT_OF_RANGE` `PRINCIPAL_OUT_OF_RANGE`

### 6.3 创建订单（落单）

* `POST /orders`

  * 入参：

    ```
    {
      skuId, principal, leverage, wallet,
      premiumUSDC, idempotencyKey,
      paymentMethod: "permit2" | "approve_transfer",
      paymentTx?: "0x..."            // 若链上先行
    }
    ```
  * 出参：`{ ok:true, orderId, status:"created"|"paid" }`

### 6.4 查询订单

* `GET /orders/{orderId}` → `{ ok, status, paymentTx, createdAt }`

> 说明：是否“先上链后落单”，由后端策略决定。若先链上支付，`/orders` 携带 `paymentTx`，后端基于 tx 归集与事件校验入账并返回 `paid`。

---

## 7. 支付通道（两条路，后端在预览中声明可用性）

### 7.1 Permit2 一次签名直付（推荐）

* 触发：选择 `permit2`。
* 行为：构造 `Permit2` 允许额度 = `premiumUSDC`，签名后由合约 `spenderOrVault` 拉取 USDC。
* 要求：

  * `deadline` 与 `nonce` 由后端或链上查询提供；过期提示 `PAYMENT_EXPIRED`。
  * 合约需校验签名并按订单粒度消费，不得超额。

### 7.2 批准 + 转账回退

* 触发：选择 `approve_transfer`。
* 行为：先 `approve(spenderOrVault, premium)`，再调用合约 `purchase(...)` 或向金库发起 `transfer`（以预览返回为准）。
* 要求：若仅 `transfer`，后端需通过**监听链上**或 **USDC 归集**识别来款并绑定 `orderId`。

---

## 8. 安全与风控

* **强制 Base 主网**：非 `0x2105` 禁止“支付”。
* **幂等**：`/orders` 必须基于 `idempotencyKey` 幂等；重复点击返回同一 `orderId`。
* **金额锁定**：超出报价 TTL 或金额与报价不符 → `QUOTE_STALE`。
* **双花防护**：同 `wallet + skuId + principal + leverage + quoteWindow` 重复支付需被识别并合并。
* **日志脱敏**：只记录 `orderId`、`wallet`、`skuId`、`paymentTx`；不记录签名明文。

---

## 9. 错误码与文案

| code                   | 说明        | 建议文案                     |
| ---------------------- | --------- | ------------------------ |
| CHAIN_SWITCH_REQUIRED  | 非 Base 主网 | “请切换到 Base 主网再支付”        |
| INSUFFICIENT_USDC      | USDC 余额不足 | “USDC 余额不足以支付保费”         |
| INSUFFICIENT_GAS       | ETH 不足    | “Base 主网 ETH 余额不足以支付矿工费” |
| SKU_DISABLED           | SKU 关闭    | “该产品暂不可用”                |
| LEVERAGE_OUT_OF_RANGE  | 杠杆越界      | “杠杆超出可选范围”               |
| PRINCIPAL_OUT_OF_RANGE | 本金越界      | “本金超出可选范围”               |
| QUOTE_STALE            | 报价过期      | “报价已过期，请重新预览”            |
| PAYMENT_EXPIRED        | 签名过期      | “支付签名已过期，请重试”            |
| PAYMENT_REJECTED       | 用户拒绝      | “已取消支付”                  |
| ONCHAIN_VERIFY_TIMEOUT | 上链核对超时    | “支付已发出，等待确认中”            |

---

## 10. BDD 场景

1. **正常下单（permit2）**

   * Given Base 主网 + USDC 足额
   * When 预览 → 选择 permit2 → 签名 → `/orders`
   * Then 返回 `orderId` 与 `status=paid`，展示 tx
2. **报价过期**

   * Given 预览 60s 后
   * When 支付
   * Then 报 `QUOTE_STALE`，需重新预览
3. **余额不足**

   * Given USDC 不足
   * When 点击支付
   * Then 阻断并提示 `INSUFFICIENT_USDC`
4. **批准回退通道**

   * Given 用户拒绝 permit2
   * When 选择 `approve_transfer` 并完成两步
   * Then `orderId` 返回 `paid`
5. **重复点击**

   * Given 用户多次点击支付
   * When `/orders` 重复请求携带同一 `idempotencyKey`
   * Then 返回同一 `orderId`

---

## 11. 验收标准

* 进入页 ≤1s 拉到 SKU 列表并渲染。
* 预览 ≤1s 返回，包含 TTL 与可用通道。
* 非 Base 主网时支付按钮永久禁用。
* 完成支付后 ≤5s 内能看到 `orderId` 与 tx 链接；≥30s 未确认展示“等待确认”。
* 可下载回执 JSON，含：`orderId, wallet, skuId, principal, leverage, premiumUSDC, paymentTx, createdAt`。

---

## 12. 给 AI 的实施任务（无代码指令）

* 任务 1：实现 `/buy` 页面元素与 ID，并复用“钱包状态机 S0→S3”。
* 任务 2：对接 `GET /catalog/skus` 与 `POST /orders/preview`，渲染倒计时与禁用态。
* 任务 3：实现两条支付通道的交互封装；支付完成后调用 `/orders` 幂等落单。
* 任务 4：实现结果展示与回执下载；失败码与文案按第 9 节映射。
* 任务 5：输出覆盖第 10 节的点测记录（通过/失败与截图占位）。
