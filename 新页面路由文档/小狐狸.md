结论：你要的是“连接小狐狸 + 强制 Base 主网 + 识别/使用 Base 上原生 USDC”的**零代码规范**。下面是可直接落地到你仓库的“钱包连接模块规范”。已对齐前文“API 校验页 / 赔付页”的流程与双机架构。

# 钱包连接 · Base + USDC 规范（零代码）

## 1. 目标与边界

* 目标：在任意业务页（尤其赔付页）确保用户已用 MetaMask 连接，并**处于 Base 主网**，且识别**原生 USDC**资产。
* 边界：不触碰私钥；不保存助记词；仅做链/账户状态机与 UI 引导。
* 关键常量：

  * Base 主网 chainId = **8453**（十六进制 **0x2105**）；RPC `https://mainnet.base.org`；浏览器 `https://basescan.org`。 ([docs.base.org][1])
  * **原生 USDC** 合约（Base 主网）：`0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913`，精度 6。不要把 **USDbC** 混为一谈。([circle.com][2])

## 2. 用户流程（状态机）

* S0 未安装：检测不到 MetaMask → 展示下载引导（不得继续）。错误码 `METAMASK_NOT_FOUND`。
* S1 未连接：显示“连接钱包” → 请求账户授权 → 成功进入 S2；拒绝报 `WALLET_CONNECT_DENIED`。
* S2 已连接但**非 Base**：显示“切换到 Base” → 先 `wallet_switchEthereumChain`，如未添加则 `wallet_addEthereumChain` → 成功进入 S3；拒绝报 `CHAIN_SWITCH_REJECTED`。链不支持报 `CHAIN_UNSUPPORTED`。
* S3 已连接且在 Base：

  * 显示当前地址与简短余额（ETH 用于 gas）。
  * 提供“**添加 USDC 到钱包**”按钮（调用 `wallet_watchAsset`），仅用于前端可见性，**不影响业务**。
  * 对赔付页：若网络与地址满足，才解锁“提交赔付”按钮。

> 目的：任何页用同一状态机，避免各处自行判断。

## 3. 全局 UI 元素与 ID

* 连接：`#btn-connect`（S1 展示）
* 切链：`#btn-switch-base`（S2 展示）
* 添加 USDC：`#btn-add-usdc`（S3 展示，可选）
* 只读展示：`#out-account`, `#out-chain`, `#out-eth-balance`, `#out-usdc-balance`
* 错误提示区：`#out-wallet-error`

## 4. 事件与联动

* 事件名：

  * `wallet:connected` → 负载 `{ address }`
  * `wallet:disconnected`
  * `wallet:chainChanged` → 负载 `{ chainId }`
  * `wallet:accountChanged` → 负载 `{ address }`
* 赔付页联动：

  * 仅当 `chainId===0x2105` 时启用 `#btn-submit`。
  * 若用户把收款地址改为非当前地址，需触发“**地址授权签名**”（EIP-191/712 任选），后端据此验证。

## 5. 资产与网络规范

* **只支持 Base 主网**完成真实赔付。测试阶段可在 Base Sepolia（chainId **84532**）做演示，但提交真实赔付前必须回到 8453。([docs.base.org][1])
* **USDC vs USDbC**

  * 原生 USDC：`0x8335...2913`（Circle 发行，生产使用）。
  * USDbC：早期桥接代币，**不得**用于赔付流。文案需明确区分。([circle.com][2])

## 6. 错误码与文案

| code                  | 场景           | 建议文案                          |
| --------------------- | ------------ | ----------------------------- |
| METAMASK_NOT_FOUND    | 未检测到钱包       | “未检测到 MetaMask，请安装后重试”        |
| WALLET_CONNECT_DENIED | 用户拒绝连接       | “已取消连接，需连接钱包后继续”              |
| CHAIN_SWITCH_REJECTED | 拒绝切链/加链      | “未切换到 Base，无法继续操作”            |
| CHAIN_UNSUPPORTED     | 钱包不支持该链      | “当前钱包不支持 Base 主网”             |
| INSUFFICIENT_GAS      | ETH gas 不足   | “Base 主网 ETH 余额不足以支付矿工费”      |
| USDC_NOT_FOUND        | 未能读取 USDC 余额 | “未识别到 USDC，请点击‘添加 USDC’或稍后重试” |

## 7. BDD 场景（赔付页最小覆盖）

1. **连接+切链成功**

   * Given 未连接且在以太坊主网
   * When 点击“连接钱包”，再点“切换到 Base”
   * Then 展示地址、链=Base、解锁“提交赔付”
2. **拒绝切链**

   * Given 已连接但在 Arbitrum
   * When 用户拒绝切换
   * Then 显示 `CHAIN_SWITCH_REJECTED`，按钮保持禁用
3. **添加 USDC**

   * Given 已在 Base
   * When 点击“添加 USDC”
   * Then 钱包内显示 USDC 资产，页面可读余额
4. **地址与收款人不一致**

   * Given 用户手动输入与当前地址不同的收款地址
   * When 点击提交
   * Then 触发一次授权签名，通过后方可提交
5. **gas 不足**

   * Given `ETH` < 最小阈值
   * When 尝试提交赔付
   * Then 阻断并提示 `INSUFFICIENT_GAS`

## 8. 验收标准

* 首次进入赔付页 ≤1s 内给出明确状态（未连接/需切链/已就绪）。
* 切换到 Base 成功后 ≤100ms 更新 UI 并广播 `wallet:chainChanged`。
* “提交赔付”在非 8453 网络时永远禁用。
* USDC 地址与 decimals 与上文常量一致；任何涉及 USDbC 的场景均提示不支持。([circle.com][2])

## 9. 安全与合规

* 不记录私钥/助记词；不在日志中写入签名原文以外的隐私。
* 所有签名只用于**地址授权**，不授权资金。
* 仅提示“添加网络/资产”，不自动添加。
* 基于官方参数添加/切链，参数源于 Base 官方文档。([docs.base.org][1])

## 10. 给 AI 的实施任务（无代码指令）

* 任务 1：实现“钱包连接状态机”（S0→S3），绑定第 3 节 ID。
* 任务 2：实现链强制为 8453；必要时发起“添加网络”。参数取第 1 节常量。([docs.base.org][1])
* 任务 3：实现“添加 USDC 到钱包”的交互，合约地址取第 1 节常量，decimals=6。([circle.com][2])
* 任务 4：在赔付页中，只有 S3 才能点“提交赔付”；地址不一致时要求一次授权签名。
* 任务 5：输出 BDD 点测记录，覆盖第 7 节 5 个场景。

需要把这一段并入前面“赔付页面规范”的第 2 节（前置条件）与第 3 节（流程）里，我可以直接合并成一版完整文档。

[1]: https://docs.base.org/base-chain/quickstart/connecting-to-base?utm_source=chatgpt.com "Connecting to Base - Base Documentation"
[2]: https://www.circle.com/blog/usdc-now-available-natively-on-base?utm_source=chatgpt.com "USDC Now Available Natively on Base"
