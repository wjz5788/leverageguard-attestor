3) Buy（购买）

前端路由：/buy

页面目的：选择 SKU，录外部订单号 order_ref（交易所订单号），用 USDC 付款，下单入库。

表单字段

sku_id：如 sku_24h_liq

order_ref：如 2938801601245126656（你常用示例）

exchange：OKX/Binance

pair：BTC-USDT …

leverage：整数，如 20

price_usdc：单价（microUSDC，整数）

qty：默认 1

付款方式：USDC on Base（Permit2 优先；否则 approve+transferFrom）

接口 / APIs

GET /catalog/skus（US） → 渲染卡片与定价参数
Res：[{ id, code, name, desc, pricing_json, active }]

POST /orders（US）
Req:

{
  "sku_id":"sku_24h_liq",
  "order_ref":"2938801601245126656",
  "exchange":"OKX",
  "pair":"BTC-USDT",
  "leverage":20,
  "price_usdc":2000000,
  "qty":1
}


Res：

{
  "order_id":"fdeec813-1d08-48e9-a7ca-dceaea45269e",
  "status":"pending",
  "usdc_amount":2000000,
  "pay_to":"0xTreasury...",
  "usdc_contract":"0xUSDC..."
}


钱包链上支付完成后的通知（两种二选一）

Permit2：POST /payments/usdc/permit2（US）
Req：{ "order_id":"...", "permit_payload":{...}, "signature":"0x..." } → 服务端校验 & 记账

回告监听：POST /payments/usdc/notify（US）
Req：{ "order_id":"...", "tx_hash":"0x..." } → 后端再查链并确认
Res：{ "status":"paid" }（确认后）

订单状态机 / Order states

pending → paid →（后续可理赔）

失败：pending → expired | cancelled（非主路径）

数据库 / DB

skus(id, code, name, desc, pricing_json, active, created_at)

orders：

关键字段：order_ref TEXT 外部订单号（需要唯一或至少加索引）

status TEXT：pending|paid|expired|cancelled

total_amount_usdc INTEGER

排序辅助：created_at_epoch INTEGER

payments(order_id, method, tx_hash, chain_id, amount_usdc, status, created_at)

关系

paid 后，页面提示去 /claims/payout 验证并申请赔付。

边界

order_ref 重复：直接返回已有订单或报错 DUPLICATE_ORDER_REF（建议“同一钱包+同一 order_ref 只允许一个有效订单”）。

AI 要点

定价前端仅展示；成交价以后端返回为准，避免被篡改。

金额一律整数传输；UI 显示时格式化。