已对齐你的仓库与双机架构。以下是**赔付页面**的零代码架构规范，人与 AI 均可直接落地。

# 「赔付页面 · 订单取证到上链」架构规范

## 0. 定义

* 目标：用户输入订单号，基于 `verifyKey` 拉取交易所证据，判定是否可赔，确认后完成**链上赔付与取证上链**。
* 边界：只读取证；赔付资产为 **Base 上 USDC**；证据与结果公开可审计。

---

## 1. 路由与页面

* 路由：`/claims/payout`
* 页面名：`PayoutPage`
* 访问：需已连接钱包；需已获得 `verifyKey`（来自 `/settings/exchange-api`）

---

## 2. 前置条件

* 钱包链：Base（chainId `0x2105`）。非 Base → 引导切链。
* 会话：`verifyKey` 有效（默认 30 分钟）。无或过期 → 引导回“API 只读校验页”重建。
* 订单：用户提供 `orderRef`（交易所原始订单号）。

---

## 3. 用户流程（四步）

1. **输入与校验**

   * 输入 `orderRef`，选择交易所（Binance/OKX）与交易对（可选）。
   * 检查 `verifyKey` 是否有效。
2. **取证与资格判定**

   * 调“预审”接口，返回：是否爆仓/强平、时间窗口、PnL、杠杆、SKU 命中与**赔付金额**。
   * 展示**不可赔理由**或**可赔细节**（含证据摘要）。
3. **确认与发起赔付**

   * 用户确认收款地址（默认当前钱包地址）。
   * 生成 `claimId`，触发赔付流程。
4. **结果与上链**

   * 展示赔付 TX（Base 上 USDC 转账或合约事件）、证据上链 TX（Attestation/MerkleRoot），提供区块浏览器链接与本地保存凭证。

---

## 4. 页面元素与 ID

* 输入区：

  * 交易所选择：`#sel-exchange`
  * 订单号：`#in-order-ref`
  * 交易对（可选）：`#sel-symbol`
* 资格区（只读）：

  * 资格结果：`#out-eligibility`（`eligible | ineligible`）
  * 赔付金额：`#out-payout-amount`（USDC）
  * 原因列表：`#out-reasons`
* 确认区：

  * 收款地址：`#in-payee`（默认当前钱包）
  * 勾选声明：`#chk-terms`（“信息属实，愿意接受审计”）
* 按钮：

  * 预审：`#btn-preview`
  * 提交赔付：`#btn-submit`
  * 查看进度：`#btn-status`
  * 下载凭证：`#btn-download-proof`
* 结果区：

  * 赔付交易哈希：`#out-payout-tx`
  * 证据上链交易哈希：`#out-attest-tx`

---

## 5. 金额与规则（对齐你项目的 SKU/参数化）

* 输入：`本金`、`杠杆`、`触发类型`（强平/ADL）、`时间窗口`、`SKU`。
* 计算：`赔付 = min(固定赔付 | 按比例赔付, SKU 上限)`。
* 作为后端“预审”输出字段：`payoutUSDC`、`skuId`、`capApplied`、`formulaNote`。
* 结果只读，前端不自行计算。

---

## 6. 前后端契约（最小可用，US-backend 统一入口 → JP-verify/链上）

> 仅列入赔付相关。`verifyKey` 来自“API 只读校验”。

### 6.1 预审（资格与金额）

* `POST /claims/preview`

  * 入参：`{ verifyKey, exchange, orderRef, symbol?, wallet }`
  * 成功：

    ```json
    {
      "ok": true,
      "eligible": true,
      "payoutUSDC": "25.00",
      "skuId": "SKU-24H-FIXED",
      "evidenceSummary": { "event": "LIQUIDATION", "ts": 1699999999, "leverage": 20, "pnl": "-100.5" },
      "reasons": [],
      "idempotencyKey": "ipm_xxx"    // 前端需原样回传到 submit
    }
    ```
  * 不可赔：`ok:true, eligible:false, reasons:[...]`（如 `NO_LIQUIDATION`, `WINDOW_MISS`, `SUSPECT_FRAUD`）

### 6.2 提交赔付

* `POST /claims/submit`

  * 入参：`{ verifyKey, exchange, orderRef, payoutTo, idempotencyKey }`
  * 出参：`{ ok:true, claimId, status:"submitted"|"eligible"|"ineligible" }`

### 6.3 发起链上赔付

* `POST /claims/{claimId}/payout`

  * 入参：`{ }`（服务端已知 payoutTo、金额）
  * 出参：

    * 模式 A（真实链上）：`{ ok:true, status:"paying", payoutTx:"0x...", chainId:"0x2105" }`
    * 模式 B（模拟/资金不足）：`{ ok:true, status:"admin_pending" }`

### 6.4 轮询状态

* `GET /claims/{claimId}/status`

  * 出参示例：

    ```json
    {
      "ok": true,
      "status": "paid",       // submitted|eligible|ineligible|paying|paid|onchain|rejected
      "payoutTx": "0x...",
      "attestTx": "0x...",    // 证据上链
      "payoutUSDC": "25.00",
      "reasons": []
    }
    ```

### 6.5 证据与上链凭证

* `GET /claims/{claimId}/evidence` → 证据摘要、Merkle 叶与路径、可下载 JSON。
* `GET /attestations/{claimId}` → 上链细节（合约地址、区块号、事件 log）。

> 要求：所有接口对 `verifyKey` 做会话校验；`submit/payout` 再做“同钱包”校验（payoutTo 必须等于当前连接钱包或经签名授权）。

---

## 7. 合约与链（Base）

* 链：Base 主网 `0x2105`；测试阶段允许 Base Sepolia。
* 赔付实现：

  * 方案 1：由平台托管金库向用户地址发送 USDC（`transfer`）。
  * 方案 2：调用你方“赔付合约”记录事件与资金流（推荐，便于审计）。
* 取证上链：

  * 事件：`ClaimAttested(claimId, merkleRoot, payout, receiver)` 或等价。
  * 要求：`attestTx` 哈希必须回传到前端展示。
* 失败回滚：链上失败 → `status="rejected"` 并注明 `reasons`。

---

## 8. 安全与合规

* 只读：`verifyKey` 不包含交易权限。
* Idempotency：`claims/submit` 必须接受 `idempotencyKey`，重复提交返回同一 `claimId`。
* 双花防护：同 `orderRef` + `receiver` 在同一 SKU 内**只能成功一次**。
* 反欺诈：黑名单、冷却期、异常模式（自成交刷单、API 多地登录）。不可赔时给出明确 `reasons`。
* 日志脱敏：不记 `apiKey/secret` 等敏感字段；`verifyKey` 可记录。

---

## 9. 错误码与文案

| code                  | 解释        | 建议文案                    |
| --------------------- | --------- | ----------------------- |
| NO_VERIFY_KEY         | 缺少会话      | “请先在‘交易所 API 校验’完成只读连接” |
| ORDER_NOT_FOUND       | 无此订单      | “未找到该订单，请核对后重试”         |
| NO_LIQUIDATION        | 未发生强平/ADL | “不满足赔付条件（无强平/ADL）”      |
| WINDOW_MISS           | 超出时间窗口    | “超出可赔付时间窗口”             |
| SKU_MISS              | 无匹配 SKU   | “不在当前保障范围”              |
| INSUFFICIENT_SCOPE    | 权限不足      | “API 未授权读取订单/持仓”        |
| SUSPECT_FRAUD         | 风控拒绝      | “异常请求，暂不赔付”             |
| CHAIN_SWITCH_REQUIRED | 钱包链错误     | “请切换到 Base 网络”          |
| PAYOUT_FAILED         | 赔付交易失败    | “赔付失败，请稍后重试或联系支持”       |
| ATTEST_FAILED         | 上链失败      | “证据上链失败，将重试或人工处理”       |
| ADMIN_PENDING         | 人工复核      | “已提交，等待人工复核”            |
| NETWORK_ERROR         | 网络错误      | “网络错误或服务不可用”            |

---

## 10. BDD 场景

1. **成功赔付**：有强平 → 预审 `eligible=true`，赔付 25 USDC → `submit` → `payout` 返回 `paying` → `status=paid` → `attestTx` 回填 → 最终 `status=onchain`。
2. **不满足条件**：`NO_LIQUIDATION` → 不出现“提交赔付”按钮。
3. **同单去重**：重复 `submit`（同 `idempotencyKey`）→ 返回同一 `claimId`；不同 `idempotencyKey` 但同订单+收款人 → 拒绝。
4. **链上失败**：`payout` 发出但交易失败 → `status=rejected`，展示 `PAYOUT_FAILED`。
5. **证据上链延迟**：`paid` 后 5s 内未上链 → 继续轮询，最后 `onchain` 或 `ATTEST_FAILED`。
6. **链错误**：用户在非 Base → 弹“切换网络”，未切换禁止提交。
7. **会话过期**：`verifyKey` 过期 → `NO_VERIFY_KEY`，引导回只读校验页。

---

## 11. 验收标准

* 非 Base 链禁止提交赔付。
* 预审 ≤3s 返回；提交与发起赔付接口均可幂等。
* 赔付与上链哈希均可点击跳转区块浏览器。
* 不可赔时必须给出**明确 reasons**。
* 导出本次赔付凭证（JSON）内容包含：`claimId, orderRef, payoutUSDC, receiver, payoutTx, attestTx, merkleRoot, evidenceSummary, timestamp`。

---

## 12. 给 AI 的实施任务（无代码指令）

* 任务 1：实现 `/claims/payout` 页面与第 4 节元素 ID。
* 任务 2：实现“预审→提交→赔付→轮询”的按钮状态机，禁用态遵守第 2 节前置条件。
* 任务 3：在 US-backend 暴露 6.1–6.5 的接口；`submit` 支持 `idempotencyKey`；`status` 提供完整状态机。
* 任务 4：在 JP-verify 复用 `verifyKey` 拉取订单证据，输出 `evidenceSummary` 与资格判定。
* 任务 5：在链侧完成 USDC 赔付与取证上链；回传 `payoutTx/attestTx`。
* 任务 6：输出一份 BDD 点测记录，覆盖第 10 节 7 个场景。

---

## 13. 与仓库的关联

* 仓库：`wjz5788/leverageguard-attestor`。
* 本页依赖：

  * JP-verify：取证与会话。
  * US-backend：`/claims/*` 网关与链上执行器。
  * 合约：Base 上 USDC 付款与 `ClaimAttested` 事件。

需要我把这份规范展开成 PR 模板或 Notion 页面，说明。
