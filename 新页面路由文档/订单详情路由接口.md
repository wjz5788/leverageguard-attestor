import React, { useEffect, useMemo, useState } from "react";

/**
 * LiqPass · 24h 保单 · 订单卡列表（React/TSX 单文件）
 * 修复：`SyntaxError: /index.tsx: Unexpected token (1:0)`
 * 根因：在 .tsx 文件中放入了 Markdown 文本。现改为**有效 TSX 组件**。
 *
 * 规范对齐（来源于你的规格）：
 * - 订单卡 = 24h 保单实例；购买即上链；链上仅存最小可审计指纹。
 * - 列表按 createdAt 倒序；展示倒计时至 coverageEndTs；状态机：
 *   pending_onchain → active → expired 或 claimed_*。
 * - 卡片显示：Principal/Leverage/Premium/PayoutMax，状态徽章+倒计时；
 *   底部按钮：查看链上 | 发起理赔(仅有效期内) | 详情；
 *   次要信息：购买时间、覆盖窗口、orderRef、exchangeAccountId。
 * - 数据来源：GET /orders（失败则回落到内置 mock）。
 *
 * 约定：
 * - /orders 返回的时间字段可能是 ISO 字符串或秒/毫秒时间戳；统一容错。
 * - Base 扫描器链接按 `chain === "Base"` 走 https://basescan.org/tx/{txHash}
 * - “发起理赔”仅做占位，待你确认实际 API 与入参（见文件末尾问题）。
 *
 * 自测：提供最小测试用例（不会发网络），仅校验排序、倒计时与按钮可用性逻辑。
 */

// =============================
// 类型
// =============================

type PolicyStatus =
  | "pending_onchain"
  | "active"
  | "expired"
  | "claimed_pending"
  | "claimed_paid"
  | "claimed_denied";

type ChainName = "Base" | string;

interface OrderCardData {
  id: string;
  title?: string; // 如 "24h 爆仓保"
  principal: number;
  leverage: number;
  premiumPaid: number; // USDC
  payoutMax: number; // USDC
  status: PolicyStatus | string;
  coverageStartTs: number | string; // 秒/毫秒/ISO 皆可
  coverageEndTs: number | string;   // 秒/毫秒/ISO 皆可
  createdAt: string;                // ISO
  orderRef: string;
  exchangeAccountId?: string;
  chain: ChainName;
  txHash: string;
  orderDigest: string; // 0x...
  skuId?: string;
}

// =============================
// 工具函数
// =============================

const toMs = (t: number | string): number => {
  if (t == null) return NaN;
  if (typeof t === "number") {
    // 判断是秒还是毫秒：小于 10^12 视为秒
    return t < 1e12 ? t * 1000 : t;
  }
  // 字符串：可能是纯数字或 ISO
  const n = Number(t);
  if (!Number.isNaN(n)) return n < 1e12 ? n * 1000 : n;
  const d = new Date(t).getTime();
  return Number.isFinite(d) ? d : NaN;
};

const fmtDate = (ts: number | string) => {
  const ms = toMs(ts);
  if (!Number.isFinite(ms)) return String(ts);
  return new Intl.DateTimeFormat("zh-CN", {
    year: "numeric", month: "2-digit", day: "2-digit",
    hour: "2-digit", minute: "2-digit", second: "2-digit",
    hour12: false,
  }).format(new Date(ms));
};

const num = (n: number, p = 2) => {
  if (typeof n !== "number" || Number.isNaN(n)) return "-";
  return n.toLocaleString("en-US", { minimumFractionDigits: p, maximumFractionDigits: p });
};

const openChainTx = (chain: ChainName, tx: string) => {
  let url = "";
  if (/^0x[0-9a-fA-F]{64}$/.test(tx)) {
    if (chain === "Base") url = `https://basescan.org/tx/${tx}`;
  }
  if (!url) url = `https://basescan.org/tx/${tx}`; // 兜底
  window.open(url, "_blank");
};

// =============================
// 自测（最小断言）
// =============================

function assert(cond: unknown, msg: string) {
  if (!cond) throw new Error(msg);
}

function runSelfTests() {
  const logs: string[] = [];
  // T1: toMs 兼容秒/毫秒/ISO
  const now = Date.now();
  assert(Math.abs(toMs(now) - now) < 2, "T1a ms passthrough");
  assert(Math.abs(toMs(Math.floor(now / 1000)) - now) < 1100, "T1b sec→ms");
  assert(Math.abs(toMs(new Date(now).toISOString()) - now) < 1100, "T1c iso→ms");
  logs.push("T1 ok");

  // T2: 倒计时为 0 时判定为过期
  const endSoon = Date.now() + 500; // 0.5s
  const remain = Math.max(0, endSoon - Date.now());
  assert(remain >= 0, "T2 remain non-negative");
  // 模拟 1s 后
  const remainAfter = Math.max(0, endSoon - (Date.now() + 1000));
  assert(remainAfter === 0, "T2 reach zero");
  logs.push("T2 ok");

  // T3: 排序（createdAt desc）
  const items = [
    { createdAt: new Date(now - 1000).toISOString() },
    { createdAt: new Date(now - 3000).toISOString() },
    { createdAt: new Date(now - 2000).toISOString() },
  ];
  const sorted = [...items].sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
  assert(sorted[0].createdAt > sorted[1].createdAt, "T3 order 0>1");
  assert(sorted[1].createdAt > sorted[2].createdAt, "T3 order 1>2");
  logs.push("T3 ok");

  // T4: “发起理赔”仅对 active+未过期 可用（逻辑层）
  const isClaimEnabled = (status: PolicyStatus, end: number) => status === "active" && Date.now() < end;
  assert(isClaimEnabled("active", Date.now() + 10000) === true, "T4 enable active within");
  assert(isClaimEnabled("active", Date.now() - 10000) === false, "T4 disable active expired");
  assert(isClaimEnabled("pending_onchain", Date.now() + 10000) === false, "T4 disable pending_onchain");
  logs.push("T4 ok");

  // T5: 指纹形态（不校验值，只校验外形为 0x 前缀 hex）
  assert(/^0x[0-9a-fA-F]+$/.test("0xdeadbeef"), "T5 digest shape");
  logs.push("T5 ok");

  // T6: 覆盖窗口短格式
  const s6 = fmtCoverageRange(now, now + 24*3600*1000);
  assert(s6.includes(' → '), 'T6 arrow');
  const colons = (s6.match(/:/g) || []).length;
  assert(colons === 2, 'T6 no seconds');
  logs.push("T6 ok");

  return { ok: true, logs } as const;
}

// =============================
// Mock 数据（后端失败时使用）
// =============================

function makeMockOrders(): OrderCardData[] {
  const baseNow = Date.now();
  const mk = (p: Partial<OrderCardData>): OrderCardData => ({
    id: crypto?.randomUUID?.() ?? Math.random().toString(36).slice(2),
    title: "24h 爆仓保",
    principal: 200,
    leverage: 10,
    premiumPaid: 3.2,
    payoutMax: 60,
    status: "active",
    coverageStartTs: Math.floor((baseNow - 60_000) / 1000),
    coverageEndTs: Math.floor((baseNow + 23 * 3600_000 + 59 * 60_000) / 1000),
    createdAt: new Date(baseNow - 5_000).toISOString(),
    orderRef: String(10_000_000_000 + Math.floor(Math.random() * 9_000_000_000)),
    exchangeAccountId: "eacc_mock",
    chain: "Base",
    txHash: "0x" + "a".repeat(64),
    orderDigest: "0x" + "b".repeat(64),
    skuId: "SKU_24H_FIXED",
    ...p,
  });

  return [
    mk({ status: "active", createdAt: new Date(baseNow - 1_000).toISOString() }),
    mk({ status: "pending_onchain", createdAt: new Date(baseNow - 2_000).toISOString() }),
    mk({ status: "claimed_pending", createdAt: new Date(baseNow - 3_000).toISOString() }),
    mk({ status: "claimed_paid", createdAt: new Date(baseNow - 4_000).toISOString() }),
    mk({ status: "expired", coverageEndTs: Math.floor((baseNow - 10_000) / 1000), createdAt: new Date(baseNow - 5_000).toISOString() }),
  ];
}

// =============================
// 主组件
// =============================

export default function OrdersCardsPage({ apiBase = "" }: { apiBase?: string }) {
  const ORDERS_URL = apiBase ? `${apiBase.replace(/\/$/, "")}/orders` : "/orders";

  // 数据与加载态
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string>("");
  const [rows, setRows] = useState<OrderCardData[]>([]);

  // 自测结果展示
  const [tests, setTests] = useState<{ ok: boolean; logs: string[]; err?: string }>({ ok: true, logs: [] });

  // 每秒 tick 触发重渲染以更新倒计时
  const [tick, setTick] = useState(0);
  useEffect(() => { const t = setInterval(() => setTick((v) => v + 1), 1000); return () => clearInterval(t); }, []);

  // 拉取列表
  const refresh = async () => {
    setLoading(true); setError("");
    try {
      const res = await fetch(ORDERS_URL, { method: "GET" });
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      const data = await res.json();
      const list: any[] = Array.isArray(data?.orders) ? data.orders : Array.isArray(data) ? data : [];
      const normalized: OrderCardData[] = list.map((r: any, i: number) => ({
        id: r.id ?? r.orderId ?? `${Date.now()}-${i}`,
        title: r.title ?? "24h 爆仓保",
        principal: Number(r.principal ?? 0),
        leverage: Number(r.leverage ?? 0),
        premiumPaid: Number(r.premiumPaid ?? r.premium ?? 0),
        payoutMax: Number(r.payoutMax ?? 0),
        status: String(r.status ?? "active"),
        coverageStartTs: r.coverageStartTs ?? r.coverage_start_ts ?? r.startTs ?? r.start_at,
        coverageEndTs: r.coverageEndTs ?? r.coverage_end_ts ?? r.endTs ?? r.end_at,
        createdAt: r.createdAt ?? r.created_at ?? new Date().toISOString(),
        orderRef: r.orderRef ?? r.order_ref ?? "",
        exchangeAccountId: r.exchangeAccountId ?? r.exchange_account_id,
        chain: r.chain ?? "Base",
        txHash: r.txHash ?? r.tx_hash ?? "",
        orderDigest: r.orderDigest ?? r.order_digest ?? "",
        skuId: r.skuId ?? r.sku_id ?? "SKU_24H_FIXED",
      }));
      // 按 createdAt desc
      normalized.sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
      setRows(normalized);
    } catch (e: any) {
      console.warn("/orders failed, fallback to mock:", e?.message || e);
      setError("订单服务不可用，展示演示数据");
      const mock = makeMockOrders().sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
      setRows(mock);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => { refresh(); /* eslint-disable-next-line */ }, [apiBase]);

  // 运行自测
  useEffect(() => {
    try { setTests(runSelfTests()); }
    catch (err: any) { setTests({ ok: false, logs: [], err: String(err?.message || err) }); }
  }, []);

  // 过滤与派生
  const total = rows.length;

  return (
    <div style={{ minHeight: "100vh", background: "#FFF7ED", color: "#3F2E20" }}>
      {/* 顶部条 */}
      <div style={{ position: "sticky", top: 0, zIndex: 40, background: "#FFF7EDF2", borderBottom: "1px solid #e7e5e4" }}>
        <div style={{ maxWidth: 1120, margin: "0 auto", padding: "0 16px", height: 56, display: "flex", alignItems: "center", justifyContent: "space-between" }}>
          <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
            <div style={{ width: 28, height: 28, borderRadius: 12, background: "#fcd34d", border: "1px solid rgba(0,0,0,0.06)" }} />
            <div style={{ fontWeight: 600 }}>订单管理</div>
            <div style={{ fontSize: 12, color: "#71717a" }}>倒序 · 共 {total} 笔</div>
            {loading && <div style={{ fontSize: 12, color: "#92400e" }}>加载中</div>}
            {error && <div style={{ fontSize: 12, color: "#b91c1c" }}>{error}</div>}
          </div>
          <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
            <button onClick={refresh} style={btn()}>刷新</button>
          </div>
        </div>
      </div>

      {/* 自测结果 */}
      <div style={{ maxWidth: 1120, margin: "8px auto 0", padding: "0 16px" }}>
        {tests.ok ? (
          <div style={{ background: "#ecfeff", color: "#164e63", padding: 8, borderRadius: 8, fontSize: 12 }}>Self-tests passed: {tests.logs.join(", ")}</div>
        ) : (
          <div style={{ background: "#fee2e2", color: "#7f1d1d", padding: 8, borderRadius: 8, fontSize: 12 }}>Self-tests failed: {tests.err}</div>
        )}
      </div>

      {/* 卡片列表 */}
      <div style={{ maxWidth: 1120, margin: "8px auto 24px", padding: "0 16px", display: "grid", gap: 12 }}>
        {rows.map((o) => (
          <OrderCard key={o.id} data={o} />
        ))}
        {rows.length === 0 && (
          <div style={{ padding: 24, background: "#fff", border: "1px solid #e5e7eb", borderRadius: 12, color: "#71717a" }}>暂无订单</div>
        )}
      </div>
    </div>
  );
}

// =============================
// 子组件：订单卡
// =============================

const OrderCard: React.FC<{ data: OrderCardData }> = ({ data }) => {
  const { principal, leverage, premiumPaid, payoutMax, status, coverageStartTs, coverageEndTs, createdAt, orderRef, exchangeAccountId, chain, txHash, orderDigest, title } = data;

  const endMs = toMs(coverageEndTs);
  const now = Date.now();
  const remainMs = Math.max(0, endMs - now);
  const isExpiredUi = remainMs <= 0 || status === "expired";

  const badge = (s: string) => {
    const map: Record<string, { t: string; bg: string; fg: string }> = {
      pending_onchain: { t: "上链确认中", bg: "#fef9c3", fg: "#854d0e" },
      active: { t: "生效中", bg: "#dcfce7", fg: "#065f46" },
      expired: { t: "已过期", bg: "#e5e7eb", fg: "#374151" },
      claimed_pending: { t: "理赔审核", bg: "#dbeafe", fg: "#1e3a8a" },
      claimed_paid: { t: "已赔付", bg: "#dcfce7", fg: "#065f46" },
      claimed_denied: { t: "理赔拒绝", bg: "#fee2e2", fg: "#7f1d1d" },
    };
    const v = map[s] || { t: s, bg: "#e5e7eb", fg: "#374151" };
    return <span style={{ background: v.bg, color: v.fg, padding: "2px 8px", borderRadius: 999, fontSize: 12 }}>{v.t}</span>;
  };

  const fmtRemain = (ms: number) => {
    const s = Math.floor(ms / 1000);
    const hh = String(Math.floor(s / 3600)).padStart(2, "0");
    const mm = String(Math.floor((s % 3600) / 60)).padStart(2, "0");
    const ss = String(s % 60).padStart(2, "0");
    return `T-${hh}:${mm}:${ss}`;
  };

  const claimEnabled = status === "active" && !isExpiredUi;

  return (
    <div style={{ background: "#fff", border: "1px solid #e5e7eb", borderRadius: 12, padding: 16 }}>
      {/* 顶部 */}
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", gap: 12 }}>
        <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
          <div style={{ fontWeight: 600 }}>{title || "24h 爆仓保"}</div>
          <div style={{ display: "flex", gap: 8, flexWrap: "wrap" }}>
            <SmallKV k="Principal" v={`$${num(principal, 2)}`} />
            <SmallKV k="Leverage" v={`${leverage}×`} />
            <SmallKV k="Premium" v={`$${num(premiumPaid, 2)}`} />
            <SmallKV k="Payout Max" v={`$${num(payoutMax, 2)}`} />
          </div>
        </div>
        <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
          {badge(isExpiredUi ? "expired" : String(status))}
          <span style={{ fontFamily: "ui-monospace, SFMono-Regular, Menlo, monospace", fontSize: 13, color: "#0f172a" }}>{isExpiredUi ? "T-00:00:00" : fmtRemain(remainMs)}</span>
        </div>
      </div>

      {/* 次要信息 */}
      <div style={{ marginTop: 8, display: "grid", gridTemplateColumns: "repeat(4, minmax(0, 1fr))", gap: 8, fontSize: 13, color: "#52525b" }}>
        <Field label="购买时间" value={fmtDate(createdAt)} />
        <Field label="覆盖窗口" value={`${fmtDate(coverageStartTs)} → ${fmtDate(coverageEndTs)}`} />
        <Field label="订单号" value={orderRef?.slice(-8)} mono />
        <Field label="最近校验账号" value={exchangeAccountId || "-"} mono />
      </div>

      {/* 动作 */}
      <div style={{ marginTop: 12, display: "flex", gap: 8, flexWrap: "wrap" }}>
        <button style={btn()} onClick={() => openChainTx(data.chain, data.txHash)}>查看链上</button>
        <button style={btn(!claimEnabled)} disabled={!claimEnabled} onClick={() => onClaimClick(data)}>发起理赔</button>
        <button style={btn()} onClick={() => onDetailClick(data)}>详情</button>
      </div>

      {/* 原始 JSON（调试用） */}
      <details style={{ marginTop: 8 }}>
        <summary style={{ cursor: "pointer", color: "#6b7280" }}>原始 JSON</summary>
        <pre style={{ marginTop: 8, background: "#0a0a0a", color: "#e5e5e5", padding: 12, borderRadius: 10, overflow: "auto", fontSize: 12 }}>{JSON.stringify(data, null, 2)}</pre>
      </details>
    </div>
  );
};

function onClaimClick(o: OrderCardData) {
  // 待你确认：POST /claims/verify 还是 /claims/start ？入参 {orderId}? {orderRef}? {exchangeAccountId}?
  // 这里暂以 alert 占位，避免误调用。
  alert(`发起理赔（占位）：orderId=${o.id}, orderRef=${o.orderRef}`);
}

function onDetailClick(o: OrderCardData) {
  alert(`详情（占位）: ${o.id}`);
}

// =============================
// UI 小部件
// =============================

const SmallKV: React.FC<{ k: string; v: string }> = ({ k, v }) => (
  <span style={{ background: "#f8fafc", border: "1px solid #e5e7eb", borderRadius: 8, padding: "2px 8px", fontSize: 12 }}>
    <b style={{ color: "#334155" }}>{k}</b> <span style={{ color: "#0f172a" }}>{v}</span>
  </span>
);

const Field: React.FC<{ label: string; value: React.ReactNode; mono?: boolean }> = ({ label, value, mono }) => (
  <div style={{ display: "flex", gap: 8 }}>
    <span style={{ color: "#737373", whiteSpace: "nowrap", wordBreak: "keep-all" }}>{label}</span>
    <span style={{ fontFamily: mono ? "ui-monospace, SFMono-Regular, Menlo, monospace" : undefined }}>{value}</span>
  </div>
);

function btn(disabled = false): React.CSSProperties {
  return { padding: "8px 12px", borderRadius: 10, background: disabled ? "#f5f5f5" : "#ffffff", border: "1px solid #e5e7eb", cursor: disabled ? "not-allowed" : "pointer" };
}
