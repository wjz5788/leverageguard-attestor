## 问题定位

* 前端详情页当前未接后端，依赖 `localStorage` 与演示数据，导致真实订单无法展示：`apps/us-frontend/src/pages/OrderDetailPage.tsx:103-107`。

* 后端已存在 `GET /api/v1/orders/:orderId`，但使用 API Key 保护，前端钱包登录无法访问：`apps/us-backend/src/routes/orders.ts:217-261`。

* 列表页已按保单视角展示，但“交易所账户”可能为空（后端字段为 `exchange`，前端映射需兼容）：`apps/us-frontend/src/pages/OrdersPage.tsx:273-277`。

## 前端改动

* 在 `apps/us-frontend/src/pages/OrderDetailPage.tsx` 接入后端详情：

  * 读取路由参数 `id` 并调用 `GET /api/v1/orders/:orderId`。

  * 使用已有鉴权封装自动附带 Bearer token 与 `credentials: 'include'`：`apps/us-frontend/src/lib/authFetch.ts:1-20`。

  * 将返回的 `order`+`sku` 数据映射为保单视角字段（不展示交易所订单号/摘要）：

    * 保单号：`order.id`

    * 交易所账户：用 `order.exchange` 作为账号标签（后续可接用户绑定别名）

      ˙

    * 创建时间：`order.createdAt`

    * 保障窗口：`createdAt → createdAt + sku.windowHours`

    * 支付交易哈希：`order.paymentTx`

    * 产品概要：`principal`、`leverage`、`premiumUSDC6d/payoutUSDC6d → $`

    * 状态时间线：创建、生效、进行中/已结束，剩余 `T-xx:xx:xx`

  * 保留按钮逻辑：

    * “查看链上交易”使用现有 `getExplorerTxUrl`：`apps/us-frontend/src/lib/explorer.ts`

    * “发起理赔”跳转：`/claims?orderId=${id}`（现有实现：`apps/us-frontend/src/pages/OrderDetailPage.tsx:135-137`）

  * 降级策略：接口报错时仍回退到本地/演示数据，UI提示“演示数据”。

## 后端改动

* 在 `apps/us-backend/src/routes/orders.ts` 新增一个面向 C 端的钱包会话版本详情接口：

  * 路由：`GET /api/v1/orders/:orderId`（改为支持钱包会话）或增加并行端点 `GET /api/v1/orders/:orderId/view`。

  * 认证：使用钱包会话中间件（Bearer 或 `x-session-token`）而非 API Key：`apps/us-backend/src/middleware/authMiddleware.ts:35-62`。

  * 鉴权：只允许查看自己订单（按 `req.auth.address === order.wallet`）。

  * 返回前端友好映射（保单视角 JSON）：

    ```ts
    {
      id,
      productName, productSku,
      notional_usdc_6d, premium_usdc_6d, maxPayout_usdc_6d,
      leverage,
      exchangeAccount: order.exchange,
      createdAt,
      coverageFrom, coverageTo,
      txHash: order.paymentTx,
      statusLabel, remainLabel,
      timeline: { createdAt, activatedAt: coverageFrom, runningLabel: remainLabel }
    }
    ```

  * 计算函数：`statusLabel`、`remainLabel` 与窗口起止，基于 `createdAt` 与 `sku.windowHours`。

  * 保留现有 API Key 版 `GET /api/v1/orders/:orderId`（用于后台）不变。

## 列表页微调

* `apps/us-frontend/src/pages/OrdersPage.tsx` 的映射 `exchangeAccountId` 兼容后端 `exchange`：

  * 优先取 `exchangeAccountId`，否则回退 `exchange`。

  * 保持“保单号”“覆盖窗口”“查看链上”“理赔”按钮现有逻辑。

## 验证与测试

* 启动后端并配置支付/会话环境变量；通过钱包登录获取 token：`/api/v1/auth/wallet/*`（前端已有调用：`apps/us-frontend/src/lib/auth.ts:69-85`）。

* 访问列表 `/orders` → 点击任一卡片“详情”跳转 `/orders/:id`。

* 断言详情页：

  * 存在“保单号”“支付交易（链上哈希）”，不出现“订单摘要/交易所订单号”。

  * “查看链上交易”打开 Basescan，理赔按钮跳转 `/claims?orderId=...`。

  * 倒计时与状态标签随时间正确变化。

* 接口不可用时，页面显示演示提示并正常渲染。

## 提交与文档

* 前端提交信息：`feat(frontend): 接入订单详情后端，统一保单视角展示`

* 后端提交信息：`feat(backend): 新增钱包会话版订单详情接口，返回保单视角 JSON`

* 更新变更记录文档与最小上线 checklist（保持原有文档结构，不新增不必要文件）。

## 兼容与后续

* 保留后台 API Key 详情接口，C 端使用钱包会话版本。

* 后续可将“交易所账户”接入用户绑定别名；理赔详情页同样按保单视角新增 `GET /api/v1/claims/:claimId`。

