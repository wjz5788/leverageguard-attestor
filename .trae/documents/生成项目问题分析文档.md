# 项目问题分析与改进计划

## 文档目标与范围
- 输出一份结构化的 Markdown 文档，系统梳理当前仓库的架构、问题清单、影响评估与修复建议
- 覆盖后端（apps/us-backend）、前端（apps/us-frontend）、链监听器（apps/chain-listener）、智能合约（contracts）、Python 校验服务（apps/jp-verify）及工作流与文档

## 计划输出
- 文件名：`项目分析与问题清单.md`
- 位置建议：`docs/02-技术文档/`（如需变更可调整到用户指定目录）
- 文档结构：
  1. 项目概览（模块与职责）
  2. 架构与数据流（API ↔ 前端 ↔ 监听器 ↔ 合约）
  3. 关键问题清单（按模块分组，含文件定位与影响评估）
  4. 安全与合规审查要点（认证、CORS、密钥管理、日志脱敏）
  5. 性能与可靠性风险（限流、重试、数据库并发、构建产物）
  6. 修复建议与优先级（P0/P1/P2）
  7. 后续维护策略（变更追踪、文档更新节奏）

## 主要问题快照（样例）
- 后端启动冲突：`apps/us-backend/src/app.ts:98` 已创建监听；`apps/us-backend/src/server.ts:22` 再次监听，造成重复启动与端口冲突
- 构建产物缺失：`apps/us-backend/tsconfig.json:14` `noEmit: true` 与 `start` 依赖 `dist/server.js` 矛盾，生产无法启动
- 数据库库不一致：代码用 `better-sqlite3`（`apps/us-backend/src/database/db.ts:1`），依赖却是 `sqlite3`（`apps/us-backend/package.json:31`）
- 依赖缺失：`http-terminator`、`swagger-ui-express`、`yamljs` 在代码中使用（`apps/us-backend/src/app.ts:6-8`），不在依赖中
- 文档加载路径不匹配：尝试加载 `swagger.yaml`（`apps/us-backend/src/app.ts:74`），仓库实际为 `openapi.json`
- workspace 过滤名不匹配：根脚本使用 `--filter us-frontend`（根 `package.json:13-17`），实际包名为 `liqpass-frontend`（`apps/us-frontend/package.json:2`）
- 链监听器与后端数据库分裂：监听器默认 `./database.db`（`apps/chain-listener/src/watchers/checkoutUSDC.mjs:13`），后端默认 `./data/us-backend.db`（`apps/us-backend/src/database/db.ts:23`），导致数据不一致
- 未实现的导入：`setupSwagger` 引用不存在文件（`apps/us-backend/src/app.ts:22`），编译报错风险

## 实施步骤
1. 复核并补充问题清单：按模块全面扫描，补充文件定位（`file_path:line_number`）与影响说明
2. 起草文档骨架并填充问题条目：按 P0/P1/P2 标注优先级与修复建议
3. 增加安全与合规章节：认证流程、CORS 策略、密钥与日志脱敏清单
4. 增加性能与可靠性章节：限流、重试、数据库模式、构建发布流程
5. 提供可操作的修复路线图：短期修复（1-2 天）、中期（1 周）、长期（>1 周）
6. 保存为 Markdown 文件至约定目录，并在后续改动中使用 Git 提交记录同步更新（遵循“每次的修改，利用git 提交记录，更新文档”）

## 验收标准
- 文档完整且可读：含架构概览、问题定位、影响评估、修复建议与优先级
- 问题条目均有明确代码定位与可执行的修复方案
- 与现有文档目录结构一致，后续可持续更新

## 预计用时
- 全量梳理与成文：半天内完成初稿；一天内完成补充与交付
