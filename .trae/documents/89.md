好，这个前端版本已经可以“吃真数据”了，后端现在只要补几块就能上线。

我帮你拆成一个**最小上线 checklist**，照着做就行。

---

## 0. 你现在这页前端的约定

`OrderDetailPage` 会请求：

```http
GET /api/v1/orders/:orderId
```

并且期望拿到这样的 JSON（字段可以多，但这几个最好有）：

```ts
{
  id: "LP-2025-11-15-0001",
  productName: "24h 爆仓保",
  productSku: "SKU_24H_FIX",
  notional_usdc_6d: 200000000,
  premium_usdc_6d: 3200000,
  maxPayout_usdc_6d: 60000000,
  leverage: 10,
  exchangeAccount: "okx_main",
  createdAt: "2025/11/15 17:24:53",
  coverageFrom: "2025/11/15 17:23:58",
  coverageTo: "2025/11/16 17:23:58",
  txHash: "0x25fabe...",
  statusLabel: "生效中",
  remainLabel: "T-23:58:32",
  timeline: {
    createdAt: "2025/11/15 17:24:53",
    activatedAt: "2025/11/15 17:23:58",
    runningLabel: "剩余 T-23:58:32"
  }
}
```

---

## 1. 数据库：orders 表要有这些字段

你现有的 `orders` 基本就够用，确保至少有：

```sql
CREATE TABLE IF NOT EXISTS orders (
  id TEXT PRIMARY KEY,                 -- 保单号（前端的 order.id）
  product_sku TEXT NOT NULL,           -- SKU_24H_FIX / SKU_8H...
  notional_usdc_6d INTEGER NOT NULL,   -- 本金 * 1e6
  premium_usdc_6d INTEGER NOT NULL,    -- 保费 * 1e6
  max_payout_usdc_6d INTEGER NOT NULL, -- 最大赔付 * 1e6

  leverage INTEGER NOT NULL,
  exchange_account TEXT,               -- 交易所账户标签

  tx_hash TEXT,                        -- 支付交易的链上哈希
  paid_at TEXT,                        -- (可选) 支付时间

  coverage_from TEXT NOT NULL,         -- 保障开始时间
  coverage_to TEXT NOT NULL,           -- 保障结束时间
  created_at TEXT NOT NULL             -- 创建时间
);
```

如果这些字段已经在，你就不用动迁移，只用在 service 里读出来。

---

## 2. 下单时：把订单完整写入 orders

你现在下单流程大致是：

1. 前端报价格 → 调后端 `/pricing/quote-hash`
2. 前端点击“立即投保” → 挂链上支付
3. 后端有一个 `createOrder` 之类逻辑写入 SQLite

**在 createOrder 里要确保：**

* 生成 `id`（比如 `LP-YYYYMMDD-序号` 或 UUID）
* 写入：

  ```ts
  product_sku        // 决定 24h / 8h / 月度
  notional_usdc_6d   // 本金
  premium_usdc_6d    // 保费
  max_payout_usdc_6d // 最大赔付
  leverage
  exchange_account   // 从用户当前绑定的 OKX 账户 / APIKey alias 来
  created_at         // now
  coverage_from      // 生效时间（可以 = now，简单先这样）
  coverage_to        // coverage_from + 24h（或按 SKU 算）
  tx_hash = NULL     // 下单时先留空，等支付成功再补
  ```

这一步做完，你的「订单列表」和「订单详情」都能有基本信息。

---

## 3. 支付成功后：补写 tx_hash

你之前就有类似：

* `POST /api/v1/orders/:orderId/submit-tx`

这一步要确保：

```ts
// 伪代码：在 apps/us-backend/src/routes/orders.ts 里
router.post('/api/v1/orders/:orderId/submit-tx', requireWalletSession, async (req, res) => {
  const { orderId } = req.params;
  const { txHash } = req.body;

  // 可以加一点校验：字符串长度 66、0x 开头
  if (!/^0x[0-9a-fA-F]{64}$/.test(txHash)) {
    return res.status(400).json({ error: 'INVALID_TX_HASH' });
  }

  await db.run(
    'UPDATE orders SET tx_hash = ?, paid_at = ? WHERE id = ?',
    [txHash, new Date().toISOString(), orderId],
  );

  res.json({ ok: true });
});
```

这样：

* 用户链上支付成功 → 前端拿到 txHash → 调这个接口；
* 数据库里的 `tx_hash` 就填上了；
* 订单详情页就能展示真实 tx，并且「查看链上交易」能跳 BaseScan。

---

## 4. 新增接口：GET `/api/v1/orders/:orderId`

这是这页真正需要的后端功能。

在 `apps/us-backend/src/routes/orders.ts` 里加：

```ts
import { Router } from 'express';
import { requireWalletSession } from '../middleware/authWallet';
import { orderService } from '../services/orderService';

const router = Router();

// 订单详情
router.get('/api/v1/orders/:orderId', requireWalletSession, async (req, res, next) => {
  try {
    const { orderId } = req.params;

    const row = await orderService.findById(orderId);
    if (!row) {
      return res.status(404).json({ error: 'ORDER_NOT_FOUND' });
    }

    // 这里做一层「对前端友好的映射」
    const detail = {
      id: row.id,
      productName: '24h 爆仓保',          // 先写死，后面再做 SKU → 文案映射
      productSku: row.product_sku,

      notional_usdc_6d: row.notional_usdc_6d,
      premium_usdc_6d: row.premium_usdc_6d,
      maxPayout_usdc_6d: row.max_payout_usdc_6d,

      leverage: row.leverage,
      exchangeAccount: row.exchange_account,

      createdAt: row.created_at,
      coverageFrom: row.coverage_from,
      coverageTo: row.coverage_to,

      txHash: row.tx_hash,

      statusLabel: computeStatusLabel(row.coverage_from, row.coverage_to),
      remainLabel: computeRemainLabel(row.coverage_to),

      timeline: {
        createdAt: row.created_at,
        activatedAt: row.coverage_from,
        runningLabel: computeRemainLabel(row.coverage_to),
      },
    };

    res.json(detail);
  } catch (err) {
    next(err);
  }
});

export default router;
```

辅助函数可以先写一个**非常简版**，上线够用：

```ts
function computeStatusLabel(from: string, to: string): string {
  const now = Date.now();
  const fromMs = Date.parse(from);
  const toMs = Date.parse(to);

  if (!Number.isFinite(fromMs) || !Number.isFinite(toMs)) return '生效中';
  if (now < fromMs) return '待生效';
  if (now > toMs) return '已到期';
  return '生效中';
}

function computeRemainLabel(to: string): string {
  const toMs = Date.parse(to);
  if (!Number.isFinite(toMs)) return '';

  const diff = toMs - Date.now();
  if (diff <= 0) return '已结束';

  const totalSeconds = Math.floor(diff / 1000);
  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);

  return `T-${hours.toString().padStart(2, '0')}:${minutes
    .toString()
    .padStart(2, '0')}`;
}
```

**权限注意点：**

* 用 `requireWalletSession`，保证只有「下这个单的钱包」能看自己订单；
* 你可以在 `orderService.findById` 里做 `WHERE wallet_address = session.wallet` 之类，再加一层保险。

---

## 5. 前端路由接一下就能跑

后端这几步做好之后，前端这边只要：

```tsx
// App.tsx
import { OrderDetailRoute } from './OrderDetailPage';

<Route path="/orders/:orderId" element={<OrderDetailRoute />} />
```

订单列表入口保持：

```ts
navigate(`/orders/${encodeURIComponent(order.id)}`);
```

一整套链路就是：

1. 用户下单 → 写入 `orders`（tx_hash 为空）
2. 用户支付成功 → 前端拿到 txHash → 调 `submit-tx` → 更新 `orders.tx_hash`
3. 用户点击「查看详情」 → `/orders/:orderId` → 前端调 `/api/v1/orders/:orderId`
4. 详情页按你现在这版 UI 把所有信息展示出来，`txHash` 也能跳 BaseScan。

---

如果你愿意，我们下一步可以把「赔付管理的理赔详情页」也按同样模式：`GET /api/v1/claims/:claimId → ClaimDetailPage`，前后台一次性收紧。
import React, { useEffect, useState } from 'react';
import { useNavigate, useParams } from 'react-router-dom';

// 订单详情页（上线版，可在有/无 Router 场景运行）
// -------------------------------------------------
// 默认导出：OrderDetailPage —— 纯展示 + 拉取逻辑，不直接依赖 useNavigate/useParams，
// 可以在 Canvas / Storybook / 单元测试中单独渲染，不会触发 Router 报错。
//
// 额外导出：OrderDetailRoute —— 仅在真实路由环境中使用 useParams/useNavigate，
// 用来把 URL 里的 :orderId 和“发起理赔”的跳转，注入到 OrderDetailPage。
//
// 前端集成方式：
//   在路由里用：
//     <Route path="/orders/:orderId" element={<OrderDetailRoute />} />
//   在画布/预览里用：
//     <OrderDetailPage initialOrder={demoOrder} />
//
// 业务约定：
// - 交易所订单号只在「赔付管理 / 理赔详情」出现，这里始终是“保单视角”。

interface OrderDetail {
  id: string; // 保单号（orders.id）

  productName?: string;      // 展示名，例如 "24h 爆仓保"
  productSku?: string;       // SKU_24H_FIX

  notional_usdc_6d?: number; // 本金（6 位小数）
  premium_usdc_6d?: number;  // 已付保费（6 位小数）
  maxPayout_usdc_6d?: number;// 最大赔付（6 位小数）

  notional?: number;         // 可选：直接给前端算好的美元金额
  premium?: number;
  maxPayout?: number;

  leverage?: number;
  exchangeAccount?: string;

  createdAt?: string;        // 已格式化好的时间字符串
  coverageFrom?: string;     // 保障开始（字符串直接展示）
  coverageTo?: string;       // 保障结束

  txHash?: string | null;    // 支付交易的链上哈希

  statusLabel?: string;      // 例如："生效中" / "已到期" / "待生效"
  remainLabel?: string;      // 例如："T-23:58:32"，由后端算好给前端

  timeline?: {
    createdAt?: string;
    activatedAt?: string;
    runningLabel?: string;
  };
}

const demoOrderStandalone: OrderDetail = {
  id: 'LP-2025-11-15-0001',
  productName: '24h 爆仓保',
  productSku: 'SKU_24H_FIX',
  notional_usdc_6d: 200_000_000, // 200 USDC
  premium_usdc_6d: 3_200_000,   // 3.2 USDC
  maxPayout_usdc_6d: 60_000_000, // 60 USDC
  leverage: 10,
  exchangeAccount: 'okx_demo_account',
  createdAt: '2025/11/15 17:24:53',
  coverageFrom: '2025/11/15 17:23:58',
  coverageTo: '2025/11/16 17:23:58',
  txHash: '0x25fabe6a2f246524ccf44be9bd34f9ad42f995f5181f9c6e2eb78869e24afff1',
  statusLabel: '生效中',
  remainLabel: 'T-23:58:32',
  timeline: {
    createdAt: '2025/11/15 17:24:53',
    activatedAt: '2025/11/15 17:23:58',
    runningLabel: '剩余 T-23:58:32',
  },
};

interface OrderDetailPageProps {
  // 可选：外部传入保单号（无 Router 场景）
  orderId?: string;
  // 可选：直接给一个已加载好的订单，组件就不会自己去拉接口
  initialOrder?: OrderDetail | null;
  // 可选：点击“发起理赔”时的回调，由上层决定如何跳转
  onStartClaim?: (orderId: string) => void;
  // 可选：点击“查看链上交易”时的回调，默认用 window.open 打开 BaseScan
  onViewTx?: (txHash: string) => void;
}

const formatUsdc = (micros?: number, fallback?: number): string => {
  if (typeof micros === 'number' && Number.isFinite(micros)) {
    return (micros / 1_000_000).toFixed(2);
  }
  if (typeof fallback === 'number' && Number.isFinite(fallback)) {
    return fallback.toFixed(2);
  }
  return '--';
};

const OrderDetailPage: React.FC<OrderDetailPageProps> = ({
  orderId,
  initialOrder,
  onStartClaim,
  onViewTx,
}) => {
  const [order, setOrder] = useState<OrderDetail | null>(initialOrder || null);
  const [loading, setLoading] = useState<boolean>(!!orderId && !initialOrder);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    // 有 initialOrder 就不拉接口
    if (initialOrder) {
      setOrder(initialOrder);
      setLoading(false);
      setError(null);
      return;
    }

    // 没有 orderId，也没有 initialOrder：在 Canvas / 预览环境下使用内置演示保单
    if (!orderId) {
      setOrder(demoOrderStandalone);
      setLoading(false);
      setError(null);
      return;
    }

    const controller = new AbortController();

    (async () => {
      try {
        setLoading(true);
        setError(null);

        const res = await fetch(`/api/v1/orders/${encodeURIComponent(orderId)}`, {
          credentials: 'include', // 带上 cookie（钱包登录后的 session）
          signal: controller.signal,
        });

        if (!res.ok) {
          throw new Error(`请求失败：${res.status}`);
        }

        const data: OrderDetail = await res.json();
        setOrder(data);
      } catch (err: any) {
        if (err?.name === 'AbortError') return;
        setError(err?.message || '加载失败');
        setOrder(null);
      } finally {
        setLoading(false);
      }
    })();

    return () => controller.abort();
  }, [orderId, initialOrder]);

  const handleViewTx = () => {
    if (!order?.txHash) return;
    if (onViewTx) {
      onViewTx(order.txHash);
      return;
    }
    const url = `https://basescan.org/tx/${order.txHash}`;
    window.open(url, '_blank', 'noopener,noreferrer');
  };

  const handleStartClaim = () => {
    if (!order?.id) return;
    if (onStartClaim) {
      onStartClaim(order.id);
    }
    // 无回调时，静默，无 Router 环境不做跳转，避免 useNavigate 报错
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-[#FFF7ED] px-6 py-4 flex items-center justify-center text-xs text-slate-500">
        加载订单详情中...
      </div>
    );
  }

  if (error || !order) {
    return (
      <div className="min-h-screen bg-[#FFF7ED] px-6 py-4 flex flex-col items-center justify-center gap-2 text-xs text-slate-500">
        <div>订单详情加载失败</div>
        <div className="text-[11px] text-slate-400">{error || '未找到对应保单'}</div>
      </div>
    );
  }

  const productName = order.productName || '24h 爆仓保';
  const productSku = order.productSku || 'SKU_24H_FIX';

  const notional = formatUsdc(order.notional_usdc_6d, order.notional);
  const premium = formatUsdc(order.premium_usdc_6d, order.premium);
  const maxPayout = formatUsdc(order.maxPayout_usdc_6d, order.maxPayout);

  const statusLabel = order.statusLabel || '生效中';
  const remainLabel = order.remainLabel || '';

  const timelineCreated = order.timeline?.createdAt || order.createdAt || '';
  const timelineActivated = order.timeline?.activatedAt || order.coverageFrom || '';
  const timelineRunning = order.timeline?.runningLabel || remainLabel || '';

  return (
    <div className="min-h-screen bg-[#FFF7ED] px-6 py-4 flex flex-col gap-4">
      {/* 顶部提示条：保单号（上线版本） */}
      <div className="w-full max-w-5xl mx-auto">
        <div className="rounded-xl border border-amber-100 bg-[#FFEDE5] px-4 py-2 text-xs text-amber-800 flex flex-wrap items-center gap-2">
          <span className="font-medium">订单详情</span>
          <span className="text-[11px] text-amber-900">保单号：{order.id}</span>
        </div>
      </div>

      {/* 主体布局：左大右小 */}
      <div className="w-full max-w-5xl mx-auto grid grid-cols-1 lg:grid-cols-[minmax(0,2fr)_minmax(0,1fr)] gap-4 items-start">
        {/* 左侧：产品 + 订单信息 */}
        <div className="flex flex-col gap-4">
          {/* 产品概要卡片 */}
          <div className="bg-white rounded-3xl shadow-sm border border-slate-100 px-6 py-5 flex flex-col gap-4">
            {/* 标题行 */}
            <div className="flex flex-wrap items-center gap-3">
              <div className="text-lg font-semibold text-slate-900">{productName}</div>
              <div className="inline-flex items-center gap-2 rounded-full bg-emerald-50 px-3 py-1 text-xs font-medium text-emerald-700">
                <span className="w-2 h-2 rounded-full bg-emerald-500" />
                <span>{statusLabel}</span>
                {remainLabel && (
                  <span className="text-[11px] text-emerald-600">{remainLabel}</span>
                )}
              </div>
              <div className="ml-auto text-right text-slate-900">
                <div className="text-base font-semibold">${maxPayout}</div>
                <div className="text-[11px] text-slate-500 mt-0.5">最大赔付金额</div>
              </div>
            </div>

            {/* 指标行 */}
            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
              <div className="rounded-2xl bg-slate-50 px-4 py-3 flex flex-col gap-1">
                <div className="text-xs text-slate-500">本金</div>
                <div className="text-base font-semibold text-slate-900">${notional}</div>
              </div>
              <div className="rounded-2xl bg-slate-50 px-4 py-3 flex flex-col gap-1">
                <div className="text-xs text-slate-500">杠杆</div>
                <div className="text-base font-semibold text-slate-900">{order.leverage ?? '--'}×</div>
              </div>
              <div className="rounded-2xl bg-slate-50 px-4 py-3 flex flex-col gap-1">
                <div className="text-xs text-slate-500">已付保费</div>
                <div className="text-base font-semibold text-slate-900">${premium}</div>
              </div>
              <div className="rounded-2xl bg-slate-50 px-4 py-3 flex flex-col gap-1">
                <div className="text-xs text-slate-500">产品类型</div>
                <div className="text-[13px] font-mono text-slate-900">{productSku}</div>
              </div>
            </div>

            {/* 操作按钮：左侧主卡片上的两个入口 */}
            <div className="flex flex-wrap gap-3 pt-1">
              <button
                type="button"
                onClick={handleViewTx}
                disabled={!order.txHash}
                className="inline-flex items-center justify-center rounded-full border border-slate-200 px-4 py-2 text-xs font-medium text-slate-700 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                查看链上交易
              </button>
              <button
                type="button"
                onClick={handleStartClaim}
                className="inline-flex items-center justify-center rounded-full bg-rose-600 px-4 py-2 text-xs font-medium text-white shadow-sm hover:bg-rose-700"
              >
                发起理赔
              </button>
            </div>
          </div>

          {/* 订单信息卡片（保单视角，不含交易所订单号） */}
          <div className="bg-white rounded-3xl shadow-sm border border-slate-100 px-6 py-5 flex flex-col gap-4">
            <div className="text-sm font-semibold text-slate-900">订单信息</div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-3 text-xs text-slate-700">
              <div>
                <div className="text-slate-400 mb-0.5">保单号</div>
                <div>{order.id}</div>
              </div>
              <div>
                <div className="text-slate-400 mb-0.5">交易所账户</div>
                <div>{order.exchangeAccount || '—'}</div>
              </div>
              <div>
                <div className="text-slate-400 mb-0.5">创建时间</div>
                <div>{order.createdAt || '—'}</div>
              </div>
              <div>
                <div className="text-slate-400 mb-0.5">保障窗口</div>
                <div>
                  {order.coverageFrom || '—'}
                  <span className="text-slate-400 mx-1">→</span>
                  {order.coverageTo || '—'}
                </div>
              </div>
              {/* 链上交易哈希：给你（运营 / 开发）看，C 端用户更多通过按钮去浏览器 */}
              <div className="md:col-span-2">
                <div className="text-slate-400 mb-0.5">支付交易（链上哈希）</div>
                <div className="font-mono text-[11px] break-all leading-snug text-slate-800">
                  {order.txHash || '—'}
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* 右侧：状态时间线 */}
        <div className="flex flex-col gap-4">
          <div className="bg-white rounded-3xl shadow-sm border border-slate-100 px-5 py-4 flex flex-col gap-3">
            <div className="text-sm font-semibold text-slate-900 mb-1">状态时间线</div>
            <div className="flex flex-col gap-3 text-xs">
              <div className="flex items-start gap-2">
                <span className="mt-1 w-2 h-2 rounded-full bg-emerald-500" />
                <div>
                  <div className="text-slate-800">订单创建</div>
                  <div className="text-[11px] text-slate-500">{timelineCreated || '—'}</div>
                </div>
              </div>
              <div className="flex items-start gap-2">
                <span className="mt-1 w-2 h-2 rounded-full bg-sky-500" />
                <div>
                  <div className="text-slate-800">保障生效</div>
                  <div className="text-[11px] text-slate-500">{timelineActivated || '—'}</div>
                </div>
              </div>
              <div className="flex items-start gap-2">
                <span className="mt-1 w-2 h-2 rounded-full bg-amber-500" />
                <div>
                  <div className="text-slate-800">保障进行中</div>
                  <div className="text-[11px] text-slate-500">{timelineRunning || '—'}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

// 路由包装组件：只在真实 <Router> 环境使用，避免在 Canvas 中触发 useNavigate 报错
export const OrderDetailRoute: React.FC = () => {
  const { orderId } = useParams<{ orderId: string }>();
  const navigate = useNavigate();

  const handleStartClaim = (id: string) => {
    navigate(`/claims?orderId=${encodeURIComponent(id)}`);
  };

  const handleViewTx = (txHash: string) => {
    const url = `https://basescan.org/tx/${txHash}`;
    window.open(url, '_blank', 'noopener,noreferrer');
  };

  return (
    <OrderDetailPage
      orderId={orderId}
      onStartClaim={handleStartClaim}
      onViewTx={handleViewTx}
    />
  );
};

export default OrderDetailPage;
